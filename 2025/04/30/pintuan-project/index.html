<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>00 拼团交易平台系统 | coo1heisenberg's Blog</title><noscript>开启JavaScript才能访问本站哦~</noscript><link rel="icon" href="/img/pwa/favicon.ico"><!-- index.css--><link rel="stylesheet" href="/css/index.css?v=1.10.6"><!-- inject head--><link rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/7pOrz0WXB5ZWJPX/latest/iconfont.css"><!-- aplayer--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.css"><!-- swiper--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"><!-- fancybox ui--><!-- katex--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/KaTeX/0.16.9/katex.min.css"><!-- Open Graph--><meta name="description" content="拼团交易平台系统 拼团需求分析 项目背景 拼团系统可以用于，这类带有支付场景购买商品的系统。我们这里以这样两个系统作为使用场景作为举例。也可以作用于任何其他的交易类系统 针对目前的小型支付商城系统，商品购买交易同比增速放缓，需要引入新的营销策略促进商品交易量。在交易数据统计分析中得到，市场存"><!-- pwa--><meta name="apple-mobile-web-app-capable" content="coo1heisenberg's Blog"><meta name="theme-color" content="var(--efu-main)"><meta name="apple-mobile-web-app-status-bar-style" content="var(--efu-main)"><link rel="bookmark" href="/img/pwa/favicon.ico"><link rel="apple-touch-icon" href="/img/pwa/favicon.ico" sizes="180x180"><script>console.log(
    "%c Program: Hexo %c Theme: Solitude %c Version: v1.10.6",
    "border-radius:5px 0 0 5px;padding: 5px 10px;color:white;background:#ff3842;",
    "padding: 5px 10px;color:white;background:#3e9f50;",
    "padding: 5px 10px;color:white;background:#0084ff;border-radius:0 5px 5px 0",
)
</script><script>(()=>{
        const saveToLocal = {
            set: function setWithExpiry(key, value, ttl) {
                if (ttl === 0)
                    return
                const now = new Date()
                const expiryDay = ttl * 86400000
                const item = {
                    value: value,
                    expiry: now.getTime() + expiryDay
                }
                localStorage.setItem(key, JSON.stringify(item))
            },
            get: function getWithExpiry(key) {
                const itemStr = localStorage.getItem(key)
    
                if (!itemStr) {
                    return undefined
                }
                const item = JSON.parse(itemStr)
                const now = new Date()
    
                if (now.getTime() > item.expiry) {
                    localStorage.removeItem(key)
                    return undefined
                }
                return item.value
            }
        };
        window.utils = {
            saveToLocal: saveToLocal,
            getCSS: (url, id = false) => new Promise((resolve, reject) => {
              const link = document.createElement('link')
              link.rel = 'stylesheet'
              link.href = url
              if (id) link.id = id
              link.onerror = reject
              link.onload = link.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                link.onload = link.onreadystatechange = null
                resolve()
              }
              document.head.appendChild(link)
            }),
            getScript: (url, attr = {}) => new Promise((resolve, reject) => {
              const script = document.createElement('script')
              script.src = url
              script.async = true
              script.onerror = reject
              script.onload = script.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                script.onload = script.onreadystatechange = null
                resolve()
              }
    
              Object.keys(attr).forEach(key => {
                script.setAttribute(key, attr[key])
              })
    
              document.head.appendChild(script)
            }),
            addGlobalFn: (key, fn, name = false, parent = window) => {
                const globalFn = parent.globalFn || {}
                const keyObj = globalFn[key] || {}
        
                if (name && keyObj[name]) return
        
                name = name || Object.keys(keyObj).length
                keyObj[name] = fn
                globalFn[key] = keyObj
                parent.globalFn = globalFn
            },
        }
    })()</script><!-- global head--><script>const GLOBAL_CONFIG = {
    root: '/',
    algolia: undefined,
    localsearch: {"preload":false,"path":"/search.xml"},
    runtime: '2024-05-12 00:00:00',
    lazyload: {
        enable: false,
        error: '/img/error_load.webp'
    },
    copyright: {"limit":50,"author":"作者: Coo1heisenberg’s BLOG","link":"链接: ","source":"来源: coo1heisenberg's Blog","info":"著作权归作者所有。 商业转载请联系作者获得授权，非商业转载请注明出处。"},
    highlight: {
        enable: true,
        limit: 200,
        expand: true,
        copy: true,
        syntax: 'highlight.js'
    },
    randomlink: false,
    lang: {"theme":{"dark":"已切换至深色模式","light":"已切换至浅色模式"},"copy":{"success":"复制成功","error":"复制失败"},"backtop":"返回顶部","time":{"day":"天前","hour":"小时前","just":"刚刚","min":"分钟前","month":"个月前"},"f12":"开发者模式已打开，请遵循GPL协议。","totalk":"无需删除空行，直接输入评论即可","search":{"empty":"找不到你查询的内容：${query}","hit":"找到 ${hits} 条结果，用时 ${time} 毫秒","placeholder":"输入关键词快速查找","count":"共 <b>${count}</b> 条结果。"}},
    aside: {
        sayhello: {
            morning: '一日之计在于晨',
            noon: '吃饱了才有力气干活',
            afternoon: '集中精力，攻克难关',
            night: '不要太劳累了，早睡更健康',
            goodnight: '睡个好觉，保证精力充沛',
        },
        sayhello2: [],
    },
    covercolor: {
        enable: false
    },
    comment: false,
    lightbox: 'null',
    post_ai: false,
    right_menu: false,
};</script><!-- page-config head--><script id="config-diff">var PAGE_CONFIG = {
    is_post: true,
    is_page: false,
    is_home: false,
    page: '',
    toc: true,
    comment: false,
    ai_text: false
}</script><meta name="generator" content="Hexo 7.2.0"></head><body id="body"><!-- universe--><canvas id="universe"></canvas><!-- loading--><!-- console--><div id="console"><div class="close-btn" onclick="sco.hideConsole()"><i class="solitude st-close-fill"></i></div><div class="console-card-group"><div class="console-card-group-right"><div class="console-card tags" onclick="sco.hideConsole()"><div class="card-content"><div class="author-content-item-tips">标签</div><div class="author-content-item-title">寻找感兴趣的领域</div></div><div class="card-tag-cloud"><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列<sup>1</sup></a><a href="/tags/MongoDB/">MongoDB<sup>1</sup></a><a href="/tags/Mybatis-Plus/">Mybatis-Plus<sup>1</sup></a><a href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础<sup>2</sup></a><a href="/tags/ElasticSearch/">ElasticSearch<sup>1</sup></a><a href="/tags/HTML-CSS/">HTML+CSS<sup>1</sup></a><a href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/">单细胞<sup>1</sup></a><a href="/tags/MySQL/">MySQL<sup>2</sup></a><a href="/tags/Redis/">Redis<sup>3</sup></a><a href="/tags/Project/">Project<sup>3</sup></a><a href="/tags/Spring/">Spring<sup>1</sup></a><a href="/tags/%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">空间转录组<sup>1</sup></a><a href="/tags/Python%E9%AB%98%E7%BA%A7/">Python高级<sup>1</sup></a><a href="/tags/Docker%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Docker基础语法<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<sup>1</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/">Java基础<sup>1</sup></a><a href="/tags/JVM/">JVM<sup>1</sup></a><a href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程<sup>1</sup></a><a href="/tags/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/">Java集合框架<sup>1</sup></a><a href="/tags/Nginx%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Nginx基础语法<sup>1</sup></a><a href="/tags/Linux%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Linux基础语法<sup>1</sup></a><a href="/tags/SpringCloud/">SpringCloud<sup>1</sup></a><a href="/tags/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/">Spring全家桶<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统<sup>1</sup></a></div></div><div class="console-card history" onclick="sco.hideConsole()"><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">2025/04</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">2025/02</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">2025/01</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">2024/12</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">2024/11</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">2024/09</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">2024/07</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">2024/06</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">2024/05</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span class="card-archive-list-count-unit">篇</span></div></a></li></ul></div></div></div><div class="button-group"><div class="console-btn-item"><span class="darkmode_switchbutton" onclick="sco.switchDarkMode()" title="昼夜切换"><i class="solitude st-moon-clear-fill"></i></span></div><div class="console-btn-item" id="consoleHideAside"><span class="asideSwitch" onclick="sco.switchHideAside()" title="边栏显示控制"><i class="solitude st-side-bar-fill"></i></span></div></div><div class="console-mask" onclick="sco.hideConsole()"></div></div><!-- sidebar--><div id="sidebar" style="zoom: 1;"><div id="menu-mask" style="display: none;"></div><div id="sidebar-menus"><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div></div></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><span class="darkmode_switchbutton menu-child" onclick="sco.switchDarkMode()"><i class="solitude st-moon-clear-fill"></i><span>显示模式</span></span></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">博客主题</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="Solitude"><img class="nolazyload back-menu-item-icon" src="https://7.isyangs.cn/1/65eb200ee4dea-1.png" alt="Solitude"><span class="back-menu-item-text">Solitude</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文库</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  st-checkbox-multiple-blank-fill"></i><span>全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/links/"><i class="solitude  st-group-fill"></i><span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/tlink/"><i class="solitude  st-tools-fill"></i><span>工具箱</span></a></li><li><a class="site-page child" href="/music/"><i class="solitude  st-disc-fill"></i><span>音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>关于本站</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-widget card-tags card-archives card-webinfo card-allinfo"><div class="card-tag-cloud"><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列<sup>1</sup></a><a href="/tags/MongoDB/">MongoDB<sup>1</sup></a><a href="/tags/Mybatis-Plus/">Mybatis-Plus<sup>1</sup></a><a href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础<sup>2</sup></a><a href="/tags/ElasticSearch/">ElasticSearch<sup>1</sup></a><a href="/tags/HTML-CSS/">HTML+CSS<sup>1</sup></a><a href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/">单细胞<sup>1</sup></a><a href="/tags/MySQL/">MySQL<sup>2</sup></a><a href="/tags/Redis/">Redis<sup>3</sup></a><a href="/tags/Project/">Project<sup>3</sup></a><a href="/tags/Spring/">Spring<sup>1</sup></a><a href="/tags/%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">空间转录组<sup>1</sup></a><a href="/tags/Python%E9%AB%98%E7%BA%A7/">Python高级<sup>1</sup></a><a href="/tags/Docker%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Docker基础语法<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<sup>1</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/">Java基础<sup>1</sup></a><a href="/tags/JVM/">JVM<sup>1</sup></a><a href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程<sup>1</sup></a><a href="/tags/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/">Java集合框架<sup>1</sup></a><a href="/tags/Nginx%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Nginx基础语法<sup>1</sup></a><a href="/tags/Linux%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Linux基础语法<sup>1</sup></a><a href="/tags/SpringCloud/">SpringCloud<sup>1</sup></a><a href="/tags/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/">Spring全家桶<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统<sup>1</sup></a></div></div></div></div><!-- keyboard--><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav class="show" id="nav"><div id="nav-group"><div id="blog_name"><div class="back-home-button" tabindex="-1"><i class="back-home-button-icon solitude st-more-fill"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">博客主题</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="Solitude"><img class="nolazyload back-menu-item-icon" src="https://7.isyangs.cn/1/65eb200ee4dea-1.png" alt="Solitude"><span class="back-menu-item-text">Solitude</span></a></div></div></div></div><a id="site-name" href="/" title="返回博客主页"><span class="title">Solitude</span></a></div><div id="page-name-mask"><div id="page-name"><a id="page-name-text" onclick="sco.toTop()">00 拼团交易平台系统</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文库</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  st-checkbox-multiple-blank-fill"></i><span>全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/links/"><i class="solitude  st-group-fill"></i><span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/tlink/"><i class="solitude  st-tools-fill"></i><span>工具箱</span></a></li><li><a class="site-page child" href="/music/"><i class="solitude  st-disc-fill"></i><span>音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>关于本站</span></a></li></ul></div></div></div><div id="nav-left"></div><div id="nav-right"><div class="nav-button" id="travellings_button"><a class="site-page" href="/" title=""><i class="solitude st-train-line"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索"><i class="solitude st-search-line"></i></a></div><div class="nav-button" id="nav-totop" onclick="sco.toTop()"><a class="totopbtn"><i class="solitude st-arrow-up-line"></i><span id="percent">0</span></a></div><div id="toggle-menu"><a class="site-page"><i class="solitude st-menu-line"></i></a></div></div></div></nav><div class="coverdiv" id="coverdiv"><img class="nolazyload" id="post-cover" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/pdd.png" alt="00 拼团交易平台系统"></div><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original" title="该文章为原创文章，注意版权协议">原创</a><span class="post-meta-categories"><a class="post-meta-categories" href="/categories/Java/">Java</a></span><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Project/"><span class="tags-name tags-punctuation">Project</span></a></div></div></div></div><h1 class="post-title">00 拼团交易平台系统</h1><div id="post-meta"><div class="meta-secondline"><span class="post-meta-date" title="发布于 2025-04-30 15:23:26"><i class="post-meta-icon solitude st-calendar-todo-fill"></i><time datetime="2025-04-30T07:23:26.000Z">2025-04-30T07:23:26.000Z</time></span><span class="post-meta-date" title="最后更新于 2025-05-06 19:02:46"><i class="post-meta-icon solitude st-refresh-line"></i><time datetime="2025-05-06T11:02:46.779Z">2025-05-06T11:02:46.779Z</time></span><span class="post-meta-wordcount"><span class="post-meta-separator"></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>拼团交易平台系统</h1>
<hr>
<h2 id="拼团需求分析"><a class="headerlink" href="#拼团需求分析"></a>拼团需求分析</h2>
<hr>
<h3 id="项目背景"><a class="headerlink" href="#项目背景"></a>项目背景</h3>
<hr>
<ul>
<li>拼团系统可以用于，这类带有支付场景购买商品的系统。我们这里以这样两个系统作为使用场景作为举例。也可以作用于任何其他的交易类系统</li>
<li>针对目前的<code>小型支付商城系统</code>，商品购买交易同比增速放缓，需要引入新的营销策略促进商品交易量。在交易数据统计分析中得到，市场存在同类竞品，商品价格设定低于目前我们的商品定价，所以用户购买意愿偏低</li>
<li>所以为了盘活沉睡用户，需要适当降低商品价格。但为了达到传播的效果，所以需要引入拼团方式，以客带客，<strong>靠用户自身传播的方式进行交易拉新</strong>。这样的处理方式对比于 KOL，会让利商品价值到用户自身。【KOL 等同于抖音大主播直播卖货】</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430154903218.png" alt="具体流程" loading="lazy"></p>
<hr>
<h3 id="产品方案"><a class="headerlink" href="#产品方案"></a>产品方案</h3>
<hr>
<p>因为我们所实现的是一个平台类系统，<strong>可以满足各类交易场景的拼团需求接入</strong>。所以在实现这套系统时候，不要与其他系统耦合。并提供相关的研发侧对接标准。</p>
<p>一般早期运营，先把商品价格促销大家，提高拼团的稀缺性。让大量用户知道拼团商品，之后调整为到期即可成团，只要参与就能拿到商品。</p>
<h4 id="1-1-商品前端界面"><a class="headerlink" href="#1-1-商品前端界面"></a>1.1 商品前端界面</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430155324225.png" alt="前端界面" loading="lazy"></p>
<ul>
<li>进入商品页后，查询是否配置了拼团活动。并进行优惠试算，拼团成团价，最低优惠展示。</li>
<li>参与首次拼团、参与拼团中拼团。拼团完成则不在展示此条拼团。</li>
<li>所有参与中的拼团统计拼团人员。</li>
</ul>
<h4 id="1-2-运营后台管理"><a class="headerlink" href="#1-2-运营后台管理"></a>1.2 运营后台管理</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430155423408.png" alt="运营后台管理界面" loading="lazy"></p>
<ul>
<li>提供配置需要提供如图所示信息。</li>
<li>人群标签为提前设定标签类型，产生对应的人群数据。</li>
</ul>
<h4 id="1-3-功能流程"><a class="headerlink" href="#1-3-功能流程"></a>1.3 功能流程</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430155930368.png" alt="功能流程" loading="lazy"></p>
<ul>
<li>首先，由运营配置商品拼团活动，增加折扣方式。因为有人群标签的过滤，所以可以控制哪些人可参与拼团。</li>
<li>之后，用户可见拼团商品并参与拼团。用户可自主分享拼团或者等待拼团。因为拼团有非常大的折扣刺激用户自主分享，以此可以节省营销推广费用。</li>
<li>最后，拼团完成，触达商品发货。这里有两种，一种运营手段是<strong>拼团成团稀有性</strong>，必须打成拼团才可以。另外一种是<strong>虚拟拼团</strong>，无论是否打成，到时都完成拼团。</li>
</ul>
<hr>
<h2 id="拼团库表设计"><a class="headerlink" href="#拼团库表设计"></a>拼团库表设计</h2>
<hr>
<p>进入公司接触新的项目时，可以先<strong>从库表进行了解</strong>。知道它们的流转关系，之后在看系统设计和代码实现会更加清晰</p>
<h3 id="库表关系"><a class="headerlink" href="#库表关系"></a>库表关系</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430160600252.png" alt="库表关系示意图" loading="lazy"></p>
<ul>
<li>首先，站在<strong>运营</strong>的角度，要<strong>为这次拼团配置对应的拼团活动</strong>。那么就会涉及到：给哪个渠道的什么商品<code>ID</code>配置拼团，这样用户在进入商品页就可以看到带有拼团商品的信息了。之后要考虑，这个拼团的商品所提供的规则信息，包括：折扣、时间、人数等。还要拿到折扣的一个试算金额。这个试算出来的金额，就是告诉用户，通过拼团可以拿到的最低价格。</li>
<li>之后，站在<strong>用户</strong>的角度，是<strong>参与拼团</strong>。首次发起一个拼团与参与已存在的拼团进行数据的记录，达成拼团约定拼团人数后，开始进行通知。这个通知的设计站在平台角度可以提供回调，那么任何的系统也就都可以接入了。</li>
<li>另外，为了支撑这套库表，也会有<strong>人群的设计</strong>。人群是互联网公司中非常常用的手段，比如：要把所有符合某个条件的用户<code>ID</code>全部写入到一个特定的 <code>Redis</code> 记录中，之后就可以专门为这些人做特定的拼团活动了。</li>
<li>那么，拼团活动表，为什么会把折扣拆分出来呢？因为这里的折扣可能有多种迭代到一个拼团上。比如：给一个商品添加了直减10元的优惠，又对符合的人群<code>ID</code>的用户，额外打9折，这样就有了2个折扣迭代。所以拆分出来会更好维护。这是对常变的元素和稳定的元素进行设计的思考。</li>
</ul>
<h3 id="库表设计"><a class="headerlink" href="#库表设计"></a>库表设计</h3>
<h4 id="1-1-拼团配置表"><a class="headerlink" href="#1-1-拼团配置表"></a>1.1 拼团配置表</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430162005678.png" alt="拼团配置表" loading="lazy"></p>
<p>如图，详细设计表：<strong>拼团活动表</strong>、<strong>折扣配置表</strong>、<strong>人群标签表</strong>、<strong>人群标签任务表</strong>、<strong>人群标签明细表</strong>。</p>
<ul>
<li><strong>拼团活动表</strong>：设定了拼团的成团规则，人群标签的使用可以限定哪些人可见，哪些人可参与。</li>
<li><strong>折扣配置表</strong>：拆分出拼团优惠到一个新的表进行多条配置。如果折扣还有更多的复杂规则，则可以配置新的折扣规则表进行处理。</li>
<li><strong>人群标签表</strong>：专门来做人群设计记录的，这3张表就是为了把符合规则的人群<code>ID</code>，也就是用户<code>ID</code>，全部跑任务到一个记录下进行使用。比如：黑玫瑰人群、高净值人群、拼团履约率90%以上的人群等。</li>
</ul>
<h4 id="1-2-参与拼团表"><a class="headerlink" href="#1-2-参与拼团表"></a>1.2 参与拼团表</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430162905010.png" alt="参与拼团表" loading="lazy"></p>
<p>如图，详细设计表：<strong>拼团账户表</strong>、<strong>用户拼单表</strong>、<strong>用户拼单明细</strong>、<strong>回调任务表</strong></p>
<ul>
<li><strong>拼团账户表</strong>：记录用户的拼团参与数据，一个是为了限制用户的参与拼团次数，另外是为了人群标签任务统计数据。</li>
<li><strong>用户拼单表</strong>：当有用户发起首次拼单的时候，产生拼单<code>ID</code>，并记录所需成团的拼单记录，另外是写上拼团的状态、唯一索引、回调接口等。这样拼团完成就可以回调对接的平台，通知完成了。【微信支付也是这样的设计，回调支付结果，这样的设计可以方便平台化对接】。当再有用户参与后，则写入用户拼单明细表。直至达成拼团。</li>
<li><strong>回调任务表</strong>：当拼团完成后，要做回调处理。但可能会有失败，所以加入任务的方式进行补偿。如果仍然失败，则需要对接的平台，自己查询拼团结果。</li>
</ul>
<hr>
<h2 id="研发系统设计"><a class="headerlink" href="#研发系统设计"></a>研发系统设计</h2>
<hr>
<p>需求：<strong>研发不能只是为了功能而直接开发。还要遵守一系列的流程，确保开发迭代的需求，都能平稳的交付</strong>。所以要有<strong>研发设计</strong>、要有<strong>评审</strong>、要有<strong>测试</strong>、要有<strong>预发</strong>、要有<strong>黑白名单验证</strong>和<strong>功能切量</strong></p>
<h3 id="1-用户用例图"><a class="headerlink" href="#1-用户用例图"></a>1. 用户用例图</h3>
<p>用例图（英语：use case diagram）是用户与系统交互的最简表示形式，展现了用户和与他相关的用例之间的关系。通过用例图，人们可以获知系统不同种类的用户和用例。用例图也经常和其他图表配合使用。</p>
<p>这样的用例图，它有点项目目标结果驱动，让你知道最终的产品形态要提供什么功能。所以有这样的一个指导是可以很好的完成后续的建模设计的。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430164407297.png" alt="用户用例图" loading="lazy"></p>
<ul>
<li>站在<strong>用户视角</strong>，会有：查看拼团商品、发起拼团、参与拼团、查看拼团结果、查看商品记录。</li>
<li>站在<strong>运营视角</strong>，会有：配置拼团活动、配置人群标签、审核拼团配置、查看拼团流水。</li>
</ul>
<h3 id="2-四色建模图"><a class="headerlink" href="#2-四色建模图"></a>2. 四色建模图</h3>
<p>在 MVC 的系统开发中，是很少做建模的事情的。因为它都是面向过程开发，过程就是一个流程需要什么就编写什么，但随着系统的复杂，会逐步发现，A 流程、B 流程、C 流程，越来越多的流程加入，但这些流程中又存在了交叉、复用。也就是大家看到的 MVC 里的代码，总是一个功能，被复制了好多次，好多地方编写。所以使用 DDD 思想的情况，会对这些内容提前思考，进行建模设计，划分出领域。让一个个单元变得容易管理。</p>
<p>MVC 有点像睡大车店子（大通铺的一个大炕），DDD 划分了每家每户，每个床睡着该睡的人。</p>
<h4 id="2-1-建模方式"><a class="headerlink" href="#2-1-建模方式"></a>2.1 建模方式</h4>
<p>DDD 的建模过程，是以一个用户为起点，通过行为命令，发起行为动作，串联整个业务。而这个用户的起点最初来自于用例图的分析。用例图是用户与系统交互的最简表示形式，展现了用户和与他相关的用例之间的关系。通过用例图，我们可以分析出所有的行为动作。</p>
<p>在 DDD 中用于完成用户的行为命令和动作分析的过程，是一个四色建模的过程，也称作风暴模型。在使用 DDD 的标准对系统建模前，一堆人要先了解 DDD 的操作手段，这样才能让产品、研发、测试、运营等了解业务的伙伴，都能在同一个语言下完成系统建模。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430173727455.png" alt="DDD建模方法" loading="lazy"></p>
<p>此图是整个四色建模的指导图，通过寻找领域事件，发起事件命令，完成领域事件的过程，完成 DDD 工程建模，左下角的示意图为：是一个用户，通过一个策略命令，使用领域对象，通过业务流程，完成 2 个领域事件，调用 1 次外部接口个过程。我们在整个 DDD 建模过程中，就是在寻找这些节点。</p>
<ul>
<li><strong>蓝色</strong>：<strong>决策命令</strong>，是用户发起的行为动作，如：开始签到、开始抽奖、查看额度等。</li>
<li><strong>黄色</strong>：<strong>领域事件</strong>，过去时态描述。如：签到完成、抽奖完成、奖品发放完成。它所阐述的都是这个领域要完成的终态。</li>
<li><strong>粉色</strong>：<strong>外部系统</strong>，如：你的系统需要调用外部的接口完成流程。</li>
<li><strong>红色</strong>：<strong>业务流程</strong>，用于串联决策命令到领域事件，所实现的业务流程。一些简单的场景则直接有决策命令到领域事件就可以了。</li>
<li><strong>绿色</strong>：<strong>只读模型</strong>，做一些读取数据的动作，没有写库的操作。</li>
<li><strong>棕色</strong>：<strong>领域对象</strong>，每个决策命令的发起，都是含有一个对应的领域对象。</li>
</ul>
<h4 id="2-2-寻找事件"><a class="headerlink" href="#2-2-寻找事件"></a>2.2 寻找事件</h4>
<p>寻找领域事件的过程，就是<strong>寻找系统中流程节点的结果态</strong>。什么结束了、什么完成了、什么终止。其实这样的手段，也是<strong>一种目标结果驱动的手段，当有人为你指明了，你要去哪里，之后你会有更目标感的前进</strong>。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430174311686.png" alt="寻找领域事件的过程" loading="lazy"></p>
<ul>
<li>目前我们可以根据需求找到，如图中黄色部分的领域事件。包括：发起拼团完成、参与拼团完成、拼团目标达成、回调通知完成、拼团发货完成、人群标签生成完成、拼团活动创建完成。</li>
<li>如果后续我们在迭代新的功能的话，还会引入其他领域事件。你也可以思考，还可能存在什么领域事件。</li>
</ul>
<h4 id="2-3-划分领域"><a class="headerlink" href="#2-3-划分领域"></a>2.3 划分领域</h4>
<p>领域的划分是基于寻找领域事件之后，<strong>所有的领域事件都应该有一个对应的发起方</strong>，我们管这个叫<strong>决策命令</strong>。比如：你去超时购物完成，是你媳妇发起的决策命令让你去买胖东来的0添加酱油。那么，我们这里就要找到完成这些领域事件的决策命令</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430174534086.png" alt="划分领域示意图" loading="lazy"></p>
<ul>
<li>蓝色为以用户维度的决策命令，你发出的所有命令，都会有一个对应的结果态承接。</li>
<li>如果是复杂的业务，要做一些列的流程，则会出现一个 <code>Business Policy</code> 业务流程。这个业务流程里可以通过设计模式来完成功能的设计。经过这样的处理，你的代码也会变得非常清晰。</li>
</ul>
<hr>
<h3 id="3-业务流程"><a class="headerlink" href="#3-业务流程"></a>3. 业务流程</h3>
<p>研发功能流程设计有一粗一细，粗的是流程图为了让大家快速的了解这些功能节点的串联关系，方便讲解的时候，可以让多方了解。细的是 UML 时序图，这个会把流程中的个细节体现出来，指导研发做功能实现。</p>
<h4 id="3-1-流程图"><a class="headerlink" href="#3-1-流程图"></a>3.1 流程图</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430174925108.png" alt="拼团流程图" loading="lazy"></p>
<ul>
<li>分别以用户和运营视角，了解一套拼团的配置到用户的参与。</li>
</ul>
<h4 id="3-2-时序图"><a class="headerlink" href="#3-2-时序图"></a>3.2 时序图</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430175217209.png" alt="拼团时序图（上）" loading="lazy"></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430175231117.png" alt="拼团时序图（下）" loading="lazy"></p>
<ul>
<li>时序图，展示了整个拼团过程所涉及的系统模块和流转关系。这部分直接看图即可。</li>
</ul>
<hr>
<h3 id="4-系统架构"><a class="headerlink" href="#4-系统架构"></a>4. 系统架构</h3>
<p>DDD 是软件开发设计的一套<strong>指导思想</strong>，但不是直接决定了你如何编码，而是提供了对需求设计为研发提供编码指引的手段。所以，DDD 建模后，你可以使用 3 层架构 MVC 开发，也可以使用六边形架构、整洁架构、菱形架构开发。这也就是为什么有些人的简历上，专业技能栏里会有相关架构内容的体现。</p>
<ul>
<li>在这方面，阿里最早推出的 cola 考拉🐨架构，就是整洁架构的代表。张毅老师推出的菱形架构，南向网关、北向网关，属于六边形这一类的架构。这些都是为了更好的落地 DDD 这套指导思想而出现的架构分层设计。</li>
</ul>
<p>所以，DDD 是指导思想，帮助你建模设计，划分领域。六边形架构、整洁架构、菱形架构，是为了帮你落地知道思想到具体编码实现上。</p>
<p>那么，MVC 分层架构不也可以开发 DDD 知道思想的编码吗？可以，但相对来说不会那么优雅。MVC 的出现，并不是在有了分布式微服务之后，所以一些分布式资源模块的承载和领域思想的处理，在 MVC 中都是比较别扭的。所以，我们选择新的架构形态可以更好的承载 DDD 指导思想。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430175537755.png" alt="MVC架构图" loading="lazy"></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250430175605550.png" alt="DDD架构图" loading="lazy"></p>
<p>如图，展示了分布式微服务架构项目，各项开发过程中所需的资源在两套分层架构中的体现。</p>
<ol>
<li>MVC 基本是把所有的内容都用服务来承载，无论是自身的服务，还是外部的服务。这样会导致维护的混乱，长期迭代成本的增加。</li>
<li>六边形架构，对于MVC的劣势做了针对性的架构处理，合理的划分了各项资源在不同层的承载。<code>domain</code>  也更专注于领域功能的实现。也就是把以前的 <code>service</code> 内容，划分到 <code>domain</code> 中处理。</li>
</ol>
<hr>
<h2 id="初始工程搭建"><a class="headerlink" href="#初始工程搭建"></a>初始工程搭建</h2>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250501102454415.png" alt="模块信息" loading="lazy"></p>
<ul>
<li><strong>接口定义 - api</strong> ：<strong>因为微服务中引用的 <code>RPC</code> 需要对外提供接口的描述信息</strong>，也就是调用方在使用的时候，需要引入 <code>Jar</code> 包，让调用方好能依赖接口的定义做代理。</li>
<li><strong>应用封装 - app</strong> ：这是<strong>应用启动和配置的一层</strong>，如：一些 <code>AOP</code> 切面或者 <code>config</code> 配置，以及打包镜像都是在这一层处理。你可以把它理解为专门为了启动服务而存在的。</li>
<li><strong>领域封装 - domain</strong> ：<strong>领域模型服务，是一个非常重要的模块</strong>。无论怎么做 DDD 的分层架构，<code>domain</code> 都是肯定存在的。在一层中会有一个个细分的领域服务，在每个服务包中会有【<strong>模型</strong>、<strong>仓库</strong>、<strong>服务</strong>】这样3部分。</li>
<li><strong>仓储服务 - infrastructure</strong> ：<strong>基础层依赖于 <code>domain</code> 领域层，因为在 <code>domain</code> 层定义了仓储接口需要在基础层实现。这是依赖倒置的一种设计方式</strong>。</li>
<li><strong>领域封装 - trigger</strong> ：<strong>触发器层</strong>，用于提供接口实现、消息接收、任务执行等。包括：<code>http</code>接口调用、<code>job</code>接口调用、<code>listener</code>接口调用。</li>
<li><strong>类型定义 - types</strong> ：<strong>通用类型定义层</strong>，在我们的系统开发中，会有很多类型的定义，包括：基本的 <code>Response</code>、<code>Constants</code> 和枚举。它会被其他的层进行引用使用。</li>
</ul>
<hr>
<h2 id="试算模型抽象模板设计"><a class="headerlink" href="#试算模型抽象模板设计"></a>试算模型抽象模板设计</h2>
<hr>
<h3 id="1-模型设计"><a class="headerlink" href="#1-模型设计"></a>1. 模型设计</h3>
<p>这是一种<strong>链式的多分支规则树模型结构</strong>，由功能节点自行决定后续流程的执行链路。它的设计比责任链的扩展性更好，自由度也更高。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250501125203497.png" alt="模型设计示意图" loading="lazy"></p>
<ul>
<li>首先，定义抽象的通用的规则树模型结构。涵盖：<code>StrategyMapper</code> - 策略映射器、<code>StrategyHandler</code> - 策略处理器、<code>AbstractStrategyRouter&lt;T, D, R&gt;</code> - 策略路由抽象类。通过泛型设计允许使用方可以自定义出入参和动态上下文，让抽象模板模型具有通用性。</li>
<li>之后，由使用方自定义出工厂、功能抽象类和一个个流程流转的节点。这些节点可以自由组装进行流转，相比于责任链它的实现方式更具有灵活性。</li>
</ul>
<h3 id="2-编码实现"><a class="headerlink" href="#2-编码实现"></a>2. 编码实现</h3>
<h4 id="2-1-模板定义"><a class="headerlink" href="#2-1-模板定义"></a>2.1 模板定义</h4>
<p>在项目工程的 <code>types</code> 模块中，<strong>添加通用设计模式模板</strong>。如果是公司里的项目工程，还可以单独提供一个通用的设计模式模板工程，这样每个项目都可以引入使用了。</p>
<p>目前，先添加 <code>tree</code> 规则树模型结构。后续随着开发需要在添加其他通用设计模式</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250501134734758.png" alt="tree规则树模型结构" loading="lazy"></p>
<p><strong>策略映射器</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StrategyMapper</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取待执行策略</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestParameter 入参</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dynamicContext   上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返参</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    StrategyHandler&lt;T, D, R&gt; <span class="title function_">get</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>StrategyMapper</code> 的 <code>get</code> 方法用于获取每一个要执行的节点，相当于一个流程走完进入到下一个流程的过程。这在我们处理复杂的业务代码时是非常重要的，避免把所有逻辑都写到一个类的方法中。</li>
<li>泛型 <code>T</code> - 入参、<code>D</code> - 上下文、<code>R</code> - 返参。</li>
</ul>
<p><strong>策略受理器</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 受理策略处理</span></span><br><span class="line"><span class="comment"> * T 入参类型</span></span><br><span class="line"><span class="comment"> * D 上下文参数</span></span><br><span class="line"><span class="comment"> * R 返参类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StrategyHandler</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StrategyHandler</span> <span class="variable">DEFAULT</span> <span class="operator">=</span> (T, D) -&gt; <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>StrategyHandler</code> 的 <code>apply</code> 受理执行的业务流程。每个业务流程执行时，如果有数据是从前面节点到后面节点要使用的，那么可以填充到 <code>dynamicContext</code> 上下文中。</li>
</ul>
<p><strong>策略路由器</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 策略路由抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractStrategyRouter</span>&lt;T, D, R&gt; <span class="keyword">implements</span> <span class="title class_">StrategyMapper</span>&lt;T, D, R&gt;, StrategyHandler&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">protected</span> StrategyHandler&lt;T, D, R&gt; defaultStrategyHandler = StrategyHandler.DEFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">router</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        StrategyHandler&lt;T, D, R&gt; strategyHandler = get(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != strategyHandler) <span class="keyword">return</span> strategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">return</span> defaultStrategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过调用策略映射器 <code>get</code> 方法，控制节点流程的走向。</li>
</ul>
<h3 id="3-首页试算"><a class="headerlink" href="#3-首页试算"></a>3. 首页试算</h3>
<p>当一个用户进入到购物首页查看商品的优惠信息，我们可以把这个过程定义为试算过程。试算：试试算一下，这个用户进入到首页看这个商品的时候，商品的营销优惠信息。包括：原始价格、折扣价格、拼团目标、拼团时效、是否可见优惠、是否可参与拼团等，这些东西都是试算拿到的结果。</p>
<p>类似的，当你进入到一个信贷贷款的页面，也会告诉你分期多少，还款多少期，每期多少钱。这些东西也都是试算。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250501140632084.png" alt="首页试算流程" loading="lazy"></p>
<ul>
<li>在 <code>domain</code> 领域层，实现拼团活动服务功能。<code>model</code> 是对象的定义，这个对象就类似于你在 <code>MVC</code> 中定义的 <code>vo</code>、<code>req</code>、<code>res</code> 这样的对象。只不过这里一般叫 <code>xxxEntity</code> 实体，它是一种<strong>面向对象的思维</strong>。</li>
<li><code>trial</code> 试算模块，把整个首页商品展示的信息都通过试算完成。后续会重点实现，本节先定义框架分层结构。</li>
<li>目前这里的代码还没有具体的实现代码，只有分层结构。可以直接参考工程的代码。</li>
</ul>
<h4 id="3-1-营销商品实体信息"><a class="headerlink" href="#3-1-营销商品实体信息"></a>3.1 营销商品实体信息</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 营销商品实体信息，通过这样一个信息获取商品优惠信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketProductEntity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户ID */</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="comment">/** 商品ID */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    <span class="comment">/** 渠道 */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="comment">/** 来源 */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-试算结果实体对象"><a class="headerlink" href="#3-2-试算结果实体对象"></a>3.2 试算结果实体对象</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 试算结果实体对象（给用户展示拼团可获得的优惠信息）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrialBalanceEntity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 商品ID */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 商品名称 */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 原始价格 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal originalPrice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 折扣金额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal deductionPrice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 支付金额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 拼团目标数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer targetCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 拼团开始时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 拼团结束时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 是否可见拼团 */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isVisible;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 是否可参与进团 */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isEnable;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>暂定一些试算的所需的结果，后续随着功能迭代再补充</li>
</ul>
<h4 id="3-3-抽象的拼团营销支撑类"><a class="headerlink" href="#3-3-抽象的拼团营销支撑类"></a>3.3 抽象的拼团营销支撑类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 抽象的拼团营销支撑类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DynamicContext, TrialBalanceEntity&gt; <span class="keyword">extends</span> <span class="title class_">AbstractStrategyRouter</span>&lt;MarketProductEntity, DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-活动策略工厂定义"><a class="headerlink" href="#3-4-活动策略工厂定义"></a>3.4 活动策略工厂定义</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultActivityStrategyFactory</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取根节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RootNode rootNode;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultActivityStrategyFactory</span><span class="params">(RootNode rootNode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rootNode = rootNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取根节点的方法的</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DynamicContext, TrialBalanceEntity&gt; <span class="title function_">strategyHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rootNode;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicContext</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-5-构建一个节点（根节点举例）"><a class="headerlink" href="#3-5-构建一个节点（根节点举例）"></a>3.5 构建一个节点（根节点举例）</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 根节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RootNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将开关节点注入</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SwitchNode switchNode;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">apply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根节点，实现 <code>AbstractGroupBuyMarketSupport</code> 抽象类。这个抽象类目前是空实现，后续一些通用的方法会放入这个抽象类里。</li>
</ul>
<h4 id="3-6-创建一个开关节点"><a class="headerlink" href="#3-6-创建一个开关节点"></a>3.6 创建一个开关节点</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 开关节点，用于消费的降级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwitchNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">apply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-7-添加一个首页的方法"><a class="headerlink" href="#3-7-添加一个首页的方法"></a>3.7 添加一个首页的方法</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 首页营销服务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IIndexGroupBuyMarketService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    TrialBalanceEntity <span class="title function_">indexMarketTrial</span><span class="params">(MarketProductEntity marketProductEntity)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 首页营销服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexGroupBuyMarketServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IIndexGroupBuyMarketService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DefaultActivityStrategyFactory defaultActivityStrategyFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">indexMarketTrial</span><span class="params">(MarketProductEntity marketProductEntity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取执行策略</span></span><br><span class="line">        StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; strategyHandler = defaultActivityStrategyFactory.strategyHandler();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 受理试算操作</span></span><br><span class="line">        <span class="type">TrialBalanceEntity</span> <span class="variable">trialBalanceEntity</span> <span class="operator">=</span> TastrategyHandler.apply(marketProductEntity, <span class="keyword">new</span> <span class="title class_">DefaultActivityStrategyFactory</span>.DynamicContext());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> trialBalanceEntity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="多线程异步数据加载"><a class="headerlink" href="#多线程异步数据加载"></a>多线程异步数据加载</h2>
<hr>
<p>扩展规则树模型结构，<strong>增加异步数据加载区</strong>。将用于<strong>试算营销优惠的接口</strong>使用异步线程进行加载，之后写入上下文，用于后续的逻辑处理。这部分的模型设计是非常巧妙的，通过<strong>解耦逻辑</strong>和<strong>划分功能区</strong>，让代码具有了文档属性，看到对应的类和类下的方法区，就可以轻松的理解代码实现方式。这样的处理非常有利于后续功能的迭代。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250501150818517.png" alt="模型链路示意图" loading="lazy"></p>
<ul>
<li>首先，对通用设计模式树结构扩展出异步数据加载区，这样可以把接口实现中所需的数据前置到异步数据加载区完成加载操作。以此提高接口的响应效率。</li>
<li>之后，串联功能节点，并在 <code>MarketNode</code> 节点，添加数据加载操作。</li>
<li>另外，注意本节需要新增加一个表 <code>sku</code>，也就是<strong>商品信息表</strong>，通过商品信息表获得当前商品的价格配置，以此来做商品的折扣计算。这块在实际生产中有两种实现方式，一种是每次都调用外部接口获取商品，另外一种是有商品统一同步库可以查询。我们这里先通过<strong>一个统一的商品库</strong>进行处理。那么后续谁要对接这个系统，就调用 <code>sku</code> 商品库，同步好商品即可。</li>
</ul>
<h3 id="1-增加多线程模块"><a class="headerlink" href="#1-增加多线程模块"></a>1. 增加多线程模块</h3>
<p>在 <code>types</code> 模块的 <code>design</code> 模型定义中，新增加抽象类设计多线程数据加载区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 异步资源加载策略</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractMultiThreadStrategyRouter</span>&lt;T, D, R&gt; <span class="keyword">implements</span> <span class="title class_">StrategyMapper</span>&lt;T, D, R&gt;, StrategyHandler&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">protected</span> StrategyHandler&lt;T, D, R&gt; defaultStrategyHandler = StrategyHandler.DEFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">router</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        StrategyHandler&lt;T, D, R&gt; strategyHandler = get(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != strategyHandler) <span class="keyword">return</span> strategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">return</span> defaultStrategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前面的和AbstractStrategyRouter这个是一样的，这里的需要重写方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 异步加载数据</span></span><br><span class="line">        multiThread(requestParameter, dynamicContext);</span><br><span class="line">        <span class="comment">// 业务流程受理</span></span><br><span class="line">        <span class="keyword">return</span> doApply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步加载数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">multiThread</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException, TimeoutException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务流程受理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> R <span class="title function_">doApply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>主要是添加了一个 <code>multiThread</code> 方法，这个方法在执行 <code>apply</code> 受理业务功能逻辑实现前完成对数据的加载调用。</li>
<li>之后在提供一个 <code>doApply</code> 受理的抽象方法，让使用方完成这个方法的实现即可。</li>
<li>这块的逻辑对新人可能有点绕，你可以在本节最后的代码测试调试时进行验证。<strong>debug 断点调试代码对编码来说非常重要</strong></li>
</ul>
<h3 id="2-节点逻辑"><a class="headerlink" href="#2-节点逻辑"></a>2. 节点逻辑</h3>
<h4 id="2-1-RootNode"><a class="headerlink" href="#2-1-RootNode"></a>2.1 RootNode</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RootNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SwitchNode switchNode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-RootNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 参数判断</span></span><br><span class="line">        <span class="comment">// userId、goodsId、source、channel</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(requestParameter.getUserId()) || StringUtils.isBlank(requestParameter.getGoodsId()) ||</span><br><span class="line">                StringUtils.isBlank(requestParameter.getSource()) || StringUtils.isBlank(requestParameter.getChannel())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> switchNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根节点一般会<strong>做数据的初始操作、信息判断、缓存处理</strong>等功能。</li>
</ul>
<h4 id="2-2-SwitchNode"><a class="headerlink" href="#2-2-SwitchNode"></a>2.2 SwitchNode</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwitchNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MarketNode marketNode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> marketNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>开关功能的节点在后续在做实现。</li>
</ul>
<h4 id="2-3-MarketNode"><a class="headerlink" href="#2-3-MarketNode"></a>2.3 MarketNode</h4>
<p>这个节点是这个部分最重要实现的一个节点，让大家理解多线程在实际场景中的使用。</p>
<p>当你一个节点要执行业务逻辑时候，需要为这些业务逻辑准备接口、数据库、Redis、配置中心等各样的数据，但有些时候外部的接口依赖的很多，那么就不能一个个顺序的查询，这样会导致接口的时长很大。所以要多线程并行处理，那么所有的时长也就只是那个耗时最长的接口时长了。</p>
<p>首先，<strong>新增加异步 <code>FutureTask</code> 任务，完成对活动配置的查询，商品的查询</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.trial.thread;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 查询营销配置任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryGroupBuyActivityDiscountVOThreadTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;GroupBuyActivityDiscountVO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 来源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String source;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渠道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String channel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动仓储</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IActivityRepository activityRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QueryGroupBuyActivityDiscountVOThreadTask</span><span class="params">(String source, String channel, IActivityRepository activityRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.source = source;</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">        <span class="built_in">this</span>.activityRepository = activityRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GroupBuyActivityDiscountVO <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> activityRepository.queryGroupBuyActivityDiscountVO(source, channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 查询商品信息任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuerySkuVOFromDBThreadTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;SkuVO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String goodsId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IActivityRepository activityRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QuerySkuVOFromDBThreadTask</span><span class="params">(String goodsId, IActivityRepository activityRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.goodsId = goodsId;</span><br><span class="line">        <span class="built_in">this</span>.activityRepository = activityRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SkuVO <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> activityRepository.querySkuByGoodsId(goodsId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里是两个实现了 <code>Callable</code> 接口的任务，分别查询不同的数据。</li>
<li>在实际的工作中，查询的不只是数据，还有很多其他方提供的 <code>RPC</code>、<code>HTTP</code> 接口。</li>
</ul>
<p>接下来，我们就可以在 <code>MarketNode</code> 节点，来处理这些数据任务的调用操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程池</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolExecutor threadPoolExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// endNode节点</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EndNode endNode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">multiThread</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException, TimeoutException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 异步查询活动配置</span></span><br><span class="line">        <span class="type">QueryGroupBuyActivityDiscountVOThreadTask</span> <span class="variable">queryGroupBuyActivityDiscountVOThreadTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryGroupBuyActivityDiscountVOThreadTask</span>(requestParameter.getSource(), requestParameter.getChannel(), repository);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// FutureTask 是 Java 并发编程中的一个重要类，它结合了 Runnable 和 Future 的特性，主要用于异步计算和任务管理，FutureTask 可以包装一个 Callable 或 Runnable 任务，将任务提交给线程池或单独线程执行，实现异步计算</span></span><br><span class="line">        FutureTask&lt;GroupBuyActivityDiscountVO&gt; groupBuyActivityDiscountVOFutureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(queryGroupBuyActivityDiscountVOThreadTask);</span><br><span class="line">        </span><br><span class="line">        threadPoolExecutor.execute(groupBuyActivityDiscountVOFutureTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步查询商品信息 - 在实际生产中，商品有同步库或者调用接口查询。这里暂时使用DB方式查询。</span></span><br><span class="line">        <span class="type">QuerySkuVOFromDBThreadTask</span> <span class="variable">querySkuVOFromDBThreadTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuerySkuVOFromDBThreadTask</span>(requestParameter.getGoodsId(), repository);</span><br><span class="line">        </span><br><span class="line">        FutureTask&lt;SkuVO&gt; skuVOFutureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(querySkuVOFromDBThreadTask);</span><br><span class="line">        </span><br><span class="line">        threadPoolExecutor.execute(skuVOFutureTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入上下文 - 对于一些复杂场景，获取数据的操作，有时候会在下N个节点获取，这样前置查询数据，可以提高接口响应效率</span></span><br><span class="line">        <span class="comment">// 这块是将上面创建的两个数据写到上下文环境中</span></span><br><span class="line">        <span class="comment">// 设置一个超时时间</span></span><br><span class="line">        dynamicContext.setGroupBuyActivityDiscountVO(groupBuyActivityDiscountVOFutureTask.get(timeout, TimeUnit.MINUTES));</span><br><span class="line">        dynamicContext.setSkuVO(skuVOFutureTask.get(timeout, TimeUnit.MINUTES));</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-MarketNode userId:&#123;&#125; 异步线程加载数据「GroupBuyActivityDiscountVO、SkuVO」完成&quot;</span>, requestParameter.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> endNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>multiThread</code> 方法中，启动对异步数据的查询处理，之后在使用动态上下文承接数据。</li>
<li><code>doApply</code> 受理业务流程的实现放在后续在处理。</li>
<li><code>threadPoolExecutor</code> 线程池配置的是 <code>CallerRunsPolicy</code> 策略。当线程池中的任务队列已满，并且没有空闲线程可以执行新任务时，<code>CallerRunsPolicy</code> 会将任务回退到调用者线程中运行。这种策略适用于不希望丢失任务且可以接受调用者线程被阻塞的场景。</li>
</ul>
<p>新增一个<strong>活动仓储接口方法类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 活动仓储</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IActivityRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增里面的传值<strong>VO对象</strong>，这其实是属于一种防腐的设计，不把数据库的对象暴露出来，因为在开发的过程中，传入的对象是不断变化的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.model.valobj;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 拼团活动营销配置值对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyActivityDiscountVO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long activityId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String activityName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 来源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渠道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折扣配置，就是下面那个内部类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> GroupBuyDiscount groupBuyDiscount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团方式（0自动成团、1达成目标拼团）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer groupType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团次数限制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer takeLimitCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团目标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer target;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团时长（分钟）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer validTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动状态（0创建、1生效、2过期、3废弃）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动开始时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动结束时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 人群标签规则标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tagId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 人群标签规则范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tagScope;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 折扣类</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">GroupBuyDiscount</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折扣标题</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String discountName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折扣描述</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String discountDesc;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折扣类型（0:base、1:tag）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> DiscountTypeEnum discountType;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 营销优惠计划（ZJ:直减、MJ:满减、N元购）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String marketPlan;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 营销优惠表达式</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String marketExpr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 人群标签，特定优惠限定</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String tagId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加 <code>Sku</code> 库表信息，就是商品库的信息，然后写一个查询的方法接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao.po;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 商品信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sku</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 自增 */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 来源 */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 渠道 */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 商品ID */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 商品名称 */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 原始价格 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal originalPrice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 创建时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 更新时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 商品查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISkuDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    Sku <span class="title function_">querySkuByGoodsId</span><span class="params">(String goodsId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-EndNode"><a class="headerlink" href="#2-4-EndNode"></a>2.4 EndNode</h4>
<p>用于封装最终返回的结果数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EndNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里属于结尾的节点，就是封装一下最终的数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-EndNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line"></span><br><span class="line">        <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivityDiscountVO();</span><br><span class="line">        <span class="type">SkuVO</span> <span class="variable">skuVO</span> <span class="operator">=</span> dynamicContext.getSkuVO();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回空结果</span></span><br><span class="line">        <span class="keyword">return</span> TrialBalanceEntity.builder()</span><br><span class="line">                  .goodsId(skuVO.getGoodsId())</span><br><span class="line">                  .goodsName(skuVO.getGoodsName())</span><br><span class="line">                  .originalPrice(skuVO.getOriginalPrice())</span><br><span class="line">                  .deductionPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.00&quot;</span>))</span><br><span class="line">                  .targetCount(groupBuyActivityDiscountVO.getTarget())</span><br><span class="line">                  .startTime(groupBuyActivityDiscountVO.getStartTime())</span><br><span class="line">                  .endTime(groupBuyActivityDiscountVO.getEndTime())</span><br><span class="line">                  .isVisible(<span class="literal">false</span>)</span><br><span class="line">                  .isEnable(<span class="literal">false</span>)</span><br><span class="line">                  .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultStrategyHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回的数据可以由动态上下文中的结果进行封装。</li>
<li>暂时我们这里只把可以获取到的数据做一个处理。关于优惠金额以及可见性等参数mock写入即可</li>
</ul>
<hr>
<h2 id="策略模式优惠折扣计算"><a class="headerlink" href="#策略模式优惠折扣计算"></a>策略模式优惠折扣计算</h2>
<hr>
<p>通过<strong>策略模式处理多类型折扣方式的逻辑计算</strong>，同时设定抽象模板，用于扩展后续人群标签的过滤。</p>
<h3 id="1-模型设计-2"><a class="headerlink" href="#1-模型设计-2"></a>1. 模型设计</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250501172042721.png" alt="优惠折扣计算模型流程图" loading="lazy"></p>
<ul>
<li>首先，<code>MarketNode</code> 节点的数据异步加载工作已经完成，这一部分开始使用这里的数据做折扣计算。</li>
<li>之后，折扣是在数据库中配置的，按照类型包括：<code>ZJ</code> - 直减、<code>MJ</code> - 满减、<code>ZK</code> - 折扣、<code>N</code> - n元购。那么这些不同的类型就可以用策略模型进行包装，每个实现类专门负责自己的逻辑计算。</li>
</ul>
<h3 id="2-编码实现-2"><a class="headerlink" href="#2-编码实现-2"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构"><a class="headerlink" href="#2-1-工程结构"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250502124654342.png" alt="工程结构" loading="lazy"></p>
<ul>
<li><code>service</code> 包下，增加 <code>discount</code> 折扣计算包，提供不同类型的折扣计算服务。</li>
<li>之后再 <code>MarketNode</code> 节点做逻辑调用。计算完结果后在写上下文，便于最后在 <code>EndNode</code> 节点填充。</li>
</ul>
<h4 id="2-2-折扣策略-MJ、N、ZJ、ZK"><a class="headerlink" href="#2-2-折扣策略-MJ、N、ZJ、ZK"></a>2.2 折扣策略 - MJ、N、ZJ、ZK</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250502124915660.png" alt="折扣数据库表" loading="lazy"></p>
<ul>
<li>折扣的方式可以有：<code>ZJ</code>、<code>MJ</code>、<code>ZK</code>、<code>N</code>，以及多种方式。这里的 <code>market_expr</code> 是计算的公式，比如：<code>MJ</code> - 满减这样的，就是满100元减10元。</li>
<li>概念：像是这种营销折扣方式，是一种商家配置无券营销方式，用户是无感知券但可以使用优惠的。另外一种就是有券，用户主动拿到手里的券，自己选择消费方式。</li>
</ul>
<h4 id="2-3-折扣优惠类型枚举值编写"><a class="headerlink" href="#2-3-折扣优惠类型枚举值编写"></a>2.3 折扣优惠类型枚举值编写</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.model.valobj;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 折扣优惠类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DiscountTypeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    BASE(<span class="number">0</span>, <span class="string">&quot;基础优惠&quot;</span>),</span><br><span class="line">    TAG(<span class="number">1</span>, <span class="string">&quot;人群标签&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DiscountTypeEnum <span class="title function_">get</span><span class="params">(Integer code)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> BASE;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> TAG;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;err code!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-4-折扣服务的接口"><a class="headerlink" href="#2-4-折扣服务的接口"></a>2.4 折扣服务的接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 折扣计算服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IDiscountCalculateService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折扣计算</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId           用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> originalPrice    商品原始价格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupBuyDiscount 折扣计划配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 商品优惠价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BigDecimal <span class="title function_">calculate</span><span class="params">(String userId, BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义折扣计算的接口，包括：用户<code>ID</code>、商品原始价格、折扣计划配置。</li>
<li>用户<code>ID</code>，主要用于后续做人群标签的过滤使用。</li>
</ul>
<h4 id="2-5-抽象模板类"><a class="headerlink" href="#2-5-抽象模板类"></a>2.5 抽象模板类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.discount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 折扣计算服务抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDiscountCalculateService</span> <span class="keyword">implements</span> <span class="title class_">IDiscountCalculateService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> IActivityRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">calculate</span><span class="params">(String userId, BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 人群标签过滤</span></span><br><span class="line">        <span class="keyword">if</span> (DiscountTypeEnum.TAG.equals(groupBuyDiscount.getDiscountType()))&#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isCrowdRange</span> <span class="operator">=</span> filterTagId(userId, groupBuyDiscount.getTagId());</span><br><span class="line">            <span class="keyword">if</span> (!isCrowdRange) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;折扣优惠计算拦截，用户不再优惠人群标签范围内 userId:&#123;&#125;&quot;</span>, userId);</span><br><span class="line">                <span class="keyword">return</span> originalPrice;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 折扣优惠计算</span></span><br><span class="line">        <span class="keyword">return</span> doCalculate(originalPrice, groupBuyDiscount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 人群过滤 - 限定人群优惠</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">filterTagId</span><span class="params">(String userId, String tagId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.isTagCrowdRange(tagId, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> BigDecimal <span class="title function_">doCalculate</span><span class="params">(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-增加一个满减（MJ）的计算"><a class="headerlink" href="#2-6-增加一个满减（MJ）的计算"></a>2.6 增加一个满减（MJ）的计算</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 满减优惠计算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service(&quot;MJ&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MJCalculateService</span> <span class="keyword">extends</span> <span class="title class_">AbstractDiscountCalculateService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">doCalculate</span><span class="params">(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;优惠策略折扣计算:&#123;&#125;&quot;</span>, groupBuyDiscount.getDiscountType().getCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 折扣表达式 - 100,10 满100减10元</span></span><br><span class="line">        <span class="comment">// 这个marketExpr就是 100,10</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">marketExpr</span> <span class="operator">=</span> groupBuyDiscount.getMarketExpr();</span><br><span class="line">        String[] split = marketExpr.split(Constants.SPLIT);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">x</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(split[<span class="number">0</span>].trim());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">y</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(split[<span class="number">1</span>].trim());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不满足最低满减约束，则按照原价</span></span><br><span class="line">        <span class="keyword">if</span> (originalPrice.compareTo(x) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> originalPrice;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 折扣价格</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">deductionPrice</span> <span class="operator">=</span> originalPrice.subtract(y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断折扣后金额，最低支付1分钱</span></span><br><span class="line">        <span class="comment">// 如果是0元，最低支付0.01元</span></span><br><span class="line">        <span class="keyword">if</span> (deductionPrice.compareTo(BigDecimal.ZERO) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.01&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deductionPrice;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>这里举例其中一个，<code>MJ</code> 的折扣计算。其他的可以参考代码中的实现。</li>
<li>满减，拿到折扣的配置表达式，拆分 <code>100,10</code>，之后判断商品金额是否满足100元，满足100元则可以减去10元。不过这里要知道，如果商品最终折扣价格不足1分钱，要按照1分钱计算。</li>
</ul>
<h4 id="2-7-MarketNode营销调用"><a class="headerlink" href="#2-7-MarketNode营销调用"></a>2.7 MarketNode营销调用</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolExecutor threadPoolExecutor;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EndNode endNode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;https://bugstack.cn/md/road-map/spring-dependency-injection.html&quot;&gt;Spring 注入详细说明&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 只要是这个接口下面的实现，都会依次注入进来</span></span><br><span class="line">    <span class="comment">// 这个名字就是MJCalculateService、NCCalculateService、ZJCalculateService、ZKCalculateService</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IDiscountCalculateService&gt; discountCalculateServiceMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-MarketNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上下文数据</span></span><br><span class="line">        <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivityDiscountVO();</span><br><span class="line">        GroupBuyActivityDiscountVO.<span class="type">GroupBuyDiscount</span> <span class="variable">groupBuyDiscount</span> <span class="operator">=</span> groupBuyActivityDiscountVO.getGroupBuyDiscount();</span><br><span class="line"></span><br><span class="line">        <span class="type">SkuVO</span> <span class="variable">skuVO</span> <span class="operator">=</span> dynamicContext.getSkuVO();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优惠试算</span></span><br><span class="line">        <span class="type">IDiscountCalculateService</span> <span class="variable">discountCalculateService</span> <span class="operator">=</span> discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == discountCalculateService) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;不存在&#123;&#125;类型的折扣计算服务，支持类型为:&#123;&#125;&quot;</span>, groupBuyDiscount.getMarketPlan(), JSON.toJSONString(discountCalculateServiceMap.keySet()));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0001.getCode(), ResponseCode.E0001.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 折扣后的价格</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">deductionPrice</span> <span class="operator">=</span> discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);</span><br><span class="line">        dynamicContext.setDeductionPrice(deductionPrice);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>private Map&lt;String, IDiscountCalculateService&gt; discountCalculateServiceMap</code> <strong>是一种 <code>Spring</code> 的 <code>Map</code> 注入方式，会根据一个接口把所有的实现类都注入上，之后 <code>Key</code> 是 <code>Bean</code> 的名字</strong></li>
<li>这样我们就可以根据数据库配置的折扣的类型来调用对应的策略，也就把 <code>if...else</code> 这样的判断代码给去掉了</li>
</ul>
<hr>
<h2 id="人群标签数据采集"><a class="headerlink" href="#人群标签数据采集"></a>人群标签数据采集</h2>
<hr>
<p>需求：</p>
<ol>
<li>以轻量化的方式构建人群标签数据，将人群数据写入到 <code>Redis BitMap</code> 用于后续使用</li>
<li>在公司中，所有部门产生的业务数据都会回流到数仓，它有一个非常庞大的数据集市系统。之后这些数据会被量化分析师使用，通过 <code>R</code> 语言建模，执行模型任务，把符合模型所需的标签数据跑到一个新的指定表文件中，这些文件在通过加工存放到 <code>Redis BitMap</code> 进行使用。一般一个标签可能会有 50万、100万、500万的数据规模</li>
<li>有了这些标签数据，运营人员就可以精准的对这些用户做定向活动投放，比如；特定的券、特定的通知等。以此达到更加精准的运营效果</li>
</ol>
<h3 id="1-业务流程"><a class="headerlink" href="#1-业务流程"></a>1. 业务流程</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250502135904082.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，人群标签是通过<strong>创建的采集任务所产生的数据</strong>。任务里包含了要采集业务中什么类型的数据规则。本项目中会采集拼团交易数据，不过本节还没有这类数据，所以先来模拟这部分数据。</li>
<li>之后，把采集的数据除了放数据库，还需要写入到 <code>Redis</code> 的 <code>BitMap</code> 中，这个数据结构<strong>比较适合高并发场景判断用户是否存在</strong>。</li>
</ul>
<h3 id="2-编码实现-3"><a class="headerlink" href="#2-编码实现-3"></a>2. 编码实现</h3>
<p>需要新创建出 <code>crowd_tags</code>、<code>crowd_tags_detail</code>、<code>crowd_tags_job</code> 3张库表，用于统计人群标签</p>
<p>引入 <code>Redisson</code> 配置，<code>pom</code>引入、<code>app/config</code> 增加配置、<code>infrastructure</code> 增加 <code>Redisson</code> 服务接口和实现类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.26.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>增加三张库表</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 转储表 crowd_tags</span><br><span class="line"># <span class="comment">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `crowd_tags`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `crowd_tags` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增ID&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;人群ID&#x27;</span>,</span><br><span class="line">  `tag_name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;人群名称&#x27;</span>,</span><br><span class="line">  `tag_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;人群描述&#x27;</span>,</span><br><span class="line">  `statistics` <span class="type">int</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;人群标签统计量&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uq_tag_id` (`tag_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;人群标签&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 转储表 crowd_tags_detail</span><br><span class="line"># <span class="comment">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `crowd_tags_detail`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `crowd_tags_detail` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增ID&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;人群ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uq_tag_user` (`tag_id`,`user_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;人群标签明细&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 转储表 crowd_tags_job</span><br><span class="line"># <span class="comment">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `crowd_tags_job`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `crowd_tags_job` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增ID&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标签ID&#x27;</span>,</span><br><span class="line">  `batch_id` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;批次ID&#x27;</span>,</span><br><span class="line">  `tag_type` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;标签类型（参与量、消费金额）&#x27;</span>,</span><br><span class="line">  `tag_rule` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标签规则（限定类型 N次）&#x27;</span>,</span><br><span class="line">  `stat_start_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;统计数据，开始时间&#x27;</span>,</span><br><span class="line">  `stat_end_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;统计数据，结束时间&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态；0初始、1计划（进入执行阶段）、2重置、3完成&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uq_batch_id` (`batch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;人群标签任务&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>增加redis的配置文件</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redis 客户端，使用 Redisson &lt;a href=&quot;https://github.com/redisson/redisson&quot;&gt;Redisson&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisClientConfigProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;redissonClient&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">(ConfigurableApplicationContext applicationContext, RedisClientConfigProperties properties)</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">// 根据需要可以设定编解码器；https://github.com/redisson/redisson/wiki/4.-%E6%95%B0%E6%8D%AE%E5%BA%8F%E5%88%97%E5%8C%96</span></span><br><span class="line">        config.setCodec(JsonJacksonCodec.INSTANCE);</span><br><span class="line"></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">                .setAddress(<span class="string">&quot;redis://&quot;</span> + properties.getHost() + <span class="string">&quot;:&quot;</span> + properties.getPort())</span><br><span class="line"><span class="comment">//                .setPassword(properties.getPassword())</span></span><br><span class="line">                .setConnectionPoolSize(properties.getPoolSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(properties.getMinIdleSize())</span><br><span class="line">                .setIdleConnectionTimeout(properties.getIdleTimeout())</span><br><span class="line">                .setConnectTimeout(properties.getConnectTimeout())</span><br><span class="line">                .setRetryAttempts(properties.getRetryAttempts())</span><br><span class="line">                .setRetryInterval(properties.getRetryInterval())</span><br><span class="line">                .setPingConnectionInterval(properties.getPingInterval())</span><br><span class="line">                .setKeepAlive(properties.isKeepAlive())</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RedisCodec</span> <span class="keyword">extends</span> <span class="title class_">BaseCodec</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> in -&gt; &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">out</span> <span class="operator">=</span> ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ByteBufOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteBufOutputStream</span>(out);</span><br><span class="line">                JSON.writeJSONString(os, in, SerializerFeature.WriteClassName);</span><br><span class="line">                <span class="keyword">return</span> os.buffer();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                out.release();</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                out.release();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Decoder&lt;Object&gt; decoder = (buf, state) -&gt; JSON.parseObject(<span class="keyword">new</span> <span class="title class_">ByteBufInputStream</span>(buf), Object.class);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Decoder&lt;Object&gt; <span class="title function_">getValueDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> decoder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Encoder <span class="title function_">getValueEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> encoder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> Redis 连接配置 &lt;a href=&quot;https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter&quot;&gt;redisson-spring-boot-starter&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;redis.sdk.config&quot;, ignoreInvalidFields = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClientConfigProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** host:ip */</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="comment">/** 端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="comment">/** 账密 */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/** 设置连接池的大小，默认为64 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">poolSize</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line">    <span class="comment">/** 设置连接池的最小空闲连接数，默认为10 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">minIdleSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/** 设置连接的最大空闲时间（单位：毫秒），超过该时间的空闲连接将被关闭，默认为10000 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">idleTimeout</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="comment">/** 设置连接超时时间（单位：毫秒），默认为10000 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">connectTimeout</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="comment">/** 设置连接重试次数，默认为3 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryAttempts</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="comment">/** 设置连接重试的间隔时间（单位：毫秒），默认为1000 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryInterval</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/** 设置定期检查连接是否可用的时间间隔（单位：毫秒），默认为0，表示不进行定期检查 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">pingInterval</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/** 设置是否保持长连接，默认为true */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">keepAlive</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">sdk:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.109</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">16379</span></span><br><span class="line">      <span class="attr">pool-size:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">min-idle-size:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">30000</span></span><br><span class="line">      <span class="attr">connect-timeout:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">retry-attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">retry-interval:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">ping-interval:</span> <span class="number">60000</span></span><br><span class="line">      <span class="attr">keep-alive:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="2-1-工程结构-2"><a class="headerlink" href="#2-1-工程结构-2"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250502143708318.png" alt="工程结构" loading="lazy"></p>
<ul>
<li><code>infrastructure</code> 基础设施层：增加人群标签仓储服务和3个操作人群标签的<code>DAO</code>操作，同时在增加一个 <code>Redisson</code> 操作接口和实现类。</li>
<li><code>domain</code> 领域层：增加 <code>tag</code> 人群标签领域，完成人群标签功能实现。</li>
<li><code>app</code> 应用启动层：配置 <code>mapper</code>、<code>application-dev.yml</code>、以及 <code>config</code> 下的 <code>Redis</code> 链接配置类。</li>
</ul>
<h4 id="2-2-人群任务"><a class="headerlink" href="#2-2-人群任务"></a>2.2 人群任务</h4>
<p>增加人群标签服务接口，并实现功能流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Fuzhengwei bugstack.cn @小傅哥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 人群标签服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2024-12-28 12:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TagService</span> <span class="keyword">implements</span> <span class="title class_">ITagService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITagRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execTagBatchJob</span><span class="params">(String tagId, String batchId)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;人群标签批次任务 tagId:&#123;&#125; batchId:&#123;&#125;&quot;</span>, tagId, batchId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 查询批次任务</span></span><br><span class="line">        <span class="type">CrowdTagsJobEntity</span> <span class="variable">crowdTagsJobEntity</span> <span class="operator">=</span> repository.queryCrowdTagsJobEntity(tagId, batchId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 采集用户数据 - 这部分需要采集用户的消费类数据，后续有用户发起拼单后再处理。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 数据写入记录</span></span><br><span class="line">        List&lt;String&gt; userIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;() &#123;&#123;</span><br><span class="line">            add(<span class="string">&quot;xxx1&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx2&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx3&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx4&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx5&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx6&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx7&quot;</span>);</span><br><span class="line">            add(<span class="string">&quot;xxx8&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 一般人群标签的处理在公司中，会有专门的数据数仓团队通过脚本方式写入到数据库，就不用这样一个个或者批次来写。</span></span><br><span class="line">        <span class="keyword">for</span> (String userId : userIdList) &#123;</span><br><span class="line">            repository.addCrowdTagsUserId(tagId, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 更新人群标签统计量</span></span><br><span class="line">        repository.updateCrowdTagsStatistics(tagId, userIdList.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过采集人群标签任务获取人群数据，暂时没有这类业务数据，所以先模拟一个用户数据，你也可以调整这里的数据为你需要的。</li>
<li>采集数据后，<code>repository.addCrowdTagsUserId(tagId, userId);</code> 写入到数据库表。注意 <code>addCrowdTagsUserId</code> 方法，写入后还会做 <code>BitMap</code> 存储。</li>
<li>这些操作完成后，会更新统计量。<strong>注意，目前的统计量更新是不准的，因为执行 <code>addCrowdTagsUserId</code> 操作，会有主键冲突，主键冲突直接拦截不会抛异常。那么更新人群标签的统计量会继续增加</strong>。</li>
</ul>
<h4 id="2-3-数据存储-bitmap"><a class="headerlink" href="#2-3-数据存储-bitmap"></a>2.3 数据存储 - bitmap</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.redis;</span><br><span class="line"><span class="comment">// 这个是redisService的内容</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> <span class="type">int</span> <span class="title function_">getIndexFromUserId</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] hashBytes = md.digest(userId.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">// 将哈希字节数组转换为正整数</span></span><br><span class="line">            <span class="type">BigInteger</span> <span class="variable">bigInt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, hashBytes);</span><br><span class="line">            <span class="comment">// 取模以确保索引在合理范围内</span></span><br><span class="line">            <span class="keyword">return</span> bigInt.mod(BigInteger.valueOf(Integer.MAX_VALUE)).intValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;MD5 algorithm not found&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 人群标签仓储</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TagRepository</span> <span class="keyword">implements</span> <span class="title class_">ITagRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ICrowdTagsDao crowdTagsDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ICrowdTagsDetailDao crowdTagsDetailDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ICrowdTagsJobDao crowdTagsJobDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IRedisService redisService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询人群标签任务实体</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CrowdTagsJobEntity <span class="title function_">queryCrowdTagsJobEntity</span><span class="params">(String tagId, String batchId)</span> &#123;</span><br><span class="line">        <span class="type">CrowdTagsJob</span> <span class="variable">crowdTagsJobReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CrowdTagsJob</span>();</span><br><span class="line">        crowdTagsJobReq.setTagId(tagId);</span><br><span class="line">        crowdTagsJobReq.setBatchId(batchId);</span><br><span class="line"></span><br><span class="line">        <span class="type">CrowdTagsJob</span> <span class="variable">crowdTagsJobRes</span> <span class="operator">=</span> crowdTagsJobDao.queryCrowdTagsJob(crowdTagsJobReq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == crowdTagsJobRes) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CrowdTagsJobEntity.builder()</span><br><span class="line">                .tagType(crowdTagsJobRes.getTagType())</span><br><span class="line">                .tagRule(crowdTagsJobRes.getTagRule())</span><br><span class="line">                .statStartTime(crowdTagsJobRes.getStatStartTime())</span><br><span class="line">                .statEndTime(crowdTagsJobRes.getStatEndTime())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加人群用户ID</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCrowdTagsUserId</span><span class="params">(String tagId, String userId)</span> &#123;</span><br><span class="line">        <span class="type">CrowdTagsDetail</span> <span class="variable">crowdTagsDetailReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CrowdTagsDetail</span>();</span><br><span class="line">        crowdTagsDetailReq.setTagId(tagId);</span><br><span class="line">        crowdTagsDetailReq.setUserId(userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            crowdTagsDetailDao.addCrowdTagsUserId(crowdTagsDetailReq);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException ignore) &#123;</span><br><span class="line">            <span class="comment">// 忽略唯一索引冲突</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取BitSet</span></span><br><span class="line">        <span class="type">RBitSet</span> <span class="variable">bitSet</span> <span class="operator">=</span> redisService.getBitSet(tagId);</span><br><span class="line">        <span class="comment">// 更新BitMap</span></span><br><span class="line">        bitSet.set(redisService.getIndexFromUserId(userId), <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新人群标签标准值</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCrowdTagsStatistics</span><span class="params">(String tagId, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="type">CrowdTags</span> <span class="variable">crowdTagsReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CrowdTags</span>();</span><br><span class="line">        crowdTagsReq.setTagId(tagId);</span><br><span class="line">        crowdTagsReq.setStatistics(count);</span><br><span class="line"></span><br><span class="line">        crowdTagsDao.updateCrowdTagsStatistics(crowdTagsReq);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行完写库后，开始把数据写入到人群标签。</li>
<li>不过注意人群标签的存储<strong>不是字符串</strong>，所以要转行为<strong>长整型</strong>进行存放。</li>
</ul>
<hr>
<h2 id="拆分库表关联关系"><a class="headerlink" href="#拆分库表关联关系"></a>拆分库表关联关系</h2>
<hr>
<p>在系统开始之初，简化功能设计，让拼团活动配置表直接耦合商品<code>ID</code>。也就是一个拼团活动，只关联一个商品<code>ID</code>。那么如果现在需要给10个商品，全配置一个相同的拼团活动，就没法配置了。总不能一个个全配置一遍。所以要对这块的内容做拆分解耦。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503132721407.png" alt="预期目标" loading="lazy"></p>
<ul>
<li><code>group_buy_activity</code> 拼团活动配置表中，融合了渠道和商品<code>ID</code>，属于和活动配置绑定了。</li>
<li><code>sku</code> 商品信息，已经包含了渠道SC值和商品ID。而商品表咱们前面提到过，它是由接入方同步的商品信息，也可以不走这里，直接用 RPC/HTTP 接口查询数据，所以 <code>sku</code> 表不适合绑定互动 <code>ID</code>。</li>
<li>那么，就需要一个新的表来关联活动和商品信息配置，表名为 <code>sc_sku_activity</code> 必备字段：<code>SC</code>渠道、活动<code>ID</code>、商品<code>ID</code>。（自己创建库表后可以和课程的库表对比）</li>
<li>这样可以根据这样的信息来创建你的库表，同时移除 <code>group_buy_activity</code> 表中 <code>SC</code>渠道值和商品<code>ID</code>。</li>
</ul>
<h3 id="1-业务流程-2"><a class="headerlink" href="#1-业务流程-2"></a>1. 业务流程</h3>
<p>整个改动流程的核心为让 <code>MarketNode</code> 节点的查询由原来方式改为先查询 <code>SC</code> 商品活动配置关联表，获得到活动 <code>ID</code>，再查询活动信息。这期间如果有效的活动配置信息无，那么则走到 <code>ErrorNode</code> 节点，返回一个指定的错误码。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503134053649.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，可以先通过如图的调用过程，理解要完成的编程动作。包括解耦后的新的库表关联关系。</li>
<li>之后，编码的时候异步多线程查询商品关联配置，如果配置的信息为空，或者不存在有效的活动，那么可以返回一个 <code>null</code>。当拿到 <code>null</code> 以后，可以做判断进行路由，走到 <code>ErrorNode</code> 节点。</li>
</ul>
<h3 id="2-编码实现-4"><a class="headerlink" href="#2-编码实现-4"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-3"><a class="headerlink" href="#2-1-工程结构-3"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503134654404.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>功能主要以这3个节点进行开发，会涉及到关于数据库映射 <code>PO</code>、<code>Mapper</code> 的字段调整和新的映射关系添加。</li>
<li><code>MarketNode</code> 营销节点查询数据方式调整处理，在 <code>QueryGroupBuyActivityDiscountVOThreadTask</code> 中需要有一个 <code>querySCSkuActivityBySCGoodsId</code> 方法，来查询商品对应的活动配置。</li>
<li><code>ErrorNode</code> 节点，主要处理一些异常兜底的逻辑，比如：查询不到对应的拼团活动配置，那么就要返回对应的错误码。</li>
</ul>
<h4 id="2-2-创建渠道商品活动配置关联表"><a class="headerlink" href="#2-2-创建渠道商品活动配置关联表"></a>2.2 创建渠道商品活动配置关联表</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao.po;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 渠道商品活动配置关联表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SCSkuActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 自增ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/** 渠道 */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="comment">/** 来源 */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    <span class="comment">/** 活动ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long activityId;</span><br><span class="line">    <span class="comment">/** 商品ID */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    <span class="comment">/** 创建时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/** 更新时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-3-修改SC商品渠道DAO"><a class="headerlink" href="#2-3-修改SC商品渠道DAO"></a>2.3 修改SC商品渠道DAO</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;cn.bugstack.infrastructure.dao.ISCSkuActivityDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;dataMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;cn.bugstack.infrastructure.dao.po.SCSkuActivity&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;source&quot;</span> <span class="attr">property</span>=<span class="string">&quot;source&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;channel&quot;</span> <span class="attr">property</span>=<span class="string">&quot;channel&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;activity_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;activityId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;goods_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;goodsId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;create_time&quot;</span> <span class="attr">property</span>=<span class="string">&quot;createTime&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;update_time&quot;</span> <span class="attr">property</span>=<span class="string">&quot;updateTime&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySCSkuActivityBySCGoodsId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;cn.bugstack.infrastructure.dao.po.SCSkuActivity&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;dataMap&quot;</span>&gt;</span></span><br><span class="line">        select source, channel, activity_id, goods_id</span><br><span class="line">        from sc_sku_activity</span><br><span class="line">        where goods_id = #&#123;goodsId&#125; and source = #&#123;source&#125; and channel = #&#123;channel&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>需要配置新的 <code>DAO</code> 方法，查询渠道商品活动 <code>ID</code> 配置信息。</li>
</ul>
<h4 id="2-4-修改查询营销配置"><a class="headerlink" href="#2-4-修改查询营销配置"></a>2.4 修改查询营销配置</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.trial.thread;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 查询营销配置任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryGroupBuyActivityDiscountVOThreadTask</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;GroupBuyActivityDiscountVO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long activityId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 来源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String source;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渠道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String channel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String goodsId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动仓储</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IActivityRepository activityRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QueryGroupBuyActivityDiscountVOThreadTask</span><span class="params">(Long activityId, String source, String channel, String goodsId, IActivityRepository activityRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.activityId = activityId;</span><br><span class="line">        <span class="built_in">this</span>.source = source;</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">        <span class="built_in">this</span>.goodsId = goodsId;</span><br><span class="line">        <span class="built_in">this</span>.activityRepository = activityRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GroupBuyActivityDiscountVO <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 判断是否存在可用的活动ID</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">availableActivityId</span> <span class="operator">=</span> activityId;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过新建的关联表scSkuActivity进行查询</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == activityId)&#123;</span><br><span class="line">            <span class="comment">// 查询渠道商品活动配置关联配置</span></span><br><span class="line">            <span class="type">SCSkuActivityVO</span> <span class="variable">scSkuActivityVO</span> <span class="operator">=</span> activityRepository.querySCSkuActivityBySCGoodsId(source, channel, goodsId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == scSkuActivityVO) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            availableActivityId = scSkuActivityVO.getActivityId();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查询活动配置</span></span><br><span class="line">        <span class="keyword">return</span> activityRepository.queryGroupBuyActivityDiscountVO(availableActivityId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>需要多增加一个查询 <code>querySCSkuActivityBySCGoodsId</code> 的操作，把对应的这个商品配置的活动ID查询出来。</li>
</ul>
<h4 id="2-5-配置营销节点路由"><a class="headerlink" href="#2-5-配置营销节点路由"></a>2.5 配置营销节点路由</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.trial.node;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">    log.info(<span class="string">&quot;拼团商品查询试算服务-MarketNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取上下文数据</span></span><br><span class="line">    <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivityDiscountVO();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyActivityDiscountVO) &#123;</span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line">    GroupBuyActivityDiscountVO.<span class="type">GroupBuyDiscount</span> <span class="variable">groupBuyDiscount</span> <span class="operator">=</span> groupBuyActivityDiscountVO.getGroupBuyDiscount();</span><br><span class="line">    <span class="type">SkuVO</span> <span class="variable">skuVO</span> <span class="operator">=</span> dynamicContext.getSkuVO();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyDiscount || <span class="literal">null</span> == skuVO) &#123;</span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 优惠试算</span></span><br><span class="line">    <span class="type">IDiscountCalculateService</span> <span class="variable">discountCalculateService</span> <span class="operator">=</span> discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan());</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == discountCalculateService) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;不存在&#123;&#125;类型的折扣计算服务，支持类型为:&#123;&#125;&quot;</span>, groupBuyDiscount.getMarketPlan(), JSON.toJSONString(discountCalculateServiceMap.keySet()));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0001.getCode(), ResponseCode.E0001.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 折扣价格</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">deductionPrice</span> <span class="operator">=</span> discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);</span><br><span class="line">    dynamicContext.setDeductionPrice(deductionPrice);</span><br><span class="line">    <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不存在配置的拼团活动，走异常节点</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == dynamicContext.getGroupBuyActivityDiscountVO() || <span class="literal">null</span> == dynamicContext.getSkuVO()) &#123;</span><br><span class="line">        <span class="keyword">return</span> errorNode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> endNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>判断 <code>groupBuyActivityDiscountVO</code>、<code>groupBuyDiscount</code>、<code>skuVO</code> 是否为空。如果为空则直接路由走到兜底节点。</li>
<li>这个兜底节点就是本节新增加的 <code>ErrorNode</code> 节点。</li>
</ul>
<h4 id="2-6-异常兜底节点"><a class="headerlink" href="#2-6-异常兜底节点"></a>2.6  异常兜底节点</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.trial.node;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-NoMarketNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 无营销配置</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == dynamicContext.getGroupBuyActivityDiscountVO() || <span class="literal">null</span> == dynamicContext.getSkuVO()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;商品无拼团营销配置 &#123;&#125;&quot;</span>, requestParameter.getGoodsId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0002.getCode(), ResponseCode.E0002.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TrialBalanceEntity.builder().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultStrategyHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>异常兜底节点可以处理很多异常流程，包括：流程讲解、接口超时等。以及公司中运营配置的活动信息有误，也会走到一个兜底的流程。</li>
</ul>
<hr>
<h2 id="人群标签节点过滤"><a class="headerlink" href="#人群标签节点过滤"></a>人群标签节点过滤</h2>
<hr>
<p>在整个首页营销试算流程中，需要添加一个新的人群标签节点 <code>TagNode</code>，来处理人群过滤的操作。</p>
<p>在这里会看到目前的模型结构设计是非常容易添加出一个新的流程节点，同时对原有的功能不会有破坏性。这样既可以让我们更好的维护代码，也能方便持续的需求迭代。</p>
<h3 id="1-业务流程-3"><a class="headerlink" href="#1-业务流程-3"></a>1. 业务流程</h3>
<p>如图，增加 <code>TagNode</code> 节点，调整节点调用关系</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503150510442.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，添加一个新的 <code>TagNode</code> 节点，调整营销 <code>MarketNode</code> 节点完成业务功能后，流转到新的 <code>TagNode</code> 节点。</li>
<li>之后，在从个 <code>TagNode</code> 节点流转到 <code>EndNode</code> 结束节点。</li>
</ul>
<h3 id="2-编码实现-5"><a class="headerlink" href="#2-编码实现-5"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-4"><a class="headerlink" href="#2-1-工程结构-4"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503154956010.png" alt="工程结构" loading="lazy"></p>
<ul>
<li><code>domain</code> 领域层的 <code>activity</code> 活动领域下，<code>trial</code> 服务下 <code>node</code> 节点中添加 <code>TagNode</code>，之后再从 <code>MarketNode</code> 流转到 <code>TagNode</code></li>
<li><code>TagNode</code> 节点重点<strong>处理人群标签的过滤操作</strong>。</li>
</ul>
<h4 id="2-2-人群过滤"><a class="headerlink" href="#2-2-人群过滤"></a>2.2 人群过滤</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503155328670.png" alt="库表配置" loading="lazy"></p>
<ul>
<li><code>group_buy_activity</code> 表中 <code>tag_scope</code> 中配置1,2 代表需要过滤人群，限制可见性和参与性。比如：这里的配置表示，一个参加活动的用户，如果不再人群范围内，既不允许看见活动，也不允许参与活动。如果只配置2，那么表示通过人群的用户，能看见，但不能参与。</li>
<li>那么我们这里就要做人群过滤限制，就要拿到这个1,2值，之后判断处理。</li>
</ul>
<h4 id="2-3-聚合方法"><a class="headerlink" href="#2-3-聚合方法"></a>2.3 聚合方法</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyActivityDiscountVO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long activityId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String activityName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 来源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渠道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折扣配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> GroupBuyDiscount groupBuyDiscount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团方式（0自动成团、1达成目标拼团）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer groupType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团次数限制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer takeLimitCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团目标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer target;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团时长（分钟）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer validTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动状态（0创建、1生效、2过期、3废弃）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动开始时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动结束时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 人群标签规则标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tagId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 人群标签规则范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tagScope;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可见限制</span></span><br><span class="line"><span class="comment">     * 只要存在这样一个值，那么首次获得的默认值就是 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isVisible</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] split = <span class="built_in">this</span>.tagScope.split(Constants.SPLIT);</span><br><span class="line">        <span class="keyword">if</span> (split.length &gt; <span class="number">0</span> &amp;&amp; Objects.equals(split[<span class="number">0</span>], <span class="string">&quot;1&quot;</span>) &amp;&amp; StringUtils.isNotBlank(split[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参与限制</span></span><br><span class="line"><span class="comment">     * 只要存在这样一个值，那么首次获得的默认值就是 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnable</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] split = <span class="built_in">this</span>.tagScope.split(Constants.SPLIT);</span><br><span class="line">        <span class="keyword">if</span> (split.length == <span class="number">2</span> &amp;&amp; Objects.equals(split[<span class="number">1</span>], <span class="string">&quot;2&quot;</span>) &amp;&amp; StringUtils.isNotBlank(split[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//... 省略部分代码</span></span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>可见限制：方法聚合到到类中，判断是否配置了1。如果配置了，那么默认这个对应的值的结果就是 false，之后在判断是否在人群范围内，如果在人群范围内则为 true。</li>
<li>参与限制：方法聚合到到类中，判断是否配置了2。如果配置了，那么默认这个对应的值的结果就是 false，之后在判断是否在人群范围内，如果在人群范围内则为 true。</li>
</ul>
<h4 id="2-4-TagNode实现"><a class="headerlink" href="#2-4-TagNode实现"></a>2.4 TagNode实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TagNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EndNode endNode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取拼团活动配置</span></span><br><span class="line">        <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivityDiscountVO();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">tagId</span> <span class="operator">=</span> groupBuyActivityDiscountVO.getTagId();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">visible</span> <span class="operator">=</span> groupBuyActivityDiscountVO.isVisible();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">enable</span> <span class="operator">=</span> groupBuyActivityDiscountVO.isEnable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 人群标签配置为空，则走默认值</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tagId)) &#123;</span><br><span class="line">            dynamicContext.setVisible(<span class="literal">true</span>);</span><br><span class="line">            dynamicContext.setEnable(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否在人群范围内：visible、enable 如果值为 ture 则表示没有配置拼团限制，那么就直接保证为 true 即可</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isWithin</span> <span class="operator">=</span> repository.isTagCrowdRange(tagId, requestParameter.getUserId());</span><br><span class="line">        dynamicContext.setVisible(visible || isWithin);</span><br><span class="line">        dynamicContext.setEnable(enable || isWithin);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> endNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，判断 <code>tagId</code> 是否为空，如果为空则访问的可见性和参与性都为 true 即可。</li>
<li>之后，过滤人群标签，<code>isWithin</code> 为用户是否在人群范围内。<code>visible || isWithin</code>、<code>enable || isWithin</code> 只要有一个 true 则可以通过。</li>
</ul>
<hr>
<h2 id="动态配置开关操作"><a class="headerlink" href="#动态配置开关操作"></a>动态配置开关操作</h2>
<hr>
<p>在程序运行过程中，直接动态变更某些属性配置。这些动态变更的配置包括：<strong>降级和切量的开关，也包括一些功能程序的白名单用户测试</strong>。</p>
<p>那么对于配置中心，有 <code>SpringCloud Config</code> + <code>Event Bus</code>，也有 <code>Nacos</code>，还有各个大厂中会基于各类组件做的自研实现。那么我们先来做一个基于 <code>Redis</code> 发布/订阅处理动态配置的自研的实现，之后对于 <code>SpringCloud</code> 的动态配置变更已经有案例</p>
<h3 id="1-业务流程-4"><a class="headerlink" href="#1-业务流程-4"></a>1. 业务流程</h3>
<p>基于 <code>Redis</code> 实现一套动态配置中心 <code>DCC</code> 服务：<code>Dynamic Config Control</code></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503162608718.png" alt="Dynamic Config Control示意图" loading="lazy"></p>
<ul>
<li>注意，这部分会涉及到 <code>Spring</code>源码、<code>Java</code> 动态配置的一些编码操作，属于组件类开发是思想。例如：本部分实现的功能也可以被独立出一个工程组件开发后被业务系统引入使用。</li>
<li>方案，动态配置的处理可以使用 <code>Zookeeper</code> 的节点监听，也可以基于 <code>Redis</code> 的发布/订阅。本部分咱们使用 <code>Redis</code> 这套方案。</li>
</ul>
<h3 id="2-编码实现-6"><a class="headerlink" href="#2-编码实现-6"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-5"><a class="headerlink" href="#2-1-工程结构-5"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250503164450330.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>步骤1：添加一个自定义注解，用于 <code>Spring</code> 扫描 <code>Bean</code> 对象的时候，可以直接管理这些配置了自定义注解的类的属性。</li>
<li>步骤2：给服务类的属性添加自定义注解。</li>
<li>步骤3：由 <code>app</code> 模块下的 <code>config</code>，添加一个动态配置管理的工厂，会自动的完成属性信息的填充和动态变更操作。</li>
<li>步骤4：业务使用，会调用步骤2中的属性服务。当有配置操作变动的时候，则可以把配置信息直接刷新到内存属性上。</li>
<li>步骤5：配置的变更来自于这里，当调用 <code>DCCController</code> 时，会触发 <code>Redis</code> 的发布/订阅，动态值的变更，以此把类上的属性的值做变更。</li>
</ul>
<h4 id="2-2-创建自定义注解"><a class="headerlink" href="#2-2-创建自定义注解"></a>2.2 创建自定义注解</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.annotations;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DCCValue &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-自定义注解的使用"><a class="headerlink" href="#2-3-自定义注解的使用"></a>2.3 自定义注解的使用</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dcc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 动态配置服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DCCService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级开关 0关闭、1开启</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DCCValue(&quot;downgradeSwitch:0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String downgradeSwitch;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DCCValue(&quot;cutRange:100&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cutRange;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDowngradeSwitch</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(downgradeSwitch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCutRange</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 计算哈希码的绝对值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> Math.abs(userId.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取最后两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastTwoDigits</span> <span class="operator">=</span> hashCode % <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否在切量范围内</span></span><br><span class="line">        <span class="keyword">if</span> (lastTwoDigits &lt;= Integer.parseInt(cutRange)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>首先，我们知道在类中的属性配置的值固定的，配置后一直在程序运行中都是一个值。</li>
<li>那么，我们为了可以让程序随着功能的验证，可以动态的调整这些属性的值，就需要引入一些手段，这些手段的目的就是可以动态调整属性值。问：Java 中怎么通过反射来处理属性值的变更。</li>
</ul>
<h4 id="2-4-动态变更属性值"><a class="headerlink" href="#2-4-动态变更属性值"></a>2.4 动态变更属性值</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DCCValueBeanFactory</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_CONFIG_PATH</span> <span class="operator">=</span> <span class="string">&quot;group_buy_market_dcc_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储bean对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; dccObjGroup = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DCCValueBeanFactory</span><span class="params">(RedissonClient redissonClient)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redissonClient = redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redis中发布订阅的一个处理</span></span><br><span class="line">    <span class="comment">// RTopic</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 增加一个bean的信息</span></span><br><span class="line">    <span class="meta">@Bean(&quot;dccTopic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RTopic <span class="title function_">testRedisTopicListener</span><span class="params">(RedissonClient redissonClient)</span> &#123;</span><br><span class="line">        <span class="type">RTopic</span> <span class="variable">topic</span> <span class="operator">=</span> redissonClient.getTopic(<span class="string">&quot;group_buy_market_dcc&quot;</span>);</span><br><span class="line">        topic.addListener(String.class, (charSequence, s) -&gt; &#123;</span><br><span class="line">            String[] split = s.split(Constants.SPLIT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取值</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">attribute</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BASE_CONFIG_PATH + attribute;</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置值</span></span><br><span class="line">            RBucket&lt;String&gt; bucket = redissonClient.getBucket(key);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> bucket.isExists();</span><br><span class="line">            <span class="keyword">if</span> (!exists) <span class="keyword">return</span>;</span><br><span class="line">            bucket.set(value);</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">objBean</span> <span class="operator">=</span> dccObjGroup.get(key);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == objBean) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; objBeanClass = objBean.getClass();</span><br><span class="line">            <span class="comment">// 检查 objBean 是否是代理对象</span></span><br><span class="line">            <span class="keyword">if</span> (AopUtils.isAopProxy(objBean)) &#123;</span><br><span class="line">                <span class="comment">// 获取代理对象的目标对象</span></span><br><span class="line">                objBeanClass = AopUtils.getTargetClass(objBean);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1. getDeclaredField 方法用于获取指定类中声明的所有字段，包括私有字段、受保护字段和公共字段。</span></span><br><span class="line">                <span class="comment">// 2. getField 方法用于获取指定类中的公共字段，即只能获取到公共访问修饰符（public）的字段。</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> objBeanClass.getDeclaredField(attribute);</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                field.set(objBean, value);</span><br><span class="line">                field.setAccessible(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                log.info(<span class="string">&quot;DCC 节点监听，动态设置值 &#123;&#125; &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> topic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注意；增加 AOP 代理后，获得类的方式要通过 AopProxyUtils.getTargetClass(bean); 不能直接 bean.class 因为代理后类的结构发生变化，这样不能获得到自己的自定义注解了。</span></span><br><span class="line">        Class&lt;?&gt; targetBeanClass = bean.getClass();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">targetBeanObject</span> <span class="operator">=</span> bean;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断这个bean对象是AOP的切面对象</span></span><br><span class="line">        <span class="keyword">if</span> (AopUtils.isAopProxy(bean)) &#123;</span><br><span class="line">            targetBeanClass = AopUtils.getTargetClass(bean);</span><br><span class="line">            targetBeanObject = AopProxyUtils.getSingletonTarget(bean);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field[] fields = targetBeanClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!field.isAnnotationPresent(DCCValue.class)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取DCC注解对象</span></span><br><span class="line">            <span class="type">DCCValue</span> <span class="variable">dccValue</span> <span class="operator">=</span> field.getAnnotation(DCCValue.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> dccValue.value();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(value)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(field.getName() + <span class="string">&quot; @DCCValue is not config value config case 「isSwitch/isSwitch:1」&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String[] splits = value.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="comment">// 进行&quot;group_buy_market_dcc_&quot;的拼接</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BASE_CONFIG_PATH.concat(splits[<span class="number">0</span>]);</span><br><span class="line">            <span class="type">String</span> <span class="variable">defaultValue</span> <span class="operator">=</span> splits.length == <span class="number">2</span> ? splits[<span class="number">1</span>] : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置值</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">setValue</span> <span class="operator">=</span> defaultValue;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 如果为空则抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isBlank(defaultValue)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;dcc config error &quot;</span> + key + <span class="string">&quot; is not null - 请配置默认值！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Redis 操作，判断配置Key是否存在，不存在则创建，存在则获取最新值</span></span><br><span class="line">                RBucket&lt;String&gt; bucket = redissonClient.getBucket(key);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> bucket.isExists();</span><br><span class="line">                <span class="keyword">if</span> (!exists) &#123;</span><br><span class="line">                    bucket.set(defaultValue);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    setValue = bucket.get();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// field.setAccessible(true)：是 Java 反射（Reflection）中的一个操作，用于绕过访问权限检查，允许程序访问或修改原本不可直接访问的字段（如 private、protected 或包级私有的字段）</span></span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                field.set(targetBeanObject, setValue);</span><br><span class="line">                field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dccObjGroup.put(key, targetBeanObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>DCCValueBeanFactory</code> 实现了 <code>BeanPostProcessor</code>，这样我们就可以拿到 <code>Spring</code> 所有实例化后的 <code>Bean</code> 对象。<code>Spring</code> 是扫描你所工程下所有的 <code>Bean</code> 对象，加载到它的容器里管理。</li>
<li><code>postProcessAfterInitialization</code> 扫描所有的 <code>Bean</code> 对象，之后检查哪个类的属性加有 <code>@DCCValue</code> 注解，检测到后进行管理操作。</li>
<li><code>@DCCValue(&quot;downgradeSwitch:0&quot;)</code> 解析自定义注解配置值，一个是<code>key</code>，一个是默认的值。之后会从 <code>redis</code> 获取值，如果没有则走默认值。</li>
<li><code>testRedisTopicListener</code> 是一个监听 <code>redis</code> 发布/订阅消息的处理，之后动态设置 <code>Redis</code> 值，完事后更新类中 <code>Redis</code> 的属性值。</li>
</ul>
<h4 id="2-5-DCC-动态配置中心接口"><a class="headerlink" href="#2-5-DCC-动态配置中心接口"></a>2.5 DCC 动态配置中心接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.api;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> DCC 动态配置中心，就是controller实现的接口类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IDCCService</span> &#123;</span><br><span class="line"></span><br><span class="line">    Response&lt;Boolean&gt; <span class="title function_">updateConfig</span><span class="params">(String key, String value)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-5-实现对应的接口"><a class="headerlink" href="#2-5-实现对应的接口"></a>2.5 实现对应的接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.trigger.http;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 动态配置管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// @CrossOrigin(&quot;*&quot;)：跨域的注解</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController()</span></span><br><span class="line"><span class="meta">@CrossOrigin(&quot;*&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/gbm/dcc/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DCCController</span> <span class="keyword">implements</span> <span class="title class_">IDCCService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RTopic dccTopic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态值变更</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * curl http://127.0.0.1:8091/api/v1/gbm/dcc/update_config?key=downgradeSwitch&amp;value=1</span></span><br><span class="line"><span class="comment">     * curl http://127.0.0.1:8091/api/v1/gbm/dcc/update_config?key=cutRange&amp;value=0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;update_config&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;Boolean&gt; <span class="title function_">updateConfig</span><span class="params">(<span class="meta">@RequestParam</span> String key, <span class="meta">@RequestParam</span> String value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;DCC 动态配置值变更 key:&#123;&#125; value:&#123;&#125;&quot;</span>, key, value);</span><br><span class="line">            dccTopic.publish(key + <span class="string">&quot;,&quot;</span> + value);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;Boolean&gt;builder()</span><br><span class="line">                    .code(ResponseCode.SUCCESS.getCode())</span><br><span class="line">                    .info(ResponseCode.SUCCESS.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;DCC 动态配置值变更失败 key:&#123;&#125; value:&#123;&#125;&quot;</span>, key, value, e);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;Boolean&gt;builder()</span><br><span class="line">                    .code(ResponseCode.UN_ERROR.getCode())</span><br><span class="line">                    .info(ResponseCode.UN_ERROR.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-开关节点使用"><a class="headerlink" href="#2-6-开关节点使用"></a>2.6 开关节点使用</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.trial.node;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwitchNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MarketNode marketNode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-SwitchNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据用户ID切量</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> requestParameter.getUserId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否降级</span></span><br><span class="line">        <span class="keyword">if</span> (repository.downgradeSwitch()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;拼团活动降级拦截 &#123;&#125;&quot;</span>, userId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0003.getCode(), ResponseCode.E0003.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 切量范围判断</span></span><br><span class="line">        <span class="keyword">if</span> (!repository.cutRange(userId)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;拼团活动切量拦截 &#123;&#125;&quot;</span>, userId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> marketNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进入开关节点，通过仓储 <code>repository</code> 获取对应的值。</li>
<li><code>repository.downgradeSwitch()</code> 判断是否降级。</li>
<li><code>repository.cutRange(userId)</code> 通过用户ID的哈希值最后2位，判断是否在100范围内，以此做切量处理。</li>
</ul>
<hr>
<h2 id="拼团交易营销锁单"><a class="headerlink" href="#拼团交易营销锁单"></a>拼团交易营销锁单</h2>
<hr>
<p>当商城类系统接入拼团时，则需要在下单过程中使用一笔营销优惠。这里的营销优惠可以为：无券平台营销、有券消费营销、拼团折扣营销、积分抵扣营销等。</p>
<p>那么，当商城类系统接入使用下单时，则需要到拼团系统锁定一笔优惠，也就是占用一个名额。完事后，商城类系统继续操作支付交易的过程。</p>
<h3 id="1-业务流程-5"><a class="headerlink" href="#1-业务流程-5"></a>1. 业务流程</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504115635083.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，团购的商品下单。下单过程分为创建流水单、锁定营销优惠（拼团、积分、券）、创建支付订单、唤起收银台支付、用户扫码支付、支付完成核销优惠等。</li>
<li>那么，这里用户以拼团方式下单，创建流水单完成后，需要与拼团系统交互，锁定营销优惠。更新流水单优惠金额和支付金额。接下来就可以创建支付单了（支付单需要最终的支付金额）。</li>
<li>注意：拼团表 <code>group_buy_order</code> 除了有目标量（<code>target_count</code>）、完成量（<code>complete</code>），还要有一个锁单量（<code>lock_count</code>），当锁单量达到目标量后，用户在此组织下，不能在参与拼团。直至这些用户支付完成达成拼团或者锁单超时回退支付营销，空出可参与锁单量，这样其他用户可以继续参与。</li>
</ul>
<h4 id="1-1-工程结构"><a class="headerlink" href="#1-1-工程结构"></a>1.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504115853735.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>步骤1：添加数据库 <code>DAO</code> 配置，拼团订单、拼团明细操作。之后交给 <code>repository</code> 仓储使用。</li>
<li>步骤2：<code>domain</code> 领域层实现交易订单服务，创建拼团锁单操作，以及查询。</li>
<li>步骤3：<code>trigger</code> 层提供拼团交易接口服务，这里会串联 <code>activity</code>、<code>trade</code> 两个领域服务。目前的 <code>trigger</code> 替代了一部分 <code>case</code> 层的编排操作，如果是较大规模的系统，则可以单独提供一个 <code>case</code> 层。</li>
</ul>
<h4 id="1-2-库表更新"><a class="headerlink" href="#1-2-库表更新"></a>1.2 库表更新</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504120050408.png" alt="库表更新" loading="lazy"></p>
<ul>
<li>首先，新增加两张表：<code>group_buy_order</code>、<code>group_buy_order_list</code>。</li>
<li>注意：库表设计中，添加了 <code>team_id</code>、<code>lock_count</code>（锁单量），以及做了细化的处理。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_buy_order` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增ID&#x27;</span>,</span><br><span class="line">  `team_id` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;拼单组队ID&#x27;</span>,</span><br><span class="line">  `activity_id` <span class="type">bigint</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动ID&#x27;</span>,</span><br><span class="line">  `source` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;渠道&#x27;</span>,</span><br><span class="line">  `channel` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;来源&#x27;</span>,</span><br><span class="line">  `original_price` <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;原始价格&#x27;</span>,</span><br><span class="line">  `deduction_price` <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣金额&#x27;</span>,</span><br><span class="line">  `pay_price` <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付价格&#x27;</span>,</span><br><span class="line">  `target_count` <span class="type">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;目标数量&#x27;</span>,</span><br><span class="line">  `complete_count` <span class="type">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;完成数量&#x27;</span>,</span><br><span class="line">  `lock_count` <span class="type">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;锁单数量&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态（0-拼单中、1-完成、2-失败）&#x27;</span>,</span><br><span class="line">  `valid_start_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;拼团开始时间&#x27;</span>,</span><br><span class="line">  `valid_end_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;拼团结束时间&#x27;</span>,</span><br><span class="line">  `notify_type` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;HTTP&#x27;</span> COMMENT <span class="string">&#x27;回调类型（HTTP、MQ）&#x27;</span>,</span><br><span class="line">  `notify_url` <span class="type">varchar</span>(<span class="number">512</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调地址（HTTP 回调不可为空）&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uq_team_id` (`team_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_buy_order_list` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `team_id` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;拼单组队ID&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">  `activity_id` <span class="type">bigint</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动ID&#x27;</span>,</span><br><span class="line">  `start_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动开始时间&#x27;</span>,</span><br><span class="line">  `end_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动结束时间&#x27;</span>,</span><br><span class="line">  `goods_id` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">  `source` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;渠道&#x27;</span>,</span><br><span class="line">  `channel` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;来源&#x27;</span>,</span><br><span class="line">  `original_price` <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;原始价格&#x27;</span>,</span><br><span class="line">  `deduction_price` <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;折扣金额&#x27;</span>,</span><br><span class="line">  `pay_price` <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付金额&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态；0初始锁定、1消费完成、2用户退单&#x27;</span>,</span><br><span class="line">  `out_trade_no` <span class="type">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;外部交易单号-确保外部调用唯一幂等&#x27;</span>,</span><br><span class="line">  `out_trade_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;外部交易时间&#x27;</span>,</span><br><span class="line">  `biz_id` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;业务唯一ID&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uq_order_id` (`order_id`),</span><br><span class="line">  KEY `idx_user_id_activity_id` (`user_id`,`activity_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<h3 id="2-编码实现-7"><a class="headerlink" href="#2-编码实现-7"></a>2. 编码实现</h3>
<h4 id="2-1-基础实现"><a class="headerlink" href="#2-1-基础实现"></a>2.1 基础实现</h4>
<p><strong>增加数据库的对象</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao.po;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 用户拼单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyOrder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 自增ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/** 拼单组队ID */</span></span><br><span class="line">    <span class="keyword">private</span> String teamId;</span><br><span class="line">    <span class="comment">/** 活动ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long activityId;</span><br><span class="line">    <span class="comment">/** 渠道 */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="comment">/** 来源 */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    <span class="comment">/** 原始价格 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal originalPrice;</span><br><span class="line">    <span class="comment">/** 折扣金额 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal deductionPrice;</span><br><span class="line">    <span class="comment">/** 支付价格 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line">    <span class="comment">/** 目标数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer targetCount;</span><br><span class="line">    <span class="comment">/** 完成数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer completeCount;</span><br><span class="line">    <span class="comment">/** 锁单数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer lockCount;</span><br><span class="line">    <span class="comment">/** 状态（0-拼单中、1-完成、2-失败） */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">/** 拼团开始时间 - 参与拼团时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date validStartTime;</span><br><span class="line">    <span class="comment">/** 拼团结束时间 - 拼团有效时长 */</span></span><br><span class="line">    <span class="keyword">private</span> Date validEndTime;</span><br><span class="line">    <span class="comment">/** 回调类型 HTTP、MQ */</span></span><br><span class="line">    <span class="keyword">private</span> String notifyType;</span><br><span class="line">    <span class="comment">/** 回调通知（HTTP 方式回调，地址不可为空） */</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;</span><br><span class="line">    <span class="comment">/** 创建时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/** 更新时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao.po;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 用户拼单明细</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyOrderList</span> <span class="keyword">extends</span> <span class="title class_">Page</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 自增ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/** 用户ID */</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="comment">/** 拼单组队ID */</span></span><br><span class="line">    <span class="keyword">private</span> String teamId;</span><br><span class="line">    <span class="comment">/** 订单ID */</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">/** 活动ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long activityId;</span><br><span class="line">    <span class="comment">/** 活动开始时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line">    <span class="comment">/** 活动结束时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    <span class="comment">/** 商品ID */</span></span><br><span class="line">    <span class="keyword">private</span> String goodsId;</span><br><span class="line">    <span class="comment">/** 渠道 */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="comment">/** 来源 */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    <span class="comment">/** 原始价格 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal originalPrice;</span><br><span class="line">    <span class="comment">/** 折扣金额 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal deductionPrice;</span><br><span class="line">    <span class="comment">/** 支付金额 */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line">    <span class="comment">/** 状态；0初始锁定、1消费完成 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">/** 外部交易单号-确保外部调用唯一幂等 */</span></span><br><span class="line">    <span class="keyword">private</span> String outTradeNo;</span><br><span class="line">    <span class="comment">/** 外部交易时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date outTradeTime;</span><br><span class="line">    <span class="comment">/** 唯一业务ID */</span></span><br><span class="line">    <span class="keyword">private</span> String bizId;</span><br><span class="line">    <span class="comment">/** 创建时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/** 更新时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>增加这两个对象的方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IGroupBuyOrderDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(GroupBuyOrder groupBuyOrder)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateAddLockCount</span><span class="params">(String teamId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateSubtractionLockCount</span><span class="params">(String teamId)</span>;</span><br><span class="line"></span><br><span class="line">    GroupBuyOrder <span class="title function_">queryGroupBuyProgress</span><span class="params">(String teamId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.dao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IGroupBuyOrderListDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(GroupBuyOrderList groupBuyOrderListReq)</span>;</span><br><span class="line"></span><br><span class="line">    GroupBuyOrderList <span class="title function_">queryGroupBuyOrderRecordByOutTradeNo</span><span class="params">(GroupBuyOrderList groupBuyOrderListReq)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给2个新表提供新的 <code>DAO</code> 操作：</p>
<ul>
<li><code>IGroupBuyOrderDao</code>：插入数据、更新锁单量、查询进度</li>
<li><code>IGroupBuyOrderListDao</code>：插入拼单明细、查询交易记录</li>
</ul>
<h4 id="2-2-交易订单"><a class="headerlink" href="#2-2-交易订单"></a>2.2 交易订单</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeOrderService</span> <span class="keyword">implements</span> <span class="title class_">ITradeOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayOrderEntity <span class="title function_">queryNoPayMarketPayOrderByOutTradeNo</span><span class="params">(String userId, String outTradeNo)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-查询未支付营销订单:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, userId, outTradeNo);</span><br><span class="line">        <span class="comment">// 查询未支付营销订单</span></span><br><span class="line">        <span class="keyword">return</span> repository.queryMarketPayOrderEntityByOutTradeNo(userId, outTradeNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GroupBuyProgressVO <span class="title function_">queryGroupBuyProgress</span><span class="params">(String teamId)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-查询拼单进度:&#123;&#125;&quot;</span>, teamId);</span><br><span class="line">        <span class="comment">// 查询拼单进度</span></span><br><span class="line">        <span class="keyword">return</span> repository.queryGroupBuyProgress(teamId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayOrderEntity <span class="title function_">lockMarketPayOrder</span><span class="params">(UserEntity userEntity, PayActivityEntity payActivityEntity, PayDiscountEntity payDiscountEntity)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-锁定营销优惠支付订单:&#123;&#125; activityId:&#123;&#125; goodsId:&#123;&#125;&quot;</span>, userEntity.getUserId(), payActivityEntity.getActivityId(), payDiscountEntity.getGoodsId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建聚合对象</span></span><br><span class="line">        <span class="type">GroupBuyOrderAggregate</span> <span class="variable">groupBuyOrderAggregate</span> <span class="operator">=</span> GroupBuyOrderAggregate.builder()</span><br><span class="line">                .userEntity(userEntity)</span><br><span class="line">                .payActivityEntity(payActivityEntity)</span><br><span class="line">                .payDiscountEntity(payDiscountEntity)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 锁定聚合订单 - 这会用户只是下单还没有支付。后续会有2个流程；支付成功、超时未支付（回退）</span></span><br><span class="line">        <span class="comment">// 锁定营销优惠支付订单</span></span><br><span class="line">        <span class="keyword">return</span> repository.lockMarketPayOrder(groupBuyOrderAggregate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在交易订单中提供查询，包括：未支付营销订单、查询拼单进度和锁定营销优惠支付订单。</li>
<li>在 <code>lockMarketPayOrder</code> 有数据库事务操作。</li>
</ul>
<h4 id="2-3-实现ITradeRepository的接口方法"><a class="headerlink" href="#2-3-实现ITradeRepository的接口方法"></a>2.3 实现ITradeRepository的接口方法</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 交易仓储服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderDao groupBuyOrderDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderListDao groupBuyOrderListDao;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查询未支付营销订单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayOrderEntity <span class="title function_">queryMarketPayOrderEntityByOutTradeNo</span><span class="params">(String userId, String outTradeNo)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupBuyOrderList</span>();</span><br><span class="line">        groupBuyOrderListReq.setUserId(userId);</span><br><span class="line">        groupBuyOrderListReq.setOutTradeNo(outTradeNo);</span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListRes</span> <span class="operator">=</span> groupBuyOrderListDao.queryGroupBuyOrderRecordByOutTradeNo(groupBuyOrderListReq);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrderListRes) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MarketPayOrderEntity.builder()</span><br><span class="line">                .teamId(groupBuyOrderListRes.getTeamId())</span><br><span class="line">                .orderId(groupBuyOrderListRes.getOrderId())</span><br><span class="line">                .originalPrice(groupBuyOrderListRes.getOriginalPrice())</span><br><span class="line">                .deductionPrice(groupBuyOrderListRes.getDeductionPrice())</span><br><span class="line">                .payPrice(groupBuyOrderListRes.getPayPrice())</span><br><span class="line">                .tradeOrderStatusEnumVO(TradeOrderStatusEnumVO.valueOf(groupBuyOrderListRes.getStatus()))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 锁定营销优惠支付订单</span></span><br><span class="line">    <span class="meta">@Transactional(timeout = 500)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayOrderEntity <span class="title function_">lockMarketPayOrder</span><span class="params">(GroupBuyOrderAggregate groupBuyOrderAggregate)</span> &#123;</span><br><span class="line">        <span class="comment">// 聚合对象信息</span></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getUserEntity();</span><br><span class="line">        <span class="type">PayActivityEntity</span> <span class="variable">payActivityEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getPayActivityEntity();</span><br><span class="line">        <span class="type">PayDiscountEntity</span> <span class="variable">payDiscountEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getPayDiscountEntity();</span><br><span class="line">        <span class="type">NotifyConfigVO</span> <span class="variable">notifyConfigVO</span> <span class="operator">=</span> payDiscountEntity.getNotifyConfigVO();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userTakeOrderCount</span> <span class="operator">=</span> groupBuyOrderAggregate.getUserTakeOrderCount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否有团 - teamId 为空 - 新团、为不空 - 老团</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> payActivityEntity.getTeamId();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(teamId)) &#123;</span><br><span class="line">            <span class="comment">// 使用 RandomStringUtils.randomNumeric 替代公司里使用的雪花算法UUID</span></span><br><span class="line">            teamId = RandomStringUtils.randomNumeric(<span class="number">8</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 日期处理</span></span><br><span class="line">            <span class="type">Date</span> <span class="variable">currentDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            calendar.setTime(currentDate);</span><br><span class="line">            calendar.add(Calendar.MINUTE, payActivityEntity.getValidTime());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建拼团订单</span></span><br><span class="line">            <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> GroupBuyOrder.builder()</span><br><span class="line">                    .teamId(teamId)</span><br><span class="line">                    .activityId(payActivityEntity.getActivityId())</span><br><span class="line">                    .source(payDiscountEntity.getSource())</span><br><span class="line">                    .channel(payDiscountEntity.getChannel())</span><br><span class="line">                    .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                    .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                    .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                    .targetCount(payActivityEntity.getTargetCount())</span><br><span class="line">                <span class="comment">// 完成数量为0</span></span><br><span class="line">                    .completeCount(<span class="number">0</span>)</span><br><span class="line">                <span class="comment">// 锁单数量为1</span></span><br><span class="line">                    .lockCount(<span class="number">1</span>)</span><br><span class="line">                    .validStartTime(currentDate)</span><br><span class="line">                    .validEndTime(calendar.getTime())</span><br><span class="line">                    .notifyType(notifyConfigVO.getNotifyType().getCode())</span><br><span class="line">                    .notifyUrl(notifyConfigVO.getNotifyUrl())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入记录</span></span><br><span class="line">            groupBuyOrderDao.insert(groupBuyOrder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新记录 - 如果更新记录不等于1，则表示拼团已满，抛出异常</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">updateAddTargetCount</span> <span class="operator">=</span> groupBuyOrderDao.updateAddLockCount(teamId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> != updateAddTargetCount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0005);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 RandomStringUtils.randomNumeric 替代公司里使用的雪花算法UUID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> RandomStringUtils.randomNumeric(<span class="number">12</span>);</span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> GroupBuyOrderList.builder()</span><br><span class="line">                .userId(userEntity.getUserId())</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .orderId(orderId)</span><br><span class="line">                .activityId(payActivityEntity.getActivityId())</span><br><span class="line">                .startTime(payActivityEntity.getStartTime())</span><br><span class="line">                .endTime(payActivityEntity.getEndTime())</span><br><span class="line">                .goodsId(payDiscountEntity.getGoodsId())</span><br><span class="line">                .source(payDiscountEntity.getSource())</span><br><span class="line">                .channel(payDiscountEntity.getChannel())</span><br><span class="line">                .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                .status(TradeOrderStatusEnumVO.CREATE.getCode())</span><br><span class="line">                .outTradeNo(payDiscountEntity.getOutTradeNo())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 写入拼团记录</span></span><br><span class="line">            groupBuyOrderListDao.insert(groupBuyOrderListReq);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.INDEX_EXCEPTION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MarketPayOrderEntity.builder()</span><br><span class="line">                .orderId(orderId)</span><br><span class="line">                .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                .tradeOrderStatusEnumVO(TradeOrderStatusEnumVO.CREATE)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询拼单进度</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GroupBuyProgressVO <span class="title function_">queryGroupBuyProgress</span><span class="params">(String teamId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> groupBuyOrderDao.queryGroupBuyProgress(teamId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrder) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> GroupBuyProgressVO.builder()</span><br><span class="line">                .completeCount(groupBuyOrder.getCompleteCount())</span><br><span class="line">                .targetCount(groupBuyOrder.getTargetCount())</span><br><span class="line">                .lockCount(groupBuyOrder.getLockCount())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>group_buy_order</code>、<code>group_buy_order_list</code>，两个库表一个写入记录，一个更新记录。需要在一个事务中完成操作。</li>
</ul>
<h4 id="2-4-服务接口的实现"><a class="headerlink" href="#2-4-服务接口的实现"></a>2.4 服务接口的实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.api;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 营销交易服务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IMarketTradeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 营销锁单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestDTO 锁单商品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 锁单结果信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Response&lt;LockMarketPayOrderResponseDTO&gt; <span class="title function_">lockMarketPayOrder</span><span class="params">(LockMarketPayOrderRequestDTO requestDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 营销结算</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestDTO 结算商品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结算结果信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Response&lt;SettlementMarketPayOrderResponseDTO&gt; <span class="title function_">settlementMarketPayOrder</span><span class="params">(SettlementMarketPayOrderRequestDTO requestDTO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.trigger.http;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 营销交易服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController()</span></span><br><span class="line"><span class="meta">@CrossOrigin(&quot;*&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/gbm/trade/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketTradeController</span> <span class="keyword">implements</span> <span class="title class_">IMarketTradeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IIndexGroupBuyMarketService indexGroupBuyMarketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeOrderService tradeOrderService;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼团营销锁单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;lock_market_pay_order&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;LockMarketPayOrderResponseDTO&gt; <span class="title function_">lockMarketPayOrder</span><span class="params">(LockMarketPayOrderRequestDTO lockMarketPayOrderRequestDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 参数</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getUserId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getSource();</span><br><span class="line">            <span class="type">String</span> <span class="variable">channel</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getChannel();</span><br><span class="line">            <span class="type">String</span> <span class="variable">goodsId</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getGoodsId();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">activityId</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getActivityId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">outTradeNo</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getOutTradeNo();</span><br><span class="line">            <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> lockMarketPayOrderRequestDTO.getTeamId();</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;营销交易锁单:&#123;&#125; LockMarketPayOrderRequestDTO:&#123;&#125;&quot;</span>, userId, JSON.toJSONString(lockMarketPayOrderRequestDTO));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(userId) || StringUtils.isBlank(source) || StringUtils.isBlank(channel) || StringUtils.isBlank(goodsId) || StringUtils.isBlank(goodsId) || <span class="literal">null</span> == activityId) &#123;</span><br><span class="line">                <span class="keyword">return</span> Response.&lt;LockMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                        .code(ResponseCode.ILLEGAL_PARAMETER.getCode())</span><br><span class="line">                        .info(ResponseCode.ILLEGAL_PARAMETER.getInfo())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询 outTradeNo 是否已经存在交易记录</span></span><br><span class="line">            <span class="type">MarketPayOrderEntity</span> <span class="variable">marketPayOrderEntity</span> <span class="operator">=</span> tradeOrderService.queryNoPayMarketPayOrderByOutTradeNo(userId, outTradeNo);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != marketPayOrderEntity) &#123;</span><br><span class="line">                <span class="type">LockMarketPayOrderResponseDTO</span> <span class="variable">lockMarketPayOrderResponseDTO</span> <span class="operator">=</span> LockMarketPayOrderResponseDTO.builder()</span><br><span class="line">                        .orderId(marketPayOrderEntity.getOrderId())</span><br><span class="line">                        .deductionPrice(marketPayOrderEntity.getDeductionPrice())</span><br><span class="line">                        .tradeOrderStatus(marketPayOrderEntity.getTradeOrderStatusEnumVO().getCode())</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">                log.info(<span class="string">&quot;交易锁单记录(存在):&#123;&#125; marketPayOrderEntity:&#123;&#125;&quot;</span>, userId, JSON.toJSONString(marketPayOrderEntity));</span><br><span class="line">                <span class="keyword">return</span> Response.&lt;LockMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                        .code(ResponseCode.SUCCESS.getCode())</span><br><span class="line">                        .info(ResponseCode.SUCCESS.getInfo())</span><br><span class="line">                        .data(lockMarketPayOrderResponseDTO)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断拼团是否完成了目标</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != teamId) &#123;</span><br><span class="line">                <span class="type">GroupBuyProgressVO</span> <span class="variable">groupBuyProgressVO</span> <span class="operator">=</span> tradeOrderService.queryGroupBuyProgress(teamId);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != groupBuyProgressVO &amp;&amp; Objects.equals(groupBuyProgressVO.getTargetCount(), groupBuyProgressVO.getLockCount())) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;交易锁单拦截-拼单目标已达成:&#123;&#125; &#123;&#125;&quot;</span>, userId, teamId);</span><br><span class="line">                    <span class="keyword">return</span> Response.&lt;LockMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                            .code(ResponseCode.E0006.getCode())</span><br><span class="line">                            .info(ResponseCode.E0006.getInfo())</span><br><span class="line">                            .build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 营销优惠试算</span></span><br><span class="line">            <span class="type">TrialBalanceEntity</span> <span class="variable">trialBalanceEntity</span> <span class="operator">=</span> indexGroupBuyMarketService.indexMarketTrial(MarketProductEntity.builder()</span><br><span class="line">                    .userId(userId)</span><br><span class="line">                    .source(source)</span><br><span class="line">                    .channel(channel)</span><br><span class="line">                    .goodsId(goodsId)</span><br><span class="line">                    .activityId(activityId)</span><br><span class="line">                    .build());</span><br><span class="line"></span><br><span class="line">            <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> trialBalanceEntity.getGroupBuyActivityDiscountVO();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 锁单</span></span><br><span class="line">            marketPayOrderEntity = tradeOrderService.lockMarketPayOrder(</span><br><span class="line">                    UserEntity.builder().userId(userId).build(),</span><br><span class="line">                    PayActivityEntity.builder()</span><br><span class="line">                            .teamId(teamId)</span><br><span class="line">                            .activityId(activityId)</span><br><span class="line">                            .activityName(groupBuyActivityDiscountVO.getActivityName())</span><br><span class="line">                            .startTime(groupBuyActivityDiscountVO.getStartTime())</span><br><span class="line">                            .endTime(groupBuyActivityDiscountVO.getEndTime())</span><br><span class="line">                            .targetCount(groupBuyActivityDiscountVO.getTarget())</span><br><span class="line">                            .build(),</span><br><span class="line">                    PayDiscountEntity.builder()</span><br><span class="line">                            .source(source)</span><br><span class="line">                            .channel(channel)</span><br><span class="line">                            .goodsId(goodsId)</span><br><span class="line">                            .goodsName(trialBalanceEntity.getGoodsName())</span><br><span class="line">                            .originalPrice(trialBalanceEntity.getOriginalPrice())</span><br><span class="line">                            .deductionPrice(trialBalanceEntity.getDeductionPrice())</span><br><span class="line">                            .outTradeNo(outTradeNo)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;交易锁单记录(新):&#123;&#125; marketPayOrderEntity:&#123;&#125;&quot;</span>, userId, JSON.toJSONString(marketPayOrderEntity));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回结果</span></span><br><span class="line">            <span class="keyword">return</span> Response.&lt;LockMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                    .code(ResponseCode.SUCCESS.getCode())</span><br><span class="line">                    .info(ResponseCode.SUCCESS.getInfo())</span><br><span class="line">                    .data(LockMarketPayOrderResponseDTO.builder()</span><br><span class="line">                            .orderId(marketPayOrderEntity.getOrderId())</span><br><span class="line">                            .deductionPrice(marketPayOrderEntity.getDeductionPrice())</span><br><span class="line">                            .tradeOrderStatus(marketPayOrderEntity.getTradeOrderStatusEnumVO().getCode())</span><br><span class="line">                            .build())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AppException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;营销交易锁单业务异常:&#123;&#125; LockMarketPayOrderRequestDTO:&#123;&#125;&quot;</span>, lockMarketPayOrderRequestDTO.getUserId(), JSON.toJSONString(lockMarketPayOrderRequestDTO), e);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;LockMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                    .code(e.getCode())</span><br><span class="line">                    .info(e.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;营销交易锁单服务失败:&#123;&#125; LockMarketPayOrderRequestDTO:&#123;&#125;&quot;</span>, lockMarketPayOrderRequestDTO.getUserId(), JSON.toJSONString(lockMarketPayOrderRequestDTO), e);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;LockMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                    .code(ResponseCode.UN_ERROR.getCode())</span><br><span class="line">                    .info(ResponseCode.UN_ERROR.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，<strong>需要查询外部交易 <code>outTradeNo</code> 是否存在交易记录</strong>。如果存在未完成的订单，直接返回结果即可。这个是幂等的一个防护。如果不查询，最终也是会有数据库唯一索引拦截。</li>
<li>之后，<strong>判断拼团锁单是否完成目标量</strong>，如果已经完成了目标量则直接直接返回，让用户不能参与当前拼团。一般在并发情况下，如果多人选择一个拼团，那么查询拼团量可以有效拦截。如果没有拦截，最终访问数据，也会有数量判断拦截。注意这里会有数据库表的行级锁，如果 <code>TPS</code> 量大，那么则需要加入 <code>redis</code> 操作库存量。</li>
<li>之后，<strong>开始做营销优惠试算</strong>。判断当前商品在拼团下应该优惠多少。确认完优惠后，开始锁单。最终返回给用户到界面展示，用户确认了支付所用到的营销优惠，那么在点击确认支付跳转收银台扫码支付即可。</li>
</ul>
<hr>
<h2 id="责任链抽象模板设计"><a class="headerlink" href="#责任链抽象模板设计"></a>责任链抽象模板设计</h2>
<hr>
<h3 id="1-模型设计-3"><a class="headerlink" href="#1-模型设计-3"></a>1. 模型设计</h3>
<p>责任链是一种简单的单链路结构，在工程中会有多个这样的单链，为了可以让不同的场景都能创建出自己的链，则需要解耦责任链的链路和执行，再有执行器处理。设计如图：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504172418423.png" alt="责任链结构图" loading="lazy"></p>
<ul>
<li>如图，这是一种多实例对象责任链的设计结构，会使用到如 <code>Java JDK</code> 源码中 <code>Link</code> 的方式填写链路，之后再有业务链路处理链路执行。而每一个链路都会被填充一个逻辑处理器的实现类（<code>ILogicHandler</code>）来处理具体的业务。</li>
<li>那么，这样就很好的扩展了各种链路的使用诉求。</li>
</ul>
<h3 id="2-编码实现-8"><a class="headerlink" href="#2-编码实现-8"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-6"><a class="headerlink" href="#2-1-工程结构-6"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504172948404.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>在 <code>types</code> → <code>design</code>，提供 <code>link</code> 责任链。<code>model1</code>、<code>model2</code></li>
<li><code>model1</code>：是通用的单例链，本身抽象类既可添加链路节点，又能做链路过程执行处理。</li>
<li><code>model2</code>：拆分了责任链和执行处理器，并由 <code>LinkArmory</code> 进行装配。这样就可以填充多例链。</li>
</ul>
<h4 id="2-2-单例链路"><a class="headerlink" href="#2-2-单例链路"></a>2.2 单例链路</h4>
<h5 id="2-2-1-ILogicChainArmory"><a class="headerlink" href="#2-2-1-ILogicChainArmory"></a>2.2.1 ILogicChainArmory</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 责任链装配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILogicChainArmory</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ILogicLink&lt;T, D, R&gt; <span class="title function_">next</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ILogicLink&lt;T, D, R&gt; <span class="title function_">appendNext</span><span class="params">(ILogicLink&lt;T, D, R&gt; next)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-2-ILogicLink"><a class="headerlink" href="#2-2-2-ILogicLink"></a>2.2.2 ILogicLink</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 略规则责任链接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILogicLink</span>&lt;T, D, R&gt; <span class="keyword">extends</span> <span class="title class_">ILogicChainArmory</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-AbstractLogicLink"><a class="headerlink" href="#2-2-3-AbstractLogicLink"></a>2.2.3 AbstractLogicLink</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractLogicLink</span>&lt;T, D, R&gt; <span class="keyword">implements</span> <span class="title class_">ILogicLink</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ILogicLink&lt;T, D, R&gt; next;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ILogicLink&lt;T, D, R&gt; <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ILogicLink&lt;T, D, R&gt; <span class="title function_">appendNext</span><span class="params">(ILogicLink&lt;T, D, R&gt; next)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> R <span class="title function_">next</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> next.apply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li><code>ILogicChainArmory</code> 装配链，提供添加节点方法和获取节点。</li>
<li><code>ILogicLink</code> 继承 <code>ILogicChainArmory</code>，并提供一个受理业务逻辑的方法。</li>
<li><code>AbstractLogicLink</code> 的过程是封装添加节点和执行 <code>next</code> 下一个节点的方法。</li>
</ol>
<p>那么，这里是由统一的类维护责任链，也就是一份责任链。如果有2个独立的链要处理，就需要使用到非单例的类进行填充，否则会修改同一份链。也就是 <code>ILogicLink&lt;T, D, R&gt; next </code>被几份链反复调整，也就不是一个单独的链了。</p>
<h5 id="2-2-4-测试举例"><a class="headerlink" href="#2-2-4-测试举例"></a>2.2.4 测试举例</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule01.logic;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuleLogic101</span> <span class="keyword">extends</span> <span class="title class_">AbstractLogicLink</span>&lt;String, Rule02TradeRuleFactory.DynamicContext, String&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(String requestParameter, Rule02TradeRuleFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;link model01 RuleLogic101&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule01.logic;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuleLogic102</span> <span class="keyword">extends</span> <span class="title class_">AbstractLogicLink</span>&lt;String, Rule02TradeRuleFactory.DynamicContext, String&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(String requestParameter, Rule02TradeRuleFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;link model01 RuleLogic102&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;link model01 单实例链&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个工厂类负责连接这两个节点：RuleLogic101和RuleLogic102</span></span><br><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule01.factory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rule01TradeRuleFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RuleLogic101 ruleLogic101;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RuleLogic102 ruleLogic102;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ILogicLink&lt;String, Rule02TradeRuleFactory.DynamicContext, String&gt; openLogicLink() &#123;</span><br><span class="line">        <span class="comment">// ruleLogic101要连接ruleLogic102</span></span><br><span class="line">        ruleLogic101.appendNext(ruleLogic102);</span><br><span class="line">        <span class="keyword">return</span> ruleLogic101;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicContext</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主测试方法</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Link01Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">public</span> Rule01TradeRuleFactory rule01TradeRuleFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_model01_01</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ILogicLink&lt;String, Rule02TradeRuleFactory.DynamicContext, String&gt; logicLink = rule01TradeRuleFactory.openLogicLink();</span><br><span class="line">        <span class="type">String</span> <span class="variable">logic</span> <span class="operator">=</span> logicLink.apply(<span class="string">&quot;123&quot;</span>, <span class="keyword">new</span> <span class="title class_">Rule02TradeRuleFactory</span>.DynamicContext());</span><br><span class="line">        log.info(<span class="string">&quot;测试结果:&#123;&#125;&quot;</span>, JSON.toJSONString(logic));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-多例链路"><a class="headerlink" href="#2-3-多例链路"></a>2.3 多例链路</h4>
<p>多例链的设计要<strong>解耦链路和执行</strong>，把链路当做一个 <code>LinkedList</code> 列表处理，之后执行当做是单独的 <code>for</code> 循环</p>
<h5 id="2-3-1-链表接口"><a class="headerlink" href="#2-3-1-链表接口"></a>2.3.1 链表接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model2.chain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 链接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILink</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">addFirst</span><span class="params">(E e)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">addLast</span><span class="params">(E e)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span>;</span><br><span class="line"></span><br><span class="line">    E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">printLinkList</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-2-功能链表"><a class="headerlink" href="#2-3-2-功能链表"></a>2.3.2 功能链表</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model2.chain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 功能链路</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedList</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">ILink</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 责任链名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;E&gt; first;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkedList</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">linkFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; f = first;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="literal">null</span>, e, f);</span><br><span class="line">        first = newNode;</span><br><span class="line">        <span class="keyword">if</span> (f == <span class="literal">null</span>)</span><br><span class="line">            last = newNode;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            f.prev = newNode;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">linkLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(l, e, <span class="literal">null</span>);</span><br><span class="line">        last = newNode;</span><br><span class="line">        <span class="keyword">if</span> (l == <span class="literal">null</span>) &#123;</span><br><span class="line">            first = newNode;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            l.next = newNode;</span><br><span class="line">        &#125;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        linkLast(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addFirst</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        linkFirst(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addLast</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        linkLast(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (x.item == <span class="literal">null</span>) &#123;</span><br><span class="line">                    unlink(x);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="literal">null</span>; x = x.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                    unlink(x);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    E <span class="title function_">unlink</span><span class="params">(Node&lt;E&gt; x)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">E</span> <span class="variable">element</span> <span class="operator">=</span> x.item;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prev == <span class="literal">null</span>) &#123;</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev.next = next;</span><br><span class="line">            x.prev = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">            last = prev;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next.prev = prev;</span><br><span class="line">            x.next = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        x.item = <span class="literal">null</span>;</span><br><span class="line">        size--;</span><br><span class="line">        <span class="keyword">return</span> element;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> node(index).item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node&lt;E&gt; <span class="title function_">node</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">            Node&lt;E&gt; x = first;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">                x = x.next;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;E&gt; x = last;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">                x = x.prev;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printLinkList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.size == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;链表为空&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;E&gt; temp = first;</span><br><span class="line">            System.out.print(<span class="string">&quot;目前的列表，头节点：&quot;</span> + first.item + <span class="string">&quot; 尾节点：&quot;</span> + last.item + <span class="string">&quot; 整体：&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (temp != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.print(temp.item + <span class="string">&quot;，&quot;</span>);</span><br><span class="line">                temp = temp.next;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">        E item;</span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">        Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.item = element;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">            <span class="built_in">this</span>.prev = prev;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-3-逻辑处理器"><a class="headerlink" href="#2-3-3-逻辑处理器"></a>2.3.3 逻辑处理器</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model2.handler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 逻辑处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILogicHandler</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> R <span class="title function_">next</span><span class="params">(T requestParameter, D dynamicContext)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-4-业务链路"><a class="headerlink" href="#2-3-4-业务链路"></a>2.3.4 业务链路</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model2.chain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 业务链路</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessLinkedList</span>&lt;T, D, R&gt; <span class="keyword">extends</span> <span class="title class_">LinkedList</span>&lt;ILogicHandler&lt;T, D, R&gt;&gt; <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;T, D, R&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BusinessLinkedList</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Node&lt;ILogicHandler&lt;T, D, R&gt;&gt; current = <span class="built_in">this</span>.first;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            ILogicHandler&lt;T, D, R&gt; item = current.item;</span><br><span class="line">            <span class="type">R</span> <span class="variable">apply</span> <span class="operator">=</span> item.apply(requestParameter, dynamicContext);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != apply) <span class="keyword">return</span> apply;</span><br><span class="line"></span><br><span class="line">            current = current.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">null</span> != current);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>BusinessLinkedList</code> 存在的意义是为了受理业务流程，循环遍历责任链。遍历的过程不只是这样，也可以实现 <code>Iterable</code> 来处理。</li>
<li>遍历的过程会以 <code>apply</code> 是否为空和链路是否走到最后来判断。<code>apply</code> 为空则表示当前 <code>ILogicHandler</code> 实现的节点的业务流程为空，放行到下一个节点。</li>
</ul>
<h5 id="2-3-5-链路装配"><a class="headerlink" href="#2-3-5-链路装配"></a>2.3.5 链路装配</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.design.framework.link.model2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 链路装配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkArmory</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BusinessLinkedList&lt;T, D, R&gt; logicLink;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SafeVarargs</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkArmory</span><span class="params">(String linkName, ILogicHandler&lt;T, D, R&gt;... logicHandlers)</span> &#123;</span><br><span class="line">        logicLink = <span class="keyword">new</span> <span class="title class_">BusinessLinkedList</span>&lt;&gt;(linkName);</span><br><span class="line">        <span class="keyword">for</span> (ILogicHandler&lt;T, D, R&gt; logicHandler: logicHandlers)&#123;</span><br><span class="line">            logicLink.add(logicHandler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BusinessLinkedList&lt;T, D, R&gt; <span class="title function_">getLogicLink</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> logicLink;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>提供一个链路装配器，让调用方自行装配处理。</li>
</ul>
<h5 id="2-3-6-测试举例"><a class="headerlink" href="#2-3-6-测试举例"></a>2.3.6 测试举例</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule02.logic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuleLogic201</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;String, Rule02TradeRuleFactory.DynamicContext, XxxResponse&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> XxxResponse <span class="title function_">apply</span><span class="params">(String requestParameter, Rule02TradeRuleFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;link model02 RuleLogic201&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule02.logic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuleLogic202</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;String, Rule02TradeRuleFactory.DynamicContext, XxxResponse&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> XxxResponse <span class="title function_">apply</span><span class="params">(String requestParameter, Rule02TradeRuleFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;link model02 RuleLogic202&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">XxxResponse</span>(<span class="string">&quot;hi 小傅哥！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule02.logic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxxResponse</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XxxResponse</span><span class="params">(String age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.test.types.rule02.factory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rule02TradeRuleFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;demo01&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BusinessLinkedList&lt;String, DynamicContext, XxxResponse&gt; <span class="title function_">demo01</span><span class="params">(RuleLogic201 ruleLogic201, RuleLogic202 ruleLogic202)</span> &#123;</span><br><span class="line"></span><br><span class="line">        LinkArmory&lt;String, DynamicContext, XxxResponse&gt; linkArmory = <span class="keyword">new</span> <span class="title class_">LinkArmory</span>&lt;&gt;(<span class="string">&quot;demo01&quot;</span>, ruleLogic201, ruleLogic202);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> linkArmory.getLogicLink();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;demo02&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BusinessLinkedList&lt;String, DynamicContext, XxxResponse&gt; <span class="title function_">demo02</span><span class="params">(RuleLogic202 ruleLogic202)</span> &#123;</span><br><span class="line"></span><br><span class="line">        LinkArmory&lt;String, DynamicContext, XxxResponse&gt; linkArmory = <span class="keyword">new</span> <span class="title class_">LinkArmory</span>&lt;&gt;(<span class="string">&quot;demo02&quot;</span>, ruleLogic202);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> linkArmory.getLogicLink();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicContext</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>多例链与单例链最大的区别在于，工厂里直接配置了两个 <code>Bean</code> 对象，组装不同的链路。每个链路只维护自己的流程。</li>
<li>之后在单测类里分别测试两套链路。测试结果符合预期。</li>
</ul>
<hr>
<h2 id="交易规则责任链过滤"><a class="headerlink" href="#交易规则责任链过滤"></a>交易规则责任链过滤</h2>
<hr>
<p>完善拼团交易营销锁单的流程，增加锁单流程中的规则处理。</p>
<p>这部分的规则过滤，会使用到前面设计的统一的设计模式框架中的责任链模式。对这类轻量的场景，一般只需要选择单链的执行模型即可，而与之对比的规则树，是适合于那种节点间的复杂分支流转。</p>
<h3 id="1-业务流程-6"><a class="headerlink" href="#1-业务流程-6"></a>1. 业务流程</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504204502136.png" alt="增加交易规则处理" loading="lazy"></p>
<ul>
<li>在前面的部分，我们实现了拼团锁单中，参数校验、幂等校验、达成校验，之后做了营销试算和营销锁单。</li>
<li>那么在这部分，还需要对营销锁单继续完善，过滤拼团活动配置的规则。包括：活动的有效期、状态，以及个人参与拼团的次数。在实际公司中的项目里，还会有更多的规则要被处理。</li>
</ul>
<h3 id="2-编码实现-9"><a class="headerlink" href="#2-编码实现-9"></a>2. 编码实现</h3>
<h4 id="2-1-数据库修改"><a class="headerlink" href="#2-1-数据库修改"></a>2.1 数据库修改</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504205219408.png" alt="数据库修改" loading="lazy"></p>
<ul>
<li>增加<code>biz_id</code>，即：业务<code>id</code>，构建唯一的索引标识，例如：<code>100123_xiaofuge_1</code>表示<code>xiaofuge</code>这个用户最多只能参与一次</li>
</ul>
<h4 id="2-2-工程结构"><a class="headerlink" href="#2-2-工程结构"></a>2.2 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250504205654997.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>这部分会围绕 <code>trade</code> 领域内 <code>service</code> 服务下的规则进行实现。实现的过程会使用到前面部分定义的责任链模板。</li>
</ul>
<h4 id="2-3-功能修复"><a class="headerlink" href="#2-3-功能修复"></a>2.3 功能修复</h4>
<h5 id="2-3-1-营销优惠记录支付金额"><a class="headerlink" href="#2-3-1-营销优惠记录支付金额"></a>2.3.1 营销优惠记录支付金额</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在marketNode的第87行</span></span><br><span class="line"><span class="keyword">package</span> cn.bugstack.domain.activity.service.trial.node;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 折扣价格，因为新增了payprice（支付价格）、deductionPrice（优惠价格）的字段</span></span><br><span class="line"><span class="type">BigDecimal</span> <span class="variable">payPrice</span> <span class="operator">=</span> discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);</span><br><span class="line"></span><br><span class="line">dynamicContext.setDeductionPrice(skuVO.getOriginalPrice().subtract(payPrice));</span><br><span class="line"></span><br><span class="line">dynamicContext.setPayPrice(payPrice);</span><br></pre></td></tr></table></figure>
<ul>
<li>为了更好的使用拼团营销试算，明确试算返回的优惠折扣和支付金额，为此 在拼团试算 <code>MarketNode</code> 节点，增加 <code>payPrice</code> 属性填写支付金额。</li>
</ul>
<h5 id="2-3-2-营销优惠计算使用人群ID"><a class="headerlink" href="#2-3-2-营销优惠计算使用人群ID"></a>2.3.2 营销优惠计算使用人群ID</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDiscountCalculateService</span> <span class="keyword">implements</span> <span class="title class_">IDiscountCalculateService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> IActivityRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">calculate</span><span class="params">(String userId, BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 人群标签过滤</span></span><br><span class="line">        <span class="keyword">if</span> (DiscountTypeEnum.TAG.equals(groupBuyDiscount.getDiscountType()))&#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isCrowdRange</span> <span class="operator">=</span> filterTagId(userId, groupBuyDiscount.getTagId());</span><br><span class="line">            <span class="keyword">if</span> (!isCrowdRange) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;折扣优惠计算拦截，用户不再优惠人群标签范围内 userId:&#123;&#125;&quot;</span>, userId);</span><br><span class="line">                <span class="keyword">return</span> originalPrice;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 折扣优惠计算</span></span><br><span class="line">        <span class="keyword">return</span> doCalculate(originalPrice, groupBuyDiscount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 人群过滤 - 限定人群优惠</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">filterTagId</span><span class="params">(String userId, String tagId)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断用户是否存在人群中</span></span><br><span class="line">        <span class="keyword">return</span> repository.isTagCrowdRange(tagId, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> BigDecimal <span class="title function_">doCalculate</span><span class="params">(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>完善 <code>AbstractDiscountCalculateService</code> 的 <code>filterTagId</code> 中对人群标签的使用</li>
</ul>
<h4 id="2-4-交易规则模型"><a class="headerlink" href="#2-4-交易规则模型"></a>2.4 交易规则模型</h4>
<h5 id="2-4-1-构建交易结算实体"><a class="headerlink" href="#2-4-1-构建交易结算实体"></a>2.4.1 构建交易结算实体</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.model.entity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 拼团交易结算规则反馈</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementRuleFilterBackEntity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 拼单组队ID */</span></span><br><span class="line">    <span class="keyword">private</span> String teamId;</span><br><span class="line">    <span class="comment">/** 活动ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long activityId;</span><br><span class="line">    <span class="comment">/** 目标数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer targetCount;</span><br><span class="line">    <span class="comment">/** 完成数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer completeCount;</span><br><span class="line">    <span class="comment">/** 锁单数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer lockCount;</span><br><span class="line">    <span class="comment">/** 状态（0-拼单中、1-完成、2-失败） */</span></span><br><span class="line">    <span class="keyword">private</span> GroupBuyOrderEnumVO status;</span><br><span class="line">    <span class="comment">/** 拼团开始时间 - 参与拼团时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date validStartTime;</span><br><span class="line">    <span class="comment">/** 拼团结束时间 - 拼团有效时长 */</span></span><br><span class="line">    <span class="keyword">private</span> Date validEndTime;</span><br><span class="line">    <span class="comment">/** 回调配置 */</span></span><br><span class="line">    <span class="keyword">private</span> NotifyConfigVO notifyConfigVO;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.model.entity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 拼团交易结算规则命令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementRuleCommandEntity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 渠道 */</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="comment">/** 来源 */</span></span><br><span class="line">    <span class="keyword">private</span> String channel;</span><br><span class="line">    <span class="comment">/** 用户ID */</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="comment">/** 外部交易单号 */</span></span><br><span class="line">    <span class="keyword">private</span> String outTradeNo;</span><br><span class="line">    <span class="comment">/** 外部交易时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Date outTradeTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-4-2-判断活动的可用性"><a class="headerlink" href="#2-4-2-判断活动的可用性"></a>2.4.2 判断活动的可用性</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.filter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityUsabilityRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;交易规则过滤-活动的可用性校验&#123;&#125; activityId:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getActivityId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询拼团活动</span></span><br><span class="line">        <span class="type">GroupBuyActivityEntity</span> <span class="variable">groupBuyActivity</span> <span class="operator">=</span> repository.queryGroupBuyActivityEntityByActivityId(requestParameter.getActivityId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 校验：活动状态 - 可以抛业务异常code，或者把code写入到动态上下文dynamicContext中，最后获取。</span></span><br><span class="line">        <span class="comment">// ActivityStatusEnumVO 是一个枚举类，包括：活动状态（0创建、1生效、2过期、3废弃）</span></span><br><span class="line">        <span class="keyword">if</span> (!ActivityStatusEnumVO.EFFECTIVE.equals(groupBuyActivity.getStatus())) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;活动的可用性校验，非生效状态 activityId:&#123;&#125;&quot;</span>, requestParameter.getActivityId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0101);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 校验：活动时间</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="keyword">if</span> (currentTime.before(groupBuyActivity.getStartTime()) || currentTime.after(groupBuyActivity.getEndTime())) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;活动的可用性校验，非可参与时间范围 activityId:&#123;&#125;&quot;</span>, requestParameter.getActivityId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0102);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入动态上下文</span></span><br><span class="line">        dynamicContext.setGroupBuyActivity(groupBuyActivity);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 走到下一个责任链节点</span></span><br><span class="line">        <span class="keyword">return</span> next(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>活动可用性过滤活动的状态和时间。之后把活动数据写入到上下文中。</li>
</ul>
<h5 id="2-4-3-判断用户参与限制"><a class="headerlink" href="#2-4-3-判断用户参与限制"></a>2.4.3 判断用户参与限制</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.filter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTakeLimitRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;交易规则过滤-用户参与次数校验&#123;&#125; activityId:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getActivityId());</span><br><span class="line"></span><br><span class="line">        <span class="type">GroupBuyActivityEntity</span> <span class="variable">groupBuyActivity</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询用户在一个拼团活动上参与的次数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> repository.queryOrderCountByActivityId(requestParameter.getActivityId(), requestParameter.getUserId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户在一个拼团活动上参与的次数超过限定的次数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != groupBuyActivity.getTakeLimitCount() &amp;&amp; count &gt;= groupBuyActivity.getTakeLimitCount()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;用户参与次数校验，已达可参与上限 activityId:&#123;&#125;&quot;</span>, requestParameter.getActivityId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0103);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TradeRuleFilterBackEntity.builder()</span><br><span class="line">                .userTakeOrderCount(count)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果拼团活动配置了对用户的参与次数限制，那么需要在用户参与活动前，做好数量的校验拦截。</li>
<li>比如：用户可以参与3次，那么库表里会记录3条数据：<code>活动ID_用户ID_1</code>、<code>活动ID_用户ID_2</code>、<code>活动ID_用户ID_3</code>，这样可以在库表层面做最强的防护拦截，不会让一个用户无限的参与活动。</li>
</ul>
<h5 id="2-4-4-构建交易规则工厂"><a class="headerlink" href="#2-4-4-构建交易规则工厂"></a>2.4.4 构建交易规则工厂</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.factory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRuleFilterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的BusinessLinkedList是用的上面的部分定义的节点</span></span><br><span class="line">    <span class="meta">@Bean(&quot;tradeRuleFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BusinessLinkedList&lt;TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity&gt; tradeRuleFilter(ActivityUsabilityRuleFilter activityUsabilityRuleFilter, UserTakeLimitRuleFilter userTakeLimitRuleFilter) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 组装链</span></span><br><span class="line">        LinkArmory&lt;TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity&gt; linkArmory =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkArmory</span>&lt;&gt;(<span class="string">&quot;交易规则过滤链&quot;</span>, activityUsabilityRuleFilter, userTakeLimitRuleFilter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 链对象</span></span><br><span class="line">        <span class="keyword">return</span> linkArmory.getLogicLink();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicContext</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> GroupBuyActivityEntity groupBuyActivity;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>责任链的规则创建完成后，就是在工厂类中构建责任链。</li>
<li>例如：在实际的公司业务开发中，一个责任链会有很多这样的规则，因为要过滤用户的开户状态、授信状态、渠道状态、风控状态、额度状态等。那么这样的设计分层结构就非常好扩展和维护了。</li>
<li>此外，也不只是一个责任链，而是很多，他们根据不同的业务模型，比如：乡村交易、政企交易、校园交易、普户交易等，他们的规则流程也是不同的，那么为不同的流程，直接配置出对应的责任链，就可以快速的搭建符合的业务流程了，开发效率、维护效率都很高，技术认可度也有很大的提高！</li>
</ul>
<hr>
<h2 id="拼团组队结算统计"><a class="headerlink" href="#拼团组队结算统计"></a>拼团组队结算统计</h2>
<hr>
<p>首先，在之前的拼团流程中，拼团的过程是用户在商城下单，锁定拼团优惠（也就是拼团系统里锁单的过程）。之后就是用户给这笔商品完成支付交易，交易后不会直接发货，直至拼团组队完成后才会发货。</p>
<p>那么，这里有一个流程，就是支付完成后，需要做拼团数量的统计结算。例如：拼团需要3个用户一起下单，那么每完成一笔支付，就要给拼团的组队加上一笔记录。</p>
<h3 id="1-业务流程-7"><a class="headerlink" href="#1-业务流程-7"></a>1. 业务流程</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505121144183.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，交易订单的营销结算，核心就是更新拼团队伍的参与人数数量。每完成一笔支付，就有一笔拼团进度数量+1。</li>
<li>之后，这里要知道，更新拼团订单的明细状态（交易完成）和更新拼团进度数量要在一个事务下完成。</li>
<li>另外，更新拼团的进度要判断，当前是否为最后一次拼团完结状态。比如：计算剩余1个，即可完成拼团目标量，那么这最后一笔更新完成后，既是整个拼团队伍的进度完成了。</li>
</ul>
<h3 id="2-编码实现-10"><a class="headerlink" href="#2-编码实现-10"></a>2. 编码实现</h3>
<h4 id="2-1-新增一张数据库表"><a class="headerlink" href="#2-1-新增一张数据库表"></a>2.1 新增一张数据库表</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 转储表 notify_task</span><br><span class="line"># <span class="comment">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `notify_task` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增ID&#x27;</span>,</span><br><span class="line">  `activity_id` <span class="type">bigint</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;活动ID&#x27;</span>,</span><br><span class="line">  `team_id` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;拼单组队ID&#x27;</span>,</span><br><span class="line">  `notify_type` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;HTTP&#x27;</span> COMMENT <span class="string">&#x27;回调类型（HTTP、MQ）&#x27;</span>,</span><br><span class="line">  `notify_mq` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调消息&#x27;</span>,</span><br><span class="line">  `notify_url` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调接口&#x27;</span>,</span><br><span class="line">  `notify_count` <span class="type">int</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调次数&#x27;</span>,</span><br><span class="line">  `notify_status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调状态【0初始、1完成、2重试、3失败】&#x27;</span>,</span><br><span class="line">  `parameter_json` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;参数对象&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uq_team_id` (`team_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-工程结构-2"><a class="headerlink" href="#2-2-工程结构-2"></a>2.2 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505121608332.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>首先，重构交易分层，用类的名称，拆分交易中的业务场景。以此完成单一职责的划分。</li>
<li>之后，<code>trade</code> 领域下目前包括2部分服务，一个是营销交易锁单服务，另外一个是本节新增加的，营销交易结算服务。</li>
<li>重点，在于本部分实现的营销交易结算服务，对每一笔支付记录的记账处理，直至完成拼团进度。</li>
</ul>
<h4 id="2-3-重构锁单"><a class="headerlink" href="#2-3-重构锁单"></a>2.3 重构锁单</h4>
<p>单一职责的特点在于一个类，主要关心一类服务的设计。单一职责的好处是：<strong>降低复杂性</strong> 、<strong>提高可读性和可维护性</strong> 、<strong>提高复用性</strong> 、<strong>降低变更风险</strong> 。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505122129249.png" alt="重构锁单" loading="lazy"></p>
<ul>
<li>那么，我们使用单一职责来设计接口，它的特点在于，接口的命名即可看出做的业务属性，如：<code>ITradePay</code>、<code>ITradeRefund</code>、<code>ITradeSettlement</code> 等。如果说没有单一职责，那么这些 pay、refund、settlement，就会被写到一个接口类里，这个类会随着业务的迭代，被充斥大量的业务逻辑，越往后越难维护。所以对于这类场景，我们要做单一职责设计。</li>
</ul>
<h4 id="2-4-拼团结算"><a class="headerlink" href="#2-4-拼团结算"></a>2.4 拼团结算</h4>
<h5 id="2-4-1-定义拼团结算的接口"><a class="headerlink" href="#2-4-1-定义拼团结算的接口"></a>2.4.1 定义拼团结算的接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ITradeSettlementOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 营销结算</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tradePaySuccessEntity 交易支付订单实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 交易结算订单实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TradePaySettlementEntity <span class="title function_">settlementMarketPayOrder</span><span class="params">(TradePaySuccessEntity tradePaySuccessEntity)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，依照于单一职责，设计出一个交易结算的服务。</li>
<li>之后，定义营销结算的方法。入参为交易支付的成功实体信息，出参为交易结算的实体。</li>
</ul>
<h5 id="2-4-2-功能实现"><a class="headerlink" href="#2-4-2-功能实现"></a>2.4.2 功能实现</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementOrderService</span> <span class="keyword">implements</span> <span class="title class_">ITradeSettlementOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradePaySettlementEntity <span class="title function_">settlementMarketPayOrder</span><span class="params">(TradePaySuccessEntity tradePaySuccessEntity)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-支付订单结算:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 查询拼团信息</span></span><br><span class="line">        <span class="type">MarketPayOrderEntity</span> <span class="variable">marketPayOrderEntity</span> <span class="operator">=</span> repository.queryMarketPayOrderEntityByOutTradeNo(tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == marketPayOrderEntity) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;不存在的外部交易单号或用户已退单，不需要做支付订单结算:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查询组团信息</span></span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建聚合对象</span></span><br><span class="line">        <span class="type">GroupBuyTeamSettlementAggregate</span> <span class="variable">groupBuyTeamSettlementAggregate</span> <span class="operator">=</span> GroupBuyTeamSettlementAggregate.builder()</span><br><span class="line">                .userEntity(UserEntity.builder().userId(tradePaySuccessEntity.getUserId()).build())</span><br><span class="line">                .groupBuyTeamEntity(groupBuyTeamEntity)</span><br><span class="line">                .tradePaySuccessEntity(tradePaySuccessEntity)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 拼团交易结算</span></span><br><span class="line">        repository.settlementMarketPayOrder(groupBuyTeamSettlementAggregate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 返回结算信息 - 公司中开发这样的流程时候，会根据外部需要进行值的设置</span></span><br><span class="line">        <span class="keyword">return</span> TradePaySettlementEntity.builder()</span><br><span class="line">                .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                .teamId(marketPayOrderEntity.getTeamId())</span><br><span class="line">                .activityId(groupBuyTeamEntity.getActivityId())</span><br><span class="line">                .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，结算的过程分为查询外部的交易单号是否为拼团锁单订单，也就是说，之前这笔交易单号，参与过有效的锁单。</li>
<li>另外，商城类系统调用营销的要过滤是否有营销类信息，如果没有则不调用，这样会减轻对拼团类系统接口的压力。</li>
<li>最后，构建聚合对象，调用仓储层的 <code>settlementMarketPayOrder</code> 完成拼团类数据落库。</li>
</ul>
<h5 id="2-4-3-settlementMarketPayOrder事务操作"><a class="headerlink" href="#2-4-3-settlementMarketPayOrder事务操作"></a>2.4.3 settlementMarketPayOrder事务操作</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyActivityDao groupBuyActivityDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderDao groupBuyOrderDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderListDao groupBuyOrderListDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> INotifyTaskDao notifyTaskDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(timeout = 500)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">settlementMarketPayOrder</span><span class="params">(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getUserEntity();</span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity();</span><br><span class="line">        <span class="type">TradePaySuccessEntity</span> <span class="variable">tradePaySuccessEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getTradePaySuccessEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 更新拼团订单明细状态</span></span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupBuyOrderList</span>();</span><br><span class="line">        groupBuyOrderListReq.setUserId(userEntity.getUserId());</span><br><span class="line">        groupBuyOrderListReq.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        <span class="type">int</span> <span class="variable">updateOrderListStatusCount</span> <span class="operator">=</span> groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderListReq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> != updateOrderListStatusCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0005);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 更新拼团达成数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateAddCount</span> <span class="operator">=</span> groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> != updateAddCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0005);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 更新拼团完成状态</span></span><br><span class="line">        <span class="keyword">if</span> (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">updateOrderStatusCount</span> <span class="operator">=</span> groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId());</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> != updateOrderStatusCount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0005);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询拼团交易完成外部单号列表</span></span><br><span class="line">            List&lt;String&gt; outTradeNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼团完成写入回调任务记录</span></span><br><span class="line">            <span class="comment">// 回调任务供外部接口访问和使用</span></span><br><span class="line">            <span class="type">NotifyTask</span> <span class="variable">notifyTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotifyTask</span>();</span><br><span class="line">            notifyTask.setActivityId(groupBuyTeamEntity.getActivityId());</span><br><span class="line">            notifyTask.setTeamId(groupBuyTeamEntity.getTeamId());</span><br><span class="line">            notifyTask.setNotifyUrl(<span class="string">&quot;暂无&quot;</span>);</span><br><span class="line">            notifyTask.setNotifyCount(<span class="number">0</span>);</span><br><span class="line">            notifyTask.setNotifyStatus(<span class="number">0</span>);</span><br><span class="line">            notifyTask.setParameterJson(JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;() &#123;&#123;</span><br><span class="line">                put(<span class="string">&quot;teamId&quot;</span>, groupBuyTeamEntity.getTeamId());</span><br><span class="line">                put(<span class="string">&quot;outTradeNoList&quot;</span>, outTradeNoList);</span><br><span class="line">            &#125;&#125;));</span><br><span class="line"></span><br><span class="line">            notifyTaskDao.insert(notifyTask);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>交易结算的过程分为：更新拼团订单明细状态、更新拼团达成数量，之后要判断当前这笔结算是否为最后的结算，如果是，还需要写入回调任务。</li>
<li>这里的回调任务，<strong>是在拼团结束后，回调商城系统，通知拼团完成。之后商城系统要对已经支付完成的订单进行发货</strong>。</li>
<li>关于回调的流程，后续在做处理。现在也可以先尝试考虑下这个流程。</li>
</ul>
<hr>
<h2 id="交易结算责任链过滤"><a class="headerlink" href="#交易结算责任链过滤"></a>交易结算责任链过滤</h2>
<hr>
<p>拼团交易结算的过程，需要一些列的规则过滤。包括：我们上一部分提到的校验外部交易单的时间是否在拼团有效时间内，同时还有关于这笔外部交易单是否为有效的拼团锁单订单。另外像是 <code>SC</code> 渠道的有效性也需要在结算时进行校验。</p>
<p>所以，这部分我们需要实现一套规则链，来处理这些业务规则。因为规则链已经被抽取为通用的模板了</p>
<h3 id="1-业务流程-8"><a class="headerlink" href="#1-业务流程-8"></a>1. 业务流程</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505140940354.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，这部分的重点在于新增加结算规则过滤的责任链，处理：SC渠道管控、有效的外部交易单号、结算实现是否为拼团时效内。</li>
<li>那么这里会有一些功能改造点：
<ul>
<li>拼团表：<code>group_buy_order</code> 增加 <code>valid_start_time</code>（有效开始时间）、<code>valid_end_time</code>（有效结束时间） 字段。用于每笔交易结算时候，用结算时间判断是否匹配到拼团有效时间范围内。</li>
<li>拼团明细：<code>group_buy_order_list</code> 增加 <code>out_trade_time</code>（交易时间） 字段，记录每笔结算的订单结算的时间。随着状态更新的时候更新。</li>
<li><code>trade</code> 领域下，<code>lock</code> 锁单。实体对象，修改名称。<code>TradeRuleCommandEntity</code> → <code>TradeLockRuleCommandEntity</code>，<code>TradeRuleFilterBackEntity</code> → <code>TradeLockRuleFilterBackEntity</code> 增加了 <code>Lock</code> 标识。便于在添加 <code>TradeSettlementRuleCommandEntity</code>、<code>TradeSettlementRuleFilterBackEntity</code> 时更好理解。</li>
<li><code>PayActivityEntity</code> 添加 <code>validTime</code>，<code>GroupBuyTeamEntity</code> 添加 <code>validStartTime</code>、<code>validEndTime</code></li>
<li><code>trade</code> 领域下，<code>settlement</code> 结算服务中，<strong>使用责任链模板，实现营销交易规则的过滤</strong>。<code>SCRuleFilter</code>（<code>SC</code> 黑名单管控过滤 <code>DCCService</code> 配置新的属性 <code>scBlacklist</code>）、<code>OutTradeNoRuleFilter</code>（外部交易单号有效性过滤）、<code>SettableRuleFilter</code>（交易时间是否在拼团有效时间内过滤）、<code>EndRuleFilter</code>（结束节点封装返回数据）</li>
<li>交易服务，<code>TradePaySettlementEntity</code> 调用 <code>tradeSettlementRuleFilter</code> 责任链方法，并返回相关的数据信息。</li>
<li><code>settlementMarketPayOrder</code> 结算一个事务下操作，增加 <code>updateOrderStatus2COMPLETE</code> 更新时候添加 <code>outTradeTime</code> 时间。</li>
</ul>
</li>
</ul>
<h3 id="2-编码实现-11"><a class="headerlink" href="#2-编码实现-11"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-7"><a class="headerlink" href="#2-1-工程结构-7"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505142355270.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>首先，你在实现功能编码的时候，要先考虑清楚你的模型结构如何处理。例如：本部分要做一个结算规则的处理，那么这些规则你是想在一个类里写大量的方法用 <code>if...else</code> 还是怎么实现。</li>
<li>之后，你要开始思考。如果不使用 <code>if...else</code> 一层层判断，那么就要先思考这块的业务流程，可以被分为几块处理。把他们的边界思考好。</li>
<li>然后，从一个个类下手，用类实现边界。也就是用类来区分你原来在一个大方法中写的一片流程代码，而每个类的衔接，可以使用规则树模型、责任链模型等，衔接中间流转的调用过程。</li>
</ul>
<h4 id="2-2-调整数据库表"><a class="headerlink" href="#2-2-调整数据库表"></a>2.2 调整数据库表</h4>
<h5 id="2-2-1-group-buy-order"><a class="headerlink" href="#2-2-1-group-buy-order"></a>2.2.1 group_buy_order</h5>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505142606501.png" alt="group_buy_order表" loading="lazy"></p>
<ul>
<li>每一个拼团，都是从拼团活动表 <code>group_buy_activity</code> 获得的参与数据。也就是在 <code>group_buy_activity</code> 活动有效时间范围内，在加上拼团时间。就是 <code>group_buy_order</code> 拼团的有效开始和结束时间。</li>
<li>把这样的数据写到 <code>group_buy_order</code> 表里，而不是每次都从活动表计算。是为了把即时性数据存库，避免以后调整活动时间，造成客诉不好排查。</li>
</ul>
<h5 id="2-2-2-group-buy-order-list"><a class="headerlink" href="#2-2-2-group-buy-order-list"></a>2.2.2 group_buy_order_list</h5>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505142709969.png" alt="group_buy_order_list" loading="lazy"></p>
<ul>
<li><code>group_buy_order_list</code> 添加一个拼团交易完成的时间，这样可以更好的知道用户是多久锁单，多久支付的。支付时候有等待的。便于以后做数据<code>量化</code>计算。</li>
</ul>
<h4 id="2-3-结算规则"><a class="headerlink" href="#2-3-结算规则"></a>2.3 结算规则</h4>
<h5 id="2-3-1-SCRuleFilter"><a class="headerlink" href="#2-3-1-SCRuleFilter"></a>2.3.1 SCRuleFilter</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.filter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> SC 渠道来源过滤 - 当某个签约渠道下架后，则不会记账</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SCRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeSettlementRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;结算规则过滤-渠道黑名单校验&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getOutTradeNo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sc 渠道黑名单拦截</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">intercept</span> <span class="operator">=</span> repository.isSCBlackIntercept(requestParameter.getSource(), requestParameter.getChannel());</span><br><span class="line">        <span class="keyword">if</span> (intercept) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&#123;&#125;&#123;&#125; 渠道黑名单拦截&quot;</span>, requestParameter.getSource(), requestParameter.getChannel());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0105);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-2-OutTradeNoRuleFilter"><a class="headerlink" href="#2-3-2-OutTradeNoRuleFilter"></a>2.3.2 OutTradeNoRuleFilter</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.filter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 外部交易单号过滤；外部交易单号是否为退单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutTradeNoRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeSettlementRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;结算规则过滤-外部单号校验&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getOutTradeNo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询拼团信息</span></span><br><span class="line">        <span class="type">MarketPayOrderEntity</span> <span class="variable">marketPayOrderEntity</span> <span class="operator">=</span> repository.queryMarketPayOrderEntityByOutTradeNo(requestParameter.getUserId(), requestParameter.getOutTradeNo());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == marketPayOrderEntity) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;不存在的外部交易单号或用户已退单，不需要做支付订单结算:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getOutTradeNo());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0104);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dynamicContext.setMarketPayOrderEntity(marketPayOrderEntity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-3-3-SettableRuleFilter"><a class="headerlink" href="#2-3-3-SettableRuleFilter"></a>2.3.3 SettableRuleFilter</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.filter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 可结算规则过滤；交易时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SettableRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeSettlementRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;结算规则过滤-有效时间校验&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getOutTradeNo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上下文：获取数据</span></span><br><span class="line">        <span class="type">MarketPayOrderEntity</span> <span class="variable">marketPayOrderEntity</span> <span class="operator">=</span> dynamicContext.getMarketPayOrderEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询拼团对象</span></span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 外部交易时间 - 也就是用户支付完成的时间，这个时间要在拼团有效时间范围内</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">outTradeTime</span> <span class="operator">=</span> requestParameter.getOutTradeTime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断，外部交易时间，要小于拼团结束时间。否则抛异常。</span></span><br><span class="line">        <span class="keyword">if</span> (!outTradeTime.before(groupBuyTeamEntity.getValidEndTime())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;订单交易时间不在拼团有效时间范围内&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0106);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置上下文</span></span><br><span class="line">        dynamicContext.setGroupBuyTeamEntity(groupBuyTeamEntity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-4-EndRuleFilter"><a class="headerlink" href="#2-3-4-EndRuleFilter"></a>2.3.4 EndRuleFilter</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.filter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 结束节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EndRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeSettlementRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;结算规则过滤-结束节点&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getOutTradeNo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上下文对象</span></span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> dynamicContext.getGroupBuyTeamEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回封装数据</span></span><br><span class="line">        <span class="keyword">return</span> TradeSettlementRuleFilterBackEntity.builder()</span><br><span class="line">                .teamId(groupBuyTeamEntity.getTeamId())</span><br><span class="line">                .activityId(groupBuyTeamEntity.getActivityId())</span><br><span class="line">                .targetCount(groupBuyTeamEntity.getTargetCount())</span><br><span class="line">                .completeCount(groupBuyTeamEntity.getCompleteCount())</span><br><span class="line">                .lockCount(groupBuyTeamEntity.getLockCount())</span><br><span class="line">                .status(groupBuyTeamEntity.getStatus())</span><br><span class="line">                .validStartTime(groupBuyTeamEntity.getValidStartTime())</span><br><span class="line">                .validEndTime(groupBuyTeamEntity.getValidEndTime())</span><br><span class="line">                .notifyConfigVO(groupBuyTeamEntity.getNotifyConfigVO())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-4-规则工厂"><a class="headerlink" href="#2-4-规则工厂"></a>2.4 规则工厂</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement.factory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 交易结算规则过滤工厂</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementRuleFilterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tradeSettlementRuleFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BusinessLinkedList&lt;TradeSettlementRuleCommandEntity,</span><br><span class="line">            TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; tradeSettlementRuleFilter(</span><br><span class="line">            SCRuleFilter scRuleFilter,</span><br><span class="line">            OutTradeNoRuleFilter outTradeNoRuleFilter,</span><br><span class="line">            SettableRuleFilter settableRuleFilter,</span><br><span class="line">            EndRuleFilter endRuleFilter) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组装链</span></span><br><span class="line">        LinkArmory&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; linkArmory =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkArmory</span>&lt;&gt;(<span class="string">&quot;交易结算规则过滤链&quot;</span>, scRuleFilter, outTradeNoRuleFilter, settableRuleFilter, endRuleFilter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 链对象</span></span><br><span class="line">        <span class="keyword">return</span> linkArmory.getLogicLink();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建上下文</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DynamicContext</span> &#123;</span><br><span class="line">        <span class="comment">// 订单营销实体对象</span></span><br><span class="line">        <span class="keyword">private</span> MarketPayOrderEntity marketPayOrderEntity;</span><br><span class="line">        <span class="comment">// 拼团组队实体对象</span></span><br><span class="line">        <span class="keyword">private</span> GroupBuyTeamEntity groupBuyTeamEntity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>规则工厂：负责把责任链进行串联。之后提供一个指定名称的规则 <code>Bean</code> 对象。</li>
</ul>
<h4 id="2-5-使用规则"><a class="headerlink" href="#2-5-使用规则"></a>2.5 使用规则</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 拼团交易结算服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementOrderService</span> <span class="keyword">implements</span> <span class="title class_">ITradeSettlementOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BusinessLinkedList&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; tradeSettlementRuleFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradePaySettlementEntity <span class="title function_">settlementMarketPayOrder</span><span class="params">(TradePaySuccessEntity tradePaySuccessEntity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-支付订单结算:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 结算规则过滤</span></span><br><span class="line">        <span class="comment">// 使用责任链实现</span></span><br><span class="line">        <span class="type">TradeSettlementRuleFilterBackEntity</span> <span class="variable">tradeSettlementRuleFilterBackEntity</span> <span class="operator">=</span> tradeSettlementRuleFilter.apply(</span><br><span class="line">                TradeSettlementRuleCommandEntity.builder()</span><br><span class="line">                        .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                        .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                        .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                        .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                        .outTradeTime(tradePaySuccessEntity.getOutTradeTime())</span><br><span class="line">                        .build(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TradeSettlementRuleFilterFactory</span>.DynamicContext());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> tradeSettlementRuleFilterBackEntity.getTeamId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查询组团信息</span></span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> GroupBuyTeamEntity.builder()</span><br><span class="line">                .teamId(tradeSettlementRuleFilterBackEntity.getTeamId())</span><br><span class="line">                .activityId(tradeSettlementRuleFilterBackEntity.getActivityId())</span><br><span class="line">                .targetCount(tradeSettlementRuleFilterBackEntity.getTargetCount())</span><br><span class="line">                .completeCount(tradeSettlementRuleFilterBackEntity.getCompleteCount())</span><br><span class="line">                .lockCount(tradeSettlementRuleFilterBackEntity.getLockCount())</span><br><span class="line">                .status(tradeSettlementRuleFilterBackEntity.getStatus())</span><br><span class="line">                .validStartTime(tradeSettlementRuleFilterBackEntity.getValidStartTime())</span><br><span class="line">                .validEndTime(tradeSettlementRuleFilterBackEntity.getValidEndTime())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建聚合对象</span></span><br><span class="line">        <span class="type">GroupBuyTeamSettlementAggregate</span> <span class="variable">groupBuyTeamSettlementAggregate</span> <span class="operator">=</span> GroupBuyTeamSettlementAggregate.builder()</span><br><span class="line">                .userEntity(UserEntity.builder().userId(tradePaySuccessEntity.getUserId()).build())</span><br><span class="line">                .groupBuyTeamEntity(groupBuyTeamEntity)</span><br><span class="line">                .tradePaySuccessEntity(tradePaySuccessEntity)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 拼团交易结算</span></span><br><span class="line">        repository.settlementMarketPayOrder(groupBuyTeamSettlementAggregate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 返回结算信息 - 公司中开发这样的流程时候，会根据外部需要进行值的设置</span></span><br><span class="line">        <span class="keyword">return</span> TradePaySettlementEntity.builder()</span><br><span class="line">                .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .activityId(groupBuyTeamEntity.getActivityId())</span><br><span class="line">                .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>营销结算服务 <code>TradeSettlementOrderService</code>，调整在于：不在这里判断外部交易单号是否有效了，而是统一收到责任链中实现。</li>
<li>另外规则链会返回所需的数据，以及返回了 <code>tradePaySuccessEntity.getOutTradeTime()</code> 交易时间。这个时间会在操作数据时候做更新。</li>
</ul>
<hr>
<h2 id="拼团回调通知任务"><a class="headerlink" href="#拼团回调通知任务"></a>拼团回调通知任务</h2>
<hr>
<p>在微服务设计中，当一个微服务系统的流程结束后，要通知下一个微服务系统。这个通知的过程，可以是 <code>RPC</code>、<code>MQ</code>，也可以是 <code>HTTP</code> 方式。</p>
<p><code>RPC</code>、<code>MQ</code>，这一类的都是需要有一个公用的注册中心，它的技术架构比较适合于公司内部的统一系统使用。如果是有和外部其他系统的对接，通常我们会使用 <code>HTTP</code> 这样统一标准协议的接口进行使用。</p>
<p>那么，本部分要为拼团组队交易结算完结后，实现一个回调通知的任务处理。告知另外的微服务系统可以进行后续的流程了。</p>
<p>注意：微信支付，支付宝支付，也是在完成支付后，做的这样的回调处理。</p>
<h3 id="1-业务流程-9"><a class="headerlink" href="#1-业务流程-9"></a>1. 业务流程</h3>
<p>如图，拼团结算组队完成，回调通知</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505151012676.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>首先，本部分的重点在拼团成团后，实现回调通知流程。回调的过程，需要在用户锁单时需要增加一个回调的地址，并在拼团完结后发起回调。</li>
<li>那么，这里的一些功能改造点：
<ul>
<li><code>group_buy_order</code> 在设计的时候有一个 <code>notify_url</code> 回调地址，这部分我们修改库表添加上这个字段。并对工程中的 <code>dao</code>&amp;<code>po</code>&amp;<code>mapper</code> 操作，增加 <code>notify_url</code> 字段。</li>
<li><code>MarketTradeController</code> 营销交易服务，<code>lockMarketPayOrder</code> 锁单接口入参对象，增加 <code>notifyUrl</code> 回调地址。并有 <code>PayDiscountEntity</code> 对象透传到 <code>TradeRepository#lockMarketPayOrder</code> 仓储操作。这样写到 <code>group_buy_order</code> 表就有回调地址了，等做回调操作的时候，就可以把这个地址写入到回调任务表中。</li>
<li><code>TradeSettlementOrderService</code>的 <code>settlementMarketPayOrder</code> 结算服务，需要把锁单记录中的 <code>notify_url</code> 拿到，放到 <code>GroupBuyTeamEntity</code> 中，这样在写入 <code>notify_task</code> 表记录的时候就可以把 <code>notify_url</code> 一起写入进去了。</li>
<li>基于 <code>okhttp</code> 框架，封装对 <code>http</code> 接口的调用。用于处理调用外部其他微服务，实现回调通知的处理。因为外部的接口是随着每个服务调用拼团写入进来的 <code>http</code> 请求地址，所以在封装这部分调用的时候，要允许动态透传请求地址。实现类写到 <code>infrastructure</code> 基础设置层的 <code>gateway</code> 调用外部网关层。实现类；<code>GroupBuyNotifyService</code> 提供方法；<code>groupBuyNotify</code></li>
<li>在交易结算服务类 <code>ITradeSettlementOrderService</code>，定义执行结算回调通知接口，包括：<code>execSettlementNotifyJob()</code>、<code>execSettlementNotifyJob(String teamId)</code> 一个是有入参的，一个无入参。这样可以指定给某个拼团队伍做结算。结算的过程就是调用 <code>GroupBuyNotifyService</code>的<code>groupBuyNotify</code> 完成回调通知，并根据返回的结果更新 <code>notify_task</code> 表状态记录（成功、失败、重试），并记录回调次数，小于5次的时候都可以继续回调。</li>
<li>回调通知，可以分为两个阶段处理。一个是拼团完成后立即执行，另外一个任务补偿。立即执行是为了提供时效性，但因为远程的 <code>http</code> 调用受网络和服务的影响可能会失败，所以要增加一个任务补偿来做定时检查。其中立即执行在 <code>TradeSettlementOrderService#settlementMarketPayOrder</code> →  <code>settlementMarketPayOrder</code> 处理。另外定时任务在 <code>GroupBuyNotifyJob</code> 处理。</li>
<li>测试接口，<code>trigger/http</code> 下，增加 <code>TestApiClientController</code> 接口实现类，提供回调接口服务。这个是模拟的其他的微服务，将来要提供的接口。</li>
</ul>
</li>
</ul>
<h3 id="2-编码实现-12"><a class="headerlink" href="#2-编码实现-12"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-8"><a class="headerlink" href="#2-1-工程结构-8"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505152226280.png" alt="工程结构" loading="lazy"></p>
<ul>
<li>首先，这是涉及本次改动的一些类。我们要实现的功能就是串联出 <code>notify_url</code> 并做回调通知处理。</li>
</ul>
<h4 id="2-2-库表变更"><a class="headerlink" href="#2-2-库表变更"></a>2.2 库表变更</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250505152338738.png" alt="库表变更" loading="lazy"></p>
<ul>
<li>在 <code>group_buy_order</code> 表增加 <code>notify_url</code> 字段，写入回调地址。</li>
</ul>
<h4 id="2-3-锁单写入-notify-url"><a class="headerlink" href="#2-3-锁单写入-notify-url"></a>2.3 锁单写入 - notify_url</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyActivityDao groupBuyActivityDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderDao groupBuyOrderDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderListDao groupBuyOrderListDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> INotifyTaskDao notifyTaskDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DCCService dccService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(timeout = 500)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayOrderEntity <span class="title function_">lockMarketPayOrder</span><span class="params">(GroupBuyOrderAggregate groupBuyOrderAggregate)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 聚合对象信息</span></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getUserEntity();</span><br><span class="line">        <span class="type">PayActivityEntity</span> <span class="variable">payActivityEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getPayActivityEntity();</span><br><span class="line">        <span class="type">PayDiscountEntity</span> <span class="variable">payDiscountEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getPayDiscountEntity();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userTakeOrderCount</span> <span class="operator">=</span> groupBuyOrderAggregate.getUserTakeOrderCount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否有团 - teamId 为空 - 新团、为不空 - 老团</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> payActivityEntity.getTeamId();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(teamId)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使用 RandomStringUtils.randomNumeric 替代公司里使用的雪花算法UUID</span></span><br><span class="line">            teamId = RandomStringUtils.randomNumeric(<span class="number">8</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 日期处理</span></span><br><span class="line">            <span class="type">Date</span> <span class="variable">currentDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            calendar.setTime(currentDate);</span><br><span class="line">            calendar.add(Calendar.MINUTE, payActivityEntity.getValidTime());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建拼团订单</span></span><br><span class="line">            <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> GroupBuyOrder.builder()</span><br><span class="line">                    .teamId(teamId)</span><br><span class="line">                    .activityId(payActivityEntity.getActivityId())</span><br><span class="line">                    .source(payDiscountEntity.getSource())</span><br><span class="line">                    .channel(payDiscountEntity.getChannel())</span><br><span class="line">                    .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                    .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                    .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                    .targetCount(payActivityEntity.getTargetCount())</span><br><span class="line">                    .completeCount(<span class="number">0</span>)</span><br><span class="line">                    .lockCount(<span class="number">1</span>)</span><br><span class="line">                    .validStartTime(currentDate)</span><br><span class="line">                    .validEndTime(calendar.getTime())</span><br><span class="line">                <span class="comment">// 这里需要加上url的信息</span></span><br><span class="line">                    .notifyUrl(payDiscountEntity.getNotifyUrl())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入记录</span></span><br><span class="line">            groupBuyOrderDao.insert(groupBuyOrder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新记录 - 如果更新记录不等于1，则表示拼团已满，抛出异常</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">updateAddTargetCount</span> <span class="operator">=</span> groupBuyOrderDao.updateAddLockCount(teamId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> != updateAddTargetCount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0005);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 RandomStringUtils.randomNumeric 替代公司里使用的雪花算法UUID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> RandomStringUtils.randomNumeric(<span class="number">12</span>);</span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> GroupBuyOrderList.builder()</span><br><span class="line">                .userId(userEntity.getUserId())</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .orderId(orderId)</span><br><span class="line">                .activityId(payActivityEntity.getActivityId())</span><br><span class="line">                .startTime(payActivityEntity.getStartTime())</span><br><span class="line">                .endTime(payActivityEntity.getEndTime())</span><br><span class="line">                .goodsId(payDiscountEntity.getGoodsId())</span><br><span class="line">                .source(payDiscountEntity.getSource())</span><br><span class="line">                .channel(payDiscountEntity.getChannel())</span><br><span class="line">                .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                .status(TradeOrderStatusEnumVO.CREATE.getCode())</span><br><span class="line">                .outTradeNo(payDiscountEntity.getOutTradeNo())</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 构建 bizId 唯一值；活动id_用户id_参与次数累加</span></span><br><span class="line">                .bizId(payActivityEntity.getActivityId() + Constants.UNDERLINE + userEntity.getUserId() + Constants.UNDERLINE + (userTakeOrderCount + <span class="number">1</span>))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入拼团记录</span></span><br><span class="line">            groupBuyOrderListDao.insert(groupBuyOrderListReq);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.INDEX_EXCEPTION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MarketPayOrderEntity.builder()</span><br><span class="line">                .orderId(orderId)</span><br><span class="line">                .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                .tradeOrderStatusEnumVO(TradeOrderStatusEnumVO.CREATE)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>lockMarketPayOrder</code> 方法中，从 <code>PayDiscountEntity</code> 获取 <code>NotifyUrl</code> 写入到拼团组队记录中。<code>groupBuyOrderDao.insert(groupBuyOrder);</code></li>
</ul>
<h4 id="2-4-结算处理-notify-url"><a class="headerlink" href="#2-4-结算处理-notify-url"></a>2.4 结算处理 - notify_url</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyActivityDao groupBuyActivityDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderDao groupBuyOrderDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderListDao groupBuyOrderListDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> INotifyTaskDao notifyTaskDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DCCService dccService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Transactional(timeout = 500)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">settlementMarketPayOrder</span><span class="params">(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getUserEntity();</span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity();</span><br><span class="line">        <span class="type">TradePaySuccessEntity</span> <span class="variable">tradePaySuccessEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getTradePaySuccessEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 更新拼团订单明细状态</span></span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupBuyOrderList</span>();</span><br><span class="line">        groupBuyOrderListReq.setUserId(userEntity.getUserId());</span><br><span class="line">        groupBuyOrderListReq.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        groupBuyOrderListReq.setOutTradeTime(tradePaySuccessEntity.getOutTradeTime());</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateOrderListStatusCount</span> <span class="operator">=</span> groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderListReq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> != updateOrderListStatusCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.UPDATE_ZERO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 更新拼团达成数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateAddCount</span> <span class="operator">=</span> groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> != updateAddCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.UPDATE_ZERO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 更新拼团完成状态</span></span><br><span class="line">        <span class="keyword">if</span> (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">updateOrderStatusCount</span> <span class="operator">=</span> groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId());</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> != updateOrderStatusCount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.UPDATE_ZERO);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询拼团交易完成外部单号列表</span></span><br><span class="line">            List&lt;String&gt; outTradeNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼团完成写入回调任务记录</span></span><br><span class="line">            <span class="type">NotifyTask</span> <span class="variable">notifyTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotifyTask</span>();</span><br><span class="line">            notifyTask.setActivityId(groupBuyTeamEntity.getActivityId());</span><br><span class="line">            notifyTask.setTeamId(groupBuyTeamEntity.getTeamId());</span><br><span class="line">            notifyTask.setNotifyUrl(groupBuyTeamEntity.getNotifyUrl());</span><br><span class="line">            notifyTask.setNotifyCount(<span class="number">0</span>);</span><br><span class="line">            notifyTask.setNotifyStatus(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            notifyTask.setParameterJson(JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;() &#123;&#123;</span><br><span class="line">                put(<span class="string">&quot;teamId&quot;</span>, groupBuyTeamEntity.getTeamId());</span><br><span class="line">                put(<span class="string">&quot;outTradeNoList&quot;</span>, outTradeNoList);</span><br><span class="line">            &#125;&#125;));</span><br><span class="line"></span><br><span class="line">            notifyTaskDao.insert(notifyTask);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>settlementMarketPayOrder</code> 方法，从 <code>GroupBuyTeamEntity</code> 拼团记录获取到 <code>notify_url</code> 写入到 <code>NotifyTask</code> 表记录中。</li>
</ul>
<h4 id="2-5-回调网关-okhttp"><a class="headerlink" href="#2-5-回调网关-okhttp"></a>2.5 回调网关 - okhttp</h4>
<h5 id="2-5-1-添加pom文件"><a class="headerlink" href="#2-5-1-添加pom文件"></a>2.5.1 添加pom文件</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http 接口框架 https://bugstack.cn/md/road-map/http.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp-sse<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.14.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logging-interceptor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.14.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-5-2-添加okhttp客户端"><a class="headerlink" href="#2-5-2-添加okhttp客户端"></a>2.5.2 添加okhttp客户端</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> http 框架</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OKHttpClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OkHttpClient <span class="title function_">httpClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-5-3-添加okhttp回调网关"><a class="headerlink" href="#2-5-3-添加okhttp回调网关"></a>2.5.3 添加okhttp回调网关</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.gateway;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 拼团回调服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyNotifyService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OkHttpClient okHttpClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">groupBuyNotify</span><span class="params">(String apiUrl, String notifyRequestDTOJSON)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 构建参数</span></span><br><span class="line">            <span class="type">MediaType</span> <span class="variable">mediaType</span> <span class="operator">=</span> MediaType.parse(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">            <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> RequestBody.create(mediaType, notifyRequestDTOJSON);</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .url(apiUrl)</span><br><span class="line">                    .post(body)</span><br><span class="line">                    .addHeader(<span class="string">&quot;content-type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 调用接口</span></span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> okHttpClient.newCall(request).execute();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 返回结果</span></span><br><span class="line">            <span class="keyword">return</span> response.body().string();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;拼团回调 HTTP 接口服务异常 &#123;&#125;&quot;</span>, apiUrl, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.HTTP_EXCEPTION);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>回调服务，在基础设置层的 <code>gateway</code> 中实现。用于动态调用外部的接口，进行回调通知。</li>
</ul>
<h4 id="2-6-回调封装"><a class="headerlink" href="#2-6-回调封装"></a>2.6 回调封装</h4>
<h5 id="2-6-1-定义回调接口"><a class="headerlink" href="#2-6-1-定义回调接口"></a>2.6.1 定义回调接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.adapter.port;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 交易接口服务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ITradePort</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">groupBuyNotify</span><span class="params">(NotifyTaskEntity notifyTask)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-6-2-实现回调接口"><a class="headerlink" href="#2-6-2-实现回调接口"></a>2.6.2 实现回调接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.types.enums;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 回调任务状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">NotifyTaskHTTPEnumVO</span> &#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="string">&quot;success&quot;</span>, <span class="string">&quot;成功&quot;</span>),</span><br><span class="line">    ERROR(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;失败&quot;</span>),</span><br><span class="line">    NULL(<span class="literal">null</span>, <span class="string">&quot;空执行&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.port;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradePort</span> <span class="keyword">implements</span> <span class="title class_">ITradePort</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GroupBuyNotifyService groupBuyNotifyService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IRedisService redisService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">groupBuyNotify</span><span class="params">(NotifyTaskEntity notifyTask)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisService.getLock(notifyTask.lockKey());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// group-buy-market 拼团服务端会被部署到多台应用服务器上，那么就会有很多任务一起执行。这个时候要进行抢占，避免被多次执行</span></span><br><span class="line">            <span class="keyword">if</span> (lock.tryLock(<span class="number">3</span>, <span class="number">0</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 回调方式 HTTP</span></span><br><span class="line">                    <span class="keyword">if</span> (NotifyTypeEnumVO.HTTP.getCode().equals(notifyTask.getNotifyType())) &#123;</span><br><span class="line">                        <span class="comment">// 无效的 notifyUrl 则直接返回成功</span></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isBlank(notifyTask.getNotifyUrl()) || <span class="string">&quot;暂无&quot;</span>.equals(notifyTask.getNotifyUrl())) &#123;</span><br><span class="line">                            <span class="keyword">return</span> NotifyTaskHTTPEnumVO.SUCCESS.getCode();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> groupBuyNotifyService.groupBuyNotify(notifyTask.getNotifyUrl(), notifyTask.getParameterJson());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (lock.isLocked() &amp;&amp; lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                        lock.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> NotifyTaskHTTPEnumVO.NULL.getCode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="keyword">return</span> NotifyTaskHTTPEnumVO.NULL.getCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-6-3-实现回调封装"><a class="headerlink" href="#2-6-3-实现回调封装"></a>2.6.3 实现回调封装</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementOrderService</span> <span class="keyword">implements</span> <span class="title class_">ITradeSettlementOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradePort port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BusinessLinkedList&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; tradeSettlementRuleFilter;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... 省略部分方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title function_">execSettlementNotifyJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-执行结算通知任务&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询未执行任务</span></span><br><span class="line">        List&lt;NotifyTaskEntity&gt; notifyTaskEntityList = repository.queryUnExecutedNotifyTaskList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> execSettlementNotifyJob(notifyTaskEntityList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定teamId进行回调</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title function_">execSettlementNotifyJob</span><span class="params">(String teamId)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-执行结算通知回调，指定 teamId:&#123;&#125;&quot;</span>, teamId);</span><br><span class="line">        List&lt;NotifyTaskEntity&gt; notifyTaskEntityList = repository.queryUnExecutedNotifyTaskList(teamId);</span><br><span class="line">        <span class="keyword">return</span> execSettlementNotifyJob(notifyTaskEntityList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title function_">execSettlementNotifyJob</span><span class="params">(List&lt;NotifyTaskEntity&gt; notifyTaskEntityList)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">successCount</span> <span class="operator">=</span> <span class="number">0</span>, errorCount = <span class="number">0</span>, retryCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (NotifyTaskEntity notifyTask : notifyTaskEntityList) &#123;</span><br><span class="line">            <span class="comment">// 回调处理 success 成功，error 失败</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> port.groupBuyNotify(notifyTask);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新状态判断 &amp; 变更数据库表回调任务状态</span></span><br><span class="line">            <span class="keyword">if</span> (NotifyTaskHTTPEnumVO.SUCCESS.getCode().equals(response)) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">updateCount</span> <span class="operator">=</span> repository.updateNotifyTaskStatusSuccess(notifyTask.getTeamId());</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">1</span> == updateCount) &#123;</span><br><span class="line">                    successCount += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (NotifyTaskHTTPEnumVO.ERROR.getCode().equals(response)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (notifyTask.getNotifyCount() &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">updateCount</span> <span class="operator">=</span> repository.updateNotifyTaskStatusError(notifyTask.getTeamId());</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">1</span> == updateCount) &#123;</span><br><span class="line">                        errorCount += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">updateCount</span> <span class="operator">=</span> repository.updateNotifyTaskStatusRetry(notifyTask.getTeamId());</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">1</span> == updateCount) &#123;</span><br><span class="line">                        retryCount += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Integer&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        resultMap.put(<span class="string">&quot;waitCount&quot;</span>, notifyTaskEntityList.size());</span><br><span class="line">        resultMap.put(<span class="string">&quot;successCount&quot;</span>, successCount);</span><br><span class="line">        resultMap.put(<span class="string">&quot;errorCount&quot;</span>, errorCount);</span><br><span class="line">        resultMap.put(<span class="string">&quot;retryCount&quot;</span>, retryCount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>execSettlementNotifyJob(List&lt;NotifyTaskEntity&gt; notifyTaskEntityList)</code> 回调任务，调用 <code>port.groupBuyNotify(notifyTask)</code> 回调服务。</li>
<li>根据回调服务返回的结果，更新回调任务表记录。包括：调用了几次、成功的状态。</li>
</ul>
<h4 id="2-7-调用处理"><a class="headerlink" href="#2-7-调用处理"></a>2.7 调用处理</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementOrderService</span> <span class="keyword">implements</span> <span class="title class_">ITradeSettlementOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradePort port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BusinessLinkedList&lt;TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity&gt; tradeSettlementRuleFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradePaySettlementEntity <span class="title function_">settlementMarketPayOrder</span><span class="params">(TradePaySuccessEntity tradePaySuccessEntity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-支付订单结算:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        <span class="comment">// 1. 结算规则过滤</span></span><br><span class="line">        <span class="type">TradeSettlementRuleFilterBackEntity</span> <span class="variable">tradeSettlementRuleFilterBackEntity</span> <span class="operator">=</span> tradeSettlementRuleFilter.apply(</span><br><span class="line">                TradeSettlementRuleCommandEntity.builder()</span><br><span class="line">                        .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                        .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                        .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                        .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                        .outTradeTime(tradePaySuccessEntity.getOutTradeTime())</span><br><span class="line">                        .build(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TradeSettlementRuleFilterFactory</span>.DynamicContext());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> tradeSettlementRuleFilterBackEntity.getTeamId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查询组团信息</span></span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> GroupBuyTeamEntity.builder()</span><br><span class="line">                .teamId(tradeSettlementRuleFilterBackEntity.getTeamId())</span><br><span class="line">                .activityId(tradeSettlementRuleFilterBackEntity.getActivityId())</span><br><span class="line">                .targetCount(tradeSettlementRuleFilterBackEntity.getTargetCount())</span><br><span class="line">                .completeCount(tradeSettlementRuleFilterBackEntity.getCompleteCount())</span><br><span class="line">                .lockCount(tradeSettlementRuleFilterBackEntity.getLockCount())</span><br><span class="line">                .status(tradeSettlementRuleFilterBackEntity.getStatus())</span><br><span class="line">                .validStartTime(tradeSettlementRuleFilterBackEntity.getValidStartTime())</span><br><span class="line">                .validEndTime(tradeSettlementRuleFilterBackEntity.getValidEndTime())</span><br><span class="line">                .notifyUrl(tradeSettlementRuleFilterBackEntity.getNotifyUrl())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建聚合对象</span></span><br><span class="line">        <span class="type">GroupBuyTeamSettlementAggregate</span> <span class="variable">groupBuyTeamSettlementAggregate</span> <span class="operator">=</span> GroupBuyTeamSettlementAggregate.builder()</span><br><span class="line">                .userEntity(UserEntity.builder().userId(tradePaySuccessEntity.getUserId()).build())</span><br><span class="line">                .groupBuyTeamEntity(groupBuyTeamEntity)</span><br><span class="line">                .tradePaySuccessEntity(tradePaySuccessEntity)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 拼团交易结算</span></span><br><span class="line">        repository.settlementMarketPayOrder(groupBuyTeamSettlementAggregate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 组队回调处理 - 处理失败也会有定时任务补偿，通过这样的方式，可以减轻任务调度，提高时效性</span></span><br><span class="line">        Map&lt;String, Integer&gt; notifyResultMap = execSettlementNotifyJob(teamId);</span><br><span class="line">        log.info(<span class="string">&quot;回调通知拼团完结 result:&#123;&#125;&quot;</span>, JSON.toJSONString(notifyResultMap));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 返回结算信息 - 公司中开发这样的流程时候，会根据外部需要进行值的设置</span></span><br><span class="line">        <span class="keyword">return</span> TradePaySettlementEntity.builder()</span><br><span class="line">                .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .activityId(groupBuyTeamEntity.getActivityId())</span><br><span class="line">                .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Map&lt;String, Integer&gt; notifyResultMap = execSettlementNotifyJob(teamId);</code> 回调通知处理。这步失败也没关系，后续会有定时任务处理。</li>
</ul>
<h4 id="2-8-任务补偿（定时任务实现）"><a class="headerlink" href="#2-8-任务补偿（定时任务实现）"></a>2.8 任务补偿（定时任务实现）</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.trigger.job;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 拼团完结回调通知任务；拼团回调任务表，实际公司场景会定时清理数据结转，不会有太多数据挤压</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyNotifyJob</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeSettlementOrderService tradeSettlementOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/15 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Integer&gt; result = tradeSettlementOrderService.execSettlementNotifyJob();</span><br><span class="line">            log.info(<span class="string">&quot;定时任务，回调通知拼团完结任务 result:&#123;&#125;&quot;</span>, JSON.toJSONString(result));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;定时任务，回调通知拼团完结任务失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，<code>app</code> 下的 <code>Application</code> 类，要添加一个 <code>@EnableScheduling</code> 注解，这样才能使用任务。</li>
<li>之后，<code>trigger</code> 下的 <code>job</code> 包下，创建 <code>GroupBuyNotifyJob</code> 回调任务，调用回调通知。</li>
</ul>
<hr>
<h2 id="根据UI展示封装接口"><a class="headerlink" href="#根据UI展示封装接口"></a>根据UI展示封装接口</h2>
<hr>
<p>根据在上一部分使用 <code>DeepSeek</code> 实现的拼团 <code>UI</code>，设计并实现所需的服务端接口。</p>
<p>在互联网公司里的开发过程也是这样，产品在评审期间，会提供 <code>UI</code> 工程师做好的设计图，研发拿到设计图后，提供所需的接口提供相应的字段。</p>
<h3 id="1-接口分析"><a class="headerlink" href="#1-接口分析"></a>1. 接口分析</h3>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506115436097.png" alt="接口分析" loading="lazy"></p>
<ul>
<li><strong>紫色圈</strong>：10人再抢，是<strong>拼团的统计数据</strong>。类似的还有总共开多少团、成功的拼团等，如果有展示需求，都可以在拼团统计中给出。</li>
<li><strong>灰色圈</strong>：商品信息，商品金额、优惠金额、支付金额等。</li>
<li><strong>绿色圈</strong>：参与拼团，UI 调用的操作是<strong>锁单的处理</strong>。在完整的流程中是调用商城类系统，发起交易，之后由商城类系统进行营销锁单。我们这里模拟，所以从前端开始锁单。</li>
<li><strong>黄色券</strong>：这里不是真实对接扫码支付，所以要点支付完成，才能触发拼团结算。所以这里需要调用拼团里的结算接口。</li>
</ul>
<h3 id="2-编码实现-13"><a class="headerlink" href="#2-编码实现-13"></a>2. 编码实现</h3>
<h4 id="2-1-工程结构-9"><a class="headerlink" href="#2-1-工程结构-9"></a>2.1 工程结构</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506120351846.png" alt="工程结构" loading="lazy"></p>
<h4 id="2-2-首页-拼团营销配置接口"><a class="headerlink" href="#2-2-首页-拼团营销配置接口"></a>2.2 首页 - 拼团营销配置接口</h4>
<h5 id="2-2-1-定义商品营销应答对象"><a class="headerlink" href="#2-2-1-定义商品营销应答对象"></a>2.2.1 定义商品营销应答对象</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.api.dto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 商品营销应答对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsMarketResponseDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商品信息</span></span><br><span class="line">    <span class="keyword">private</span> Goods goods;</span><br><span class="line">    <span class="comment">// 组队信息（1个个人的置顶、2个随机的「获取10个，随机取2个」）</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Team&gt; teamList;</span><br><span class="line">    <span class="comment">// 组队统计</span></span><br><span class="line">    <span class="keyword">private</span> TeamStatistic teamStatistic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">        <span class="comment">// 商品ID</span></span><br><span class="line">        <span class="keyword">private</span> String goodsId;</span><br><span class="line">        <span class="comment">// 原始价格</span></span><br><span class="line">        <span class="keyword">private</span> BigDecimal originalPrice;</span><br><span class="line">        <span class="comment">// 折扣金额</span></span><br><span class="line">        <span class="keyword">private</span> BigDecimal deductionPrice;</span><br><span class="line">        <span class="comment">// 支付价格</span></span><br><span class="line">        <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 组队信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Team</span> &#123;</span><br><span class="line">        <span class="comment">// 用户ID</span></span><br><span class="line">        <span class="keyword">private</span> String userId;</span><br><span class="line">        <span class="comment">// 拼单组队ID</span></span><br><span class="line">        <span class="keyword">private</span> String teamId;</span><br><span class="line">        <span class="comment">// 活动ID</span></span><br><span class="line">        <span class="keyword">private</span> Long activityId;</span><br><span class="line">        <span class="comment">// 目标数量</span></span><br><span class="line">        <span class="keyword">private</span> Integer targetCount;</span><br><span class="line">        <span class="comment">// 完成数量</span></span><br><span class="line">        <span class="keyword">private</span> Integer completeCount;</span><br><span class="line">        <span class="comment">// 锁单数量</span></span><br><span class="line">        <span class="keyword">private</span> Integer lockCount;</span><br><span class="line">        <span class="comment">// 拼团开始时间 - 参与拼团时间</span></span><br><span class="line">        <span class="keyword">private</span> Date validStartTime;</span><br><span class="line">        <span class="comment">// 拼团结束时间 - 拼团有效时长</span></span><br><span class="line">        <span class="keyword">private</span> Date validEndTime;</span><br><span class="line">        <span class="comment">// 倒计时(字符串) validEndTime - validStartTime</span></span><br><span class="line">        <span class="keyword">private</span> String validTimeCountdown;</span><br><span class="line">        <span class="comment">/** 外部交易单号-确保外部调用唯一幂等 */</span></span><br><span class="line">        <span class="keyword">private</span> String outTradeNo;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">differenceDateTime2Str</span><span class="params">(Date validStartTime, Date validEndTime)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (validStartTime == <span class="literal">null</span> || validEndTime == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;无效的时间&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">diffInMilliseconds</span> <span class="operator">=</span> validEndTime.getTime() - validStartTime.getTime();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (diffInMilliseconds &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;已结束&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">seconds</span> <span class="operator">=</span> TimeUnit.MILLISECONDS.toSeconds(diffInMilliseconds) % <span class="number">60</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">minutes</span> <span class="operator">=</span> TimeUnit.MILLISECONDS.toMinutes(diffInMilliseconds) % <span class="number">60</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">hours</span> <span class="operator">=</span> TimeUnit.MILLISECONDS.toHours(diffInMilliseconds) % <span class="number">24</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">days</span> <span class="operator">=</span> TimeUnit.MILLISECONDS.toDays(diffInMilliseconds);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;%02d:%02d:%02d&quot;</span>, hours, minutes, seconds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 组队统计</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TeamStatistic</span> &#123;</span><br><span class="line">        <span class="comment">// 开团队伍数量</span></span><br><span class="line">        <span class="keyword">private</span> Integer allTeamCount;</span><br><span class="line">        <span class="comment">// 成团队伍数量</span></span><br><span class="line">        <span class="keyword">private</span> Integer allTeamCompleteCount;</span><br><span class="line">        <span class="comment">// 参团人数总量 - 一个商品的总参团人数</span></span><br><span class="line">        <span class="keyword">private</span> Integer allTeamUserCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，这里要注意，不要把页面的所有要的属性，都用一个个属性字段平铺到类中，那样以后维护会非常复杂。要思考这些属性的归属问题，定义不同的对象承载。</li>
<li>之后，根据页面诉求，定义三个对象：<code>Goods</code> - 商品、<code>Team</code> - 拼团、<code>TeamStatistic</code> - 统计。</li>
</ul>
<h5 id="2-2-2-定义服务接口"><a class="headerlink" href="#2-2-2-定义服务接口"></a>2.2.2 定义服务接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IMarketIndexService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询拼团营销配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> goodsMarketRequestDTO 营销商品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 营销配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Response&lt;GoodsMarketResponseDTO&gt; <span class="title function_">queryGroupBuyMarketConfig</span><span class="params">(GoodsMarketRequestDTO goodsMarketRequestDTO)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-实现服务接口"><a class="headerlink" href="#2-2-3-实现服务接口"></a>2.2.3 实现服务接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.trigger.http;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 营销首页服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController()</span></span><br><span class="line"><span class="meta">@CrossOrigin(&quot;*&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/gbm/index/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketIndexController</span> <span class="keyword">implements</span> <span class="title class_">IMarketIndexService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IIndexGroupBuyMarketService indexGroupBuyMarketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;query_group_buy_market_config&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;GoodsMarketResponseDTO&gt; <span class="title function_">queryGroupBuyMarketConfig</span><span class="params">(<span class="meta">@RequestBody</span> GoodsMarketRequestDTO goodsMarketRequestDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;查询拼团营销配置开始:&#123;&#125; goodsId:&#123;&#125;&quot;</span>, goodsMarketRequestDTO.getUserId(), goodsMarketRequestDTO.getGoodsId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断参数信息</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(goodsMarketRequestDTO.getUserId()) || StringUtils.isBlank(goodsMarketRequestDTO.getSource()) || StringUtils.isBlank(goodsMarketRequestDTO.getChannel()) || StringUtils.isBlank(goodsMarketRequestDTO.getGoodsId())) &#123;</span><br><span class="line">                <span class="keyword">return</span> Response.&lt;GoodsMarketResponseDTO&gt;builder()</span><br><span class="line">                        .code(ResponseCode.ILLEGAL_PARAMETER.getCode())</span><br><span class="line">                        .info(ResponseCode.ILLEGAL_PARAMETER.getInfo())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 营销优惠试算</span></span><br><span class="line">            <span class="type">TrialBalanceEntity</span> <span class="variable">trialBalanceEntity</span> <span class="operator">=</span> indexGroupBuyMarketService.indexMarketTrial(MarketProductEntity.builder()</span><br><span class="line">                    .userId(goodsMarketRequestDTO.getUserId())</span><br><span class="line">                    .source(goodsMarketRequestDTO.getSource())</span><br><span class="line">                    .channel(goodsMarketRequestDTO.getChannel())</span><br><span class="line">                    .goodsId(goodsMarketRequestDTO.getGoodsId())</span><br><span class="line">                    .build());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> trialBalanceEntity.getGroupBuyActivityDiscountVO();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">activityId</span> <span class="operator">=</span> groupBuyActivityDiscountVO.getActivityId();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 查询拼团组队</span></span><br><span class="line">            List&lt;UserGroupBuyOrderDetailEntity&gt; userGroupBuyOrderDetailEntities = indexGroupBuyMarketService.queryInProgressUserGroupBuyOrderDetailList(activityId, goodsMarketRequestDTO.getUserId(), <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 统计拼团数据</span></span><br><span class="line">            <span class="type">TeamStatisticVO</span> <span class="variable">teamStatisticVO</span> <span class="operator">=</span> indexGroupBuyMarketService.queryTeamStatisticByActivityId(activityId);</span><br><span class="line"></span><br><span class="line">            GoodsMarketResponseDTO.<span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> GoodsMarketResponseDTO.Goods.builder()</span><br><span class="line">                    .goodsId(trialBalanceEntity.getGoodsId())</span><br><span class="line">                    .originalPrice(trialBalanceEntity.getOriginalPrice())</span><br><span class="line">                    .deductionPrice(trialBalanceEntity.getDeductionPrice())</span><br><span class="line">                    .payPrice(trialBalanceEntity.getPayPrice())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            List&lt;GoodsMarketResponseDTO.Team&gt; teams = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != userGroupBuyOrderDetailEntities &amp;&amp; !userGroupBuyOrderDetailEntities.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserGroupBuyOrderDetailEntity userGroupBuyOrderDetailEntity : userGroupBuyOrderDetailEntities) &#123;</span><br><span class="line">                    GoodsMarketResponseDTO.<span class="type">Team</span> <span class="variable">team</span> <span class="operator">=</span> GoodsMarketResponseDTO.Team.builder()</span><br><span class="line">                            .userId(userGroupBuyOrderDetailEntity.getUserId())</span><br><span class="line">                            .teamId(userGroupBuyOrderDetailEntity.getTeamId())</span><br><span class="line">                            .activityId(userGroupBuyOrderDetailEntity.getActivityId())</span><br><span class="line">                            .targetCount(userGroupBuyOrderDetailEntity.getTargetCount())</span><br><span class="line">                            .completeCount(userGroupBuyOrderDetailEntity.getCompleteCount())</span><br><span class="line">                            .lockCount(userGroupBuyOrderDetailEntity.getLockCount())</span><br><span class="line">                            .validStartTime(userGroupBuyOrderDetailEntity.getValidStartTime())</span><br><span class="line">                            .validEndTime(userGroupBuyOrderDetailEntity.getValidEndTime())</span><br><span class="line">                            .validTimeCountdown(GoodsMarketResponseDTO.Team.differenceDateTime2Str(<span class="keyword">new</span> <span class="title class_">Date</span>(), userGroupBuyOrderDetailEntity.getValidEndTime()))</span><br><span class="line">                            .outTradeNo(userGroupBuyOrderDetailEntity.getOutTradeNo())</span><br><span class="line">                            .build();</span><br><span class="line">                    teams.add(team);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            GoodsMarketResponseDTO.<span class="type">TeamStatistic</span> <span class="variable">teamStatistic</span> <span class="operator">=</span> GoodsMarketResponseDTO.TeamStatistic.builder()</span><br><span class="line">                    .allTeamCount(teamStatisticVO.getAllTeamCount())</span><br><span class="line">                    .allTeamCompleteCount(teamStatisticVO.getAllTeamCompleteCount())</span><br><span class="line">                    .allTeamUserCount(teamStatisticVO.getAllTeamUserCount())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            Response&lt;GoodsMarketResponseDTO&gt; response = Response.&lt;GoodsMarketResponseDTO&gt;builder()</span><br><span class="line">                    .code(ResponseCode.SUCCESS.getCode())</span><br><span class="line">                    .info(ResponseCode.SUCCESS.getInfo())</span><br><span class="line">                    .data(GoodsMarketResponseDTO.builder()</span><br><span class="line">                            .goods(goods)</span><br><span class="line">                            .teamList(teams)</span><br><span class="line">                            .teamStatistic(teamStatistic)</span><br><span class="line">                            .build())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;查询拼团营销配置完成:&#123;&#125; goodsId:&#123;&#125; response:&#123;&#125;&quot;</span>, goodsMarketRequestDTO.getUserId(), goodsMarketRequestDTO.getGoodsId(), JSON.toJSONString(response));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;查询拼团营销配置失败:&#123;&#125; goodsId:&#123;&#125;&quot;</span>, goodsMarketRequestDTO.getUserId(), goodsMarketRequestDTO.getGoodsId(), e);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;GoodsMarketResponseDTO&gt;builder()</span><br><span class="line">                    .code(ResponseCode.UN_ERROR.getCode())</span><br><span class="line">                    .info(ResponseCode.UN_ERROR.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>接口的查询组装数据主要分为3部分：<code>营销优惠试算</code>、<code>查询拼团组队</code>、<code>统计拼团数据</code>。</li>
<li>其中，<code>查询拼团组队</code> 分为优先查询一个，个人的一条拼团数据显示在最上面。之后在随机查询2条其他人的拼团数据。查询的过程要先查询个人的明细数据，之后从明细数据获得拼团队伍 <code>teamId</code>，在查询拼团队伍的信息，最后组装数据。随机查询可以查询2倍量的数据，之后在随机获取需要的量的数据。</li>
</ul>
<h5 id="2-2-4-查询拼团组队数据组装"><a class="headerlink" href="#2-2-4-查询拼团组队数据组装"></a>2.2.4 查询拼团组队数据组装</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityRepository</span> <span class="keyword">implements</span> <span class="title class_">IActivityRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyActivityDao groupBuyActivityDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyDiscountDao groupBuyDiscountDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISkuDao skuDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISCSkuActivityDao skuActivityDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IRedisService redisService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DCCService dccService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderDao groupBuyOrderDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGroupBuyOrderListDao groupBuyOrderListDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 组装个人的数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserGroupBuyOrderDetailEntity&gt; <span class="title function_">queryInProgressUserGroupBuyOrderDetailListByOwner</span><span class="params">(Long activityId, String userId, Integer ownerCount)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 根据用户ID、活动ID，查询用户参与的拼团队伍</span></span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupBuyOrderList</span>();</span><br><span class="line">        groupBuyOrderListReq.setActivityId(activityId);</span><br><span class="line">        groupBuyOrderListReq.setUserId(userId);</span><br><span class="line">        groupBuyOrderListReq.setCount(ownerCount);</span><br><span class="line">        List&lt;GroupBuyOrderList&gt; groupBuyOrderLists = groupBuyOrderListDao.queryInProgressUserGroupBuyOrderDetailListByUserId(groupBuyOrderListReq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrderLists || groupBuyOrderLists.isEmpty()) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 过滤队伍获取 TeamId</span></span><br><span class="line">        Set&lt;String&gt; teamIds = groupBuyOrderLists.stream()</span><br><span class="line">                .map(GroupBuyOrderList::getTeamId)</span><br><span class="line">                .filter(teamId -&gt; teamId != <span class="literal">null</span> &amp;&amp; !teamId.isEmpty()) <span class="comment">// 过滤非空和非空字符串</span></span><br><span class="line">                .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 查询队伍明细，组装Map结构</span></span><br><span class="line">        List&lt;GroupBuyOrder&gt; groupBuyOrders = groupBuyOrderDao.queryGroupBuyProgressByTeamIds(teamIds);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrders || groupBuyOrders.isEmpty()) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, GroupBuyOrder&gt; groupBuyOrderMap = groupBuyOrders.stream()</span><br><span class="line">                .collect(Collectors.toMap(GroupBuyOrder::getTeamId, order -&gt; order));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 转换数据</span></span><br><span class="line">        List&lt;UserGroupBuyOrderDetailEntity&gt; userGroupBuyOrderDetailEntities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (GroupBuyOrderList groupBuyOrderList : groupBuyOrderLists) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> groupBuyOrderList.getTeamId();</span><br><span class="line">            <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> groupBuyOrderMap.get(teamId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrder) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">UserGroupBuyOrderDetailEntity</span> <span class="variable">userGroupBuyOrderDetailEntity</span> <span class="operator">=</span> UserGroupBuyOrderDetailEntity.builder()</span><br><span class="line">                    .userId(groupBuyOrderList.getUserId())</span><br><span class="line">                    .teamId(groupBuyOrder.getTeamId())</span><br><span class="line">                    .activityId(groupBuyOrder.getActivityId())</span><br><span class="line">                    .targetCount(groupBuyOrder.getTargetCount())</span><br><span class="line">                    .completeCount(groupBuyOrder.getCompleteCount())</span><br><span class="line">                    .lockCount(groupBuyOrder.getLockCount())</span><br><span class="line">                    .validStartTime(groupBuyOrder.getValidStartTime())</span><br><span class="line">                    .validEndTime(groupBuyOrder.getValidEndTime())</span><br><span class="line">                    .outTradeNo(groupBuyOrderList.getOutTradeNo())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            userGroupBuyOrderDetailEntities.add(userGroupBuyOrderDetailEntity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userGroupBuyOrderDetailEntities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 随机组装非个人用户的数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserGroupBuyOrderDetailEntity&gt; <span class="title function_">queryInProgressUserGroupBuyOrderDetailListByRandom</span><span class="params">(Long activityId, String userId, Integer randomCount)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 根据用户ID、活动ID，查询用户参与的拼团队伍</span></span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupBuyOrderList</span>();</span><br><span class="line">        groupBuyOrderListReq.setActivityId(activityId);</span><br><span class="line">        groupBuyOrderListReq.setUserId(userId);</span><br><span class="line">        groupBuyOrderListReq.setCount(randomCount * <span class="number">2</span>); <span class="comment">// 查询2倍的量，之后其中 randomCount 数量</span></span><br><span class="line">        List&lt;GroupBuyOrderList&gt; groupBuyOrderLists = groupBuyOrderListDao.queryInProgressUserGroupBuyOrderDetailListByRandom(groupBuyOrderListReq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrderLists || groupBuyOrderLists.isEmpty()) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断总量是否大于 randomCount</span></span><br><span class="line">        <span class="keyword">if</span> (groupBuyOrderLists.size() &gt; randomCount) &#123;</span><br><span class="line">            <span class="comment">// 随机打乱列表</span></span><br><span class="line">            Collections.shuffle(groupBuyOrderLists);</span><br><span class="line">            <span class="comment">// 获取前 randomCount 个元素</span></span><br><span class="line">            groupBuyOrderLists = groupBuyOrderLists.subList(<span class="number">0</span>, randomCount);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 过滤队伍获取 TeamId</span></span><br><span class="line">        Set&lt;String&gt; teamIds = groupBuyOrderLists.stream()</span><br><span class="line">                .map(GroupBuyOrderList::getTeamId)</span><br><span class="line">                .filter(teamId -&gt; teamId != <span class="literal">null</span> &amp;&amp; !teamId.isEmpty()) <span class="comment">// 过滤非空和非空字符串</span></span><br><span class="line">                .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 查询队伍明细，组装Map结构</span></span><br><span class="line">        List&lt;GroupBuyOrder&gt; groupBuyOrders = groupBuyOrderDao.queryGroupBuyProgressByTeamIds(teamIds);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrders || groupBuyOrders.isEmpty()) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, GroupBuyOrder&gt; groupBuyOrderMap = groupBuyOrders.stream()</span><br><span class="line">                .collect(Collectors.toMap(GroupBuyOrder::getTeamId, order -&gt; order));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 转换数据</span></span><br><span class="line">        List&lt;UserGroupBuyOrderDetailEntity&gt; userGroupBuyOrderDetailEntities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (GroupBuyOrderList groupBuyOrderList : groupBuyOrderLists) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> groupBuyOrderList.getTeamId();</span><br><span class="line">            <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> groupBuyOrderMap.get(teamId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyOrder) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">UserGroupBuyOrderDetailEntity</span> <span class="variable">userGroupBuyOrderDetailEntity</span> <span class="operator">=</span> UserGroupBuyOrderDetailEntity.builder()</span><br><span class="line">                    .userId(groupBuyOrderList.getUserId())</span><br><span class="line">                    .teamId(groupBuyOrder.getTeamId())</span><br><span class="line">                    .activityId(groupBuyOrder.getActivityId())</span><br><span class="line">                    .targetCount(groupBuyOrder.getTargetCount())</span><br><span class="line">                    .completeCount(groupBuyOrder.getCompleteCount())</span><br><span class="line">                    .lockCount(groupBuyOrder.getLockCount())</span><br><span class="line">                    .validStartTime(groupBuyOrder.getValidStartTime())</span><br><span class="line">                    .validEndTime(groupBuyOrder.getValidEndTime())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            userGroupBuyOrderDetailEntities.add(userGroupBuyOrderDetailEntity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userGroupBuyOrderDetailEntities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼团队伍统计</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TeamStatisticVO <span class="title function_">queryTeamStatisticByActivityId</span><span class="params">(Long activityId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 根据活动ID查询拼团队伍</span></span><br><span class="line">        List&lt;GroupBuyOrderList&gt; groupBuyOrderLists = groupBuyOrderListDao.queryInProgressUserGroupBuyOrderDetailListByActivityId(activityId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 过滤队伍获取 TeamId</span></span><br><span class="line">        Set&lt;String&gt; teamIds = groupBuyOrderLists.stream()</span><br><span class="line">                .map(GroupBuyOrderList::getTeamId)</span><br><span class="line">                .filter(teamId -&gt; teamId != <span class="literal">null</span> &amp;&amp; !teamId.isEmpty()) <span class="comment">// 过滤非空和非空字符串</span></span><br><span class="line">                .collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 统计数据</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">allTeamCount</span> <span class="operator">=</span> groupBuyOrderDao.queryAllTeamCount(teamIds);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">allTeamCompleteCount</span> <span class="operator">=</span> groupBuyOrderDao.queryAllTeamCompleteCount(teamIds);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">allTeamUserCount</span> <span class="operator">=</span> groupBuyOrderDao.queryAllUserCount(teamIds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 构建对象</span></span><br><span class="line">        <span class="keyword">return</span> TeamStatisticVO.builder()</span><br><span class="line">                .allTeamCount(allTeamCount)</span><br><span class="line">                .allTeamCompleteCount(allTeamCompleteCount)</span><br><span class="line">                .allTeamUserCount(allTeamUserCount)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>queryInProgressUserGroupBuyOrderDetailListByOwner</code>：组装个人用户数据。</li>
<li><code>queryInProgressUserGroupBuyOrderDetailListByRandom</code>：随机组装非个人用户数据。</li>
<li><code>queryTeamStatisticByActivityId</code>：拼团队伍统计。</li>
<li>这些数据的查询，也可以用 <code>Redis</code> 缓存优化以及使用定时任务 + 异步消息统计好，查询的时候直接使用。</li>
</ul>
<h5 id="2-2-5-交易-结算接口"><a class="headerlink" href="#2-2-5-交易-结算接口"></a>2.2.5 交易 - 结算接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.trigger.http;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController()</span></span><br><span class="line"><span class="meta">@CrossOrigin(&quot;*&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/gbm/trade/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketTradeController</span> <span class="keyword">implements</span> <span class="title class_">IMarketTradeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IIndexGroupBuyMarketService indexGroupBuyMarketService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeLockOrderService tradeOrderService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeSettlementOrderService tradeSettlementOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;settlement_market_pay_order&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;SettlementMarketPayOrderResponseDTO&gt; <span class="title function_">settlementMarketPayOrder</span><span class="params">(<span class="meta">@RequestBody</span> SettlementMarketPayOrderRequestDTO requestDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;营销交易组队结算开始:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, requestDTO.getUserId(), requestDTO.getOutTradeNo());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(requestDTO.getUserId()) || StringUtils.isBlank(requestDTO.getSource()) || StringUtils.isBlank(requestDTO.getChannel()) || StringUtils.isBlank(requestDTO.getOutTradeNo()) || <span class="literal">null</span> == requestDTO.getOutTradeTime()) &#123;</span><br><span class="line">                <span class="keyword">return</span> Response.&lt;SettlementMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                        .code(ResponseCode.ILLEGAL_PARAMETER.getCode())</span><br><span class="line">                        .info(ResponseCode.ILLEGAL_PARAMETER.getInfo())</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 结算服务</span></span><br><span class="line">            <span class="type">TradePaySettlementEntity</span> <span class="variable">tradePaySettlementEntity</span> <span class="operator">=</span> tradeSettlementOrderService.settlementMarketPayOrder(TradePaySuccessEntity.builder()</span><br><span class="line">                    .source(requestDTO.getSource())</span><br><span class="line">                    .channel(requestDTO.getChannel())</span><br><span class="line">                    .userId(requestDTO.getUserId())</span><br><span class="line">                    .outTradeNo(requestDTO.getOutTradeNo())</span><br><span class="line">                    .outTradeTime(requestDTO.getOutTradeTime())</span><br><span class="line">                    .build());</span><br><span class="line"></span><br><span class="line">            <span class="type">SettlementMarketPayOrderResponseDTO</span> <span class="variable">responseDTO</span> <span class="operator">=</span> SettlementMarketPayOrderResponseDTO.builder()</span><br><span class="line">                        .userId(tradePaySettlementEntity.getUserId())</span><br><span class="line">                        .teamId(tradePaySettlementEntity.getTeamId())</span><br><span class="line">                        .activityId(tradePaySettlementEntity.getActivityId())</span><br><span class="line">                        .outTradeNo(tradePaySettlementEntity.getOutTradeNo())</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回结果</span></span><br><span class="line">            Response&lt;SettlementMarketPayOrderResponseDTO&gt; response = Response.&lt;SettlementMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                    .code(ResponseCode.SUCCESS.getCode())</span><br><span class="line">                    .info(ResponseCode.SUCCESS.getInfo())</span><br><span class="line">                    .data(SettlementMarketPayOrderResponseDTO.builder()</span><br><span class="line">                            .userId(tradePaySettlementEntity.getUserId())</span><br><span class="line">                            .teamId(tradePaySettlementEntity.getTeamId())</span><br><span class="line">                            .activityId(tradePaySettlementEntity.getActivityId())</span><br><span class="line">                            .outTradeNo(tradePaySettlementEntity.getOutTradeNo())</span><br><span class="line">                            .build())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;营销交易组队结算完成:&#123;&#125; outTradeNo:&#123;&#125; response:&#123;&#125;&quot;</span>, requestDTO.getUserId(), requestDTO.getOutTradeNo(), JSON.toJSONString(response));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AppException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;营销交易组队结算异常:&#123;&#125; LockMarketPayOrderRequestDTO:&#123;&#125;&quot;</span>, requestDTO.getUserId(), JSON.toJSONString(requestDTO), e);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;SettlementMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                    .code(e.getCode())</span><br><span class="line">                    .info(e.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;营销交易组队结算失败:&#123;&#125; LockMarketPayOrderRequestDTO:&#123;&#125;&quot;</span>, requestDTO.getUserId(), JSON.toJSONString(requestDTO), e);</span><br><span class="line">            <span class="keyword">return</span> Response.&lt;SettlementMarketPayOrderResponseDTO&gt;builder()</span><br><span class="line">                    .code(ResponseCode.UN_ERROR.getCode())</span><br><span class="line">                    .info(ResponseCode.UN_ERROR.getInfo())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>settlementMarketPayOrder</code> 为结算接口，这个接口就是对领域服务 <code>settlementMarketPayOrder</code> 包装即可。</li>
</ul>
<hr>
<h2 id="引入RabbitMQ分布式多端消费"><a class="headerlink" href="#引入RabbitMQ分布式多端消费"></a>引入RabbitMQ分布式多端消费</h2>
<hr>
<p>引入 <code>RabbitMQ</code> 分布式技术框架，实现分布式消息消费和多服务消费的能力。</p>
<p>消息，是一种解耦服务间直接（<code>http</code> / <code>rpc</code>）调用的手段，以发送消息和接收消息的模式，完成业务流程的异步化处理。</p>
<h3 id="1-业务流程-10"><a class="headerlink" href="#1-业务流程-10"></a>1. 业务流程</h3>
<p>在互联网公司中，往往一个微服务发送出来的 <code>MQ</code>，除了自己接收消费处理自己的业务流程，也会有很多其他微服务进行消费。那么这里就会有一个 <code>Topic</code>，被多个应用消费的配置。如图：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506144728977.png" alt="业务流程" loading="lazy"></p>
<ul>
<li>以拼团发送结算完成消息举例，拼团是负载均衡部署了2套服务，发送的 <code>MQ</code> 消息，由小型支付对接。</li>
<li>那么，负载均衡的拼团服务，发送 <code>MQ</code> 后，自己的2套微服务，会分别接收到消息。另外一套小型支付，假设只部署了一套，那么这里会消费5个 <code>MQ</code> 消息。</li>
<li>注意，以 <code>RabbitMQ</code> 举例，这里会需要使用到同一套交换机，同一个路由 <code>Key</code>，但队列要分别每个服务配置不同的。同时消息支持持久化，也就是拼团发送的 <code>MQ</code> 消息，即使小型支付服务暂时没有启动，也可以在启动后消费队列里的 <code>MQ</code> 消息。</li>
<li>这里的 <code>team_success</code> 就是 <code>Topic</code> 主题</li>
</ul>
<h3 id="2-编码实现-14"><a class="headerlink" href="#2-编码实现-14"></a>2. 编码实现</h3>
<h4 id="2-1-引入-POM-文件"><a class="headerlink" href="#2-1-引入-POM-文件"></a>2.1 引入 POM 文件</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rabbitmq https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-amqp --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>要在使用 <code>MQ</code> 的 <code>module</code> 模块下，增加 <code>rabbitmq</code> 配置。这样才能使用对应的方法。<code>group-buy-market-infrastructure</code>、<code>group-buy-market-trigger</code>、<code>group-buy-market-app</code> 都要引入。</li>
</ul>
<h4 id="2-2-生产者-拼团"><a class="headerlink" href="#2-2-生产者-拼团"></a>2.2 生产者 - 拼团</h4>
<p><strong>group-buy-market 拼团营销项目</strong>：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据库配置；启动时配置数据库资源信息</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">addresses:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.109</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次投递n个消息，消费完在投递n个</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">delivery-mode:</span> <span class="string">persistent</span> <span class="comment"># 确保全局默认设置为持久化（可选）</span></span><br><span class="line">    <span class="comment"># 消息配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 生产者</span></span><br><span class="line">      <span class="attr">producer:</span></span><br><span class="line">        <span class="comment"># 绑定交换机，统一一套交换机</span></span><br><span class="line">        <span class="attr">exchange:</span> <span class="string">group_buy_market_exchange</span></span><br><span class="line">        <span class="comment"># 消息主题配置；路由key、队列</span></span><br><span class="line">        <span class="attr">topic_team_success:</span></span><br><span class="line">          <span class="comment"># 消息主题</span></span><br><span class="line">          <span class="attr">routing_key:</span> <span class="string">topic.team_success</span></span><br><span class="line">          <span class="comment"># 消费队列</span></span><br><span class="line">          <span class="attr">queue:</span> <span class="string">group_buy_market_queue_2_topic_team_success</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>首先，<code>spring.rabbitmq</code> 下的 <code>config</code> 为自定义配置，我们在这里配置 <code>MQ</code> 消息生产者信息。</li>
<li>之后，一整套服务，可以使用一个交换机。<code>group_buy_market_exchange</code></li>
<li>然后，一个消息使用一个队列。<code>topic_team_success</code> 是 <code>MQ</code> 消息，下面配置了队列和路由<code>key</code>。</li>
</ul>
<h4 id="2-3-消费者-支付"><a class="headerlink" href="#2-3-消费者-支付"></a>2.3 消费者 - 支付</h4>
<p><strong>market小型支付项目</strong> ：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># RabbitMQ</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">addresses:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.109</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次投递n个消息，消费完在投递n个</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">delivery-mode:</span> <span class="string">persistent</span> <span class="comment"># 确保全局默认设置为持久化（可选）</span></span><br><span class="line">    <span class="comment"># 消息配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">consumer:</span></span><br><span class="line">        <span class="comment"># 消费 topic 主题，team_success</span></span><br><span class="line">        <span class="attr">topic_team_success:</span></span><br><span class="line">          <span class="comment"># 绑定交换机 - 消息提供者的交换机</span></span><br><span class="line">          <span class="attr">exchange:</span> <span class="string">group_buy_market_exchange</span></span><br><span class="line">          <span class="comment"># 消息主题</span></span><br><span class="line">          <span class="attr">routing_key:</span> <span class="string">topic.team_success</span></span><br><span class="line">          <span class="comment"># 消费队列 - 每个系统有自己的消费队列</span></span><br><span class="line">          <span class="attr">queue:</span> <span class="string">s_pay_mall_queue_2_topic_team_success</span></span><br></pre></td></tr></table></figure>
<ul>
<li>首先，<code>spring.rabbitmq</code> 下的 <code>config</code> 为自定义配置，我们在这里配置 <code>MQ</code> 消息消费者信息。</li>
<li>之后，<code>consumer</code> 下，<code>topic_team_success</code> 这个消息，要指定一套交换机，一套消息主题的路由 <code>key</code>，但要使用自己的队列。这个队列就像水桶，分别装 <code>MQ</code> 消息。</li>
</ul>
<h4 id="2-4-代码配置"><a class="headerlink" href="#2-4-代码配置"></a>2.4 代码配置</h4>
<p><strong>生产者 - 拼团</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506151650752.png" alt="生产者-拼团配置" loading="lazy"></p>
<ul>
<li>配置 <code>EventPublisher</code> 发送消息的工具类。</li>
<li>配置 <code>TeamSuccessTopicListener</code> 监听消息的工具类。</li>
</ul>
<p><strong>消费者 - 支付</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506151757392.png" alt="消费者-支付界面" loading="lazy"></p>
<ul>
<li>配置 <code>TeamSuccessTopicListener</code> 监听消息的工具类。</li>
</ul>
<hr>
<h2 id="发送MQ结算消息"><a class="headerlink" href="#发送MQ结算消息"></a>发送MQ结算消息</h2>
<hr>
<p>增加拼团结算完成 <code>MQ</code> 触达方式，<code>HTTP</code>、<code>MQ</code> 触达，由调用方通过入参类型决定。</p>
<p><code>MQ</code> 一般用在企业内的微服务系统间通信，因为企业内的微服务，共用了一套的 <code>MQ</code> 注册中心，<code>MQ</code> 可以更加高效的触达和分布式部署。而对于企业外的调用，与我们完全不是一个公司的系统，那么不再同一个微服务环境内，则需要通过 <code>HTTP</code> 方式这样标准的协议调用。如：支付宝支付完成回调、微信公众号发送消息后的回调，都是基于 <code>HTTP</code> 的方式实现。</p>
<h3 id="1-业务流程-11"><a class="headerlink" href="#1-业务流程-11"></a>1. 业务流程</h3>
<p>如图，<code>HTTP</code>、<code>MQ</code>，由调用方配置使用那种方式进行处理。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506152905640.png" alt="业务流程1" loading="lazy"></p>
<ul>
<li>用户创建营销锁单时，选择<code>MQ</code>、<code>HTTP</code> 回调方式。这个类型会被写入到对应的拼团订单记录里。</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506152957774.png" alt="业务流程2" loading="lazy"></p>
<ul>
<li>拼团完成结算后，在根据写入到拼团订单的记录，回调的方式，来回调通知结算。</li>
</ul>
<h3 id="2-编码实现-15"><a class="headerlink" href="#2-编码实现-15"></a>2. 编码实现</h3>
<h4 id="2-1-库表修改"><a class="headerlink" href="#2-1-库表修改"></a>2.1 库表修改</h4>
<p><strong>拼团组队订单 group_buy_order</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506153111846.png" alt="group_buy_order表" loading="lazy"></p>
<p><strong>拼团回调任务 notify_task</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506153147719.png" alt="notify_task表" loading="lazy"></p>
<h4 id="2-2-锁单链路修改"><a class="headerlink" href="#2-2-锁单链路修改"></a>2.2 锁单链路修改</h4>
<h5 id="2-2-1-研发设计流程"><a class="headerlink" href="#2-2-1-研发设计流程"></a>2.2.1 研发设计流程</h5>
<ol>
<li><code>MarketTradeController</code> 的 <code>lockMarketPayOrder</code> 营销锁单方法入口，<code>LockMarketPayOrderRequestDTO</code> 入参对象增加 <code>NotifyConfigVO</code> 回调配置。也就是让调用方自己设置入参的回调类型。在 <code>LockMarketPayOrderRequestDTO</code> 类中会内聚一些方法，方便参数设置。</li>
<li><code>ITradeLockOrderService</code> 的 <code>lockMarketPayOrder</code> 领域方法，<code>PayDiscountEntity</code> 也需要添加 <code>NotifyConfigVO</code> 对象。只不过这个对象要放在 <code>trade</code> 领域下的值对象里。</li>
<li>数据库操作：<code>GroupBuyOrder</code> 添加回调类型，<code>group_buy_order_mapper.xml</code> 映射回调字段以及插入、查询时，都要增加 <code>notify_type</code> 字段。</li>
<li><code>TradeRepository</code> 的 <code>lockMarketPayOrder</code> 锁单仓储存储时，设置字段值 <code>.notifyType(notifyConfigVO.getNotifyType().getCode())</code> 写入到库里 <code>groupBuyOrderDao.insert(groupBuyOrder);</code> 这样用户在锁单的时候，就把要回调的类型写入进来了。</li>
</ol>
<h5 id="2-2-2-核心代码"><a class="headerlink" href="#2-2-2-核心代码"></a>2.2.2 核心代码</h5>
<p><strong>锁单入参对象</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.trigger.http;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;lock_market_pay_order&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response&lt;LockMarketPayOrderResponseDTO&gt; <span class="title function_">lockMarketPayOrder</span><span class="params">(<span class="meta">@RequestBody</span> LockMarketPayOrderRequestDTO requestDTO)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//... 省略部分代码</span></span><br><span class="line"></span><br><span class="line">marketPayOrderEntity = tradeOrderService.lockMarketPayOrder(</span><br><span class="line">        UserEntity.builder().userId(userId).build(),</span><br><span class="line">        PayActivityEntity.builder()</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .activityId(activityId)</span><br><span class="line">                .activityName(groupBuyActivityDiscountVO.getActivityName())</span><br><span class="line">                .startTime(groupBuyActivityDiscountVO.getStartTime())</span><br><span class="line">                .endTime(groupBuyActivityDiscountVO.getEndTime())</span><br><span class="line">                .validTime(groupBuyActivityDiscountVO.getValidTime())</span><br><span class="line">                .targetCount(groupBuyActivityDiscountVO.getTarget())</span><br><span class="line">                .build(),</span><br><span class="line">        PayDiscountEntity.builder()</span><br><span class="line">                .source(source)</span><br><span class="line">                .channel(channel)</span><br><span class="line">                .goodsId(goodsId)</span><br><span class="line">                .goodsName(trialBalanceEntity.getGoodsName())</span><br><span class="line">                .originalPrice(trialBalanceEntity.getOriginalPrice())</span><br><span class="line">                .deductionPrice(trialBalanceEntity.getDeductionPrice())</span><br><span class="line">                .payPrice(trialBalanceEntity.getPayPrice())</span><br><span class="line">                .outTradeNo(outTradeNo)</span><br><span class="line">                .notifyConfigVO(</span><br><span class="line">                        <span class="comment">// 构建回调通知对象</span></span><br><span class="line">                        NotifyConfigVO.builder()</span><br><span class="line">                                .notifyType(NotifyTypeEnumVO.valueOf(notifyConfigVO.getNotifyType()))</span><br><span class="line">                                .notifyMQ(notifyConfigVO.getNotifyMQ())</span><br><span class="line">                                .notifyUrl(notifyConfigVO.getNotifyUrl())</span><br><span class="line">                                .build())</span><br><span class="line">                .build());</span><br><span class="line">  <span class="comment">// ... 省略部分代码               </span></span><br><span class="line">&#125;                </span><br></pre></td></tr></table></figure>
<ul>
<li>注意入参值的构建 <code>NotifyConfigVO</code>，透传到数据库操作。</li>
</ul>
<p><strong>写入库表</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;    </span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 省略部分代码</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Transactional(timeout = 500)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayOrderEntity <span class="title function_">lockMarketPayOrder</span><span class="params">(GroupBuyOrderAggregate groupBuyOrderAggregate)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 聚合对象信息</span></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getUserEntity();</span><br><span class="line">        <span class="type">PayActivityEntity</span> <span class="variable">payActivityEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getPayActivityEntity();</span><br><span class="line">        <span class="type">PayDiscountEntity</span> <span class="variable">payDiscountEntity</span> <span class="operator">=</span> groupBuyOrderAggregate.getPayDiscountEntity();</span><br><span class="line">        <span class="comment">// 取出notifyConfigVO对象</span></span><br><span class="line">        <span class="type">NotifyConfigVO</span> <span class="variable">notifyConfigVO</span> <span class="operator">=</span> payDiscountEntity.getNotifyConfigVO();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userTakeOrderCount</span> <span class="operator">=</span> groupBuyOrderAggregate.getUserTakeOrderCount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否有团 - teamId 为空 - 新团、为不空 - 老团</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> payActivityEntity.getTeamId();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(teamId)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使用 RandomStringUtils.randomNumeric 替代公司里使用的雪花算法UUID</span></span><br><span class="line">            teamId = RandomStringUtils.randomNumeric(<span class="number">8</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 日期处理</span></span><br><span class="line">            <span class="type">Date</span> <span class="variable">currentDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            calendar.setTime(currentDate);</span><br><span class="line">            calendar.add(Calendar.MINUTE, payActivityEntity.getValidTime());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建拼团订单</span></span><br><span class="line">            <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> GroupBuyOrder.builder()</span><br><span class="line">                    .teamId(teamId)</span><br><span class="line">                    .activityId(payActivityEntity.getActivityId())</span><br><span class="line">                    .source(payDiscountEntity.getSource())</span><br><span class="line">                    .channel(payDiscountEntity.getChannel())</span><br><span class="line">                    .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                    .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                    .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                    .targetCount(payActivityEntity.getTargetCount())</span><br><span class="line">                    .completeCount(<span class="number">0</span>)</span><br><span class="line">                    .lockCount(<span class="number">1</span>)</span><br><span class="line">                    .validStartTime(currentDate)</span><br><span class="line">                    .validEndTime(calendar.getTime())</span><br><span class="line">                    .notifyType(notifyConfigVO.getNotifyType().getCode())</span><br><span class="line">                    .notifyUrl(notifyConfigVO.getNotifyUrl())</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入记录</span></span><br><span class="line">            groupBuyOrderDao.insert(groupBuyOrder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新记录 - 如果更新记录不等于1，则表示拼团已满，抛出异常</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">updateAddTargetCount</span> <span class="operator">=</span> groupBuyOrderDao.updateAddLockCount(teamId);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> != updateAddTargetCount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0005);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 RandomStringUtils.randomNumeric 替代公司里使用的雪花算法UUID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> RandomStringUtils.randomNumeric(<span class="number">12</span>);</span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> GroupBuyOrderList.builder()</span><br><span class="line">                .userId(userEntity.getUserId())</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .orderId(orderId)</span><br><span class="line">                .activityId(payActivityEntity.getActivityId())</span><br><span class="line">                .startTime(payActivityEntity.getStartTime())</span><br><span class="line">                .endTime(payActivityEntity.getEndTime())</span><br><span class="line">                .goodsId(payDiscountEntity.getGoodsId())</span><br><span class="line">                .source(payDiscountEntity.getSource())</span><br><span class="line">                .channel(payDiscountEntity.getChannel())</span><br><span class="line">                .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                .status(TradeOrderStatusEnumVO.CREATE.getCode())</span><br><span class="line">                .outTradeNo(payDiscountEntity.getOutTradeNo())</span><br><span class="line">                <span class="comment">// 构建 bizId 唯一值；活动id_用户id_参与次数累加</span></span><br><span class="line">                .bizId(payActivityEntity.getActivityId() + Constants.UNDERLINE + userEntity.getUserId() + Constants.UNDERLINE + (userTakeOrderCount + <span class="number">1</span>))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入拼团记录</span></span><br><span class="line">            groupBuyOrderListDao.insert(groupBuyOrderListReq);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.INDEX_EXCEPTION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MarketPayOrderEntity.builder()</span><br><span class="line">                .orderId(orderId)</span><br><span class="line">                .originalPrice(payDiscountEntity.getOriginalPrice())</span><br><span class="line">                .deductionPrice(payDiscountEntity.getDeductionPrice())</span><br><span class="line">                .payPrice(payDiscountEntity.getPayPrice())</span><br><span class="line">                .tradeOrderStatusEnumVO(TradeOrderStatusEnumVO.CREATE)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>.notifyType(notifyConfigVO.getNotifyType().getCode())</code> 注意，写入拼团组队订单透传回调类型。</li>
</ul>
<h4 id="2-3-结算链路"><a class="headerlink" href="#2-3-结算链路"></a>2.3 结算链路</h4>
<h5 id="2-3-1-研发设计流程"><a class="headerlink" href="#2-3-1-研发设计流程"></a>2.3.1 研发设计流程</h5>
<ol>
<li>拼团结算的过程，会先过滤 <code>filter</code>，在 <code>SettableRuleFilter</code> 过滤器中，执行拼团对象查询时候，在仓储层组装出拼团回调配置数据。</li>
<li><code>TradeRepository</code> 的 <code>settlementMarketPayOrder</code> 结算入库数据，按照不同的回调类型，写入进 <code>notify_task</code> 表中。</li>
<li>根据拼团交易结算是否完成，使用多线程异步执行发送 <code>MQ</code> 或者 <code>HTTP</code> 回调。这部分异步操作就好，即时触达。即时失败了，也会有任务兜底操作。</li>
<li><code>TradePort</code> 执行任务分为 <code>HTTP</code>、<code>MQ</code>，来触达回调。</li>
</ol>
<h5 id="2-3-2-核心代码"><a class="headerlink" href="#2-3-2-核心代码"></a>2.3.2 核心代码</h5>
<p><strong>拼团查询</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GroupBuyTeamEntity <span class="title function_">queryGroupBuyTeamByTeamId</span><span class="params">(String teamId)</span> &#123;</span><br><span class="line">        <span class="type">GroupBuyOrder</span> <span class="variable">groupBuyOrder</span> <span class="operator">=</span> groupBuyOrderDao.queryGroupBuyTeamByTeamId(teamId);</span><br><span class="line">        <span class="keyword">return</span> GroupBuyTeamEntity.builder()</span><br><span class="line">                .teamId(groupBuyOrder.getTeamId())</span><br><span class="line">                .activityId(groupBuyOrder.getActivityId())</span><br><span class="line">                .targetCount(groupBuyOrder.getTargetCount())</span><br><span class="line">                .completeCount(groupBuyOrder.getCompleteCount())</span><br><span class="line">                .lockCount(groupBuyOrder.getLockCount())</span><br><span class="line">                .status(GroupBuyOrderEnumVO.valueOf(groupBuyOrder.getStatus()))</span><br><span class="line">                .validStartTime(groupBuyOrder.getValidStartTime())</span><br><span class="line">                .validEndTime(groupBuyOrder.getValidEndTime())</span><br><span class="line">                .notifyConfigVO(NotifyConfigVO.builder()</span><br><span class="line">                        .notifyType(NotifyTypeEnumVO.valueOf(groupBuyOrder.getNotifyType()))</span><br><span class="line">                        .notifyUrl(groupBuyOrder.getNotifyUrl())</span><br><span class="line">                        <span class="comment">// MQ 是固定的</span></span><br><span class="line">                        .notifyMQ(topic_team_success)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查询出拼团数据，这里要返回拼团的回调类型。</li>
<li>回调 <code>MQ</code> 是固定的，不需要外部透彻。</li>
</ul>
<p><strong>回调任务</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.infrastructure.adapter.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line">    <span class="comment">// ... 省略部分代码</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Transactional(timeout = 500)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> NotifyTaskEntity <span class="title function_">settlementMarketPayOrder</span><span class="params">(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">UserEntity</span> <span class="variable">userEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getUserEntity();</span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity();</span><br><span class="line">        <span class="type">NotifyConfigVO</span> <span class="variable">notifyConfigVO</span> <span class="operator">=</span> groupBuyTeamEntity.getNotifyConfigVO();</span><br><span class="line">        <span class="type">TradePaySuccessEntity</span> <span class="variable">tradePaySuccessEntity</span> <span class="operator">=</span> groupBuyTeamSettlementAggregate.getTradePaySuccessEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 更新拼团订单明细状态</span></span><br><span class="line">        <span class="type">GroupBuyOrderList</span> <span class="variable">groupBuyOrderListReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupBuyOrderList</span>();</span><br><span class="line">        groupBuyOrderListReq.setUserId(userEntity.getUserId());</span><br><span class="line">        groupBuyOrderListReq.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        groupBuyOrderListReq.setOutTradeTime(tradePaySuccessEntity.getOutTradeTime());</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateOrderListStatusCount</span> <span class="operator">=</span> groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderListReq);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> != updateOrderListStatusCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.UPDATE_ZERO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 更新拼团达成数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateAddCount</span> <span class="operator">=</span> groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> != updateAddCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.UPDATE_ZERO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 更新拼团完成状态</span></span><br><span class="line">        <span class="keyword">if</span> (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">updateOrderStatusCount</span> <span class="operator">=</span> groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId());</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> != updateOrderStatusCount) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.UPDATE_ZERO);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询拼团交易完成外部单号列表</span></span><br><span class="line">            List&lt;String&gt; outTradeNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼团完成写入回调任务记录</span></span><br><span class="line">            <span class="type">NotifyTask</span> <span class="variable">notifyTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotifyTask</span>();</span><br><span class="line">            notifyTask.setActivityId(groupBuyTeamEntity.getActivityId());</span><br><span class="line">            notifyTask.setTeamId(groupBuyTeamEntity.getTeamId());</span><br><span class="line">            notifyTask.setNotifyType(notifyConfigVO.getNotifyType().getCode());</span><br><span class="line">            notifyTask.setNotifyMQ(NotifyTypeEnumVO.MQ.equals(notifyConfigVO.getNotifyType()) ? notifyConfigVO.getNotifyMQ() : <span class="literal">null</span>);</span><br><span class="line">            notifyTask.setNotifyUrl(NotifyTypeEnumVO.HTTP.equals(notifyConfigVO.getNotifyType()) ? notifyConfigVO.getNotifyUrl() : <span class="literal">null</span>);</span><br><span class="line">            notifyTask.setNotifyCount(<span class="number">0</span>);</span><br><span class="line">            notifyTask.setNotifyStatus(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            notifyTask.setParameterJson(JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;() &#123;&#123;</span><br><span class="line">                put(<span class="string">&quot;teamId&quot;</span>, groupBuyTeamEntity.getTeamId());</span><br><span class="line">                put(<span class="string">&quot;outTradeNoList&quot;</span>, outTradeNoList);</span><br><span class="line">            &#125;&#125;));</span><br><span class="line"></span><br><span class="line">            notifyTaskDao.insert(notifyTask);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NotifyTaskEntity.builder()</span><br><span class="line">                    .teamId(notifyTask.getTeamId())</span><br><span class="line">                    .notifyType(notifyTask.getNotifyType())</span><br><span class="line">                    .notifyMQ(notifyTask.getNotifyMQ())</span><br><span class="line">                    .notifyUrl(notifyTask.getNotifyUrl())</span><br><span class="line">                    .notifyCount(notifyTask.getNotifyCount())</span><br><span class="line">                    .parameterJson(notifyTask.getParameterJson())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>这部分主要就是往 <code>notifyTaskDao.insert(notifyTask);</code> 写入数据的时候，要判断好写入的回调类型。因为任务还要被执行选择不同的类型来发 <code>MQ</code> 或者调用 <code>HTTP</code> 接口。</li>
</ul>
<p><strong>异步任务</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.settlement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeSettlementOrderService</span> <span class="keyword">implements</span> <span class="title class_">ITradeSettlementOrderService</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradePaySettlementEntity <span class="title function_">settlementMarketPayOrder</span><span class="params">(TradePaySuccessEntity tradePaySuccessEntity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团交易-支付订单结算:&#123;&#125; outTradeNo:&#123;&#125;&quot;</span>, tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 结算规则过滤</span></span><br><span class="line">        <span class="type">TradeSettlementRuleFilterBackEntity</span> <span class="variable">tradeSettlementRuleFilterBackEntity</span> <span class="operator">=</span> tradeSettlementRuleFilter.apply(</span><br><span class="line">                TradeSettlementRuleCommandEntity.builder()</span><br><span class="line">                        .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                        .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                        .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                        .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                        .outTradeTime(tradePaySuccessEntity.getOutTradeTime())</span><br><span class="line">                        .build(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TradeSettlementRuleFilterFactory</span>.DynamicContext());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> tradeSettlementRuleFilterBackEntity.getTeamId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查询组团信息</span></span><br><span class="line">        <span class="type">GroupBuyTeamEntity</span> <span class="variable">groupBuyTeamEntity</span> <span class="operator">=</span> GroupBuyTeamEntity.builder()</span><br><span class="line">                .teamId(tradeSettlementRuleFilterBackEntity.getTeamId())</span><br><span class="line">                .activityId(tradeSettlementRuleFilterBackEntity.getActivityId())</span><br><span class="line">                .targetCount(tradeSettlementRuleFilterBackEntity.getTargetCount())</span><br><span class="line">                .completeCount(tradeSettlementRuleFilterBackEntity.getCompleteCount())</span><br><span class="line">                .lockCount(tradeSettlementRuleFilterBackEntity.getLockCount())</span><br><span class="line">                .status(tradeSettlementRuleFilterBackEntity.getStatus())</span><br><span class="line">                .validStartTime(tradeSettlementRuleFilterBackEntity.getValidStartTime())</span><br><span class="line">                .validEndTime(tradeSettlementRuleFilterBackEntity.getValidEndTime())</span><br><span class="line">                .notifyConfigVO(tradeSettlementRuleFilterBackEntity.getNotifyConfigVO())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建聚合对象</span></span><br><span class="line">        <span class="type">GroupBuyTeamSettlementAggregate</span> <span class="variable">groupBuyTeamSettlementAggregate</span> <span class="operator">=</span> GroupBuyTeamSettlementAggregate.builder()</span><br><span class="line">                .userEntity(UserEntity.builder().userId(tradePaySuccessEntity.getUserId()).build())</span><br><span class="line">                .groupBuyTeamEntity(groupBuyTeamEntity)</span><br><span class="line">                .tradePaySuccessEntity(tradePaySuccessEntity)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 拼团交易结算</span></span><br><span class="line">        <span class="type">NotifyTaskEntity</span> <span class="variable">notifyTaskEntity</span> <span class="operator">=</span> repository.settlementMarketPayOrder(groupBuyTeamSettlementAggregate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 组队回调处理 - 处理失败也会有定时任务补偿，通过这样的方式，可以减轻任务调度，提高时效性</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != notifyTaskEntity) &#123;</span><br><span class="line">            threadPoolExecutor.execute(() -&gt; &#123;</span><br><span class="line">                Map&lt;String, Integer&gt; notifyResultMap = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    notifyResultMap = execSettlementNotifyJob(notifyTaskEntity);</span><br><span class="line">                    log.info(<span class="string">&quot;回调通知拼团完结 result:&#123;&#125;&quot;</span>, JSON.toJSONString(notifyResultMap));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;回调通知拼团完结失败 result:&#123;&#125;&quot;</span>, JSON.toJSONString(notifyResultMap), e);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 返回结算信息 - 公司中开发这样的流程时候，会根据外部需要进行值的设置</span></span><br><span class="line">        <span class="keyword">return</span> TradePaySettlementEntity.builder()</span><br><span class="line">                .source(tradePaySuccessEntity.getSource())</span><br><span class="line">                .channel(tradePaySuccessEntity.getChannel())</span><br><span class="line">                .userId(tradePaySuccessEntity.getUserId())</span><br><span class="line">                .teamId(teamId)</span><br><span class="line">                .activityId(groupBuyTeamEntity.getActivityId())</span><br><span class="line">                .outTradeNo(tradePaySuccessEntity.getOutTradeNo())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>引入多线程，异步执行结算任务。</li>
</ul>
<p><strong>触达回调</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradePort</span> <span class="keyword">implements</span> <span class="title class_">ITradePort</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GroupBuyNotifyService groupBuyNotifyService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IRedisService redisService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EventPublisher publisher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">groupBuyNotify</span><span class="params">(NotifyTaskEntity notifyTask)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisService.getLock(notifyTask.lockKey());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// group-buy-market 拼团服务端会被部署到多台应用服务器上，那么就会有很多任务一起执行。这个时候要进行抢占，避免被多次执行</span></span><br><span class="line">            <span class="keyword">if</span> (lock.tryLock(<span class="number">3</span>, <span class="number">0</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 回调方式 HTTP</span></span><br><span class="line">                    <span class="keyword">if</span> (NotifyTypeEnumVO.HTTP.getCode().equals(notifyTask.getNotifyType())) &#123;</span><br><span class="line">                        <span class="comment">// 无效的 notifyUrl 则直接返回成功</span></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isBlank(notifyTask.getNotifyUrl()) || <span class="string">&quot;暂无&quot;</span>.equals(notifyTask.getNotifyUrl())) &#123;</span><br><span class="line">                            <span class="keyword">return</span> NotifyTaskHTTPEnumVO.SUCCESS.getCode();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> groupBuyNotifyService.groupBuyNotify(notifyTask.getNotifyUrl(), notifyTask.getParameterJson());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 回调方式 MQ</span></span><br><span class="line">                    <span class="keyword">if</span> (NotifyTypeEnumVO.MQ.getCode().equals(notifyTask.getNotifyType())) &#123;</span><br><span class="line">                        publisher.publish(notifyTask.getNotifyMQ(), notifyTask.getParameterJson());</span><br><span class="line">                        <span class="keyword">return</span> NotifyTaskHTTPEnumVO.SUCCESS.getCode();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (lock.isLocked() &amp;&amp; lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                        lock.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> NotifyTaskHTTPEnumVO.NULL.getCode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="keyword">return</span> NotifyTaskHTTPEnumVO.NULL.getCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这部分会根据 <code>HTTP</code>、<code>MQ</code>，分别以不同的方式进行触达。如果还有其他回调方式，可以考虑使用策略模式封装。</li>
</ul>
<hr>
<h2 id="消费MQ结算消息"><a class="headerlink" href="#消费MQ结算消息"></a>消费MQ结算消息</h2>
<hr>
<p>完善支付商城对拼团组队结算消息的处理，同时完成小型支付商城中支付交易结算消息的处理。这样我们整个系统就都具备分布式部署的能力了。也就是多个应用实例同时部署，一个MQ在一个应用实例消费宕机，可以被其他应用实例继续拉取消费。</p>
<h3 id="1-业务流程-12"><a class="headerlink" href="#1-业务流程-12"></a>1. 业务流程</h3>
<p>如图，<code>MQ</code> 在小型支付和拼团的执行流程。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506180330183.png" alt="业务流程" loading="lazy"></p>
<ul>
<li><code>MQ</code> 具有解耦、消峰，最终一致性的特性。所以很多的分布式设计中，都会引入 <code>MQ</code> 来解耦复杂的业务流程，除了数据库事务处理外的流程节点，则由 <code>MQ</code> 进行驱动。</li>
<li>从拼团下单到锁单结算，完成后触达 <code>MQ</code> 消费。之后由支付商城消费 <code>MQ</code> 结算消息，变更订单状态，之后触达下一个支付结算的动作。在接收支付结算完成模拟发货。第二个 <code>MQ</code> 的发送不用写数据库任务来补偿，如果发 <code>MQ</code> 失败了，就直接抛异常重试继续发就可以。</li>
</ul>
<h3 id="2-编码实现-16"><a class="headerlink" href="#2-编码实现-16"></a>2. 编码实现</h3>
<h4 id="2-1-RabbitMQ-后台"><a class="headerlink" href="#2-1-RabbitMQ-后台"></a>2.1 RabbitMQ 后台</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506182306923.png" alt="RabbitMQ 后台" loading="lazy"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://192.168.1.109:15672/#/queues">http://192.168.1.109:15672/#/queues</a> - 修改为你的地址进入。</li>
<li>这里的交换机（Exchanges）、队列会随着系统启动使用创建。你也可以手动创建。</li>
</ul>
<h4 id="2-2-消费结算消息"><a class="headerlink" href="#2-2-消费结算消息"></a>2.2 消费结算消息</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeamSuccessTopicListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定消费队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(</span></span><br><span class="line"><span class="meta">            bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">                    value = @Queue(value = &quot;$&#123;spring.rabbitmq.config.consumer.topic_team_success.queue&#125;&quot;),</span></span><br><span class="line"><span class="meta">                    exchange = @Exchange(value = &quot;$&#123;spring.rabbitmq.config.consumer.topic_team_success.exchange&#125;&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">                    key = &quot;$&#123;spring.rabbitmq.config.consumer.topic_team_success.routing_key&#125;&quot;</span></span><br><span class="line"><span class="meta">            )</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">NotifyRequestDTO</span> <span class="variable">requestDTO</span> <span class="operator">=</span> JSON.parseObject(message, NotifyRequestDTO.class);</span><br><span class="line">            log.info(<span class="string">&quot;拼团回调，组队完成，结算开始 &#123;&#125;&quot;</span>, JSON.toJSONString(requestDTO));</span><br><span class="line">            <span class="comment">// 营销结算</span></span><br><span class="line">            orderService.changeOrderMarketSettlement(requestDTO.getOutTradeNoList());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;拼团回调，组队完成，结算失败 &#123;&#125;&quot;</span>, message, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>listener</code> 监听方法内，调用营销结算。这个营销结算其实就是以前 <code>http</code> 回调里的操作。现在迁移过来。</li>
</ul>
<h4 id="2-3-增加支付结算MQ"><a class="headerlink" href="#2-3-增加支付结算MQ"></a>2.3 增加支付结算MQ</h4>
<p>这一部分，我们要在小型支付系统自己发送支付完成结算的 <code>MQ</code>，再消费这个 <code>MQ</code>。通过这个方式替换掉原来依赖于 <code>Guava</code> 的发布订阅模型。因为 <code>Guava</code> 没法让不同实例间负载消费（也就是A1应用发送的消息，A2应用不能消费。而分布式架构技术栈 <code>MQ</code> 是可以的）。</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506182600081.png" alt="增加支付结算MQ" loading="lazy"></p>
<ul>
<li>生产者，<code>topic_order_pay_success</code>，是订单结算消息。分别在使用拼团和没有使用拼团结算发送消息。</li>
<li>消费者，<code>topic_order_pay_success</code>，消费触达结算动作。另外一个拼团组队成功的消息则是前面已经对接的。</li>
</ul>
<h4 id="2-4-发送，支付成功结算消息"><a class="headerlink" href="#2-4-发送，支付成功结算消息"></a>2.4 发送，支付成功结算消息</h4>
<p><strong>添加事件消息发送方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventPublisher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.config.producer.topic_order_pay_success.exchange&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String exchangeName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(String routingKey, String message)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(exchangeName, routingKey, message, m -&gt; &#123;</span><br><span class="line">                <span class="comment">// 持久化消息配置</span></span><br><span class="line">                m.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);</span><br><span class="line">                <span class="keyword">return</span> m;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;发送MQ消息失败 routingKey:&#123;&#125; message:&#123;&#125;&quot;</span>, routingKey, message, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个类放到 <code>s-pay-mall-ddd-infrastructure</code> 下的 <code>event</code> 中。</li>
</ul>
<p><strong>发送MQ消息</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeOrderPaySuccess</span><span class="params">(String orderId, Date payTime)</span> &#123;</span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">payOrderReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayOrder</span>();</span><br><span class="line">    payOrderReq.setOrderId(orderId);</span><br><span class="line">    payOrderReq.setStatus(OrderStatusVO.PAY_SUCCESS.getCode());</span><br><span class="line">    payOrderReq.setPayTime(payTime);</span><br><span class="line">    orderDao.changeOrderPaySuccess(payOrderReq);</span><br><span class="line">    <span class="comment">// 不走拼团营销的直接结算发货</span></span><br><span class="line">    BaseEvent.EventMessage&lt;PaySuccessMessageEvent.PaySuccessMessage&gt; paySuccessMessageEventMessage = paySuccessMessageEvent.buildEventMessage(</span><br><span class="line">            PaySuccessMessageEvent.PaySuccessMessage.builder()</span><br><span class="line">                    .tradeNo(orderId)</span><br><span class="line">                    .build());</span><br><span class="line">    PaySuccessMessageEvent.<span class="type">PaySuccessMessage</span> <span class="variable">paySuccessMessage</span> <span class="operator">=</span> paySuccessMessageEventMessage.getData();</span><br><span class="line">    <span class="comment">// 旧版发送消息方式</span></span><br><span class="line">    <span class="comment">// eventBus.post(JSON.toJSONString(paySuccessMessage));</span></span><br><span class="line">    eventPublisher.publish(paySuccessMessageEvent.topic(), JSON.toJSONString(paySuccessMessage));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeOrderMarketSettlement</span><span class="params">(List&lt;String&gt; outTradeNoList)</span> &#123;</span><br><span class="line">    <span class="comment">// 更新拼团结算状态</span></span><br><span class="line">    orderDao.changeOrderMarketSettlement(outTradeNoList);</span><br><span class="line">    <span class="comment">// 循环成功发送消息 - 一般在公司的场景里，还会有job任务扫描超时没有结算的订单，查询订单状态。查询对方服务端的接口，会被限制一次查询多少，频次多少。</span></span><br><span class="line">    outTradeNoList.forEach(outTradeNo -&gt; &#123;</span><br><span class="line">        BaseEvent.EventMessage&lt;PaySuccessMessageEvent.PaySuccessMessage&gt; paySuccessMessageEventMessage = paySuccessMessageEvent.buildEventMessage(</span><br><span class="line">                PaySuccessMessageEvent.PaySuccessMessage.builder()</span><br><span class="line">                        .tradeNo(outTradeNo)</span><br><span class="line">                        .build());</span><br><span class="line">        PaySuccessMessageEvent.<span class="type">PaySuccessMessage</span> <span class="variable">paySuccessMessage</span> <span class="operator">=</span> paySuccessMessageEventMessage.getData();</span><br><span class="line">        <span class="comment">// 旧版发送消息方式</span></span><br><span class="line">        <span class="comment">// eventBus.post(JSON.toJSONString(paySuccessMessage));</span></span><br><span class="line">        eventPublisher.publish(paySuccessMessageEvent.topic(), JSON.toJSONString(paySuccessMessage));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>两处发送 <code>MQ</code> 的操作。</li>
</ul>
<p><strong>消费，支付成功结算消息</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderPaySuccessListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IGoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Subscribe - 旧版发布订阅方式</span></span><br><span class="line">    <span class="meta">@RabbitListener(</span></span><br><span class="line"><span class="meta">            bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">                    value = @Queue(value = &quot;$&#123;spring.rabbitmq.config.consumer.topic_order_pay_success.queue&#125;&quot;),</span></span><br><span class="line"><span class="meta">                    exchange = @Exchange(value = &quot;$&#123;spring.rabbitmq.config.consumer.topic_order_pay_success.exchange&#125;&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">                    key = &quot;$&#123;spring.rabbitmq.config.consumer.topic_order_pay_success.routing_key&#125;&quot;</span></span><br><span class="line"><span class="meta">            )</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">(String paySuccessMessageJson)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;收到支付成功消息 &#123;&#125;&quot;</span>, paySuccessMessageJson);</span><br><span class="line"></span><br><span class="line">            PaySuccessMessageEvent.<span class="type">PaySuccessMessage</span> <span class="variable">paySuccessMessage</span> <span class="operator">=</span> JSON.parseObject(paySuccessMessageJson, PaySuccessMessageEvent.PaySuccessMessage.class);</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;模拟发货（如；发货、充值、开户员、返利），单号:&#123;&#125;&quot;</span>, paySuccessMessage.getTradeNo());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 变更订单状态 - 发货完成&amp;结算</span></span><br><span class="line">            goodsService.changeOrderDealDone(paySuccessMessage.getTradeNo());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 可以打开测试，MQ 消费失败，会抛异常，之后重试消费。这个也是最终执行的重要手段。</span></span><br><span class="line">            <span class="comment">// throw new RuntimeException(&quot;重试消费&quot;);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;收到支付成功消息失败 &#123;&#125;&quot;</span>, paySuccessMessageJson,e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-5-锁单API对接"><a class="headerlink" href="#2-5-锁单API对接"></a>2.5 锁单API对接</h4>
<p>拼团的锁单增加了使用 <code>MQ</code>、<code>HTTP</code> 不同方式进行处理。所以这部分要处理下对接的接口，增加 <code>MQ</code> 的配置。</p>
<h5 id="2-5-1-配置请求对象"><a class="headerlink" href="#2-5-1-配置请求对象"></a>2.5.1 配置请求对象</h5>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506183028854.png" alt="配置请求对象" loading="lazy"></p>
<ul>
<li>需要在原有的 <code>LockMarketPayOrderRequestDTO</code> 请求对象，新增加回调配置。</li>
<li>这个配置类也就是拼团 <code>API</code> 模块下的配置类。</li>
</ul>
<h5 id="2-5-2-使用请求对象"><a class="headerlink" href="#2-5-2-使用请求对象"></a>2.5.2 使用请求对象</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductPort</span> <span class="keyword">implements</span> <span class="title class_">IProductPort</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.config.group-buy-market.source&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String source;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.config.group-buy-market.chanel&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String chanel;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.config.group-buy-market.notify-url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProductRPC productRPC;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IGroupBuyMarketService groupBuyMarketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MarketPayDiscountEntity <span class="title function_">lockMarketPayOrder</span><span class="params">(String userId, String teamId, Long activityId, String productId, String orderId)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求参数</span></span><br><span class="line">        <span class="type">LockMarketPayOrderRequestDTO</span> <span class="variable">requestDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LockMarketPayOrderRequestDTO</span>();</span><br><span class="line">        requestDTO.setUserId(userId);</span><br><span class="line">        requestDTO.setTeamId(teamId);</span><br><span class="line">        requestDTO.setGoodsId(productId);</span><br><span class="line">        requestDTO.setActivityId(activityId);</span><br><span class="line">        requestDTO.setSource(source);</span><br><span class="line">        requestDTO.setChannel(chanel);</span><br><span class="line">        requestDTO.setOutTradeNo(orderId);</span><br><span class="line"><span class="comment">//        requestDTO.setNotifyUrl(notifyUrl);</span></span><br><span class="line">        requestDTO.setNotifyMQ();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 营销锁单</span></span><br><span class="line">            Call&lt;Response&lt;LockMarketPayOrderResponseDTO&gt;&gt; call = groupBuyMarketService.lockMarketPayOrder(requestDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取结果</span></span><br><span class="line">            Response&lt;LockMarketPayOrderResponseDTO&gt; response = call.execute().body();</span><br><span class="line">            log.info(<span class="string">&quot;营销锁单&#123;&#125; requestDTO:&#123;&#125; responseDTO:&#123;&#125;&quot;</span>, userId, JSON.toJSONString(requestDTO), JSON.toJSONString(response));</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == response) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 异常判断</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;0000&quot;</span>.equals(response.getCode())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(response.getCode(), response.getInfo());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">LockMarketPayOrderResponseDTO</span> <span class="variable">responseDTO</span> <span class="operator">=</span> response.getData();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取拼团优惠</span></span><br><span class="line">            <span class="keyword">return</span> MarketPayDiscountEntity.builder()</span><br><span class="line">                    .originalPrice(responseDTO.getOriginalPrice())</span><br><span class="line">                    .deductionPrice(responseDTO.getDeductionPrice())</span><br><span class="line">                    .payPrice(responseDTO.getPayPrice())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;营销锁单失败&#123;&#125;&quot;</span>, userId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>requestDTO.setNotifyMQ();</code> 增加使用 <code>MQ</code> 方式进行对接。</li>
</ul>
<hr>
<h2 id="独占锁和无锁化场景运用"><a class="headerlink" href="#独占锁和无锁化场景运用"></a>独占锁和无锁化场景运用</h2>
<hr>
<p>以独占锁抢占方式，迭代拼团结算通知互备执行任务。再以无锁化设计，处理用户拼团锁单，库存抢占处理，降低对数据库的行锁压力，提高整体吞吐量。</p>
<h3 id="1-业务流程-13"><a class="headerlink" href="#1-业务流程-13"></a>1. 业务流程</h3>
<p>如图，两种锁应对的场景：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506183343087.png" alt="两种锁应对的场景" loading="lazy"></p>
<ul>
<li>分段锁，颗粒度缩小到库存维度。先加（<code>incr</code>）后锁的操作，是一种无锁化设计。锁的目的只是作为兜底。这类似于我们操作账户，操作完写一条流水。<code>incr</code> 操作是原子的，基本不会产生一样的值。但在实际生产中，遇到过集群的运维配置问题，以及业务运营配置数据问题，导致 <code>incr</code> 得到的值相同。</li>
<li>独占锁，在分布式架构系统设计中，会有多个实例部署。这些实例都会做 <code>job</code> 任务的执行，为了保障既能让任务互备，同时不要重复执行。这里要加独占锁，谁抢占到谁执行。执行完成后，释放锁，下一轮继续抢占。</li>
</ul>
<h3 id="2-编码实现-17"><a class="headerlink" href="#2-编码实现-17"></a>2. 编码实现</h3>
<h4 id="2-1-独占锁"><a class="headerlink" href="#2-1-独占锁"></a>2.1 独占锁</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupBuyNotifyJob</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeSettlementOrderService tradeSettlementOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 0 * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 为什么加锁？分布式应用N台机器部署互备（一个应用实例挂了，还有另外可用的），任务调度会有N个同时执行，那么这里需要增加抢占机制，谁抢占到谁就执行。完毕后，下一轮继续抢占。</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;group_buy_market_notify_job_exec&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLocked</span> <span class="operator">=</span> lock.tryLock(<span class="number">3</span>, <span class="number">0</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!isLocked) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            Map&lt;String, Integer&gt; result = tradeSettlementOrderService.execSettlementNotifyJob();</span><br><span class="line">            log.info(<span class="string">&quot;定时任务，回调通知拼团完结任务 result:&#123;&#125;&quot;</span>, JSON.toJSONString(result));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;定时任务，回调通知拼团完结任务失败&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lock.isLocked() &amp;&amp; lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在执行任务时，要抢占一个锁，谁抢占到谁就执行。</li>
<li>这种独占锁的设计，也是大家最为常用的。但有一些场景是不适合使用的，比如：集中式库存的抢占，这类场景如果使用独占锁，就会出现排队现象，所有的竞争用户都要等待上一个释放锁才能继续执行。这样会大大的降低系统的吞吐量。</li>
</ul>
<h4 id="2-2-无锁化（乐观锁）"><a class="headerlink" href="#2-2-无锁化（乐观锁）"></a>2.2 无锁化（乐观锁）</h4>
<h5 id="2-2-1-更改部分"><a class="headerlink" href="#2-2-1-更改部分"></a>2.2.1 更改部分</h5>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506184425315.png" alt="无锁化（乐观锁）" loading="lazy"></p>
<ul>
<li>在 <code>trade</code> 交易下，锁单 <code>filter</code> 过滤中，添加一个组队库存占用规则过滤。再有了设计的使用后，你会发现，想扩展新的功能既不会污染织染的逻辑，也不会让加入就得大量做 <code>if···else</code> 判断。而是非常优雅的加入，之后在 <code>TradeLockRuleFilterFactory</code> 配置上即可。</li>
</ul>
<h5 id="2-2-2-责任链-组队库存规则"><a class="headerlink" href="#2-2-2-责任链-组队库存规则"></a>2.2.2 责任链 - 组队库存规则</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.bugstack.domain.trade.service.lock.filter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeamStockOccupyRuleFilter</span> <span class="keyword">implements</span> <span class="title class_">ILogicHandler</span>&lt;TradeLockRuleCommandEntity, TradeLockRuleFilterFactory.DynamicContext, TradeLockRuleFilterBackEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ITradeRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TradeLockRuleFilterBackEntity <span class="title function_">apply</span><span class="params">(TradeLockRuleCommandEntity requestParameter, TradeLockRuleFilterFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;交易规则过滤-组队库存校验&#123;&#125; activityId:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getActivityId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. teamId 为空，则为首次开团，不做拼团组队目标量库存限制</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">teamId</span> <span class="operator">=</span> requestParameter.getTeamId();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(teamId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> TradeLockRuleFilterBackEntity.builder()</span><br><span class="line">                    .userTakeOrderCount(dynamicContext.getUserTakeOrderCount())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 抢占库存；通过抢占 Redis 缓存库存，来降低对数据库的操作压力。</span></span><br><span class="line">        <span class="type">GroupBuyActivityEntity</span> <span class="variable">groupBuyActivity</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivity();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">target</span> <span class="operator">=</span> groupBuyActivity.getTarget();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">validTime</span> <span class="operator">=</span> groupBuyActivity.getValidTime();</span><br><span class="line">        <span class="type">String</span> <span class="variable">teamStockKey</span> <span class="operator">=</span> dynamicContext.generateTeamStockKey(teamId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">recoveryTeamStockKey</span> <span class="operator">=</span> dynamicContext.generateRecoveryTeamStockKey(teamId);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> repository.occupyTeamStock(teamStockKey, recoveryTeamStockKey, target, validTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!status) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;交易规则过滤-组队库存校验&#123;&#125; activityId:&#123;&#125; 抢占失败:&#123;&#125;&quot;</span>, requestParameter.getUserId(), requestParameter.getActivityId(), teamStockKey);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0008);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TradeLockRuleFilterBackEntity.builder()</span><br><span class="line">                .userTakeOrderCount(dynamicContext.getUserTakeOrderCount())</span><br><span class="line">                .recoveryTeamStockKey(recoveryTeamStockKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>首先，如果 <code>teamId</code> 为空，则不需要做库存的抢占。抢占库存是在一个 <code>team</code> 已经创建完成后，再有用户开始参与抢占时候，这个时候要做库存的缓存扣减处理。</li>
<li>之后，从上下文中获取到组队的目标量，有效期时间，以及组队的key和恢复量key。这个恢复量的用途是我们扣了 <code>redis</code> 中组队的任务缓存，但这个时候，发生异常了。那么我们要记录一个这样的数据。等做库存使用对比量的时候，可以用 target 目标量 + 恢复量一起来比。</li>
</ul>
<h5 id="2-2-3-占用库存"><a class="headerlink" href="#2-2-3-占用库存"></a>2.2.3 占用库存</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeRepository</span> <span class="keyword">implements</span> <span class="title class_">ITradeRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">occupyTeamStock</span><span class="params">(String teamStockKey, String recoveryTeamStockKey, Integer target, Integer validTime)</span> &#123;</span><br><span class="line">        <span class="comment">// 失败恢复量</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">recoveryCount</span> <span class="operator">=</span> redisService.getAtomicLong(recoveryTeamStockKey);</span><br><span class="line">        recoveryCount = <span class="literal">null</span> == recoveryCount ? <span class="number">0</span> : recoveryCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. incr 得到值，与总量和恢复量做对比。恢复量为系统失败时候记录的量。</span></span><br><span class="line">        <span class="comment">// 2. 从有组队量开始，相当于已经有了一个占用量，所以要 +1</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">occupy</span> <span class="operator">=</span> redisService.incr(teamStockKey) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (occupy &gt;= target + recoveryCount) &#123;</span><br><span class="line">            redisService.setAtomicLong(teamStockKey, target);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 给每个产生的值加锁为兜底设计，虽然incr操作是原子的，基本不会产生一样的值。但在实际生产中，遇到过集群的运维配置问题，以及业务运营配置数据问题，导致incr得到的值相同。</span></span><br><span class="line">        <span class="comment">// 2. validTime + 60分钟，是一个延后时间的设计，让数据保留时间稍微长一些，便于排查问题。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> teamStockKey + Constants.UNDERLINE + occupy;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisService.setNx(lockKey, validTime + <span class="number">60</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!lock) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;组队库存加锁失败 &#123;&#125;&quot;</span>, lockKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lock;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>occupyTeamStock</code> 占用库存操作，先获取恢复量。之后和 <code>target</code> 目标量 + <code>recoveryCount</code> 恢复量做对比。</li>
<li>库存扣减后，添加一个锁，这个锁不会影响整体效率。只是一个兜底操作。如注释说明。</li>
</ul>
<h5 id="2-2-4-恢复记录"><a class="headerlink" href="#2-2-4-恢复记录"></a>2.2.4 恢复记录</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recoveryTeamStock</span><span class="params">(String recoveryTeamStockKey, Integer validTime)</span> &#123;</span><br><span class="line">    <span class="comment">// 首次组队拼团，是没有 teamId 的，所以不需要这个做处理。</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(recoveryTeamStockKey)) <span class="keyword">return</span>;</span><br><span class="line">    redisService.incr(recoveryTeamStockKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>recoveryTeamStockKey</code> 为空，则表示没有组队信息，这个时候即使发生异常，也不用处理库存恢复记录。</li>
<li>之后做 <code>incr</code> 记录库存恢复量。</li>
</ul>
<h5 id="2-2-5-责任链配置"><a class="headerlink" href="#2-2-5-责任链配置"></a>2.2.5 责任链配置</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TradeLockRuleFilterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tradeRuleFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BusinessLinkedList&lt;TradeLockRuleCommandEntity, TradeLockRuleFilterFactory.DynamicContext, TradeLockRuleFilterBackEntity&gt; tradeRuleFilter(</span><br><span class="line">            ActivityUsabilityRuleFilter activityUsabilityRuleFilter,</span><br><span class="line">            UserTakeLimitRuleFilter userTakeLimitRuleFilter,</span><br><span class="line">            TeamStockOccupyRuleFilter teamStockOccupyRuleFilter) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组装链</span></span><br><span class="line">        LinkArmory&lt;TradeLockRuleCommandEntity, TradeLockRuleFilterFactory.DynamicContext, TradeLockRuleFilterBackEntity&gt; linkArmory =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkArmory</span>&lt;&gt;(<span class="string">&quot;交易规则过滤链&quot;</span>,</span><br><span class="line">                        activityUsabilityRuleFilter,</span><br><span class="line">                        userTakeLimitRuleFilter,</span><br><span class="line">                        teamStockOccupyRuleFilter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 链对象</span></span><br><span class="line">        <span class="keyword">return</span> linkArmory.getLogicLink();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们实现的一个新的规则（teamStockOccupyRuleFilter），只要配置到工程中即可。</li>
<li>所以，即使你用AI编码，但不告诉它要在什么框架结构下编码，实现出什么编码。他可能给你的大概率也是CRUD。</li>
</ul>
<hr>
<h2 id="函数式数据缓存和降级到DB处理"><a class="headerlink" href="#函数式数据缓存和降级到DB处理"></a>函数式数据缓存和降级到DB处理</h2>
<hr>
<p>以查询活动配置为场景，增加缓存处理。同时使用降级服务，控制走缓存还是走 <code>DB</code> 数据库。并把这部分功能统一抽象成函数式编程。</p>
<h3 id="1-业务流程-14"><a class="headerlink" href="#1-业务流程-14"></a>1. 业务流程</h3>
<p>如图，缓存和降级的使用：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506185233768.png" alt="缓存和降级的使用" loading="lazy"></p>
<ul>
<li>首先，在日常的业务场景中，很多高频使用的数据，都是从 Redis 缓存获取。如果缓存不存在，才会从数据库读取。</li>
<li>之后，也会给缓存配置降级，如果缓存有问题，或者要做一些验证，必须从库里读取，则会动态的配置，让当时的操作从数据库获取。</li>
<li>注意，整个操作过程，缓存、降级、数据库，是一整条代码编程。如果在每个方法里都加这样的内容，就会显得很臃肿，所以一般会抽象一个方法，使用函数式的方式进行编程，降低使用者的编码量。<strong>这个技巧很重要</strong></li>
</ul>
<h3 id="2-编码实现-18"><a class="headerlink" href="#2-编码实现-18"></a>2. 编码实现</h3>
<h4 id="2-1-实现目标"><a class="headerlink" href="#2-1-实现目标"></a>2.1 实现目标</h4>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20250506185459690.png" alt="实现目标" loading="lazy"></p>
<ul>
<li>首先，以 <code>ActivityRepository</code> 场景举例，两个 <code>dao</code> 操作从数据库查询，改为从 <code>Redis</code> 缓存获取。如果缓存不存在，则从数据库查询后写入缓存。</li>
<li>之后，要添加上降级逻辑的处理，如果此时不需要从缓存获取，则直接从数据库获取。</li>
<li>另外，要抽象操作缓存、降级的模块到共用的抽象类。</li>
</ul>
<h4 id="2-2-缓存处理"><a class="headerlink" href="#2-2-缓存处理"></a>2.2 缓存处理</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DCCService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DCCValue(&quot;cacheSwitch:0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cacheOpenSwitch;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存开启开关，0为开启，1为关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCacheOpenSwitch</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>.equals(cacheOpenSwitch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<ul>
<li>降级开关，缓存开启。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">GroupBuyActivity</span> <span class="variable">groupBuyActivityRes</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (dccService.isCacheOpenSwitch()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">groupBuyActivityCacheKey</span> <span class="operator">=</span> GroupBuyActivity.cacheRedisKey(activityId);</span><br><span class="line">    groupBuyActivityRes = redisService.getValue(groupBuyActivityCacheKey);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyActivityRes) &#123;</span><br><span class="line">        groupBuyActivityRes = groupBuyActivityDao.queryValidGroupBuyActivityId(activityId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyActivityRes) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        redisService.setValue(groupBuyActivityCacheKey, groupBuyActivityRes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    groupBuyActivityRes = groupBuyActivityDao.queryValidGroupBuyActivityId(activityId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>判断缓存降级开关。如果是降级的，则直接走DB查询操作。非降级，则走 <code>Redis</code> 缓存，缓存为空则从数据库查询后写入缓存。</li>
<li>这样的代码看着并没有什么问题，但如果大量的这样在程序中编写，就会变得很恶心，以后修改也麻烦。所以要做抽象的设计处理。</li>
</ul>
<h4 id="2-3-函数编程"><a class="headerlink" href="#2-3-函数编程"></a>2.3 函数编程</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_Supplier</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个 Supplier 实例，返回一个字符串</span></span><br><span class="line">    Supplier&lt;String&gt; stringSupplier = () -&gt; <span class="string">&quot;Hello, XFG!&quot;</span>;</span><br><span class="line">    <span class="comment">// 使用 get() 方法获取 Supplier 提供的值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringSupplier.get();</span><br><span class="line">    <span class="comment">// 输出结果</span></span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="comment">// 另一个示例，使用 Supplier 提供当前时间</span></span><br><span class="line">    Supplier&lt;Long&gt; currentTimeSupplier = System::currentTimeMillis;</span><br><span class="line">    <span class="comment">// 获取当前时间</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">currentTime</span> <span class="operator">=</span> currentTimeSupplier.get();</span><br><span class="line">    <span class="comment">// 输出当前时间</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Current time in milliseconds: &quot;</span> + currentTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>这里要介绍一个函数 <code>Supplier</code>，它的作用是帮你延迟执行代码块。如：想调用一个 <code>dao.query()</code> 如果这样写那么就直接调用了，现在通过 <code>Supplier.get</code> 可以在你需要的时候调用。</li>
<li>好，那么这么一个东西有啥用途呢。如：我们使用缓存、查询DB、降级判断，这个代码如果被抽象出来，那么必然会有一个问题，就是所有使用方都有自己的 <code>dao.query()</code> 怎么抽象呢，那么就要让大家的 <code>dao.query</code> 作为参数使用 <code>Supplier</code> 传递到抽象类的方法里，方法里来执行操作。</li>
</ul>
<h4 id="2-4-抽象方法"><a class="headerlink" href="#2-4-抽象方法"></a>2.4 抽象方法</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AbstractRepository.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> IRedisService redisService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> DCCService dccService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用缓存处理方法</span></span><br><span class="line"><span class="comment">     * 优先从缓存获取，缓存不存在则从数据库获取并写入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cacheKey      缓存键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dbFallback    数据库查询函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;           返回类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>              查询结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">getFromCacheOrDb</span><span class="params">(String cacheKey, Supplier&lt;T&gt; dbFallback)</span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否开启缓存</span></span><br><span class="line">        <span class="keyword">if</span> (dccService.isCacheOpenSwitch()) &#123;</span><br><span class="line">            <span class="comment">// 从缓存获取</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">cacheResult</span> <span class="operator">=</span> redisService.getValue(cacheKey);</span><br><span class="line">            <span class="comment">// 缓存存在则直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != cacheResult) &#123;</span><br><span class="line">                <span class="keyword">return</span> cacheResult;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 缓存不存在则从数据库获取</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">dbResult</span> <span class="operator">=</span> dbFallback.get();</span><br><span class="line">            <span class="comment">// 数据库查询结果为空则直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == dbResult) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 写入缓存</span></span><br><span class="line">            redisService.setValue(cacheKey, dbResult);</span><br><span class="line">            <span class="keyword">return</span> dbResult;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 缓存未开启，直接从数据库获取</span></span><br><span class="line">            logger.warn(<span class="string">&quot;缓存降级 &#123;&#125;&quot;</span>, cacheKey);</span><br><span class="line">            <span class="keyword">return</span> dbFallback.get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，增加 <code>AbstractRepository</code> 抽象类，让所有需要使用缓存、降级一套判断的，都继承这个抽象类。</li>
<li>之后，提供 <code>getFromCacheOrDb</code> 方法，在这个方法中判断走降级、走缓存的处理。<code>Supplier&lt;T&gt; dbFallback</code> 就可以帮助我们在需要的地方，完成 <code>get</code> 操作执行传入进来的代码块。</li>
</ul>
<h4 id="2-5-方法使用"><a class="headerlink" href="#2-5-方法使用"></a>2.5 方法使用</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> GroupBuyActivityDiscountVO <span class="title function_">queryGroupBuyActivityDiscountVO</span><span class="params">(Long activityId)</span> &#123;</span><br><span class="line">    <span class="comment">// 优先从缓存获取&amp;写缓存，注意如果实现了后台配置，在更新时要更库，删缓存。</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">groupBuyActivityCacheKey</span> <span class="operator">=</span> GroupBuyActivity.cacheRedisKey(activityId);</span><br><span class="line">    <span class="type">GroupBuyActivity</span> <span class="variable">groupBuyActivityRes</span> <span class="operator">=</span> getFromCacheOrDb(groupBuyActivityCacheKey, </span><br><span class="line">            () -&gt; groupBuyActivityDao.queryValidGroupBuyActivityId(activityId));</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyActivityRes) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">discountId</span> <span class="operator">=</span> groupBuyActivityRes.getDiscountId();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 优先从缓存获取&amp;写缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">groupBuyDiscountCacheKey</span> <span class="operator">=</span> GroupBuyDiscount.cacheRedisKey(discountId);</span><br><span class="line">    <span class="type">GroupBuyDiscount</span> <span class="variable">groupBuyDiscountRes</span> <span class="operator">=</span> getFromCacheOrDb(groupBuyDiscountCacheKey,</span><br><span class="line">            () -&gt; groupBuyDiscountDao.queryGroupBuyActivityDiscountByDiscountId(discountId));</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyDiscountRes) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... 省略部分代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>现在我们使用缓存的方式则直接从 <code>getFromCacheOrDb</code> 抽象父类的方法获取。并把我们要执行的代码库函数的方式透传过去。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author_group"><a class="post-copyright__author_img" href="/about/"><img class="post-copyright__author_img_front" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/MyPhoto.jpg"></a><div class="post-copyright__author_name">coo1heisenberg's Blog</div><div class="post-copyright__author_desc">Diligence can make up for clumsiness!</div></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div id="quit-box" onclick="RemoveRewardMask()"></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本文是原创文章，采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>协议，完整转载请注明来自<a href="/">coo1heisenberg's Blog</a></span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Project/"><span class="tags-punctuation"></span>Project<span class="tagsPageCount">3</span></a></div></div><div class="social-share"></div></div><nav class="needEndHide pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/02/25/Java-%E5%9F%BA%E7%A1%80/"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">00 Java基础 笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="solitude st-star-smile-fill"></i><span>喜欢这篇的人也看了</span><div class="relatedPosts-link"><a onclick="event.preventDefault(); toRandomPost();" href="javascript:void(0);" rel="external nofollow" data-pjax-state="">随便逛逛</a></div></div><div class="relatedPosts-list"><div><a href="/2024/07/08/01-%E5%A4%B4%E6%9D%A1%E7%82%B9%E8%AF%84%E9%A1%B9%E7%9B%AE/" title="01 仿今日头条项目"><img class="cover" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Snipaste_2024-06-25_21-33-23.png" alt="cover"><div class="content is-center"><div class="title">01 仿今日头条项目</div></div></a></div><div><a href="/2024/06/25/00-%E5%A4%B4%E6%9D%A1%E7%82%B9%E8%AF%84%E9%A1%B9%E7%9B%AE/" title="00 仿今日头条项目"><img class="cover" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Snipaste_2024-06-25_21-33-23.png" alt="cover"><div class="content is-center"><div class="title">00 仿今日头条项目</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><div class="author-info__top-group"><div class="author-info__sayhi" id="author-info__sayhi" onclick="sco.changeSayHelloText()">sayhello.morning</div></div></div><div class="avatar-img-group"><img class="avatar-img" alt="头像" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/MyPhoto.jpg"><div class="avatar-sticker"><img class="avatar-sticker-img" src="https://7.isyangs.cn/34/65f2e4e0423cc-34.png" alt="心情贴纸"></div></div><div class="author-info__description_group"><div class="author-info__description">菜鸡的自我救赎...</div><div class="author-info__description2"></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about/"><div class="author-info__name">Coo1heisenberg’s BLOG</div><div class="author-info__desc">Diligence can make up for clumsiness!</div></a><div class="card-info-social-icons is-center"><a class="social-icon" target="_blank" rel="noopener" href="https://github.com/coo1heisenbergProject" title="Github"><i class="solitude  st-github-line"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="solitude st-menu-line"></i><span>文章目录</span></div><div class="toc-content" id="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">拼团交易平台系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E5%9B%A2%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">拼团需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span class="toc-text">项目背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A7%E5%93%81%E6%96%B9%E6%A1%88"><span class="toc-text">产品方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%95%86%E5%93%81%E5%89%8D%E7%AB%AF%E7%95%8C%E9%9D%A2"><span class="toc-text">1.1 商品前端界面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E8%BF%90%E8%90%A5%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86"><span class="toc-text">1.2 运营后台管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%8A%9F%E8%83%BD%E6%B5%81%E7%A8%8B"><span class="toc-text">1.3 功能流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E5%9B%A2%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-text">拼团库表设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="toc-text">库表关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-text">库表设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%8B%BC%E5%9B%A2%E9%85%8D%E7%BD%AE%E8%A1%A8"><span class="toc-text">1.1 拼团配置表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E5%8F%82%E4%B8%8E%E6%8B%BC%E5%9B%A2%E8%A1%A8"><span class="toc-text">1.2 参与拼团表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%94%E5%8F%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1"><span class="toc-text">研发系统设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E7%94%A8%E4%BE%8B%E5%9B%BE"><span class="toc-text">1. 用户用例图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9B%9B%E8%89%B2%E5%BB%BA%E6%A8%A1%E5%9B%BE"><span class="toc-text">2. 四色建模图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%BB%BA%E6%A8%A1%E6%96%B9%E5%BC%8F"><span class="toc-text">2.1 建模方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%AF%BB%E6%89%BE%E4%BA%8B%E4%BB%B6"><span class="toc-text">2.2 寻找事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%88%92%E5%88%86%E9%A2%86%E5%9F%9F"><span class="toc-text">2.3 划分领域</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">3. 业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">3.1 流程图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="toc-text">3.2 时序图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-text">4. 系统架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-text">初始工程搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%95%E7%AE%97%E6%A8%A1%E5%9E%8B%E6%8A%BD%E8%B1%A1%E6%A8%A1%E6%9D%BF%E8%AE%BE%E8%AE%A1"><span class="toc-text">试算模型抽象模板设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-text">1. 模型设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%A8%A1%E6%9D%BF%E5%AE%9A%E4%B9%89"><span class="toc-text">2.1 模板定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%A6%96%E9%A1%B5%E8%AF%95%E7%AE%97"><span class="toc-text">3. 首页试算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E8%90%A5%E9%94%80%E5%95%86%E5%93%81%E5%AE%9E%E4%BD%93%E4%BF%A1%E6%81%AF"><span class="toc-text">3.1 营销商品实体信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E8%AF%95%E7%AE%97%E7%BB%93%E6%9E%9C%E5%AE%9E%E4%BD%93%E5%AF%B9%E8%B1%A1"><span class="toc-text">3.2 试算结果实体对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%8A%BD%E8%B1%A1%E7%9A%84%E6%8B%BC%E5%9B%A2%E8%90%A5%E9%94%80%E6%94%AF%E6%92%91%E7%B1%BB"><span class="toc-text">3.3 抽象的拼团营销支撑类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%B4%BB%E5%8A%A8%E7%AD%96%E7%95%A5%E5%B7%A5%E5%8E%82%E5%AE%9A%E4%B9%89"><span class="toc-text">3.4 活动策略工厂定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%88%E6%A0%B9%E8%8A%82%E7%82%B9%E4%B8%BE%E4%BE%8B%EF%BC%89"><span class="toc-text">3.5 构建一个节点（根节点举例）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%BC%80%E5%85%B3%E8%8A%82%E7%82%B9"><span class="toc-text">3.6 创建一个开关节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E9%A6%96%E9%A1%B5%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">3.7 添加一个首页的方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="toc-text">多线程异步数据加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A2%9E%E5%8A%A0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9D%97"><span class="toc-text">1. 增加多线程模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%8A%82%E7%82%B9%E9%80%BB%E8%BE%91"><span class="toc-text">2. 节点逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-RootNode"><span class="toc-text">2.1 RootNode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-SwitchNode"><span class="toc-text">2.2 SwitchNode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-MarketNode"><span class="toc-text">2.3 MarketNode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-EndNode"><span class="toc-text">2.4 EndNode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%BC%98%E6%83%A0%E6%8A%98%E6%89%A3%E8%AE%A1%E7%AE%97"><span class="toc-text">策略模式优惠折扣计算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1-2"><span class="toc-text">1. 模型设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%8A%98%E6%89%A3%E7%AD%96%E7%95%A5-MJ%E3%80%81N%E3%80%81ZJ%E3%80%81ZK"><span class="toc-text">2.2 折扣策略 - MJ、N、ZJ、ZK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%8A%98%E6%89%A3%E4%BC%98%E6%83%A0%E7%B1%BB%E5%9E%8B%E6%9E%9A%E4%B8%BE%E5%80%BC%E7%BC%96%E5%86%99"><span class="toc-text">2.3 折扣优惠类型枚举值编写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%8A%98%E6%89%A3%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.4 折扣服务的接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E6%8A%BD%E8%B1%A1%E6%A8%A1%E6%9D%BF%E7%B1%BB"><span class="toc-text">2.5 抽象模板类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%BB%A1%E5%87%8F%EF%BC%88MJ%EF%BC%89%E7%9A%84%E8%AE%A1%E7%AE%97"><span class="toc-text">2.6 增加一个满减（MJ）的计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-MarketNode%E8%90%A5%E9%94%80%E8%B0%83%E7%94%A8"><span class="toc-text">2.7 MarketNode营销调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%BA%E7%BE%A4%E6%A0%87%E7%AD%BE%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86"><span class="toc-text">人群标签数据采集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-2"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E4%BA%BA%E7%BE%A4%E4%BB%BB%E5%8A%A1"><span class="toc-text">2.2 人群任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8-bitmap"><span class="toc-text">2.3 数据存储 - bitmap</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E5%BA%93%E8%A1%A8%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB"><span class="toc-text">拆分库表关联关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-2"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-3"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E6%B8%A0%E9%81%93%E5%95%86%E5%93%81%E6%B4%BB%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%85%B3%E8%81%94%E8%A1%A8"><span class="toc-text">2.2 创建渠道商品活动配置关联表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E4%BF%AE%E6%94%B9SC%E5%95%86%E5%93%81%E6%B8%A0%E9%81%93DAO"><span class="toc-text">2.3 修改SC商品渠道DAO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E4%BF%AE%E6%94%B9%E6%9F%A5%E8%AF%A2%E8%90%A5%E9%94%80%E9%85%8D%E7%BD%AE"><span class="toc-text">2.4 修改查询营销配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E9%85%8D%E7%BD%AE%E8%90%A5%E9%94%80%E8%8A%82%E7%82%B9%E8%B7%AF%E7%94%B1"><span class="toc-text">2.5 配置营销节点路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-%E5%BC%82%E5%B8%B8%E5%85%9C%E5%BA%95%E8%8A%82%E7%82%B9"><span class="toc-text">2.6  异常兜底节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%BA%E7%BE%A4%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E8%BF%87%E6%BB%A4"><span class="toc-text">人群标签节点过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-3"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-5"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-4"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E4%BA%BA%E7%BE%A4%E8%BF%87%E6%BB%A4"><span class="toc-text">2.2 人群过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E8%81%9A%E5%90%88%E6%96%B9%E6%B3%95"><span class="toc-text">2.3 聚合方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-TagNode%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.4 TagNode实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E5%BC%80%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-text">动态配置开关操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-4"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-6"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-5"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-text">2.2 创建自定义注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">2.3 自定义注解的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E5%8A%A8%E6%80%81%E5%8F%98%E6%9B%B4%E5%B1%9E%E6%80%A7%E5%80%BC"><span class="toc-text">2.4 动态变更属性值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-DCC-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.5 DCC 动态配置中心接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E5%AE%9E%E7%8E%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.5 实现对应的接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-%E5%BC%80%E5%85%B3%E8%8A%82%E7%82%B9%E4%BD%BF%E7%94%A8"><span class="toc-text">2.6 开关节点使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E5%9B%A2%E4%BA%A4%E6%98%93%E8%90%A5%E9%94%80%E9%94%81%E5%8D%95"><span class="toc-text">拼团交易营销锁单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-5"><span class="toc-text">1. 业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="toc-text">1.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E5%BA%93%E8%A1%A8%E6%9B%B4%E6%96%B0"><span class="toc-text">1.2 库表更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-7"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%9F%BA%E7%A1%80%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.1 基础实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E4%BA%A4%E6%98%93%E8%AE%A2%E5%8D%95"><span class="toc-text">2.2 交易订单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%AE%9E%E7%8E%B0ITradeRepository%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%96%B9%E6%B3%95"><span class="toc-text">2.3 实现ITradeRepository的接口方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.4 服务接口的实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%8A%BD%E8%B1%A1%E6%A8%A1%E6%9D%BF%E8%AE%BE%E8%AE%A1"><span class="toc-text">责任链抽象模板设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1-3"><span class="toc-text">1. 模型设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-8"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-6"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%8D%95%E4%BE%8B%E9%93%BE%E8%B7%AF"><span class="toc-text">2.2 单例链路</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-ILogicChainArmory"><span class="toc-text">2.2.1 ILogicChainArmory</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-ILogicLink"><span class="toc-text">2.2.2 ILogicLink</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-AbstractLogicLink"><span class="toc-text">2.2.3 AbstractLogicLink</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-%E6%B5%8B%E8%AF%95%E4%B8%BE%E4%BE%8B"><span class="toc-text">2.2.4 测试举例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%A4%9A%E4%BE%8B%E9%93%BE%E8%B7%AF"><span class="toc-text">2.3 多例链路</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E9%93%BE%E8%A1%A8%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.3.1 链表接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E5%8A%9F%E8%83%BD%E9%93%BE%E8%A1%A8"><span class="toc-text">2.3.2 功能链表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">2.3.3 逻辑处理器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-%E4%B8%9A%E5%8A%A1%E9%93%BE%E8%B7%AF"><span class="toc-text">2.3.4 业务链路</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-5-%E9%93%BE%E8%B7%AF%E8%A3%85%E9%85%8D"><span class="toc-text">2.3.5 链路装配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-6-%E6%B5%8B%E8%AF%95%E4%B8%BE%E4%BE%8B"><span class="toc-text">2.3.6 测试举例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E8%A7%84%E5%88%99%E8%B4%A3%E4%BB%BB%E9%93%BE%E8%BF%87%E6%BB%A4"><span class="toc-text">交易规则责任链过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-6"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-9"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BF%AE%E6%94%B9"><span class="toc-text">2.1 数据库修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="toc-text">2.2 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%8A%9F%E8%83%BD%E4%BF%AE%E5%A4%8D"><span class="toc-text">2.3 功能修复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E8%90%A5%E9%94%80%E4%BC%98%E6%83%A0%E8%AE%B0%E5%BD%95%E6%94%AF%E4%BB%98%E9%87%91%E9%A2%9D"><span class="toc-text">2.3.1 营销优惠记录支付金额</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E8%90%A5%E9%94%80%E4%BC%98%E6%83%A0%E8%AE%A1%E7%AE%97%E4%BD%BF%E7%94%A8%E4%BA%BA%E7%BE%A4ID"><span class="toc-text">2.3.2 营销优惠计算使用人群ID</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E4%BA%A4%E6%98%93%E8%A7%84%E5%88%99%E6%A8%A1%E5%9E%8B"><span class="toc-text">2.4 交易规则模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-%E6%9E%84%E5%BB%BA%E4%BA%A4%E6%98%93%E7%BB%93%E7%AE%97%E5%AE%9E%E4%BD%93"><span class="toc-text">2.4.1 构建交易结算实体</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-%E5%88%A4%E6%96%AD%E6%B4%BB%E5%8A%A8%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-text">2.4.2 判断活动的可用性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3-%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E5%8F%82%E4%B8%8E%E9%99%90%E5%88%B6"><span class="toc-text">2.4.3 判断用户参与限制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-4-%E6%9E%84%E5%BB%BA%E4%BA%A4%E6%98%93%E8%A7%84%E5%88%99%E5%B7%A5%E5%8E%82"><span class="toc-text">2.4.4 构建交易规则工厂</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E5%9B%A2%E7%BB%84%E9%98%9F%E7%BB%93%E7%AE%97%E7%BB%9F%E8%AE%A1"><span class="toc-text">拼团组队结算统计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-7"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-10"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%96%B0%E5%A2%9E%E4%B8%80%E5%BC%A0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-text">2.1 新增一张数据库表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-2"><span class="toc-text">2.2 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E9%87%8D%E6%9E%84%E9%94%81%E5%8D%95"><span class="toc-text">2.3 重构锁单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%8B%BC%E5%9B%A2%E7%BB%93%E7%AE%97"><span class="toc-text">2.4 拼团结算</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-%E5%AE%9A%E4%B9%89%E6%8B%BC%E5%9B%A2%E7%BB%93%E7%AE%97%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.4.1 定义拼团结算的接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.4.2 功能实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3-settlementMarketPayOrder%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="toc-text">2.4.3 settlementMarketPayOrder事务操作</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E7%BB%93%E7%AE%97%E8%B4%A3%E4%BB%BB%E9%93%BE%E8%BF%87%E6%BB%A4"><span class="toc-text">交易结算责任链过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-8"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-11"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-7"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E8%B0%83%E6%95%B4%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-text">2.2 调整数据库表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-group-buy-order"><span class="toc-text">2.2.1 group_buy_order</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-group-buy-order-list"><span class="toc-text">2.2.2 group_buy_order_list</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E7%BB%93%E7%AE%97%E8%A7%84%E5%88%99"><span class="toc-text">2.3 结算规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-SCRuleFilter"><span class="toc-text">2.3.1 SCRuleFilter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-OutTradeNoRuleFilter"><span class="toc-text">2.3.2 OutTradeNoRuleFilter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-SettableRuleFilter"><span class="toc-text">2.3.3 SettableRuleFilter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-EndRuleFilter"><span class="toc-text">2.3.4 EndRuleFilter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E8%A7%84%E5%88%99%E5%B7%A5%E5%8E%82"><span class="toc-text">2.4 规则工厂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E4%BD%BF%E7%94%A8%E8%A7%84%E5%88%99"><span class="toc-text">2.5 使用规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E5%9B%A2%E5%9B%9E%E8%B0%83%E9%80%9A%E7%9F%A5%E4%BB%BB%E5%8A%A1"><span class="toc-text">拼团回调通知任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-9"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-12"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-8"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%BA%93%E8%A1%A8%E5%8F%98%E6%9B%B4"><span class="toc-text">2.2 库表变更</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E9%94%81%E5%8D%95%E5%86%99%E5%85%A5-notify-url"><span class="toc-text">2.3 锁单写入 - notify_url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E7%BB%93%E7%AE%97%E5%A4%84%E7%90%86-notify-url"><span class="toc-text">2.4 结算处理 - notify_url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E5%9B%9E%E8%B0%83%E7%BD%91%E5%85%B3-okhttp"><span class="toc-text">2.5 回调网关 - okhttp</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-1-%E6%B7%BB%E5%8A%A0pom%E6%96%87%E4%BB%B6"><span class="toc-text">2.5.1 添加pom文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-%E6%B7%BB%E5%8A%A0okhttp%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">2.5.2 添加okhttp客户端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-3-%E6%B7%BB%E5%8A%A0okhttp%E5%9B%9E%E8%B0%83%E7%BD%91%E5%85%B3"><span class="toc-text">2.5.3 添加okhttp回调网关</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-%E5%9B%9E%E8%B0%83%E5%B0%81%E8%A3%85"><span class="toc-text">2.6 回调封装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6-1-%E5%AE%9A%E4%B9%89%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.6.1 定义回调接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6-2-%E5%AE%9E%E7%8E%B0%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.6.2 实现回调接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6-3-%E5%AE%9E%E7%8E%B0%E5%9B%9E%E8%B0%83%E5%B0%81%E8%A3%85"><span class="toc-text">2.6.3 实现回调封装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-%E8%B0%83%E7%94%A8%E5%A4%84%E7%90%86"><span class="toc-text">2.7 调用处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-%E4%BB%BB%E5%8A%A1%E8%A1%A5%E5%81%BF%EF%BC%88%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-text">2.8 任务补偿（定时任务实现）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AEUI%E5%B1%95%E7%A4%BA%E5%B0%81%E8%A3%85%E6%8E%A5%E5%8F%A3"><span class="toc-text">根据UI展示封装接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-text">1. 接口分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-13"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84-9"><span class="toc-text">2.1 工程结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E9%A6%96%E9%A1%B5-%E6%8B%BC%E5%9B%A2%E8%90%A5%E9%94%80%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2 首页 - 拼团营销配置接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E5%AE%9A%E4%B9%89%E5%95%86%E5%93%81%E8%90%A5%E9%94%80%E5%BA%94%E7%AD%94%E5%AF%B9%E8%B1%A1"><span class="toc-text">2.2.1 定义商品营销应答对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.2 定义服务接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.3 实现服务接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-%E6%9F%A5%E8%AF%A2%E6%8B%BC%E5%9B%A2%E7%BB%84%E9%98%9F%E6%95%B0%E6%8D%AE%E7%BB%84%E8%A3%85"><span class="toc-text">2.2.4 查询拼团组队数据组装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-%E4%BA%A4%E6%98%93-%E7%BB%93%E7%AE%97%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.5 交易 - 结算接口</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5RabbitMQ%E5%88%86%E5%B8%83%E5%BC%8F%E5%A4%9A%E7%AB%AF%E6%B6%88%E8%B4%B9"><span class="toc-text">引入RabbitMQ分布式多端消费</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-10"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-14"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%BC%95%E5%85%A5-POM-%E6%96%87%E4%BB%B6"><span class="toc-text">2.1 引入 POM 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E7%94%9F%E4%BA%A7%E8%80%85-%E6%8B%BC%E5%9B%A2"><span class="toc-text">2.2 生产者 - 拼团</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B6%88%E8%B4%B9%E8%80%85-%E6%94%AF%E4%BB%98"><span class="toc-text">2.3 消费者 - 支付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AE"><span class="toc-text">2.4 代码配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81MQ%E7%BB%93%E7%AE%97%E6%B6%88%E6%81%AF"><span class="toc-text">发送MQ结算消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-11"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-15"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%BA%93%E8%A1%A8%E4%BF%AE%E6%94%B9"><span class="toc-text">2.1 库表修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E9%94%81%E5%8D%95%E9%93%BE%E8%B7%AF%E4%BF%AE%E6%94%B9"><span class="toc-text">2.2 锁单链路修改</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E7%A0%94%E5%8F%91%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">2.2.1 研发设计流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-text">2.2.2 核心代码</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E7%BB%93%E7%AE%97%E9%93%BE%E8%B7%AF"><span class="toc-text">2.3 结算链路</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E7%A0%94%E5%8F%91%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">2.3.1 研发设计流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-text">2.3.2 核心代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9MQ%E7%BB%93%E7%AE%97%E6%B6%88%E6%81%AF"><span class="toc-text">消费MQ结算消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-12"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-16"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-RabbitMQ-%E5%90%8E%E5%8F%B0"><span class="toc-text">2.1 RabbitMQ 后台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%B6%88%E8%B4%B9%E7%BB%93%E7%AE%97%E6%B6%88%E6%81%AF"><span class="toc-text">2.2 消费结算消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%A2%9E%E5%8A%A0%E6%94%AF%E4%BB%98%E7%BB%93%E7%AE%97MQ"><span class="toc-text">2.3 增加支付结算MQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E5%8F%91%E9%80%81%EF%BC%8C%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E7%BB%93%E7%AE%97%E6%B6%88%E6%81%AF"><span class="toc-text">2.4 发送，支付成功结算消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E9%94%81%E5%8D%95API%E5%AF%B9%E6%8E%A5"><span class="toc-text">2.5 锁单API对接</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-1-%E9%85%8D%E7%BD%AE%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1"><span class="toc-text">2.5.1 配置请求对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-%E4%BD%BF%E7%94%A8%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1"><span class="toc-text">2.5.2 使用请求对象</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E9%94%81%E5%92%8C%E6%97%A0%E9%94%81%E5%8C%96%E5%9C%BA%E6%99%AF%E8%BF%90%E7%94%A8"><span class="toc-text">独占锁和无锁化场景运用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-13"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-17"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E7%8B%AC%E5%8D%A0%E9%94%81"><span class="toc-text">2.1 独占锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%97%A0%E9%94%81%E5%8C%96%EF%BC%88%E4%B9%90%E8%A7%82%E9%94%81%EF%BC%89"><span class="toc-text">2.2 无锁化（乐观锁）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E6%9B%B4%E6%94%B9%E9%83%A8%E5%88%86"><span class="toc-text">2.2.1 更改部分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E8%B4%A3%E4%BB%BB%E9%93%BE-%E7%BB%84%E9%98%9F%E5%BA%93%E5%AD%98%E8%A7%84%E5%88%99"><span class="toc-text">2.2.2 责任链 - 组队库存规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-%E5%8D%A0%E7%94%A8%E5%BA%93%E5%AD%98"><span class="toc-text">2.2.3 占用库存</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-%E6%81%A2%E5%A4%8D%E8%AE%B0%E5%BD%95"><span class="toc-text">2.2.4 恢复记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-%E8%B4%A3%E4%BB%BB%E9%93%BE%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.5 责任链配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98%E5%92%8C%E9%99%8D%E7%BA%A7%E5%88%B0DB%E5%A4%84%E7%90%86"><span class="toc-text">函数式数据缓存和降级到DB处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-14"><span class="toc-text">1. 业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-18"><span class="toc-text">2. 编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87"><span class="toc-text">2.1 实现目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E7%BC%93%E5%AD%98%E5%A4%84%E7%90%86"><span class="toc-text">2.2 缓存处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%87%BD%E6%95%B0%E7%BC%96%E7%A8%8B"><span class="toc-text">2.3 函数编程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95"><span class="toc-text">2.4 抽象方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8"><span class="toc-text">2.5 方法使用</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="solitude st-map-line"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/30/pintuan-project/" title="00 拼团交易平台系统"><img alt="00 拼团交易平台系统" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/pdd.png"></a><div class="content"><a class="title" href="/2025/04/30/pintuan-project/" title="00 拼团交易平台系统">00 拼团交易平台系统</a><a class="article-recent_post_categories" href="/2025/04/30/pintuan-project/">Java</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/25/Java-%E5%9F%BA%E7%A1%80/" title="00 Java基础 笔记"><img alt="00 Java基础 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Javalogobalala.png"></a><div class="content"><a class="title" href="/2025/02/25/Java-%E5%9F%BA%E7%A1%80/" title="00 Java基础 笔记">00 Java基础 笔记</a><a class="article-recent_post_categories" href="/2025/02/25/Java-%E5%9F%BA%E7%A1%80/">Java</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/15/SpringCloud%E7%AC%94%E8%AE%B0/" title="02 SpringCloud 笔记"><img alt="02 SpringCloud 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/SpringCloud_2025-01-15.png"></a><div class="content"><a class="title" href="/2025/01/15/SpringCloud%E7%AC%94%E8%AE%B0/" title="02 SpringCloud 笔记">02 SpringCloud 笔记</a><a class="article-recent_post_categories" href="/2025/01/15/SpringCloud%E7%AC%94%E8%AE%B0/">Spring</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/10/00-Kafka/" title="00 Kafka 笔记"><img alt="00 Kafka 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/kafka_log.png"></a><div class="content"><a class="title" href="/2025/01/10/00-Kafka/" title="00 Kafka 笔记">00 Kafka 笔记</a><a class="article-recent_post_categories" href="/2025/01/10/00-Kafka/">MQ</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/04/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E7%82%B9%E5%BD%92%E7%BA%B3/" title="00 操作系统知识点归纳 笔记"><img alt="00 操作系统知识点归纳 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/caozuoxitong.png"></a><div class="content"><a class="title" href="/2025/01/04/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E7%82%B9%E5%BD%92%E7%BA%B3/" title="00 操作系统知识点归纳 笔记">00 操作系统知识点归纳 笔记</a><a class="article-recent_post_categories" href="/2025/01/04/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E7%82%B9%E5%BD%92%E7%BA%B3/">Others</a></div></div></div></div></div></div></main><footer id="footer"><div id="st-footer-bar"><div class="footer-logo"><span>Solitude</span></div><div class="footer-bar-description">来自 Heisenberg 的原创文章</div><a class="footer-bar-link" href="/about/">了解更多</a></div><div id="footer_deal"></div><div id="st-footer"><div class="footer-group"><h3 class="footer-title">导航</h3><div class="footer-links"><a class="footer-item" href="/archives/" title="归档">归档</a><a class="footer-item" href="/categories/" title="分类">分类</a><a class="footer-item" href="/tags/" title="标签">标签</a></div></div><div class="footer-group"><h3 class="footer-title">服务</h3><div class="footer-links"><a class="footer-item" target="_blank" rel="noopener" href="https://aliyun.com/" title="阿里云">阿里云</a></div></div><div class="footer-group"><h3 class="footer-title">支持</h3><div class="footer-links"><a class="footer-item" href="/about/" title="打赏记录">打赏记录</a></div></div><div class="footer-group"><h3 class="footer-title">协议</h3><div class="footer-links"><a class="footer-item" href="/cookies/" title="Cookies">Cookies</a><a class="footer-item" href="/privacy/" title="用户协议">用户协议</a><a class="footer-item" href="/copyright/" title="版权协议">版权协议</a></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div class="copyright">© 2024 - 2025 By&nbsp;<a class="footer-bar-link" href="/">Coo1heisenberg’s BLOG</a></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" alt="主题">主题</a><a class="footer-bar-link cc" href="/null" aria-label="copyright"><i class="solitude st-copyright-line"></i><i class="solitude st-creative-commons-by-line"></i><i class="solitude st-creative-commons-nc-line"></i><i class="solitude st-creative-commons-nd-line"></i></a></div></div></div></footer></div><!-- right_menu--><!-- inject body--><div><script src="/js/utils.js?v=1.10.6"></script><script src="/js/main.js?v=1.10.6"></script><script src="/js/third_party/waterfall.min.js?v=1.10.6"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script src="/js/third_party/universe.min.js?v=1.10.6"></script><script>dark()
</script><script src="//open.lightxi.com/cdnjs/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js"><script>(() => {
    document.querySelectorAll('#article-container span.katex-display').forEach(item => {
        utils.wrap(item, 'div', {class: 'katex-wrap'})
    })
})();
</script></script><script src="//open.lightxi.com/cdnjs/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js"></script><script>var meting_api = 'https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r';</script><script src="//open.lightxi.com/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/meting/2.0.1/Meting.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/pace/1.2.4/pace.min.js"></script><div class="js-pjax"><script defer pjax src="//open.lightxi.com/cdnjs/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.min.js"></script></div></div><!-- newest comment--><!-- pjax--><script>const pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: ['title','#body-wrap','#site-config','meta[name="description"]','.js-pjax','meta[property^="og:"]','#config-diff'],
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
})

document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
})

document.addEventListener('pjax:complete', () => {
    window.refreshFn()

    document.querySelectorAll('script[data-pjax]').forEach(item => {
        const newScript = document.createElement('script')
        const content = item.text || item.textContent || item.innerHTML || ""
        Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
        newScript.appendChild(document.createTextNode(content))
        item.parentNode.replaceChild(newScript, item)
    })

    GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

})

document.addEventListener('pjax:error', (e) => {
    if (e.request.status === 404) {
        pjax.loadUrl('/404.html')
    }
})</script><!-- theme--><script>initTheme = () => {
    let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const cachedMode = utils.saveToLocal.get('theme');
    if (cachedMode === undefined) {
        const nowMode =
            isDarkMode ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', nowMode);
    } else {
        document.documentElement.setAttribute('data-theme', cachedMode);
    }
    is_rm && rm.mode(cachedMode === 'dark' && isDarkMode)
}
initTheme()</script><!-- google adsense--><!-- search--><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="solitude st-close-fill"></i></button></nav><div class="search-wrap"><div class="search-box"><input class="search-box-input" id="search-input" type="text" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" placeholder="输入关键词快速查找"></div><div id="search-results"><div id="search-hits"></div></div><div id="search-pagination"></div><div id="search-tips"></div></div></div><div id="search-mask"></div></div><script src="/js/search/local.js?v=1.10.6"></script><!-- Tianli-Talk--><!-- music--></body></html><script>const posts=["2025/04/30/pintuan-project/","2025/02/25/Java-基础/","2025/01/15/SpringCloud笔记/","2025/01/10/00-Kafka/","2025/01/04/操作系统知识点归纳/","2024/12/24/计算机网络知识点归纳/","2024/12/21/01-redis知识点归纳/","2024/12/16/01-MySQL知识点归纳/","2024/12/04/Spring框架/","2024/12/02/Java-JVM虚拟机/","2024/11/04/Java-并发编程/","2024/11/01/Java-集合框架/","2024/09/28/00-前端开发入门教程/","2024/09/26/01-空间转录组/","2024/09/13/00-单细胞多组学分析/","2024/07/22/00-MongoDB/","2024/07/17/00-elasticsearch/","2024/07/15/01-黑马redis/","2024/07/13/00-黑马redis/","2024/07/08/00-黑马SSM/","2024/07/08/01-头条点评项目/","2024/07/06/00-Mybatis-Plus/","2024/06/29/00-黑马MySQL/","2024/06/25/00-头条点评项目/","2024/06/21/02-Python/","2024/06/11/01-Python/","2024/05/25/00-Python/","2024/05/13/DesignPattern/","2024/05/13/Docker/","2024/05/13/Nginx/","2024/05/13/Linux/"];function toRandomPost(){ pjax.loadUrl('/'+posts[Math.floor(Math.random()*posts.length)]); }</script>