<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>00 单细胞多组学分析 笔记 | coo1heisenberg's Blog</title><noscript>开启JavaScript才能访问本站哦~</noscript><link rel="icon" href="/img/pwa/favicon.ico"><!-- index.css--><link rel="stylesheet" href="/css/index.css?v=1.10.6"><!-- inject head--><link rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/7pOrz0WXB5ZWJPX/latest/iconfont.css"><!-- aplayer--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.css"><!-- swiper--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"><!-- fancybox ui--><!-- katex--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/KaTeX/0.16.9/katex.min.css"><!-- Open Graph--><meta name="description" content="单细胞多组学分析 单细胞技术的核心：实现单个细胞精度的分辨度 Bulk-RNA测序关注的重点是基因 单细胞技术首先关注细胞状态的差异，再关注基因表达的差异 在单细胞 RNA 测序（scRNA-seq）分析中，nFeature 和 nCount 是两个常见的质量控制（QC）指标，分别表示： nF"><!-- pwa--><meta name="apple-mobile-web-app-capable" content="coo1heisenberg's Blog"><meta name="theme-color" content="var(--efu-main)"><meta name="apple-mobile-web-app-status-bar-style" content="var(--efu-main)"><link rel="bookmark" href="/img/pwa/favicon.ico"><link rel="apple-touch-icon" href="/img/pwa/favicon.ico" sizes="180x180"><script>console.log(
    "%c Program: Hexo %c Theme: Solitude %c Version: v1.10.6",
    "border-radius:5px 0 0 5px;padding: 5px 10px;color:white;background:#ff3842;",
    "padding: 5px 10px;color:white;background:#3e9f50;",
    "padding: 5px 10px;color:white;background:#0084ff;border-radius:0 5px 5px 0",
)
</script><script>(()=>{
        const saveToLocal = {
            set: function setWithExpiry(key, value, ttl) {
                if (ttl === 0)
                    return
                const now = new Date()
                const expiryDay = ttl * 86400000
                const item = {
                    value: value,
                    expiry: now.getTime() + expiryDay
                }
                localStorage.setItem(key, JSON.stringify(item))
            },
            get: function getWithExpiry(key) {
                const itemStr = localStorage.getItem(key)
    
                if (!itemStr) {
                    return undefined
                }
                const item = JSON.parse(itemStr)
                const now = new Date()
    
                if (now.getTime() > item.expiry) {
                    localStorage.removeItem(key)
                    return undefined
                }
                return item.value
            }
        };
        window.utils = {
            saveToLocal: saveToLocal,
            getCSS: (url, id = false) => new Promise((resolve, reject) => {
              const link = document.createElement('link')
              link.rel = 'stylesheet'
              link.href = url
              if (id) link.id = id
              link.onerror = reject
              link.onload = link.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                link.onload = link.onreadystatechange = null
                resolve()
              }
              document.head.appendChild(link)
            }),
            getScript: (url, attr = {}) => new Promise((resolve, reject) => {
              const script = document.createElement('script')
              script.src = url
              script.async = true
              script.onerror = reject
              script.onload = script.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                script.onload = script.onreadystatechange = null
                resolve()
              }
    
              Object.keys(attr).forEach(key => {
                script.setAttribute(key, attr[key])
              })
    
              document.head.appendChild(script)
            }),
            addGlobalFn: (key, fn, name = false, parent = window) => {
                const globalFn = parent.globalFn || {}
                const keyObj = globalFn[key] || {}
        
                if (name && keyObj[name]) return
        
                name = name || Object.keys(keyObj).length
                keyObj[name] = fn
                globalFn[key] = keyObj
                parent.globalFn = globalFn
            },
        }
    })()</script><!-- global head--><script>const GLOBAL_CONFIG = {
    root: '/',
    algolia: undefined,
    localsearch: {"preload":false,"path":"/search.xml"},
    runtime: '2024-05-12 00:00:00',
    lazyload: {
        enable: false,
        error: '/img/error_load.webp'
    },
    copyright: {"limit":50,"author":"作者: Coo1heisenberg’s BLOG","link":"链接: ","source":"来源: coo1heisenberg's Blog","info":"著作权归作者所有。 商业转载请联系作者获得授权，非商业转载请注明出处。"},
    highlight: {
        enable: true,
        limit: 200,
        expand: true,
        copy: true,
        syntax: 'highlight.js'
    },
    randomlink: false,
    lang: {"theme":{"dark":"已切换至深色模式","light":"已切换至浅色模式"},"copy":{"success":"复制成功","error":"复制失败"},"backtop":"返回顶部","time":{"day":"天前","hour":"小时前","just":"刚刚","min":"分钟前","month":"个月前"},"f12":"开发者模式已打开，请遵循GPL协议。","totalk":"无需删除空行，直接输入评论即可","search":{"empty":"找不到你查询的内容：${query}","hit":"找到 ${hits} 条结果，用时 ${time} 毫秒","placeholder":"输入关键词快速查找","count":"共 <b>${count}</b> 条结果。"}},
    aside: {
        sayhello: {
            morning: '一日之计在于晨',
            noon: '吃饱了才有力气干活',
            afternoon: '集中精力，攻克难关',
            night: '不要太劳累了，早睡更健康',
            goodnight: '睡个好觉，保证精力充沛',
        },
        sayhello2: [],
    },
    covercolor: {
        enable: false
    },
    comment: false,
    lightbox: 'null',
    post_ai: false,
    right_menu: false,
};</script><!-- page-config head--><script id="config-diff">var PAGE_CONFIG = {
    is_post: true,
    is_page: false,
    is_home: false,
    page: '',
    toc: true,
    comment: false,
    ai_text: false
}</script><meta name="generator" content="Hexo 7.2.0"></head><body id="body"><!-- universe--><canvas id="universe"></canvas><!-- loading--><!-- console--><div id="console"><div class="close-btn" onclick="sco.hideConsole()"><i class="solitude st-close-fill"></i></div><div class="console-card-group"><div class="console-card-group-right"><div class="console-card tags" onclick="sco.hideConsole()"><div class="card-content"><div class="author-content-item-tips">标签</div><div class="author-content-item-title">寻找感兴趣的领域</div></div><div class="card-tag-cloud"><a href="/tags/%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">空间转录组<sup>1</sup></a><a href="/tags/Python%E9%AB%98%E7%BA%A7/">Python高级<sup>1</sup></a><a href="/tags/Docker%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Docker基础语法<sup>1</sup></a><a href="/tags/Nginx%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Nginx基础语法<sup>1</sup></a><a href="/tags/MongoDB/">MongoDB<sup>1</sup></a><a href="/tags/HTML-CSS/">HTML+CSS<sup>1</sup></a><a href="/tags/Redis/">Redis<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<sup>1</sup></a><a href="/tags/Linux%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Linux基础语法<sup>1</sup></a><a href="/tags/Mybatis-Plus/">Mybatis-Plus<sup>1</sup></a><a href="/tags/ElasticSearch/">ElasticSearch<sup>1</sup></a><a href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础<sup>2</sup></a><a href="/tags/MySQL/">MySQL<sup>1</sup></a><a href="/tags/Project/">Project<sup>2</sup></a><a href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/">单细胞<sup>1</sup></a><a href="/tags/Spring/">Spring<sup>1</sup></a></div></div><div class="console-card history" onclick="sco.hideConsole()"><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">2024/09</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">2024/07</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">2024/06</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">2024/05</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span class="card-archive-list-count-unit">篇</span></div></a></li></ul></div></div></div><div class="button-group"><div class="console-btn-item"><span class="darkmode_switchbutton" onclick="sco.switchDarkMode()" title="昼夜切换"><i class="solitude st-moon-clear-fill"></i></span></div><div class="console-btn-item" id="consoleHideAside"><span class="asideSwitch" onclick="sco.switchHideAside()" title="边栏显示控制"><i class="solitude st-side-bar-fill"></i></span></div></div><div class="console-mask" onclick="sco.hideConsole()"></div></div><!-- sidebar--><div id="sidebar" style="zoom: 1;"><div id="menu-mask" style="display: none;"></div><div id="sidebar-menus"><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><span class="darkmode_switchbutton menu-child" onclick="sco.switchDarkMode()"><i class="solitude st-moon-clear-fill"></i><span>显示模式</span></span></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">博客主题</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="Solitude"><img class="nolazyload back-menu-item-icon" src="https://7.isyangs.cn/1/65eb200ee4dea-1.png" alt="Solitude"><span class="back-menu-item-text">Solitude</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文库</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  st-checkbox-multiple-blank-fill"></i><span>全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/links/"><i class="solitude  st-group-fill"></i><span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/tlink/"><i class="solitude  st-tools-fill"></i><span>工具箱</span></a></li><li><a class="site-page child" href="/music/"><i class="solitude  st-disc-fill"></i><span>音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>关于本站</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-widget card-tags card-archives card-webinfo card-allinfo"><div class="card-tag-cloud"><a href="/tags/%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">空间转录组<sup>1</sup></a><a href="/tags/Python%E9%AB%98%E7%BA%A7/">Python高级<sup>1</sup></a><a href="/tags/Docker%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Docker基础语法<sup>1</sup></a><a href="/tags/Nginx%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Nginx基础语法<sup>1</sup></a><a href="/tags/MongoDB/">MongoDB<sup>1</sup></a><a href="/tags/HTML-CSS/">HTML+CSS<sup>1</sup></a><a href="/tags/Redis/">Redis<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<sup>1</sup></a><a href="/tags/Linux%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Linux基础语法<sup>1</sup></a><a href="/tags/Mybatis-Plus/">Mybatis-Plus<sup>1</sup></a><a href="/tags/ElasticSearch/">ElasticSearch<sup>1</sup></a><a href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础<sup>2</sup></a><a href="/tags/MySQL/">MySQL<sup>1</sup></a><a href="/tags/Project/">Project<sup>2</sup></a><a href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/">单细胞<sup>1</sup></a><a href="/tags/Spring/">Spring<sup>1</sup></a></div></div></div></div><!-- keyboard--><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav class="show" id="nav"><div id="nav-group"><div id="blog_name"><div class="back-home-button" tabindex="-1"><i class="back-home-button-icon solitude st-more-fill"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">博客主题</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="Solitude"><img class="nolazyload back-menu-item-icon" src="https://7.isyangs.cn/1/65eb200ee4dea-1.png" alt="Solitude"><span class="back-menu-item-text">Solitude</span></a></div></div></div></div><a id="site-name" href="/" title="返回博客主页"><span class="title">Solitude</span></a></div><div id="page-name-mask"><div id="page-name"><a id="page-name-text" onclick="sco.toTop()">00 单细胞多组学分析 笔记</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文库</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  st-checkbox-multiple-blank-fill"></i><span>全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/links/"><i class="solitude  st-group-fill"></i><span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/tlink/"><i class="solitude  st-tools-fill"></i><span>工具箱</span></a></li><li><a class="site-page child" href="/music/"><i class="solitude  st-disc-fill"></i><span>音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>关于本站</span></a></li></ul></div></div></div><div id="nav-left"></div><div id="nav-right"><div class="nav-button" id="travellings_button"><a class="site-page" href="/" title=""><i class="solitude st-train-line"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索"><i class="solitude st-search-line"></i></a></div><div class="nav-button" id="nav-totop" onclick="sco.toTop()"><a class="totopbtn"><i class="solitude st-arrow-up-line"></i><span id="percent">0</span></a></div><div id="toggle-menu"><a class="site-page"><i class="solitude st-menu-line"></i></a></div></div></div></nav><div class="coverdiv" id="coverdiv"><img class="nolazyload" id="post-cover" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/bio_gene.png" alt="00 单细胞多组学分析 笔记"></div><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original" title="该文章为原创文章，注意版权协议">原创</a><span class="post-meta-categories"><a class="post-meta-categories" href="/categories/%E7%94%9F%E4%BF%A1%E5%88%86%E6%9E%90/">生信分析</a></span><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/"><span class="tags-name tags-punctuation">单细胞</span></a></div></div></div></div><h1 class="post-title">00 单细胞多组学分析 笔记</h1><div id="post-meta"><div class="meta-secondline"><span class="post-meta-date" title="发布于 2024-09-13 12:23:51"><i class="post-meta-icon solitude st-calendar-todo-fill"></i><time datetime="2024-09-13T04:23:51.000Z">2024-09-13T04:23:51.000Z</time></span><span class="post-meta-date" title="最后更新于 2024-10-09 15:51:24"><i class="post-meta-icon solitude st-refresh-line"></i><time datetime="2024-10-09T07:51:24.883Z">2024-10-09T07:51:24.883Z</time></span><span class="post-meta-wordcount"><span class="post-meta-separator"></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>单细胞多组学分析</h1>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240914161659739.png" alt="单细胞转录组分析流程" loading="lazy"></p>
<p>单细胞技术的核心：实现单个细胞精度的分辨度</p>
<p>Bulk-RNA测序关注的重点是基因</p>
<p>单细胞技术首先关注细胞状态的差异，再关注基因表达的差异</p>
<p>在单细胞 RNA 测序（scRNA-seq）分析中，<code>nFeature</code> 和 <code>nCount</code> 是两个常见的质量控制（QC）指标，分别表示：</p>
<ol>
<li><strong>nFeature</strong>（Feature Count 或 Gene Count）
<ul>
<li>这是细胞中检测到的基因（或特征，通常是基因）的数量。在每个细胞中，这个值代表在这个细胞中有表达（即检测到转录本）的基因数量。如果某个细胞中基因表达的数量过少，可能表明该细胞的捕获或测序质量较低。</li>
</ul>
</li>
<li><strong>nCount</strong>（UMI Count 或 Total Count）
<ul>
<li>这是一个细胞中所有转录本的总数，通常通过唯一分子标识（UMI，Unique Molecular Identifier）来计数。UMI 可以帮助消除 PCR 扩增的重复性，以更准确地估计在每个细胞中测序到的总转录本数。</li>
</ul>
</li>
</ol>
<p><strong>应用</strong>：</p>
<ul>
<li>在数据质量控制过程中，通常会根据这两个值过滤掉质量较差的细胞。例如，具有极低 <code>nFeature</code> 或 <code>nCount</code> 的细胞可能表示有技术噪音，反之，极高的值可能是双细胞（doublet）或其他异常情况。</li>
</ul>
<hr>
<h2 id="Seurat-对象构建及降维聚类"><a class="headerlink" href="#Seurat-对象构建及降维聚类"></a>Seurat 对象构建及降维聚类</h2>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## install.packages(&#x27;remotes&#x27;)</span></span><br><span class="line"><span class="comment">## remotes::install_version(&quot;Seurat&quot;, version = &quot;3.2.0&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="string">&#x27;Seurat&#x27;</span><span class="punctuation">)</span></span><br><span class="line">getwd<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/Study_R/20240913/&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#### 清除环境，就是把环境清空了</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 读取10x的数据</span></span><br><span class="line"><span class="operator">?</span>Read10X </span><br><span class="line">scRNA.counts<span class="operator">=</span>Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span> <span class="string">&quot;/home/oelab/RunData2/heisenberg/Study_R/20240913/BC21/&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>scRNA.counts<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建Seurat对象</span></span><br><span class="line"><span class="operator">?</span>CreateSeuratObject</span><br><span class="line"></span><br><span class="line"><span class="comment">### Seurat对象的创建主要是为了后续的分析</span></span><br><span class="line"><span class="comment">### min.cells 这个基因至少在3个细胞中表达</span></span><br><span class="line">scRNA <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>scRNA.counts <span class="punctuation">,</span></span><br><span class="line">                           min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> project<span class="operator">=</span><span class="string">&quot;sampl.1&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                           min.features <span class="operator">=</span> <span class="number">40</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">view<span class="punctuation">(</span>scRNA<span class="punctuation">)</span></span><br><span class="line">View<span class="punctuation">(</span>scRNA<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### s3 data.frame  list  character matirx </span></span><br><span class="line"><span class="comment">### s4 层级结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第一种s4对象的提取方法：点击白框</span></span><br><span class="line"></span><br><span class="line">gene<span class="operator">=</span>scRNA<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>data<span class="operator">@</span>Dimnames<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">bc<span class="operator">=</span>scRNA<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>data<span class="operator">@</span>Dimnames<span class="punctuation">[[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">bc<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line">gene<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">100</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phe<span class="operator">=</span>scRNA<span class="operator">@</span>meta.data</span><br><span class="line">count<span class="operator">=</span>scRNA<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>counts</span><br><span class="line">z<span class="operator">=</span>scRNA<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>counts<span class="operator">@</span>Dimnames<span class="punctuation">[[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##### 第二提取s4对象的方法：@ $交替使用</span></span><br><span class="line"></span><br><span class="line">x1<span class="operator">=</span>scRNA<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>data</span><br><span class="line"></span><br><span class="line">count<span class="operator">=</span>scRNA<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>counts</span><br><span class="line">scRNA<span class="operator">@</span>meta.data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看样本的细胞数量</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span>        </span><br><span class="line"></span><br><span class="line"><span class="comment">## 计算质控指标</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算细胞中线粒体基因比例</span></span><br><span class="line"><span class="operator">?</span>PercentageFeatureSet</span><br><span class="line">x<span class="operator">=</span>scRNA<span class="punctuation">[[</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">x<span class="operator">=</span>PercentageFeatureSet<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span>  PercentageFeatureSet<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA<span class="operator">@</span>meta.data<span class="operator">$</span>per.mt<span class="operator">=</span>PercentageFeatureSet<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算红细胞比例</span></span><br><span class="line">HB.genes <span class="operator">&lt;-</span>  <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;HBA1&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBA2&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBB&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBD&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBE1&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBG1&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBG2&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBM&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBQ1&quot;</span><span class="punctuation">,</span><span class="string">&quot;HBZ&quot;</span><span class="punctuation">)</span></span><br><span class="line">HB_m <span class="operator">&lt;-</span>  match<span class="punctuation">(</span>HB.genes<span class="punctuation">,</span> rownames<span class="punctuation">(</span>scRNA<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line">HB.genes <span class="operator">&lt;-</span>  rownames<span class="punctuation">(</span>scRNA<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="punctuation">)</span><span class="punctuation">[</span>HB_m<span class="punctuation">]</span> </span><br><span class="line">HB.genes <span class="operator">&lt;-</span>  HB.genes<span class="punctuation">[</span><span class="operator">!</span><span class="built_in">is.na</span><span class="punctuation">(</span>HB.genes<span class="punctuation">)</span><span class="punctuation">]</span> </span><br><span class="line">scRNA<span class="punctuation">[[</span><span class="string">&quot;percent.HB&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> features<span class="operator">=</span>HB.genes<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#head(scRNA@meta.data)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;a1&quot;</span><span class="punctuation">,</span><span class="string">&quot;a2&quot;</span><span class="punctuation">,</span><span class="string">&quot;a3&quot;</span><span class="punctuation">)</span></span><br><span class="line">b<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;b1&quot;</span><span class="punctuation">,</span><span class="string">&quot;a2&quot;</span><span class="punctuation">,</span><span class="string">&quot;m1&quot;</span><span class="punctuation">,</span><span class="string">&quot;m2&quot;</span><span class="punctuation">,</span><span class="string">&quot;a1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 匹配函数</span></span><br><span class="line">match<span class="punctuation">(</span>a<span class="punctuation">,</span>b<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Feature、count、线粒体基因、红细胞基因占比可视化。</span></span><br><span class="line">violin <span class="operator">&lt;-</span>  VlnPlot<span class="punctuation">(</span>scRNA<span class="punctuation">,</span></span><br><span class="line">                     features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                  <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">,</span><span class="string">&quot;percent.HB&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                     </span><br><span class="line">                     pt.size <span class="operator">=</span> <span class="number">0.01</span><span class="punctuation">,</span> <span class="comment">#不需要显示点，可以设置pt.size = 0</span></span><br><span class="line">                     ncol <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># ncol 表示一行放几个图</span></span><br><span class="line"><span class="comment"># pt.size 表示点的大小</span></span><br><span class="line">violin</span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA<span class="punctuation">,</span></span><br><span class="line">        features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">,</span><span class="string">&quot;percent.HB&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        </span><br><span class="line">        pt.size <span class="operator">=</span> <span class="number">0.01</span><span class="punctuation">,</span> <span class="comment">#不需要显示点，可以设置pt.size = 0</span></span><br><span class="line">        ncol <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>VlnPlot</span><br><span class="line"><span class="comment">###把图片画到画板上面</span></span><br><span class="line">violin</span><br><span class="line"><span class="comment">#####以后保存图片都手动保存 不要用代码保存了。</span></span><br><span class="line"><span class="comment">#####你做到保存图片的时候喊师傅  我们语音聊天 我教你怎么保存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### dpi 表示图的大小 plot表示保存哪张图</span></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;vlnplot_before_qc.pdf&quot;</span><span class="punctuation">,</span>dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">,</span> plot <span class="operator">=</span> violin<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span> </span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;vlnplot_before_qc.png&quot;</span><span class="punctuation">,</span> plot <span class="operator">=</span> violin<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">### 这几个指标之间的相关性。 把图画到画板上，然后手动保存</span></span><br><span class="line">plot1<span class="operator">=</span>FeatureScatter<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> feature1 <span class="operator">=</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> feature2 <span class="operator">=</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span></span><br><span class="line">plot2<span class="operator">=</span>FeatureScatter<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> feature1 <span class="operator">=</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> feature2 <span class="operator">=</span> <span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line">plot3<span class="operator">=</span>FeatureScatter<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> feature1 <span class="operator">=</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> feature2 <span class="operator">=</span> <span class="string">&quot;percent.HB&quot;</span><span class="punctuation">)</span></span><br><span class="line">pearplot <span class="operator">&lt;-</span> CombinePlots<span class="punctuation">(</span>plots <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>plot1<span class="punctuation">,</span> plot2<span class="punctuation">,</span> plot3<span class="punctuation">)</span><span class="punctuation">,</span> nrow<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span> legend<span class="operator">=</span><span class="string">&quot;none&quot;</span><span class="punctuation">)</span> </span><br><span class="line">plot1</span><br><span class="line"><span class="comment">####看画板</span></span><br><span class="line">plot2</span><br><span class="line"><span class="comment">####看画板</span></span><br><span class="line">plot3</span><br><span class="line"><span class="comment">####看画板</span></span><br><span class="line">pearplot</span><br><span class="line"><span class="comment">####看画板</span></span><br><span class="line"><span class="comment"># 自己选择性保存图片，但是 pearplot的图片必须要看，因为这个是做质控用的</span></span><br><span class="line"><span class="comment">## 可以看到，nFeature_RNA的范围在0到8000之内，percent.mt代表线粒体含量</span></span><br><span class="line"><span class="comment">### 默认线粒体含量至少要小于20%，这是根据生物学知识得出的默认阈值。红细胞的数目要至少小于5%</span></span><br><span class="line"><span class="comment">### 至于nFeature_RNA和nCount_RNA的阈值怎么确定，这个要结合 pearplot的图来判断。我们质控的目标就是删除离异值。而且注意阈值尽可能取的宽松一下，防止后面分析想要的细胞得不到。</span></span><br><span class="line"><span class="comment">### 接下来从pearplot的图片来做质控---剔除离异值</span></span><br><span class="line"><span class="comment">## nFeature_RNA选择大于200 小于7500的 nFeature_RNA选择小于100000，percent.mt小于20，percent.HB小于5</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">500</span> <span class="operator">&amp;</span> </span><br><span class="line">                      percent.mt <span class="operator">&lt;</span> <span class="number">20</span> <span class="operator">&amp;</span> percent.HB <span class="operator">&lt;</span> <span class="number">1</span> <span class="operator">&amp;</span> nCount_RNA <span class="operator">&gt;</span> <span class="number">1000</span><span class="punctuation">)</span></span><br><span class="line">scRNA</span><br><span class="line">scRNA1</span><br><span class="line"><span class="comment">### 在控制台中我们可以看到有500多细胞过滤了</span></span><br><span class="line"><span class="comment">#### 过滤完之后，就要对数据进行均一化，使用NormalizeData这个函数。</span></span><br><span class="line"><span class="comment">### 注意均一化是用NormalizeData，标准化是用ScaleData</span></span><br><span class="line"><span class="operator">?</span>NormalizeData</span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  NormalizeData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> normalization.method <span class="operator">=</span> <span class="string">&quot;LogNormalize&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                           scale.factor <span class="operator">=</span> <span class="number">10000</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c1  g1 <span class="number">20</span>  g2 <span class="number">40</span>    <span class="number">60</span></span><br><span class="line">c2  g1 <span class="number">15</span>  g2 <span class="number">15</span>    <span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c1  g1 <span class="number">20</span><span class="operator">/</span><span class="number">60</span>  g2 <span class="number">40</span><span class="operator">/</span><span class="number">60</span>    <span class="number">1</span></span><br><span class="line">c2  g1 <span class="number">15</span><span class="operator">/</span><span class="number">30</span>  g2 <span class="number">15</span><span class="operator">/</span><span class="number">30</span>    <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c2  g1 <span class="number">15</span>  g2 <span class="number">15</span>    <span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 好了，这一节数据加载、质控的内容就算是做完了。</span></span><br><span class="line"><span class="comment">### 在我们关闭rstudio之前 先把环境中运行好的数据保存一下</span></span><br><span class="line"><span class="comment">### 数据将保存在之前设定好的路径中。还有保存的scRNA1，不是scRNA，因为scRNA1才是过滤好的数据。</span></span><br><span class="line">save<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>file<span class="operator">=</span><span class="string">&#x27;scRNA1.Rdata&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 降维 20000 -&gt; 2000</span></span><br><span class="line"><span class="comment">### 官方推荐是2000个高变基因，很多文章也有设置30000的，这个因自己的实验项目决定</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  FindVariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                                  nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># Identify the 10 most highly variable genes，把top10的高变基因挑选出来，目的是为了作图</span></span><br><span class="line">top10 <span class="operator">&lt;-</span>  head<span class="punctuation">(</span>VariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># plot variable features with and without labels  画出来不带标签的高变基因图</span></span><br><span class="line">plot1 <span class="operator">&lt;-</span>  VariableFeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">### 把top10的基因加到图中</span></span><br><span class="line">plot2 <span class="operator">&lt;-</span>  LabelPoints<span class="punctuation">(</span>plot <span class="operator">=</span> plot1<span class="punctuation">,</span> points <span class="operator">=</span> top10<span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> size<span class="operator">=</span><span class="number">2.5</span><span class="punctuation">)</span> </span><br><span class="line">plot <span class="operator">&lt;-</span>  CombinePlots<span class="punctuation">(</span>plots <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>plot1<span class="punctuation">,</span> plot2<span class="punctuation">)</span><span class="punctuation">,</span>legend<span class="operator">=</span><span class="string">&quot;bottom&quot;</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment">### 画图</span></span><br><span class="line">plot </span><br><span class="line"><span class="comment">#### 去画板看看 想保存就自己手动保存 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 数据的中心化处理</span></span><br><span class="line"><span class="comment">### ScalaData 函数是数据比例伸缩</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 如果内存足够最好对所有基因进行中心化</span></span><br><span class="line">scale.genes <span class="operator">&lt;-</span>   rownames<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  ScaleData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> scale.genes<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 如果内存不够，可以只对高变基因进行标准化</span></span><br><span class="line">scale.genes <span class="operator">&lt;-</span>   VariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  ScaleData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> scale.genes<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>layers<span class="punctuation">[[</span><span class="string">&quot;counts&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>layers<span class="punctuation">[[</span><span class="string">&quot;data&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>assays<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>layers<span class="punctuation">[[</span><span class="string">&quot;scale.data&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#细胞周期回归：上一步找到的高变基因，常常会包含一些细胞周期相关基因。</span></span><br><span class="line"><span class="comment">#它们会导致细胞聚类发生一定的偏移，即相同类型的细胞在聚类时会因为细胞周期的不同而分开。</span></span><br><span class="line"><span class="operator">?</span>CaseMatch</span><br><span class="line">cc.genes</span><br><span class="line">CaseMatch<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span>cc.genes<span class="operator">$</span>s.genes<span class="punctuation">,</span>cc.genes<span class="operator">$</span>g2m.genes<span class="punctuation">)</span><span class="punctuation">,</span>VariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#细胞周期评分</span></span><br><span class="line">g2m_genes <span class="operator">=</span> cc.genes<span class="operator">$</span>g2m.genes</span><br><span class="line">g2m_genes <span class="operator">=</span> CaseMatch<span class="punctuation">(</span>search <span class="operator">=</span> g2m_genes<span class="punctuation">,</span> match <span class="operator">=</span> VariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">s_genes <span class="operator">=</span> cc.genes<span class="operator">$</span>s.genes</span><br><span class="line">s_genes <span class="operator">=</span> CaseMatch<span class="punctuation">(</span>search <span class="operator">=</span> s_genes<span class="punctuation">,</span> match <span class="operator">=</span> VariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  CellCycleScoring<span class="punctuation">(</span>object<span class="operator">=</span>scRNA1<span class="punctuation">,</span>  g2m.features<span class="operator">=</span>g2m_genes<span class="punctuation">,</span>  s.features<span class="operator">=</span>s_genes<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#查看细胞周期基因对细胞聚类的影响</span></span><br><span class="line">scRNAa <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>s_genes<span class="punctuation">,</span> g2m_genes<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">p <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>scRNAa<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;Phase&quot;</span><span class="punctuation">)</span></span><br><span class="line">p</span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNAa<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">,</span><span class="string">&quot;percent.HB&quot;</span><span class="punctuation">,</span><span class="string">&quot;G2M.Score&quot;</span><span class="punctuation">,</span><span class="string">&quot;S.Score&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;cellcycle_pca.png&quot;</span><span class="punctuation">,</span> p<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#scRNAb &lt;- ScaleData(scRNA1, vars.to.regress = c(&quot;S.Score&quot;, &quot;G2M.Score&quot;))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### PCA降维到了50个维度</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  RunPCA<span class="punctuation">(</span>scRNA1 <span class="punctuation">,</span> features <span class="operator">=</span> VariableFeatures<span class="punctuation">(</span>object <span class="operator">=</span> scRNA1<span class="punctuation">)</span> <span class="punctuation">)</span></span><br><span class="line">plot1 <span class="operator">&lt;-</span>  DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span> </span><br><span class="line">y1<span class="operator">=</span>scRNA1<span class="operator">@</span>reductions<span class="punctuation">[[</span><span class="string">&quot;pca&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>cell.embeddings</span><br><span class="line"></span><br><span class="line">ElbowPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> ndims<span class="operator">=</span><span class="number">50</span><span class="punctuation">,</span> reduction<span class="operator">=</span><span class="string">&quot;pca&quot;</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">pc.num<span class="operator">=</span><span class="number">1</span><span class="operator">:</span><span class="number">20</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span> </span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  FindClusters<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span>  <span class="comment">## resolution</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span> BuildClusterTree<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">PlotClusterTree<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 可视化降维 t-sne umap</span></span><br><span class="line">scRNA1 <span class="operator">=</span> RunTSNE<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">embed_tsne <span class="operator">&lt;-</span>  Embeddings<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> <span class="string">&#x27;tsne&#x27;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>embed_tsne<span class="punctuation">,</span> <span class="string">&#x27;embed_tsne.csv&#x27;</span><span class="punctuation">)</span></span><br><span class="line">plot1 <span class="operator">=</span> DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment">##画图</span></span><br><span class="line">plot1</span><br><span class="line"><span class="comment">###label = TRUE把注释展示在图中</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span> <span class="punctuation">)</span> </span><br><span class="line"><span class="comment">###你会发现cluster都标了图中</span></span><br><span class="line"><span class="operator">?</span>ggsave</span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;tSNE.pdf&quot;</span><span class="punctuation">,</span> plot <span class="operator">=</span> plot1<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">7</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##把图片保存一下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#UMAP---第二种可视化降维</span></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">embed_umap <span class="operator">&lt;-</span>  Embeddings<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> <span class="string">&#x27;umap&#x27;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>embed_umap<span class="punctuation">,</span><span class="string">&#x27;embed_umap.csv&#x27;</span><span class="punctuation">)</span> </span><br><span class="line">plot2 <span class="operator">=</span> DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span> </span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">plot2</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="多个样本数据整合"><a class="headerlink" href="#多个样本数据整合"></a>多个样本数据整合</h2>
<hr>
<p>样本的整合 就是 <strong>去除批次效应</strong>，批次效应指：当细胞以不同的分组处理时，可能发生批次效应，批次效应可以由不同芯片上的细胞，不同测序泳道中的细胞或者不同时间收获的细胞组成，细胞经历的不同环境对转录组的测量或者转录组本身产生的影响，产生的影响存在于多个层面：实验中的细胞组之间、在同一实验室进行的实验之间或者来着不同实验室的数据集之间</p>
<h3 id="Nature-Genetics-处理样本整合的代码"><a class="headerlink" href="#Nature-Genetics-处理样本整合的代码"></a>Nature Genetics 处理样本整合的代码</h3>
<p><strong>链接</strong>：<a target="_blank" rel="noopener" href="https://github.com/winstonbecker/scCRC_continuum/blob/main/snRNA_initial_clustering.R">scCRC_continuum/snRNA_initial_clustering.R at main · winstonbecker/scCRC_continuum · GitHub</a></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Script to analyze scRNA data from scHTAN and scHuBMAP Projects</span></span><br><span class="line"><span class="comment"># For this script we will just make some qc plots and do simple clustering to divide the samples into groups</span></span><br><span class="line"><span class="comment"># WRB 2020</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Import libraries</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>RColorBrewer<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ArchR<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>viridis<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>DoubletFinder<span class="punctuation">)</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># These are the analysis steps tht will be performed below, set execute steps to reflect which ones you want to do, note some are dependent on previous steps</span></span><br><span class="line"><span class="comment"># 1) Create seurat objects for individual 10x runs, run doblet finder and filter most likely doublets, merge into a seurat object containing all samples</span></span><br><span class="line"><span class="comment"># 2) QC and filtering</span></span><br><span class="line"><span class="comment"># 3) Add metadata</span></span><br><span class="line"><span class="comment"># 4) Normalize and scale data</span></span><br><span class="line"><span class="comment"># 5) Plot UMAPs</span></span><br><span class="line"><span class="comment"># 6) ID Cluster Markers</span></span><br><span class="line"><span class="comment"># 7) Initial cluster identification and seperation into compartments</span></span><br><span class="line"></span><br><span class="line">execute_steps <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define variables</span></span><br><span class="line">sample_name <span class="operator">&lt;-</span> <span class="string">&quot;all_samples&quot;</span></span><br><span class="line">individual_qc_and_dublet_plot_location <span class="operator">&lt;-</span> <span class="string">&quot;./initial_clustering/doublet_analysis/&quot;</span></span><br><span class="line">analysis_parent_folder <span class="operator">&lt;-</span> <span class="string">&quot;./initial_clustering/&quot;</span></span><br><span class="line">setwd<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">)</span></span><br><span class="line">path_to_metadata <span class="operator">&lt;-</span> <span class="string">&quot;./hubmap_htan_metadata_atac_and_rna_final.csv&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define sets and locations of files for initial processing</span></span><br><span class="line">scRNA_data_path <span class="operator">&lt;-</span> <span class="string">&quot;./data/&quot;</span></span><br><span class="line">scRNA_set_names <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;all_samples_s12a&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s12b&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s5&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s6&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s7&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s8&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s3&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s4&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s9&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s10&quot;</span><span class="punctuation">,</span> <span class="string">&quot;all_samples_s11&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA_sets <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;EP007&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-201&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-010&quot;</span><span class="punctuation">,</span><span class="string">&quot;A001-C-207&quot;</span><span class="punctuation">,</span><span class="string">&quot;A001-C-124&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;B004-A-204&quot;</span><span class="punctuation">,</span> <span class="string">&quot;B004-A-104&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A002-C-106&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A001-C-223&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A002-C-204&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A014-C-111&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A015-C-203&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-204&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-040&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-201&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-203&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;B001-A-301&quot;</span><span class="punctuation">,</span><span class="string">&quot;B001-A-401&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-008&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-208&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-114&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-043&quot;</span><span class="punctuation">,</span><span class="string">&quot;A001-C-202&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A001-C-119&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A001-C-108&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-021&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-212&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-205&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-101&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-108&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A001-C-104&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A015-C-005&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-006&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-106&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-114&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-104&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-202&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A001-C-014&quot;</span><span class="punctuation">,</span><span class="string">&quot;A001-C-023&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-016&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-024&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-001&quot;</span><span class="punctuation">,</span><span class="string">&quot;A014-C-054&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-002&quot;</span><span class="punctuation">,</span><span class="string">&quot;A015-C-010&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A015-C-109&quot;</span><span class="punctuation">,</span><span class="string">&quot;B004-A-004&quot;</span><span class="punctuation">,</span><span class="string">&quot;A002-C-121-R0&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A002-C-010-R0&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A001-C-007&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A001-C-203&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A002-C-116&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A002-C-121&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A008-E-008&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A008-E-015&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A010-E-018&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A010-E-023&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A014-C-008&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A014-C-052&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A015-C-001&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A018-E-013&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A018-E-020&quot;</span><span class="punctuation">,</span> <span class="string">&quot;B001-A-406&quot;</span><span class="punctuation">,</span> <span class="string">&quot;B001-A-501&quot;</span><span class="punctuation">,</span> <span class="string">&quot;B004-A-008&quot;</span><span class="punctuation">,</span> <span class="string">&quot;EP034&quot;</span><span class="punctuation">,</span> <span class="string">&quot;EP072B&quot;</span><span class="punctuation">,</span> <span class="string">&quot;EP091&quot;</span><span class="punctuation">,</span> <span class="string">&quot;A022-E-022&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">			<span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CRC1_8810&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CRC2_15564&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CRC3_11773&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Define functions</span></span><br><span class="line">seurat_standard_normalize_and_scale <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>colon<span class="punctuation">,</span> cluster<span class="punctuation">,</span> cluster_resolution<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># colon is seurat object, </span></span><br><span class="line">	colon <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>colon<span class="punctuation">,</span> normalization.method <span class="operator">=</span> <span class="string">&quot;LogNormalize&quot;</span><span class="punctuation">,</span> scale.factor <span class="operator">=</span> <span class="number">10000</span><span class="punctuation">)</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> FindVariableFeatures<span class="punctuation">(</span>colon<span class="punctuation">,</span> selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span></span><br><span class="line">	all.genes <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>colon<span class="punctuation">)</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>colon<span class="punctuation">,</span> features <span class="operator">=</span> all.genes<span class="punctuation">)</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>colon<span class="punctuation">,</span> features <span class="operator">=</span> VariableFeatures<span class="punctuation">(</span>object <span class="operator">=</span> colon<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	<span class="keyword">if</span> <span class="punctuation">(</span>cluster<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">		colon <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>colon<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">		colon <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>colon<span class="punctuation">,</span> resolution <span class="operator">=</span> cluster_resolution<span class="punctuation">)</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>colon<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">	<span class="built_in">return</span><span class="punctuation">(</span>colon<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">make_seurat_object_and_doublet_removal <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data_directory<span class="punctuation">,</span> project_name<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># function for basic seurat based qc and doubletfinder based doublet removal</span></span><br><span class="line">	colon.data <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span> data_directory<span class="punctuation">)</span></span><br><span class="line">	currentSample <span class="operator">&lt;-</span> CreateSeuratObject<span class="punctuation">(</span>counts <span class="operator">=</span> colon.data<span class="punctuation">,</span> project <span class="operator">=</span> project_name<span class="punctuation">,</span> min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">40</span><span class="punctuation">)</span></span><br><span class="line">	currentSample<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>currentSample<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># qc plot-pre filtering</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./qc_plots_&quot;</span><span class="punctuation">,</span> project_name<span class="punctuation">,</span> <span class="string">&quot;_prefiltered.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>VlnPlot<span class="punctuation">(</span>currentSample<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./qc_plots_&quot;</span><span class="punctuation">,</span> project_name<span class="punctuation">,</span> <span class="string">&quot;_prefiltered_no_points.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>VlnPlot<span class="punctuation">(</span>currentSample<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># filter everything to 400 unique genes/cell</span></span><br><span class="line">	currentSample <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>currentSample<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">400</span> <span class="operator">&amp;</span> nFeature_RNA <span class="operator">&lt;</span> <span class="number">4000</span><span class="punctuation">)</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># Normalize and make UMAP</span></span><br><span class="line">	currentSample <span class="operator">&lt;-</span> seurat_standard_normalize_and_scale<span class="punctuation">(</span>currentSample<span class="punctuation">,</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Run doublet finder</span></span><br><span class="line">	nExp_poi <span class="operator">&lt;-</span> <span class="built_in">round</span><span class="punctuation">(</span><span class="number">0.08</span><span class="operator">*</span><span class="built_in">length</span><span class="punctuation">(</span>currentSample<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span><span class="operator">*</span><span class="built_in">length</span><span class="punctuation">(</span>currentSample<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span><span class="operator">/</span><span class="number">10000</span><span class="punctuation">)</span>  <span class="comment">## Assuming 7.5% doublet formation rate - tailor for your dataset</span></span><br><span class="line">	seu_colon <span class="operator">&lt;-</span> doubletFinder_v3<span class="punctuation">(</span>currentSample<span class="punctuation">,</span> PCs <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">,</span> pN <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> pK <span class="operator">=</span> <span class="number">0.09</span><span class="punctuation">,</span> nExp <span class="operator">=</span> nExp_poi<span class="punctuation">,</span> reuse.pANN <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> sct <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>head<span class="punctuation">(</span>seu_colon<span class="operator">@</span>meta.data<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># rename columns</span></span><br><span class="line">	seu_colon<span class="operator">$</span>doublet.class <span class="operator">&lt;-</span> seu_colon<span class="punctuation">[[</span>paste0<span class="punctuation">(</span><span class="string">&quot;DF.classifications_0.25_0.09_&quot;</span><span class="punctuation">,</span>nExp_poi<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">	seu_colon<span class="punctuation">[[</span>paste0<span class="punctuation">(</span><span class="string">&quot;DF.classifications_0.25_0.09_&quot;</span><span class="punctuation">,</span>nExp_poi<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">	pann <span class="operator">&lt;-</span> grep<span class="punctuation">(</span>pattern<span class="operator">=</span><span class="string">&quot;^pANN&quot;</span><span class="punctuation">,</span> x<span class="operator">=</span><span class="built_in">names</span><span class="punctuation">(</span>seu_colon<span class="operator">@</span>meta.data<span class="punctuation">)</span><span class="punctuation">,</span> value<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">	seu_colon<span class="operator">$</span>pANN <span class="operator">&lt;-</span> seu_colon<span class="punctuation">[[</span>pann<span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">	seu_colon<span class="punctuation">[[</span>pann<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># plot pre and post doublet finder results</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_pre_double_removal&quot;</span><span class="punctuation">,</span> project_name<span class="punctuation">,</span> <span class="string">&quot;.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>seu_colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;doublet.class&quot;</span><span class="punctuation">,</span> cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#D51F26&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#272E6A&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">	seu_colon <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>seu_colon<span class="punctuation">,</span> subset <span class="operator">=</span> doublet.class <span class="operator">!=</span> <span class="string">&quot;Doublet&quot;</span><span class="punctuation">)</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_post_double_removal&quot;</span><span class="punctuation">,</span> project_name<span class="punctuation">,</span> <span class="string">&quot;.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>seu_colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#D51F26&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Remove extra stuff and return filtered Seurat object</span></span><br><span class="line">	seu_colon <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>seu_colon<span class="punctuation">,</span> counts<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> data<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> scale.data<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> assays<span class="operator">=</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line">	<span class="built_in">return</span><span class="punctuation">(</span>seu_colon<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">seurat_qc_plots <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>colon<span class="punctuation">,</span> sample_name<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># Make some basic qc plots</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./seurat_nFeature_plots_&quot;</span><span class="punctuation">,</span> sample_name<span class="punctuation">,</span> <span class="string">&quot;.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">40</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>VlnPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./seurat_nCount_plots_&quot;</span><span class="punctuation">,</span> sample_name<span class="punctuation">,</span> <span class="string">&quot;.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">40</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>VlnPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./seurat_pMT_plots_&quot;</span><span class="punctuation">,</span> sample_name<span class="punctuation">,</span> <span class="string">&quot;.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">40</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>VlnPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 1) Create seurat objects for individual 10x runs, run doblet finder and filter most likely doublets, merge into a seurat object containing all samples</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">1</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	setwd<span class="punctuation">(</span>individual_qc_and_dublet_plot_location<span class="punctuation">)</span></span><br><span class="line">	<span class="keyword">for</span> <span class="punctuation">(</span>j <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>scRNA_set_names<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">		samples <span class="operator">&lt;-</span> scRNA_sets<span class="punctuation">[[</span>j<span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">		print<span class="punctuation">(</span>paste0<span class="punctuation">(</span>scRNA_data_path<span class="punctuation">,</span> samples<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="string">&quot;/outs/filtered_feature_bc_matrix/&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">		data_directory <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>scRNA_data_path<span class="punctuation">,</span> samples<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="string">&quot;/outs/filtered_feature_bc_matrix/&quot;</span><span class="punctuation">)</span></span><br><span class="line">		sample1 <span class="operator">&lt;-</span> make_seurat_object_and_doublet_removal<span class="punctuation">(</span>data_directory<span class="punctuation">,</span> samples<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">		seu_list <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">		<span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">2</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>samples<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">			data_directory <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>scRNA_data_path<span class="punctuation">,</span> samples<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> <span class="string">&quot;/outs/filtered_feature_bc_matrix/&quot;</span><span class="punctuation">)</span></span><br><span class="line">			seu_list <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span>seu_list<span class="punctuation">,</span> make_seurat_object_and_doublet_removal<span class="punctuation">(</span>data_directory<span class="punctuation">,</span> samples<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">		current_merge <span class="operator">&lt;-</span> merge<span class="punctuation">(</span>sample1<span class="punctuation">,</span> y <span class="operator">=</span> seu_list<span class="punctuation">,</span> add.cell.ids <span class="operator">=</span> samples<span class="punctuation">,</span> project <span class="operator">=</span> scRNA_set_names<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">		<span class="keyword">if</span> <span class="punctuation">(</span>j<span class="operator">==</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">			colon <span class="operator">&lt;-</span> current_merge</span><br><span class="line">		<span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span>j<span class="operator">&gt;</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">			colon <span class="operator">&lt;-</span> merge<span class="punctuation">(</span>colon<span class="punctuation">,</span> y <span class="operator">=</span> current_merge<span class="punctuation">,</span> project <span class="operator">=</span> <span class="string">&quot;full_colon_project&quot;</span><span class="punctuation">)</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">	setwd<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">)</span></span><br><span class="line">	colon<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>colon<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon<span class="punctuation">,</span> <span class="string">&quot;initial_full_colon_proj_seurat.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> elif <span class="punctuation">(</span><span class="number">2</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># if 1 is not a step, but 2 is then you need to load the initial object</span></span><br><span class="line">	setwd<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">)</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;initial_full_colon_proj_seurat.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">	<span class="comment"># clean up if necessary:</span></span><br><span class="line">	pann <span class="operator">&lt;-</span> grep<span class="punctuation">(</span>pattern<span class="operator">=</span><span class="string">&quot;^pANN&quot;</span><span class="punctuation">,</span> x<span class="operator">=</span><span class="built_in">names</span><span class="punctuation">(</span>colon<span class="operator">@</span>meta.data<span class="punctuation">)</span><span class="punctuation">,</span> value<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">	<span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> pann<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	  colon<span class="punctuation">[[</span>i<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">	pann <span class="operator">&lt;-</span> grep<span class="punctuation">(</span>pattern<span class="operator">=</span><span class="string">&quot;^DF.classification&quot;</span><span class="punctuation">,</span> x<span class="operator">=</span><span class="built_in">names</span><span class="punctuation">(</span>colon<span class="operator">@</span>meta.data<span class="punctuation">)</span><span class="punctuation">,</span> value<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">	<span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> pann<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	  colon<span class="punctuation">[[</span>i<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 2) QC</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">2</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># create and set working directory to save qc plots</span></span><br><span class="line">	<span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>dir.exists<span class="punctuation">(</span>paste0<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">,</span> <span class="string">&quot;all_samples_qc_plots&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">		dir.create<span class="punctuation">(</span>paste0<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">,</span> <span class="string">&quot;all_samples_qc_plots&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">	setwd<span class="punctuation">(</span>paste0<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">,</span> <span class="string">&quot;all_samples_qc_plots&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># make the standard seurat qc plots</span></span><br><span class="line">	seurat_qc_plots<span class="punctuation">(</span>colon<span class="punctuation">,</span> sample_name<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Now subset the project (if not done already)</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>colon<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">400</span> <span class="operator">&amp;</span> nFeature_RNA <span class="operator">&lt;</span> <span class="number">4000</span> <span class="operator">&amp;</span> percent.mt <span class="operator">&lt;</span> <span class="number">5</span> <span class="operator">&amp;</span> nCount_RNA <span class="operator">&lt;</span> <span class="number">10000</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># leave the qc directory</span></span><br><span class="line">	setwd<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 3) Add metadata</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">3</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	metadata <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span>path_to_metadata<span class="punctuation">,</span> header <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;,&quot;</span><span class="punctuation">,</span> stringsAsFactors<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># remove atac column</span></span><br><span class="line">	metadata <span class="operator">&lt;-</span> metadata<span class="punctuation">[</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span>metadata<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="operator">:</span><span class="number">28</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">	colnames<span class="punctuation">(</span>metadata<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Sample&quot;</span><span class="punctuation">,</span> colnames<span class="punctuation">(</span>metadata<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="operator">:</span><span class="number">27</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">	metadata <span class="operator">&lt;-</span> metadata<span class="punctuation">[</span>metadata<span class="operator">$</span>Sample <span class="operator">!=</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">	meta_data_types <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span>metadata<span class="punctuation">)</span></span><br><span class="line">	<span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">2</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>meta_data_types<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">		identities <span class="operator">&lt;-</span> colon<span class="punctuation">[[</span><span class="string">&#x27;orig.ident&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">		<span class="keyword">for</span> <span class="punctuation">(</span>j <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>metadata<span class="operator">$</span>Sample<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">			identities<span class="punctuation">[</span>identities<span class="operator">==</span>metadata<span class="operator">$</span>Sample<span class="punctuation">[</span>j<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> metadata<span class="punctuation">[</span>j<span class="punctuation">,</span>meta_data_types<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">		colon <span class="operator">&lt;-</span> AddMetaData<span class="punctuation">(</span>colon<span class="punctuation">,</span> identities<span class="operator">$</span>orig.ident<span class="punctuation">,</span> col.name <span class="operator">=</span> meta_data_types<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 4) Normalize and scale data</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">4</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> seurat_standard_normalize_and_scale<span class="punctuation">(</span>colon<span class="punctuation">,</span> <span class="literal">TRUE</span><span class="punctuation">,</span> <span class="number">1.0</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 5) Plot UMAPs</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">5</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># Plot by clustering, sample, and disease state</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>colon<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAPclustering&quot;</span> <span class="punctuation">,</span> <span class="string">&quot;.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> onefile<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> cols <span class="operator">=</span> paletteDiscrete<span class="punctuation">(</span>values <span class="operator">=</span> unique<span class="punctuation">(</span>colon<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span><span class="punctuation">,</span> set <span class="operator">=</span> <span class="string">&quot;stallion&quot;</span><span class="punctuation">,</span> reverse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_samples.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">,</span> onefile<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> cols <span class="operator">=</span> paletteDiscrete<span class="punctuation">(</span>values <span class="operator">=</span> unique<span class="punctuation">(</span>colon<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span><span class="punctuation">,</span> set <span class="operator">=</span> <span class="string">&quot;stallion&quot;</span><span class="punctuation">,</span> reverse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_donor.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">,</span> onefile<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;Donor&quot;</span><span class="punctuation">,</span> cols <span class="operator">=</span> paletteDiscrete<span class="punctuation">(</span>values <span class="operator">=</span> unique<span class="punctuation">(</span>colon<span class="operator">@</span>meta.data<span class="operator">$</span>Donor<span class="punctuation">)</span><span class="punctuation">,</span> set <span class="operator">=</span> <span class="string">&quot;stallion&quot;</span><span class="punctuation">,</span> reverse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_disease_state.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">6.5</span><span class="punctuation">,</span> onefile<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">	print<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;DiseaseState&quot;</span><span class="punctuation">,</span></span><br><span class="line">		cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#D51F26&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#D7CEC7&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#89288F&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#D7CEC7&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> theme_ArchR<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon<span class="punctuation">,</span> <span class="string">&quot;clustered_full_colon_proj_seurat.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 6) ID Cluster Markers</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">6</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># Find cluster specific markers</span></span><br><span class="line">	colon.markers <span class="operator">&lt;-</span> FindAllMarkers<span class="punctuation">(</span>colon<span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> max.cells.per.ident <span class="operator">=</span> <span class="number">250</span><span class="punctuation">)</span></span><br><span class="line">	top10 <span class="operator">&lt;-</span> colon.markers <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_logFC<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment">#............................................................................................................................#</span></span><br><span class="line"><span class="comment">##############################################################################################################################</span></span><br><span class="line"><span class="comment"># 7) Initial cluster identification</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="number">7</span> <span class="operator">%in%</span> execute_steps<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment"># Rough initial cluster identification</span></span><br><span class="line">	new.cluster.ids <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span> <span class="comment">#0</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span><span class="comment">#5</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Immune&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Stromal&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Immune&quot;</span><span class="punctuation">,</span><span class="comment">#10</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Stromal&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Immune&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span><span class="comment">#15</span></span><br><span class="line">		<span class="string">&quot;Stromal&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Stromal&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Immune&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Tuft&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span><span class="comment">#20</span></span><br><span class="line">		<span class="string">&quot;Immune&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Enteroendocrine&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Stromal&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="string">&quot;Immune&quot;</span><span class="comment">#25</span></span><br><span class="line">		<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	identities <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>colon<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line">	<span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">0</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>new.cluster.ids<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">		identities<span class="punctuation">[</span>identities<span class="operator">==</span><span class="built_in">as.character</span><span class="punctuation">(</span>i<span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> new.cluster.ids<span class="punctuation">[</span>i<span class="operator">+</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">	colon <span class="operator">&lt;-</span> AddMetaData<span class="punctuation">(</span>colon<span class="punctuation">,</span> identities<span class="punctuation">,</span> col.name <span class="operator">=</span> <span class="string">&quot;CellTypeInitial&quot;</span><span class="punctuation">)</span></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_cell_type_initial.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">)</span></span><br><span class="line">	AugmentPlot<span class="punctuation">(</span>DimPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;CellTypeInitial&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	pdf<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;./UMAP_cell_type_initial_v2.pdf&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">)</span></span><br><span class="line">	plot <span class="operator">=</span> DimPlot<span class="punctuation">(</span>colon<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;CellTypeInitial&quot;</span><span class="punctuation">)</span></span><br><span class="line">	plot <span class="operator">=</span> LabelClusters<span class="punctuation">(</span>plot <span class="operator">=</span> plot<span class="punctuation">,</span> id <span class="operator">=</span> <span class="string">&quot;CellTypeInitial&quot;</span><span class="punctuation">)</span></span><br><span class="line">	AugmentPlot<span class="punctuation">(</span>plot<span class="punctuation">)</span></span><br><span class="line">	dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Save ids of immune, epithelial, and stromal cells</span></span><br><span class="line">	immune_clusters <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">8</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">18</span><span class="punctuation">,</span><span class="number">21</span><span class="punctuation">,</span><span class="number">25</span><span class="punctuation">)</span></span><br><span class="line">	stromal_clusters <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">9</span><span class="punctuation">,</span><span class="number">12</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">,</span><span class="number">17</span><span class="punctuation">,</span><span class="number">24</span><span class="punctuation">)</span></span><br><span class="line">	epithelial_clusters <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">,</span><span class="number">11</span><span class="punctuation">,</span><span class="number">13</span><span class="punctuation">,</span><span class="number">15</span><span class="punctuation">,</span><span class="number">19</span><span class="punctuation">,</span><span class="number">20</span><span class="punctuation">,</span><span class="number">22</span><span class="punctuation">,</span><span class="number">23</span><span class="punctuation">)</span></span><br><span class="line">	epithelial_specialized_clusters <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">19</span><span class="punctuation">,</span><span class="number">23</span><span class="punctuation">)</span></span><br><span class="line">	epithelial_nonspecialized_clusters <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">,</span><span class="number">12</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">20</span><span class="punctuation">,</span><span class="number">21</span><span class="punctuation">,</span><span class="number">25</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Subset to make immune, stromal, and epithelial projects</span></span><br><span class="line">	colon_immune <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>subset<span class="punctuation">(</span>colon<span class="punctuation">,</span> subset <span class="operator">=</span> seurat_clusters <span class="operator">%in%</span> immune_clusters<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	colon_stromal <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>subset<span class="punctuation">(</span>colon<span class="punctuation">,</span> subset <span class="operator">=</span> seurat_clusters <span class="operator">%in%</span> stromal_clusters<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	colon_epitehlial <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>subset<span class="punctuation">(</span>colon<span class="punctuation">,</span> subset <span class="operator">=</span> seurat_clusters <span class="operator">%in%</span> epithelial_clusters<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	colon_specialized_epitehlial <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>subset<span class="punctuation">(</span>colon<span class="punctuation">,</span> subset <span class="operator">=</span> seurat_clusters <span class="operator">%in%</span> epithelial_specialized_clusters<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">	colon_nonspecialized_epitehlial <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>subset<span class="punctuation">(</span>colon<span class="punctuation">,</span> subset <span class="operator">=</span> seurat_clusters <span class="operator">%in%</span> epithelial_nonspecialized_clusters<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon_immune<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;colon_immune_all_samples_initial.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon_stromal<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;colon_stromal_all_samples_initial.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon_epitehlial<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;colon_epithelial_all_samples_initial.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon_specialized_epitehlial<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;colon_specialized_epitehlial_all_samples_initial.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">	saveRDS<span class="punctuation">(</span>colon_nonspecialized_epitehlial<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;colon_nonspecialized_epitehlial_all_samples_initial.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="两种归一化算法"><a class="headerlink" href="#两种归一化算法"></a>两种归一化算法</h3>
<hr>
<h4 id="SCTransfrom"><a class="headerlink" href="#SCTransfrom"></a>SCTransfrom</h4>
<p>SCTransform 是对单细胞RNA测序数据进行归一化和方差稳定化，它通常与基于锚定点的整合方法结合使用，以实现不同数据集之间的整合，尤其是在跨样本、跨实验甚至跨物种的分析中。</p>
<p>基于锚定点的方法，最常见于 Seurat 的  <code>FindIntegrationAnchors()</code>  和  <code>IntegrateData()</code>  函数中，是用来在不同数据集之间找到共同的“锚定点” —— 这些点代表了不同数据集中相似的细胞或基因表达模式。</p>
<p>eg：</p>
<p><strong>Single-cell protein activity analysis identifies recurrence-associated renal tumor macrophages</strong></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s2 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>s2<span class="punctuation">,</span> subset <span class="operator">=</span> percent.mt <span class="operator">&lt;</span> <span class="number">10</span> <span class="operator">&amp;</span> nCount_RNA <span class="operator">&gt;</span> <span class="number">1000</span> <span class="operator">&amp;</span> nCount_RNA <span class="operator">&lt;</span> <span class="number">15000</span><span class="punctuation">)</span></span><br><span class="line">s2 <span class="operator">&lt;-</span> SCTransform<span class="punctuation">(</span>s2<span class="punctuation">,</span>return.only.var.genes <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>verbose <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span>conserve.memory <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## SCTransform 包含：归一化处理、找高变基因以及数据放缩</span></span><br><span class="line"></span><br><span class="line">s2 <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>s2<span class="punctuation">,</span> features <span class="operator">=</span> VariableFeatures<span class="punctuation">(</span>object <span class="operator">=</span> s2<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">s2 <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>s2<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span>umap.method<span class="operator">=</span><span class="string">&quot;umap-learn&quot;</span><span class="punctuation">,</span>metric<span class="operator">=</span><span class="string">&quot;correlation&quot;</span><span class="punctuation">)</span></span><br><span class="line">s2 <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>s2<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">s2 <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>s2<span class="punctuation">,</span> resolution<span class="operator">=</span>seq<span class="punctuation">(</span><span class="number">0.01</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>by<span class="operator">=</span><span class="number">0.01</span><span class="punctuation">)</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span>algorithm<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<h4 id="Harmony"><a class="headerlink" href="#Harmony"></a>Harmony</h4>
<p><strong>Harmony的优势</strong>：</p>
<ol>
<li>整合数据的同时对稀有细胞的敏感性较好</li>
<li>省内存</li>
<li>适用于更复杂的单细胞分析实验设计，可以比较来自不同供体、组织和技术平台的细胞</li>
</ol>
<p>eg：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## install.packages(&quot;devtools&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>devtools<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## install_github(&quot;immunogenomics/harmony&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#BiocManager::install(&quot;SingleCellExperiment&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA.11<span class="operator">=</span>Read10X<span class="punctuation">(</span><span class="string">&quot;BC2/&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA.3<span class="operator">=</span>Read10X<span class="punctuation">(</span><span class="string">&quot;BC21/&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA.11 <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>scRNA.11 <span class="punctuation">,</span>project<span class="operator">=</span><span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span>min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line">scRNA.3 <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>scRNA.3 <span class="punctuation">,</span>project<span class="operator">=</span><span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span>min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> merge<span class="punctuation">(</span>x<span class="operator">=</span>scRNA.11<span class="punctuation">,</span> y<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span>scRNA.3 <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindVariableFeatures<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> ScaleData<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> RunPCA<span class="punctuation">(</span>verbose<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> RunHarmony<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> group.by.vars <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#system.time(&#123;scRNA_harmony &lt;-  RunHarmony(scRNA_harmony, group.by.vars = &quot;orig.ident&quot;)&#125;)</span></span><br><span class="line"><span class="comment">###问题 harmony之后的数据在哪里？</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###一定要指定harmony</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindClusters<span class="punctuation">(</span>resolution <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>DimPlot</span><br><span class="line">plot1 <span class="operator">=</span>DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line">plot2 <span class="operator">=</span> DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&#x27;orig.ident&#x27;</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#combinate</span></span><br><span class="line">plotc <span class="operator">&lt;-</span> plot1<span class="operator">+</span>plot2</span><br><span class="line">plotc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="现阶段单细胞流程分析总结"><a class="headerlink" href="#现阶段单细胞流程分析总结"></a>现阶段单细胞流程分析总结</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">make_seurat_pp<span class="operator">=</span><span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  </span><br><span class="line">  scRNA.counts<span class="operator">=</span>Read10X<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  scRNA <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>scRNA.counts <span class="punctuation">,</span></span><br><span class="line">                             min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>project<span class="operator">=</span>y<span class="punctuation">,</span> </span><br><span class="line">                             min.features <span class="operator">=</span> <span class="number">40</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>scRNA<span class="punctuation">,</span> normalization.method <span class="operator">=</span> <span class="string">&quot;LogNormalize&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                             scale.factor <span class="operator">=</span> <span class="number">10000</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span> FindVariableFeatures<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                                    nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span> </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  scale.genes <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> scale.genes<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span>  RunPCA<span class="punctuation">(</span>scRNA1 <span class="punctuation">)</span> </span><br><span class="line">  </span><br><span class="line">  pc.num<span class="operator">=</span><span class="number">1</span><span class="operator">:</span><span class="number">20</span></span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> dims <span class="operator">=</span> pc.num<span class="punctuation">)</span> </span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  scRNA1 <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> dims <span class="operator">=</span> pc.num<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="四种数据整合方式的对比"><a class="headerlink" href="#四种数据整合方式的对比"></a>四种数据整合方式的对比</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 数据的整合</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/Study_R/20240913/&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">x<span class="operator">=</span>list.files<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="string">&quot;abc&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 内容</span></span><br><span class="line">dir <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;./BC2/&#x27;</span><span class="punctuation">,</span> <span class="string">&quot;./BC21/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 起的名字</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>dir<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;s1&#x27;</span><span class="punctuation">,</span>  <span class="string">&#x27;s2&#x27;</span><span class="punctuation">)</span>      </span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>Read10X</span><br><span class="line"></span><br><span class="line"><span class="comment">## Read10X可以把两个样本读取到一个对象中</span></span><br><span class="line">counts <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span>dir<span class="punctuation">)</span></span><br><span class="line">scRNA1 <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>counts<span class="punctuation">,</span> min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA1<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^MT-&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span></span><br><span class="line">        features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span> <span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        </span><br><span class="line">        pt.size <span class="operator">=</span> <span class="number">0.01</span><span class="punctuation">,</span> <span class="comment">#不需要显示点，可以设置pt.size = 0</span></span><br><span class="line">        ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">scRNA2 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">500</span> <span class="operator">&amp;</span> </span><br><span class="line">                      percent.mt <span class="operator">&lt;</span> <span class="number">20</span> <span class="operator">&amp;</span>   nCount_RNA <span class="operator">&gt;</span> <span class="number">1000</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA3<span class="operator">=</span>SplitObject<span class="punctuation">(</span>scRNA2<span class="punctuation">,</span>split.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb<span class="operator">=</span>scRNA2</span><br><span class="line">ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> split<span class="punctuation">(</span>ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> f <span class="operator">=</span> ifnb<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">ifnb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 如果不用整合的话，分析的流程</span></span><br><span class="line"><span class="comment">##Perform analysis without integration</span></span><br><span class="line"><span class="comment"># run standard anlaysis workflow</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  NormalizeData<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindVariableFeatures<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  ScaleData<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunPCA<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> cluster.name <span class="operator">=</span> <span class="string">&quot;unintegrated_clusters&quot;</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> reduction.name <span class="operator">=</span> <span class="string">&quot;umap.unintegrated&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap.unintegrated&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> <span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 常规整合 cca</span></span><br><span class="line"><span class="comment">## Perform integration</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  IntegrateLayers<span class="punctuation">(</span>object <span class="operator">=</span> ifnb<span class="punctuation">,</span> method <span class="operator">=</span> CCAIntegration<span class="punctuation">,</span> orig.reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> new.reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           verbose <span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re-join layers after integration</span></span><br><span class="line">ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span>  JoinLayers<span class="punctuation">(</span>ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Visualization</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span><span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 用SCTransform整合</span></span><br><span class="line"><span class="comment">## Perform integration with SCTransform-normalized datasets</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  SCTransform<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### SCTransform包含：NormalizeData、FindVariableFeatures、ScaleData，可以把这三个函数直接省略掉</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunPCA<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> <span class="string">&quot;seurat_annotations&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># integrate datasets</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  IntegrateLayers<span class="punctuation">(</span>object <span class="operator">=</span> ifnb<span class="punctuation">,</span> method <span class="operator">=</span> CCAIntegration<span class="punctuation">,</span> normalization.method <span class="operator">=</span> <span class="string">&quot;SCT&quot;</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.dr&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">0.6</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.dr&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> <span class="string">&quot;seurat_annotations&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 用Harmony整合</span></span><br><span class="line"><span class="comment">## install.packages(&quot;devtools&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>devtools<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## install_github(&quot;immunogenomics/harmony&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#BiocManager::install(&quot;SingleCellExperiment&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA.11<span class="operator">=</span>Read10X<span class="punctuation">(</span><span class="string">&quot;BC2/&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA.3<span class="operator">=</span>Read10X<span class="punctuation">(</span><span class="string">&quot;BC21/&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA.11 <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>scRNA.11 <span class="punctuation">,</span>project<span class="operator">=</span><span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span>min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line">scRNA.3 <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>scRNA.3 <span class="punctuation">,</span>project<span class="operator">=</span><span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span>min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> merge<span class="punctuation">(</span>x<span class="operator">=</span>scRNA.11<span class="punctuation">,</span> y<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span>scRNA.3 <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindVariableFeatures<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> ScaleData<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> RunPCA<span class="punctuation">(</span>verbose<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> RunHarmony<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> group.by.vars <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#system.time(&#123;scRNA_harmony &lt;-  RunHarmony(scRNA_harmony, group.by.vars = &quot;orig.ident&quot;)&#125;)</span></span><br><span class="line"><span class="comment">###问题 harmony之后的数据在哪里？</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###一定要指定harmony</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindClusters<span class="punctuation">(</span>resolution <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>DimPlot</span><br><span class="line">plot1 <span class="operator">=</span>DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line">plot2 <span class="operator">=</span> DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&#x27;orig.ident&#x27;</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#combinate</span></span><br><span class="line">plotc <span class="operator">&lt;-</span> plot1<span class="operator">+</span>plot2</span><br><span class="line">plotc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################################################################</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="双细胞的去除"><a class="headerlink" href="#双细胞的去除"></a>双细胞的去除</h2>
<hr>
<h3 id="单个样本的双细胞的去除"><a class="headerlink" href="#单个样本的双细胞的去除"></a>单个样本的双细胞的去除</h3>
<p><strong>双细胞的原理</strong>：</p>
<ol>
<li>从现有单细胞数据中人为产生doublets</li>
<li>将人工产生的doublets与真实细胞混合在一起</li>
<li>用PCA降维或者用PCA距离矩阵寻找每个单元的artificial k最近邻居（pANN）的比例</li>
<li>根据预期的doublets数量进行排序和计算pANN阈值</li>
</ol>
<p>eg：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/Study_R/&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#remotes::install_github(&#x27;chris-mcginnis-ucsf/DoubletFinder&#x27;)</span></span><br><span class="line">library<span class="punctuation">(</span>DoubletFinder<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kidney.data<span class="operator">=</span>Read10X<span class="punctuation">(</span><span class="string">&quot;BC10/&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## Pre-process Seurat object (standard) --------------------------------------------------------------------------------------</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span>  CreateSeuratObject<span class="punctuation">(</span>kidney.data<span class="punctuation">)</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span>  NormalizeData<span class="punctuation">(</span>seu_kidney<span class="punctuation">)</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span>  FindVariableFeatures<span class="punctuation">(</span>seu_kidney<span class="punctuation">,</span> selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span>  ScaleData<span class="punctuation">(</span>seu_kidney<span class="punctuation">)</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span>  RunPCA<span class="punctuation">(</span>seu_kidney<span class="punctuation">)</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>seu_kidney<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 找pk值</span></span><br><span class="line"><span class="comment">## pK 控制的是每个细胞的邻域大小，即在计算双重细胞评分时，用于评估每个细胞周围的细胞数量</span></span><br><span class="line"><span class="comment">## pK Identification (no ground-truth) ---------------------------------------------------------------------------------------</span></span><br><span class="line">sweep.res.list_kidney <span class="operator">&lt;-</span> paramSweep<span class="punctuation">(</span>seu_kidney<span class="punctuation">,</span> PCs <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">,</span> sct <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">sweep.stats_kidney <span class="operator">&lt;-</span> summarizeSweep<span class="punctuation">(</span>sweep.res.list_kidney<span class="punctuation">,</span> GT <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">bcmvn_kidney <span class="operator">&lt;-</span> find.pK<span class="punctuation">(</span>sweep.stats_kidney<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Assuming 7.5% doublet formation rate - tailor for your dataset</span></span><br><span class="line">nExp_poi <span class="operator">&lt;-</span> <span class="built_in">round</span><span class="punctuation">(</span><span class="number">0.08</span><span class="operator">*</span><span class="built_in">length</span><span class="punctuation">(</span>seu_kidney<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span><span class="operator">*</span><span class="built_in">length</span><span class="punctuation">(</span>seu_kidney<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span><span class="operator">/</span><span class="number">10000</span><span class="punctuation">)</span>  </span><br><span class="line"><span class="comment">#DoubletRate1 = ncol(seu_kidney)*8*1e-6 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Run DoubletFinder with varying classification stringencies ----------------------------------------------------------------</span></span><br><span class="line">seu_kidney <span class="operator">&lt;-</span> doubletFinder<span class="punctuation">(</span>seu_kidney<span class="punctuation">,</span> PCs <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">,</span> pN <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> pK <span class="operator">=</span> <span class="number">0.09</span><span class="punctuation">,</span> nExp <span class="operator">=</span> nExp_poi<span class="punctuation">,</span> reuse.pANN <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> sct <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>seu_kidney<span class="operator">@</span>meta.data<span class="operator">$</span>DF.classifications_0.25_0.09_2445<span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seu_colon<span class="operator">=</span>seu_kidney</span><br><span class="line"><span class="comment"># rename columns</span></span><br><span class="line">seu_colon<span class="operator">$</span>doublet.class <span class="operator">&lt;-</span> seu_colon<span class="punctuation">[[</span>paste0<span class="punctuation">(</span><span class="string">&quot;DF.classifications_0.25_0.09_&quot;</span><span class="punctuation">,</span>nExp_poi<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">seu_colon<span class="punctuation">[[</span>paste0<span class="punctuation">(</span><span class="string">&quot;DF.classifications_0.25_0.09_&quot;</span><span class="punctuation">,</span>nExp_poi<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">pann <span class="operator">&lt;-</span> grep<span class="punctuation">(</span>pattern<span class="operator">=</span><span class="string">&quot;^pANN&quot;</span><span class="punctuation">,</span> x<span class="operator">=</span><span class="built_in">names</span><span class="punctuation">(</span>seu_colon<span class="operator">@</span>meta.data<span class="punctuation">)</span><span class="punctuation">,</span> value<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">seu_colon<span class="operator">$</span>pANN <span class="operator">&lt;-</span> seu_colon<span class="punctuation">[[</span>pann<span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">seu_colon<span class="punctuation">[[</span>pann<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">seu_colon1 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>seu_colon<span class="punctuation">,</span> subset <span class="operator">=</span> doublet.class <span class="operator">==</span> <span class="string">&quot;Singlet&quot;</span><span class="punctuation">)</span></span><br><span class="line">seu_colon2 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>seu_colon<span class="punctuation">,</span> subset <span class="operator">=</span> doublet.class <span class="operator">!=</span> <span class="string">&quot;Doublet&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove extra stuff and return filtered Seurat object</span></span><br><span class="line">seu_colon3 <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>seu_colon1<span class="punctuation">,</span> counts<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> data<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> scale.data<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> assays<span class="operator">=</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="亚群注释"><a class="headerlink" href="#亚群注释"></a>亚群注释</h2>
<hr>
<p><strong>目标</strong>：</p>
<ol>
<li>确定每个类群的基因标记物</li>
<li>使用标记物识别每个类群的细胞类型</li>
<li>根据细胞类型标记物来判断是否需要重新分组，或者需要合并或者拆分聚类的类群</li>
</ol>
<p><strong>可以查询marker基因的网站</strong>：<a target="_blank" rel="noopener" href="http://xteam.xbio.top/CellMarker/">CellMarker (xbio.top)</a></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>RColorBrewer<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>viridis<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>DoubletFinder<span class="punctuation">)</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/Study_R/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data_directory<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;BC2/&quot;</span> <span class="punctuation">,</span><span class="string">&quot;BC21/&quot;</span><span class="punctuation">)</span></span><br><span class="line">project_name<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;sample21&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">samples <span class="operator">&lt;-</span> project_name</span><br><span class="line"></span><br><span class="line">sample1 <span class="operator">&lt;-</span> make_seurat_object_and_doublet_removal<span class="punctuation">(</span>data_directory<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> samples<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###  多个样本合并 </span></span><br><span class="line">seu_list <span class="operator">&lt;-</span> sample1</span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">2</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>samples<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  sc.i <span class="operator">=</span> make_seurat_object_and_doublet_removal<span class="punctuation">(</span>data_directory<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span> samples<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  seu_list<span class="operator">=</span>merge<span class="punctuation">(</span>seu_list<span class="punctuation">,</span>sc.i<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>seu_list<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA_harmony<span class="operator">=</span>seu_list</span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>scRNA_harmony <span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindVariableFeatures<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> ScaleData<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> RunPCA<span class="punctuation">(</span>verbose<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> RunHarmony<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> group.by.vars <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">###问题 harmony之后的数据在哪里？</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###一定要指定harmony</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span> <span class="operator">%&amp;gt;%</span> FindClusters<span class="punctuation">(</span>resolution <span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony <span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> split.by <span class="operator">=</span><span class="string">&#x27;orig.ident&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&#x27;orig.ident&#x27;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>orig.ident<span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line">save<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">###  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 另外一种整合方法  ---CCA 锚定点整合</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span> split</span><br><span class="line">ifnb<span class="operator">=</span>seu_list</span><br><span class="line">ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> split<span class="punctuation">(</span>ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> f <span class="operator">=</span> ifnb<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">ifnb</span><br><span class="line"></span><br><span class="line"><span class="comment">##Perform analysis without integration</span></span><br><span class="line"><span class="comment"># run standard anlaysis workflow</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindVariableFeatures<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> cluster.name <span class="operator">=</span> <span class="string">&quot;unintegrated_clusters&quot;</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> reduction.name <span class="operator">=</span> <span class="string">&quot;umap.unintegrated&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap.unintegrated&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> <span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Perform integration</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> IntegrateLayers<span class="punctuation">(</span>object <span class="operator">=</span> ifnb<span class="punctuation">,</span> method <span class="operator">=</span> CCAIntegration<span class="punctuation">,</span> orig.reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> new.reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           verbose <span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re-join layers after integration</span></span><br><span class="line">ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># Visualization</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span><span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 亚群注释</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment">### 方法一</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### JoinLayers可以把多个样本进行合并</span></span><br><span class="line">scRNA_harmony<span class="operator">=</span>JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 下载MAST包</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;https://mirrors.westlake.edu.cn/bioconductor&quot;</span><span class="punctuation">)</span></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;MAST&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>MAST<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 如果找marker基因过慢，可以选择抽样</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">sc.s<span class="operator">=</span>sample<span class="punctuation">(</span>colnames<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### subset 可以筛选Seurat对象的样本，downsample表示从每个分组（通常是每个细胞群或簇）中随机选择最多 100 个细胞</span></span><br><span class="line">sc.s<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> downsample<span class="operator">=</span><span class="number">100</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.s<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 寻找marker基因</span></span><br><span class="line"><span class="comment">### marker基因的特征：特异性、高表达</span></span><br><span class="line">markers <span class="operator">&lt;-</span> FindAllMarkers<span class="punctuation">(</span>sc.s<span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>test.use <span class="operator">=</span> <span class="string">&quot;MAST&quot;</span><span class="punctuation">)</span></span><br><span class="line">top10 <span class="operator">&lt;-</span> markers <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Macrophage</span></span><br><span class="line"><span class="string">&#x27;C1QA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;C1QB&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;C1QC&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;APOE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;APOC1&#x27;</span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">#### 2  C1QA  C1QB  </span></span><br><span class="line">scRNA_harmony<span class="operator">=</span>RenameIdents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span><span class="string">&quot;2&quot;</span><span class="operator">=</span><span class="string">&quot;Macrophage&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony<span class="operator">=</span>RenameIdents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> </span><br><span class="line">                           <span class="string">&quot;7&quot;</span><span class="operator">=</span><span class="string">&quot;Endothelial cell&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                           <span class="string">&quot;4&quot;</span><span class="operator">=</span><span class="string">&quot;Fibroblast&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           <span class="string">&quot;1&quot;</span><span class="operator">=</span><span class="string">&quot;B cell&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                           <span class="string">&quot;5&quot;</span><span class="operator">=</span><span class="string">&quot;Myeloid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           <span class="string">&quot;3&quot;</span><span class="operator">=</span><span class="string">&quot;NK&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment">###  方法二</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;seurat_clusters&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 制作指定基因的气泡图</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>features <span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;LYZ&quot;</span><span class="punctuation">,</span><span class="string">&quot;NKG7&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD3E&quot;</span><span class="punctuation">,</span><span class="string">&#x27;CD3D&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;VCAN&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;CD19&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;CD79A&#x27;</span><span class="punctuation">,</span><span class="string">&quot;PECAM1&quot;</span> <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### RenameIdents：对Seurat对象进行细胞注释</span></span><br><span class="line">scRNA_harmony<span class="operator">=</span>RenameIdents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span><span class="string">&quot;7&quot;</span><span class="operator">=</span><span class="string">&quot;Endothelial cell&quot;</span><span class="punctuation">,</span><span class="string">&quot;4&quot;</span><span class="operator">=</span><span class="string">&quot;Fibroblast&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           <span class="string">&quot;1&quot;</span><span class="operator">=</span><span class="string">&quot;B cell&quot;</span> <span class="punctuation">,</span><span class="string">&quot;0&quot;</span><span class="operator">=</span><span class="string">&quot;Myeloid&quot;</span><span class="punctuation">,</span><span class="string">&quot;8&quot;</span><span class="operator">=</span><span class="string">&quot;Myeloid&quot;</span><span class="punctuation">,</span><span class="string">&quot;6&quot;</span><span class="operator">=</span><span class="string">&quot;Myeloid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           <span class="string">&quot;2&quot;</span><span class="operator">=</span><span class="string">&quot;Myeloid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;5&quot;</span><span class="operator">=</span><span class="string">&quot;Myeloid&quot;</span><span class="punctuation">,</span><span class="string">&quot;3&quot;</span><span class="operator">=</span><span class="string">&quot;NK_T&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 制作细胞注释图</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">genes_to_check <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>Tcells <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CD2&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD3D&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD3E&quot;</span><span class="punctuation">,</span><span class="string">&quot;NKG7&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Bcells <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CD79A&quot;</span><span class="punctuation">,</span><span class="string">&quot;MS4A1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       SMC <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;ACTA2&quot;</span><span class="punctuation">,</span><span class="string">&quot;CNN1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PLN&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       MonoMacro <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CD14&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD68&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD163&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Dendriticcells <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CD1C&quot;</span><span class="punctuation">,</span><span class="string">&quot;CLEC9A&quot;</span><span class="punctuation">,</span><span class="string">&quot;CLEC10A&quot;</span><span class="punctuation">,</span><span class="string">&quot;LILR4&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Mastcells <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;TPSAB1&quot;</span><span class="punctuation">,</span><span class="string">&quot;TPSB2&quot;</span><span class="punctuation">,</span><span class="string">&quot;CPA3&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Fibroblasts <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;PDGFRA&quot;</span><span class="punctuation">,</span><span class="string">&quot;FN1&quot;</span><span class="punctuation">,</span><span class="string">&quot;DCN&quot;</span><span class="punctuation">,</span><span class="string">&quot;LUM&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Pericyte <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MYH11&quot;</span><span class="punctuation">,</span><span class="string">&quot;RGS5&quot;</span><span class="punctuation">,</span><span class="string">&quot;MCAM&quot;</span><span class="punctuation">,</span><span class="string">&quot;NOTCH3&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Endothelialcells <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;PECAM1&quot;</span><span class="punctuation">,</span><span class="string">&quot;VWF&quot;</span><span class="punctuation">,</span><span class="string">&quot;PLVAP&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD34&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                       Neutrophils <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;CSF3R&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;FCGR3B&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;CXCL8&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p_all_markers <span class="operator">&lt;-</span> DotPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> features <span class="operator">=</span>genes_to_check<span class="punctuation">,</span> assay <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> hjust<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.title <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line">p_all_markers</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 亚群删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 提取 1~10 的亚群，可以把小的亚群删除</span></span><br><span class="line">sc1<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>sc1<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 方法三</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用SingleR鉴定细胞类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 原理：</span></span><br><span class="line"><span class="comment">## 1. 计算其表达谱与各参考样本表达谱之间的Spearman相关性</span></span><br><span class="line"><span class="comment">## 2. 按每个标签的得分定义为相关性分布的固定分位数（默认情况下为0.8）</span></span><br><span class="line"><span class="comment">## 3. 对所有标签重复次操作，并将得分最高的标签作为该单细胞的注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 文章中的代码</span></span><br><span class="line"><span class="comment"># use R/4.0</span></span><br><span class="line">library<span class="punctuation">(</span>SingleR<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>celldex<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read in seurat object</span></span><br><span class="line">analysis_parent_folder <span class="operator">&lt;-</span> <span class="string">&quot;./immune_results/&quot;</span></span><br><span class="line">setwd<span class="punctuation">(</span>analysis_parent_folder<span class="punctuation">)</span></span><br><span class="line">colon <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;./clustered_full_colon_immune_proj_seurat_post_doublet_filter.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set up reference, and define cell types to use</span></span><br><span class="line">ref <span class="operator">&lt;-</span> HumanPrimaryCellAtlasData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">types_to_use <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DC&quot;</span><span class="punctuation">,</span><span class="string">&quot;Epithelial_cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;B_cell&quot;</span><span class="punctuation">,</span><span class="string">&quot;Neutrophils&quot;</span><span class="punctuation">,</span><span class="string">&quot;T_cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Monocyte&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&quot;Endothelial_cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Neurons&quot;</span><span class="punctuation">,</span><span class="string">&quot;Macrophage&quot;</span><span class="punctuation">,</span><span class="string">&quot;NK_cell&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&quot;BM&quot;</span><span class="punctuation">,</span><span class="string">&quot;Platelets&quot;</span><span class="punctuation">,</span><span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">,</span><span class="string">&quot;Astrocyte&quot;</span><span class="punctuation">,</span><span class="string">&quot;Myelocyte&quot;</span><span class="punctuation">,</span><span class="string">&quot;Pre-B_cell_CD34-&quot;</span><span class="punctuation">,</span><span class="string">&quot;Pro-B_cell_CD34+&quot;</span><span class="punctuation">,</span><span class="string">&quot;Pro-Myelocyte&quot;</span><span class="punctuation">)</span></span><br><span class="line">ref <span class="operator">&lt;-</span> ref<span class="punctuation">[</span><span class="punctuation">,</span><span class="punctuation">(</span>colData<span class="punctuation">(</span>ref<span class="punctuation">)</span><span class="operator">$</span>label.main <span class="operator">%in%</span> types_to_use<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run singleR</span></span><br><span class="line">singler.pred <span class="operator">&lt;-</span> SingleR<span class="punctuation">(</span>test <span class="operator">=</span> as.SingleCellExperiment<span class="punctuation">(</span>colon<span class="punctuation">)</span><span class="punctuation">,</span> ref <span class="operator">=</span> ref<span class="punctuation">,</span> labels <span class="operator">=</span> ref<span class="operator">$</span>label.fine<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add to seurat object, and then you cna plot the results if desired</span></span><br><span class="line">colon <span class="operator">&lt;-</span> AddMetaData<span class="punctuation">(</span>colon<span class="punctuation">,</span> metadata <span class="operator">=</span> singler.pred<span class="operator">$</span>labels<span class="punctuation">,</span> col.name <span class="operator">=</span> <span class="string">&quot;SingleR.labels&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;SingleR&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;celldex&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>SingleR<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### HumanPrimaryCellAtlasData为人类细胞图谱计划的数据集</span></span><br><span class="line">HumanPrimaryCellAtlasData <span class="operator">=</span> celldex<span class="operator">::</span>HumanPrimaryCellAtlasData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>HumanPrimaryCellAtlasData<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;HumanPrimaryCellAtlasData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BlueprintEncodeData</span></span><br><span class="line">BlueprintEncodeData <span class="operator">=</span> celldex<span class="operator">::</span>BlueprintEncodeData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>BlueprintEncodeData<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;BlueprintEncodeData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DatabaseImmuneCellExpressionData <span class="operator">=</span> celldex<span class="operator">::</span>DatabaseImmuneCellExpressionData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>DatabaseImmuneCellExpressionData<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;DatabaseImmuneCellExpressionData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ImmGenData <span class="operator">=</span> celldex<span class="operator">::</span>ImmGenData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>ImmGenData<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;ImmGenData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">MonacoImmuneData <span class="operator">=</span> celldex<span class="operator">::</span>MonacoImmuneData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>MonacoImmuneData<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;MonacoImmuneData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MouseRNAseqData <span class="operator">=</span> celldex<span class="operator">::</span>MouseRNAseqData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>MouseRNAseqData<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;MouseRNAseqData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">NovershternHematopoieticData <span class="operator">=</span> celldex<span class="operator">::</span>NovershternHematopoieticData<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>NovershternHematopoieticData<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;NovershternHematopoieticData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 下载好数据库后，把ref_Human_all.Rdata加载到环境中，这样算是对数据库的加载，就可以按照singler的算法来对细胞亚群进行定义了。</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;F:/ref.data/ref_Human_all.RData&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 可以看到在环境中多了一个叫ref_Human_all的文件 大小为113mb  这个就是数据库</span></span><br><span class="line"><span class="comment">#### 然后把环境中的ref_Human_all赋值与refdata</span></span><br><span class="line">refdata <span class="operator">&lt;-</span> HumanPrimaryCellAtlasData</span><br><span class="line"></span><br><span class="line"><span class="comment">### 把RNA的转录表达数据提取</span></span><br><span class="line"><span class="operator">?</span>LayerData</span><br><span class="line">testdata <span class="operator">&lt;-</span>  LayerData<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> assay <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> layer <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 把scRNA数据中的seurat_clusters提取出来，注意这里是因子类型的</span></span><br><span class="line">clusters <span class="operator">&lt;-</span>  scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters</span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>refdata<span class="operator">$</span>label.main<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 开始用singler分析</span></span><br><span class="line">cellpred <span class="operator">&lt;-</span> SingleR<span class="punctuation">(</span>test <span class="operator">=</span> testdata<span class="punctuation">,</span> ref <span class="operator">=</span> refdata<span class="punctuation">,</span> labels <span class="operator">=</span> refdata<span class="operator">$</span>label.main<span class="punctuation">,</span> </span><br><span class="line">                       method <span class="operator">=</span> <span class="string">&quot;cluster&quot;</span><span class="punctuation">,</span> clusters <span class="operator">=</span> clusters<span class="punctuation">,</span> </span><br><span class="line">                       assay.type.test <span class="operator">=</span> <span class="string">&quot;logcounts&quot;</span><span class="punctuation">,</span> assay.type.ref <span class="operator">=</span> <span class="string">&quot;logcounts&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 制作细胞类型的注释文件</span></span><br><span class="line">celltype <span class="operator">=</span> data.frame<span class="punctuation">(</span>ClusterID<span class="operator">=</span>rownames<span class="punctuation">(</span>cellpred<span class="punctuation">)</span><span class="punctuation">,</span> celltype<span class="operator">=</span>cellpred<span class="operator">$</span>labels<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 保存一下</span></span><br><span class="line">write.csv<span class="punctuation">(</span>celltype<span class="punctuation">,</span><span class="string">&quot;celltype_singleR.csv&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##把singler的注释写到metadata中 有两种方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 方法一</span></span><br><span class="line">scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>celltype <span class="operator">=</span><span class="string">&quot;NA&quot;</span></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  scRNA_harmony<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters <span class="operator">==</span> celltype<span class="operator">$</span>ClusterID<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;celltype&#x27;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> celltype<span class="operator">$</span>celltype<span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 第一次循环  </span></span><br><span class="line">i <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="operator">=</span><span class="string">&quot;Macrophage&quot;</span></span><br><span class="line">celltype<span class="operator">$</span>celltype<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters <span class="operator">==</span> celltype<span class="operator">$</span>ClusterID<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;celltype&#x27;</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">celltype<span class="operator">$</span>ClusterID<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">which<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters <span class="operator">==</span> celltype<span class="operator">$</span>ClusterID<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">which<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters <span class="operator">==</span>  <span class="string">&quot;0&quot;</span><span class="punctuation">)</span></span><br><span class="line">a<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;a1&quot;</span><span class="punctuation">,</span><span class="string">&quot;a2&quot;</span><span class="punctuation">,</span><span class="string">&quot;a3&quot;</span><span class="punctuation">)</span></span><br><span class="line">b<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;b1&quot;</span><span class="punctuation">,</span><span class="string">&quot;a2&quot;</span><span class="punctuation">,</span><span class="string">&quot;m1&quot;</span><span class="punctuation">,</span><span class="string">&quot;m2&quot;</span><span class="punctuation">,</span><span class="string">&quot;a1&quot;</span><span class="punctuation">)</span></span><br><span class="line">which<span class="punctuation">(</span>b<span class="operator">==</span><span class="string">&quot;a1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 因为把singler的注释加载到metadata中时候，命名的名字叫celltype，所以画图时候，group.by=&quot;celltype&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span> label<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span> label.size<span class="operator">=</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 方法二：</span></span><br><span class="line">celltype <span class="operator">=</span> data.frame<span class="punctuation">(</span>ClusterID<span class="operator">=</span>rownames<span class="punctuation">(</span>cellpred<span class="punctuation">)</span><span class="punctuation">,</span> celltype<span class="operator">=</span>cellpred<span class="operator">$</span>labels <span class="punctuation">)</span> </span><br><span class="line">scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>singleR<span class="operator">=</span>celltype<span class="punctuation">[</span>match<span class="punctuation">(</span>clusters<span class="punctuation">,</span>celltype<span class="operator">$</span>ClusterID<span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;celltype&#x27;</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 因为把singler的注释加载到metadata中时候，命名的名字叫singleR，所以画图时候，group.by=&quot;singleR&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&quot;singleR&quot;</span><span class="punctuation">,</span> label<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span> label.size<span class="operator">=</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">### 可以看到两种方法得到的结果都是一样的，但是我比较喜欢第二种方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 鉴定结果展示</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span> label<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span> label.size<span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span> reduction<span class="operator">=</span><span class="string">&#x27;umap&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 方法三：Azimuth</span></span><br><span class="line"><span class="comment">### 细胞预测</span></span><br><span class="line"><span class="comment">### https://satijalab.org/azimuth/</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="亚群细分"><a class="headerlink" href="#亚群细分"></a>亚群细分</h2>
<hr>
<p>就是在亚群注释的基础上，单独分析亚群注释上几个cluster</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 亚群细分</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllData/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 多个样本的整合要用到JoinLayers这个函数</span></span><br><span class="line">scRNA_harmony<span class="operator">=</span>JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PTPRC表示免疫细胞</span></span><br><span class="line"></span><br><span class="line">scRNA1 <span class="operator">=</span> scRNA_harmony</span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;seurat_clusters&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 针对PTPRC的，提取出来的cluster</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> <span class="string">&quot;PTPRC&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span><span class="string">&quot;seurat_clusters&quot;</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 针对EPCAM的，提取出来的cluster</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> <span class="string">&quot;EPCAM&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span><span class="string">&quot;seurat_clusters&quot;</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将PTPRC，提取出来的cluster用一个对象来接收</span></span><br><span class="line">sc.immu<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 绘制PTPRC的基因分布</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>sc.immu<span class="punctuation">,</span> features <span class="operator">=</span><span class="string">&quot;PTPRC&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">#sc.immu=subset(scRNA1,ident=c(&quot;immu&quot;))</span></span><br><span class="line"><span class="comment">#sc.immu=subset(scRNA1,ident=c(&quot;0&quot;,&quot;2&quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 进行harmony整合</span></span><br><span class="line">scRNA_harmony1 <span class="operator">&lt;-</span> sc.immu</span><br><span class="line">scRNA_harmony1 <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindVariableFeatures<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> ScaleData<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> RunPCA<span class="punctuation">(</span>verbose<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">system.time<span class="punctuation">(</span><span class="punctuation">&#123;</span>scRNA_harmony1 <span class="operator">&lt;-</span> RunHarmony<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">,</span> group.by.vars <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span><span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 一定要指定harmony</span></span><br><span class="line">scRNA_harmony1 <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> FindClusters<span class="punctuation">(</span>resolution <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony1 <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot1 <span class="operator">=</span> DimPlot<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line">plot2 <span class="operator">=</span> DimPlot<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by<span class="operator">=</span><span class="string">&#x27;orig.ident&#x27;</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># combinate</span></span><br><span class="line">plotc <span class="operator">&lt;-</span> plot1<span class="operator">+</span>plot2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 这个结果就是针对免疫细胞的再次降维聚类 </span></span><br><span class="line">plotc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">markers <span class="operator">&lt;-</span> FindAllMarkers<span class="punctuation">(</span>scRNA_harmony1<span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>test.use <span class="operator">=</span> <span class="string">&quot;MAST&quot;</span><span class="punctuation">)</span></span><br><span class="line">top10 <span class="operator">&lt;-</span> markers <span class="operator">%&amp;&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Marker基因展示"><a class="headerlink" href="#Marker基因展示"></a>Marker基因展示</h2>
<hr>
<h3 id="样本分类提取的方法"><a class="headerlink" href="#样本分类提取的方法"></a>样本分类提取的方法</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cowplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>reshape2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA1.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ncol 就是 2*2 的展示方式</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> split.by  <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> split.by  <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>split.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>split.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 参考78-79 https://github.com/UMCCR-RADIO-Lab/snRNA-seq-atlas-of-pheochromocytoma-and-paraganglioma/blob/main/snRNA_add_and_format_metadata.R</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 展示n个分组的结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################</span></span><br><span class="line"><span class="comment">### 方法一</span></span><br><span class="line">metadata<span class="operator">=</span>scRNA1<span class="operator">@</span>meta.data</span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">meta.caf1 <span class="operator">=</span> filter<span class="punctuation">(</span>metadata<span class="punctuation">,</span> orig.ident<span class="operator">==</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">)</span></span><br><span class="line">meta.caf1<span class="operator">$</span>group <span class="operator">=</span> <span class="string">&quot;CAF&quot;</span></span><br><span class="line">meta.caf2 <span class="operator">=</span> filter<span class="punctuation">(</span>metadata<span class="punctuation">,</span> orig.ident<span class="operator">==</span><span class="string">&quot;CAF2&quot;</span><span class="punctuation">)</span></span><br><span class="line">meta.caf2<span class="operator">$</span>group <span class="operator">=</span><span class="string">&quot;CAF&quot;</span></span><br><span class="line">meta.dap1 <span class="operator">=</span> filter<span class="punctuation">(</span>metadata<span class="punctuation">,</span> orig.ident<span class="operator">==</span><span class="string">&quot;DapiNeg1&quot;</span><span class="punctuation">)</span></span><br><span class="line">meta.dap1<span class="operator">$</span>group <span class="operator">=</span> <span class="string">&quot;DAP&quot;</span></span><br><span class="line">meta.dap2 <span class="operator">=</span> filter<span class="punctuation">(</span>metadata<span class="punctuation">,</span> orig.ident<span class="operator">==</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">)</span></span><br><span class="line">meta.dap2<span class="operator">$</span>group <span class="operator">=</span> <span class="string">&quot;DAP&quot;</span></span><br><span class="line">meta.all <span class="operator">=</span> rbind<span class="punctuation">(</span>meta.caf1<span class="punctuation">,</span> meta.caf2<span class="punctuation">,</span> meta.dap1<span class="punctuation">,</span> meta.dap2<span class="punctuation">)</span></span><br><span class="line"><span class="comment">### 参考78-79 https://github.com/UMCCR-RADIO-Lab/snRNA-seq-atlas-of-pheochromocytoma-and-paraganglioma/blob/main/snRNA_add_and_format_metadata.R</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">=</span>AddMetaData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> metadata <span class="operator">=</span> meta.all<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> split.by <span class="operator">=</span> <span class="string">&quot;group&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> <span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span> split.by <span class="operator">=</span> <span class="string">&quot;group&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 方法二</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">=</span>RenameIdents<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> <span class="string">&quot;CAF1&quot;</span><span class="operator">=</span><span class="string">&quot;CAF&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CAF2&quot;</span><span class="operator">=</span><span class="string">&quot;CAF&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;DapiNeg1&quot;</span><span class="operator">=</span><span class="string">&quot;DapiNeg&quot;</span><span class="punctuation">,</span> <span class="string">&quot;DapiNeg2&quot;</span><span class="operator">=</span><span class="string">&quot;DapiNeg&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>group.2<span class="operator">=</span>scRNA1<span class="operator">@</span>active.ident</span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>split.by <span class="operator">=</span> <span class="string">&quot;group.2&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################################################</span></span><br><span class="line"><span class="comment">### 方法三（用的最多）</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="operator">==</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;group.3&quot;</span><span class="punctuation">]</span><span class="operator">=</span><span class="string">&quot;CAF&quot;</span></span><br><span class="line">scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="operator">==</span><span class="string">&quot;CAF2&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;group.3&quot;</span><span class="punctuation">]</span><span class="operator">=</span><span class="string">&quot;CAF&quot;</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="operator">==</span><span class="string">&quot;DapiNeg1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;group.3&quot;</span><span class="punctuation">]</span><span class="operator">=</span><span class="string">&quot;DapiNeg&quot;</span></span><br><span class="line">scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="operator">==</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;group.3&quot;</span><span class="punctuation">]</span><span class="operator">=</span><span class="string">&quot;DapiNeg&quot;</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>split.by <span class="operator">=</span> <span class="string">&quot;group.3&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################################</span></span><br><span class="line"><span class="comment">### 方法四</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 字符串的提取</span></span><br><span class="line">substr<span class="punctuation">(</span><span class="string">&quot;abcdef&quot;</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">$</span>group.4 <span class="operator">=</span> substr<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> split.by <span class="operator">=</span> <span class="string">&quot;group.4&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################################</span></span><br><span class="line"><span class="comment">####################################################################################</span></span><br><span class="line"><span class="comment">####################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对于cluster的提取</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;seurat_clusters&quot;</span></span><br><span class="line">sc.1<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="operator">:</span><span class="number">8</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">,</span><span class="number">11</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>sc.1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对于基因的提取</span></span><br><span class="line">sc.3<span class="operator">=</span>subset<span class="punctuation">(</span>sc.1<span class="punctuation">,</span> Rbp1 <span class="operator">&gt;</span> <span class="number">0</span> <span class="operator">&amp;</span> Gapd <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对于downsample的提取</span></span><br><span class="line">sc.4<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> downsample<span class="operator">=</span><span class="number">50</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.4<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA2 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">500</span> <span class="operator">&amp;</span> </span><br><span class="line">                      percent.mt <span class="operator">&lt;</span> <span class="number">20</span> <span class="operator">&amp;</span> nCount_RNA <span class="operator">&gt;</span> <span class="number">1000</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line"><span class="comment">### 提取免疫细胞 是否合理？</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 不能根据参数进行细胞的提取，有可能存在双细胞</span></span><br><span class="line">sc.cd45<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> Ptprc <span class="operator">&gt;</span> <span class="number">0</span>  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 只能根据cluster进行细胞的提取</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span><span class="string">&quot;Ptprc&quot;</span> <span class="punctuation">)</span></span><br><span class="line">sc.cd45<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">,</span><span class="number">13</span><span class="operator">:</span><span class="number">17</span><span class="punctuation">,</span><span class="number">21</span><span class="punctuation">)</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">sc.fibr <span class="operator">=</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对于Seurat数据集的切割</span></span><br><span class="line">sc.fibr.t <span class="operator">=</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;T cells&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Marker基因绘图展示"><a class="headerlink" href="#Marker基因绘图展示"></a>Marker基因绘图展示</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">### Marker基因的展示</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllData/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 加载harmony数据</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 绘图</span></span><br><span class="line"></span><br><span class="line">pbmc3k.final<span class="operator">=</span>scRNA_harmony</span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">features <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;LYZ&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CCL5&quot;</span><span class="punctuation">,</span> <span class="string">&quot;IL32&quot;</span><span class="punctuation">,</span> <span class="string">&quot;GAPDH&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 峰峦图</span></span><br><span class="line">RidgePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 小提琴图</span></span><br><span class="line"><span class="comment">## pt.size=0 就是把点给去掉</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> pt.size<span class="operator">=</span><span class="number">0</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>VlnPlot</span><br><span class="line"><span class="comment">## 将有表达的基因（eg：细胞组LYZ表达量大于1的）挑选出来</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>subset<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span>LYZ <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span> features <span class="operator">=</span><span class="string">&quot;LYZ&quot;</span><span class="punctuation">,</span>pt.size<span class="operator">=</span><span class="number">0</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 维度图</span></span><br><span class="line"><span class="comment">## reduction = &quot;tsne&quot; 这里可以tsne，也可以umap</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pbmc3k.final<span class="operator">=</span>RunTSNE<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;harmony&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 气泡图</span></span><br><span class="line"><span class="comment">## RotatedAxis()可以将基因旋转45°，防止重叠</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> scale<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> scale<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> RotatedAxis<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>DotPlot</span><br><span class="line"></span><br><span class="line"><span class="comment">## 热图</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> slot<span class="operator">=</span><span class="string">&quot;data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## downsample = 100 会保持每个cluster的数量一致</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span>subset<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> downsample <span class="operator">=</span> <span class="number">100</span><span class="punctuation">)</span><span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>DoHeatmap</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看某个基因的维度图</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> <span class="string">&quot;MS4A1&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## min.cutoff 表达值的最低值</span></span><br><span class="line"><span class="comment">## max.cutoff 表达值得最高值</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> <span class="string">&quot;MS4A1&quot;</span><span class="punctuation">,</span> min.cutoff <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> max.cutoff <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MS4A1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;GAPDH&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> min.cutoff <span class="operator">=</span> <span class="string">&quot;q10&quot;</span><span class="punctuation">,</span> max.cutoff <span class="operator">=</span> <span class="string">&quot;q90&quot;</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MS4A1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CD79A&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> blend <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MS4A1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CD79A&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> split.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 降维图</span></span><br><span class="line">plot1 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看两个基因是否线性相关，用FeatureScatter进行展示</span></span><br><span class="line">plot2 <span class="operator">&lt;-</span> FeatureScatter<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> feature1 <span class="operator">=</span> <span class="string">&quot;LYZ&quot;</span><span class="punctuation">,</span> feature2 <span class="operator">=</span> <span class="string">&quot;CCL5&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Combine two plots</span></span><br><span class="line">plot1 <span class="operator">+</span> plot2</span><br><span class="line"></span><br><span class="line">baseplot <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>pbmc3k.final<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加标签和标题</span></span><br><span class="line">baseplot <span class="operator">+</span> labs<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot;huage PBMCs&quot;</span><span class="punctuation">)</span><span class="operator">+</span>xlab<span class="punctuation">(</span><span class="string">&quot;x1&quot;</span><span class="punctuation">)</span></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;ggmin&quot;</span><span class="punctuation">)</span></span><br><span class="line">baseplot <span class="operator">+</span> ggmin<span class="operator">::</span>theme_powerpoint<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## metadata分组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllData/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cowplot<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dir<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CAFs.1/&quot;</span><span class="punctuation">,</span><span class="string">&quot;CAFs.2/&quot;</span><span class="punctuation">,</span><span class="string">&quot;dapi1/&quot;</span><span class="punctuation">,</span><span class="string">&quot;dapi2/&quot;</span><span class="punctuation">)</span></span><br><span class="line">dir<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CAFs.1/&quot;</span><span class="punctuation">,</span><span class="string">&quot;CAFs.2/&quot;</span><span class="punctuation">,</span><span class="string">&quot;dapi1/&quot;</span><span class="punctuation">,</span><span class="string">&quot;dapi2/&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>dir<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;CAF1&#x27;</span><span class="punctuation">,</span>  <span class="string">&#x27;CAF2&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;DapiNeg1&#x27;</span><span class="punctuation">,</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">)</span>      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">counts <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span>dir<span class="punctuation">)</span></span><br><span class="line">scRNA1 <span class="operator">=</span> CreateSeuratObject<span class="punctuation">(</span>counts<span class="punctuation">,</span>min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> pattern <span class="operator">=</span> <span class="string">&quot;^mt-&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span></span><br><span class="line">        features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span> <span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        </span><br><span class="line">        pt.size <span class="operator">=</span> <span class="number">0.01</span><span class="punctuation">,</span> <span class="comment">#不需要显示点，可以设置pt.size = 0</span></span><br><span class="line">        ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">scRNA2 <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">500</span> <span class="operator">&amp;</span> </span><br><span class="line">                      percent.mt <span class="operator">&lt;</span> <span class="number">20</span> <span class="operator">&amp;</span> nCount_RNA <span class="operator">&gt;</span> <span class="number">1000</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA3 <span class="operator">=</span> SplitObject<span class="punctuation">(</span>scRNA2 <span class="punctuation">,</span> split.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb<span class="operator">=</span>scRNA2</span><br><span class="line">ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> split<span class="punctuation">(</span>ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> f <span class="operator">=</span> ifnb<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">ifnb</span><br><span class="line"></span><br><span class="line"><span class="comment">##Perform analysis without integration</span></span><br><span class="line"><span class="comment"># run standard anlaysis workflow</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindVariableFeatures<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  ScaleData<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunPCA<span class="punctuation">(</span>ifnb<span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> cluster.name <span class="operator">=</span> <span class="string">&quot;unintegrated_clusters&quot;</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span>  RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> reduction.name <span class="operator">=</span> <span class="string">&quot;umap.unintegrated&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap.unintegrated&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> <span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Perform integration</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> IntegrateLayers<span class="punctuation">(</span>object <span class="operator">=</span> ifnb<span class="punctuation">,</span> method <span class="operator">=</span> CCAIntegration<span class="punctuation">,</span> orig.reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> new.reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           verbose <span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re-join layers after integration</span></span><br><span class="line">ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>ifnb<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">)</span></span><br><span class="line">ifnb <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ifnb <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">30</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;integrated.cca&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># Visualization</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>ifnb<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> <span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################</span></span><br><span class="line">scRNA1<span class="operator">=</span>ifnb</span><br><span class="line"></span><br><span class="line">DefaultAssay<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;RNA&quot;</span></span><br><span class="line"><span class="comment">##BiocManager::install(&quot;SingleR&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>SingleR<span class="punctuation">)</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;F:/ref.data/ref_Mouse_all.RData&quot;</span><span class="punctuation">)</span></span><br><span class="line">refdata <span class="operator">&lt;-</span> ref_Mouse</span><br><span class="line"><span class="comment">###把rna的转录表达数据提取</span></span><br><span class="line">testdata<span class="operator">=</span>LayerData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> assay<span class="operator">=</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> layer<span class="operator">=</span><span class="string">&#x27;data&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###把scRNA数据中的seurat_clusters提取出来，注意这里是因子类型的</span></span><br><span class="line">clusters <span class="operator">&lt;-</span> scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters</span><br><span class="line"><span class="comment">###开始用singler分析</span></span><br><span class="line">cellpred <span class="operator">&lt;-</span> SingleR<span class="punctuation">(</span>test <span class="operator">=</span> testdata<span class="punctuation">,</span> ref <span class="operator">=</span> refdata<span class="punctuation">,</span> labels <span class="operator">=</span> refdata<span class="operator">$</span>label.main<span class="punctuation">,</span> </span><br><span class="line">                       method <span class="operator">=</span> <span class="string">&quot;cluster&quot;</span><span class="punctuation">,</span> clusters <span class="operator">=</span> clusters<span class="punctuation">,</span> </span><br><span class="line">                       assay.type.test <span class="operator">=</span> <span class="string">&quot;logcounts&quot;</span><span class="punctuation">,</span> assay.type.ref <span class="operator">=</span> <span class="string">&quot;logcounts&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">celltype <span class="operator">=</span> data.frame<span class="punctuation">(</span>ClusterID<span class="operator">=</span>rownames<span class="punctuation">(</span>cellpred<span class="punctuation">)</span><span class="punctuation">,</span> celltype<span class="operator">=</span>cellpred<span class="operator">$</span>labels<span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>celltype <span class="operator">=</span> <span class="string">&quot;NA&quot;</span></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters <span class="operator">==</span> celltype<span class="operator">$</span>ClusterID<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;celltype&#x27;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> celltype<span class="operator">$</span>celltype<span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"> </span><br><span class="line">getwd<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;scRNA1.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA1.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#################################################################################################</span></span><br><span class="line"><span class="comment">##scRNA1@active.ident=scRNA1@meta.data$celltype</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 做图</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my36colors <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;#E5D2DD&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#53A85F&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F1BB72&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F3B1A0&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#D6E7A3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#57C3F3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#476D87&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#E95C59&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E59CC4&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#AB3282&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#23452F&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#BD956A&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#8C549C&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#585658&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#9FA3A8&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E0D4CA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#5F3D69&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#C5DEBA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#58A4C3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E4C755&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F7F398&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#AA9A59&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E63863&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E39A35&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#C1E6F3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#6778AE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#91D0BE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#B53E2B&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#712820&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#DCC1DD&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#CCE0F5&#x27;</span><span class="punctuation">,</span>  <span class="string">&#x27;#CCC9E6&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#625D9E&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#68A180&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#3A6963&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#968175&#x27;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">,</span> label<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span> cols <span class="operator">=</span> my36colors<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>  label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>scRNA1<span class="operator">@</span>meta.data<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">degs <span class="operator">&lt;-</span> FindAllMarkers<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                          test.use <span class="operator">=</span> <span class="string">&quot;roc&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                          return.thresh <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> </span><br><span class="line">                          min.pct <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">degs_sig <span class="operator">&lt;-</span>  degs <span class="operator">%&gt;%</span> </span><br><span class="line">  filter<span class="punctuation">(</span>pct.1 <span class="operator">&amp;</span>gt; <span class="number">0.3</span> <span class="operator">&amp;</span></span><br><span class="line">           power <span class="operator">&amp;</span>gt; <span class="number">0.25</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  filter<span class="punctuation">(</span>cluster <span class="operator">!=</span> <span class="string">&quot;other&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>cluster<span class="punctuation">,</span> <span class="operator">-</span>power<span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># select degs for heatmap</span></span><br><span class="line">degs_top50 <span class="operator">&lt;-</span> degs_sig <span class="operator">%&gt;%</span> </span><br><span class="line">  <span class="comment">#  filter(cluster!=&quot;other&quot;) %&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  top_n<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">,</span> power<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  top_n<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">,</span> avg_diff<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>cluster<span class="punctuation">,</span> <span class="operator">-</span>power<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">avgData <span class="operator">&lt;-</span> scRNA1<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>data<span class="punctuation">[</span>degs_top50<span class="operator">$</span>gene<span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  apply<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">    tapply<span class="punctuation">(</span>x<span class="punctuation">,</span> scRNA1<span class="operator">$</span>celltype<span class="punctuation">,</span> mean<span class="punctuation">)</span> <span class="comment"># ExpMean</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phData <span class="operator">&lt;-</span> MinMax<span class="punctuation">(</span>scale<span class="punctuation">(</span>avgData<span class="punctuation">)</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span> <span class="comment"># z-score</span></span><br><span class="line">rownames<span class="punctuation">(</span>phData<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>phData<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##install.packages(&quot;pheatmap&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">phres <span class="operator">&lt;-</span> pheatmap<span class="punctuation">(</span></span><br><span class="line">  phData<span class="punctuation">,</span> </span><br><span class="line">  color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">99</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#配色</span></span><br><span class="line">  scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#不按行聚类</span></span><br><span class="line">  cluster_cols <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> <span class="comment">#按列聚类</span></span><br><span class="line">  clustering_method <span class="operator">=</span> <span class="string">&quot;complete&quot;</span><span class="punctuation">,</span></span><br><span class="line">  show_rownames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#显示cluster名</span></span><br><span class="line">  annotation_row <span class="operator">=</span> data.frame<span class="punctuation">(</span>cluster <span class="operator">=</span> degs_top50<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"><span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line">phData1<span class="operator">=</span> phData<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">,</span><span class="string">&quot;Adipocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;Macrophages&quot;</span><span class="punctuation">,</span><span class="string">&quot;Granulocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;Monocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;T cells&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phres <span class="operator">&lt;-</span> pheatmap<span class="punctuation">(</span></span><br><span class="line">  phData1<span class="punctuation">,</span> </span><br><span class="line">  color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">99</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#配色</span></span><br><span class="line">  scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#不按行聚类</span></span><br><span class="line">  cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#按列聚类</span></span><br><span class="line">  clustering_method <span class="operator">=</span> <span class="string">&quot;complete&quot;</span><span class="punctuation">,</span></span><br><span class="line">  show_rownames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#显示cluster名</span></span><br><span class="line">  annotation_row <span class="operator">=</span> data.frame<span class="punctuation">(</span>cluster <span class="operator">=</span> degs_top50<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">phres</span><br><span class="line"><span class="comment">########################################################################################################</span></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA1.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">=</span>scRNA2</span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="string">&quot;Gapdh&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA1<span class="operator">@</span>active.ident<span class="operator">=</span>factor<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span> <span class="string">&quot;T cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Fibroblasts&quot;</span> <span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;Granulocytes&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Macrophages&quot;</span><span class="punctuation">,</span>   <span class="string">&quot;Monocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;Adipocytes&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">scRNA1<span class="operator">$</span>celltype1<span class="operator">=</span>scRNA1<span class="operator">@</span>active.ident</span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype1&quot;</span><span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1  <span class="punctuation">)</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="string">&quot;Gapdh&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Cfd&quot;</span><span class="punctuation">,</span><span class="string">&quot;S100a8&quot;</span><span class="punctuation">,</span><span class="string">&quot;Gapdh&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>active.ident<span class="operator">=</span>factor<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Adipocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;Fibroblasts&quot;</span> <span class="punctuation">,</span> <span class="string">&quot;Granulocytes&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Macrophages&quot;</span><span class="punctuation">,</span>   <span class="string">&quot;Monocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;T cells&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">marker<span class="operator">=</span>FindAllMarkers<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">write.csv<span class="punctuation">(</span>marker<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;marker.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">top10 <span class="operator">&lt;-</span> marker  <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> rownames<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;scale.data&quot;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>downsample<span class="operator">=</span><span class="number">300</span><span class="punctuation">)</span> <span class="punctuation">,</span>features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;scale.data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line">scRNA2<span class="operator">=</span>scRNA1</span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">scRNA1<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> downsample <span class="operator">=</span> <span class="number">150</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colanno<span class="operator">=</span>scRNA1<span class="operator">@</span>meta.data </span><br><span class="line">colanno<span class="operator">$</span>barcode<span class="operator">=</span>rownames<span class="punctuation">(</span>colanno<span class="punctuation">)</span></span><br><span class="line">colanno<span class="operator">=</span>colanno<span class="operator">%&amp;gt;%</span>arrange<span class="punctuation">(</span>celltype<span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>colanno<span class="punctuation">)</span><span class="operator">=</span>colanno<span class="operator">$</span>barcode</span><br><span class="line">colanno<span class="operator">$</span>barcode<span class="operator">=</span><span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">colanno1<span class="operator">=</span>colanno<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">]</span></span><br><span class="line">colanno1<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>colanno1<span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>colanno1<span class="punctuation">)</span><span class="operator">=</span>rownames<span class="punctuation">(</span>colanno<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>colanno1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line"></span><br><span class="line">rowanno<span class="operator">=</span>top10</span><br><span class="line">colnames<span class="punctuation">(</span>top10<span class="punctuation">)</span></span><br><span class="line">rowanno<span class="operator">=</span>rowanno<span class="operator">%&gt;%</span>arrange<span class="punctuation">(</span>cluster<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">mat4<span class="operator">=</span>scRNA1<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>scale.data<span class="punctuation">[</span>rowanno<span class="operator">$</span>gene<span class="punctuation">,</span>rownames<span class="punctuation">(</span>colanno1<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">mat4<span class="punctuation">[</span>mat4<span class="operator">&gt;=</span><span class="number">2.5</span><span class="punctuation">]</span><span class="operator">=</span><span class="number">2.5</span></span><br><span class="line">mat4<span class="punctuation">[</span>mat4 <span class="operator">&lt;</span> <span class="punctuation">(</span><span class="operator">-</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">=</span> <span class="operator">-</span><span class="number">1</span>  </span><br><span class="line"></span><br><span class="line">pheatmap<span class="punctuation">(</span>mat4<span class="punctuation">,</span>cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         annotation_col <span class="operator">=</span> colanno1<span class="punctuation">,</span></span><br><span class="line">         gaps_row<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>rowanno<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         gaps_col<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>colanno<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span> </span><br><span class="line">         </span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pheatmap<span class="punctuation">(</span>mat4<span class="punctuation">,</span>cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         annotation_col <span class="operator">=</span> colanno1<span class="punctuation">,</span></span><br><span class="line">         gaps_row<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>rowanno<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         gaps_col<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>colanno<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">99</span><span class="punctuation">)</span></span><br><span class="line">         </span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pheatmap<span class="punctuation">(</span>mat4<span class="punctuation">,</span>cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         annotation_col <span class="operator">=</span> colanno1<span class="punctuation">,</span></span><br><span class="line">         gaps_row<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>rowanno<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         gaps_col<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>colanno<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="punctuation">,</span></span><br><span class="line">         filename<span class="operator">=</span><span class="string">&quot;marker.heatmap.pdf&quot;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">11</span><span class="punctuation">,</span>height <span class="operator">=</span> <span class="number">7</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################################</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.x.bottom <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">top10 <span class="operator">&lt;-</span>  marker  <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>reshape2<span class="punctuation">)</span></span><br><span class="line">vln.df<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>scRNA1<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>data<span class="punctuation">[</span>top10<span class="operator">$</span>gene<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">vln.df<span class="operator">$</span>gene<span class="operator">=</span>rownames<span class="punctuation">(</span>vln.df<span class="punctuation">)</span></span><br><span class="line">vln.df<span class="operator">=</span>melt<span class="punctuation">(</span>vln.df<span class="punctuation">,</span>id<span class="operator">=</span><span class="string">&quot;gene&quot;</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>vln.df<span class="punctuation">)</span><span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;barcode&quot;</span><span class="punctuation">,</span><span class="string">&quot;exp&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">anno<span class="operator">=</span>scRNA1<span class="operator">@</span>meta.data</span><br><span class="line">anno<span class="operator">$</span>barcode<span class="operator">=</span>rownames<span class="punctuation">(</span>anno<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vln.df<span class="operator">=</span>inner_join<span class="punctuation">(</span>vln.df<span class="punctuation">,</span>anno<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;barcode&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##vln.df$gene=factor(vln.df$gene,levels = top10$gene[1:7]) #为了控制画图的基因顺序</span></span><br><span class="line"></span><br><span class="line">vln.df<span class="operator">%&amp;&gt;%</span>ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>celltype<span class="punctuation">,</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_violin<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill<span class="operator">=</span>gene<span class="punctuation">)</span><span class="punctuation">,</span>scale <span class="operator">=</span> <span class="string">&quot;width&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>vln.df<span class="operator">$</span>gene<span class="operator">~</span>.<span class="punctuation">,</span>scales <span class="operator">=</span> <span class="string">&quot;free_y&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_fill_brewer<span class="punctuation">(</span>palette <span class="operator">=</span> <span class="string">&quot;Set3&quot;</span><span class="punctuation">,</span>direction <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.x.bottom <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################################################################################</span></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">top10 <span class="operator">&lt;-</span>  marker  <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span>cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lightgrey&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#FF00FF&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot;huage&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_discrete<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>RotatedAxis<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="operator">?</span>DotPlot</span><br><span class="line">bubble.df<span class="operator">=</span>as.matrix<span class="punctuation">(</span>scRNA1<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>data<span class="punctuation">[</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">bubble.df<span class="operator">=</span>t<span class="punctuation">(</span>bubble.df<span class="punctuation">)</span></span><br><span class="line">bubble.df<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>scale<span class="punctuation">(</span>bubble.df<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">bubble.df<span class="operator">$</span>CB<span class="operator">=</span>rownames<span class="punctuation">(</span>bubble.df<span class="punctuation">)</span></span><br><span class="line">meta<span class="operator">=</span>scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">bubble.df<span class="operator">=</span>merge<span class="punctuation">(</span>bubble.df<span class="punctuation">,</span>meta<span class="punctuation">,</span>by.x <span class="operator">=</span> <span class="string">&quot;CB&quot;</span><span class="punctuation">,</span>by.y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">bubble.df<span class="operator">$</span>CB<span class="operator">=</span><span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">celltype_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">gene_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">mean_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">ratio_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> unique<span class="punctuation">(</span>bubble.df<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  bubble.df_small<span class="operator">=</span>bubble.df<span class="operator">%&gt;%</span>filter<span class="punctuation">(</span>celltype<span class="operator">==</span>i<span class="punctuation">)</span></span><br><span class="line">  <span class="keyword">for</span> <span class="punctuation">(</span>j <span class="keyword">in</span> top10<span class="operator">$</span>gene<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    exp_mean<span class="operator">=</span>mean<span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">    exp_ratio<span class="operator">=</span><span class="built_in">sum</span><span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">&amp;</span>gt; <span class="built_in">min</span><span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="built_in">length</span><span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">    celltype_v<span class="operator">=</span>append<span class="punctuation">(</span>celltype_v<span class="punctuation">,</span>i<span class="punctuation">)</span>  <span class="comment">##Add elements to a vector.</span></span><br><span class="line">    gene_v<span class="operator">=</span>append<span class="punctuation">(</span>gene_v<span class="punctuation">,</span>j<span class="punctuation">)</span></span><br><span class="line">    mean_v<span class="operator">=</span>append<span class="punctuation">(</span>mean_v<span class="punctuation">,</span>exp_mean<span class="punctuation">)</span></span><br><span class="line">    ratio_v<span class="operator">=</span>append<span class="punctuation">(</span>ratio_v<span class="punctuation">,</span>exp_ratio<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">plotdf<span class="operator">=</span>data.frame<span class="punctuation">(</span></span><br><span class="line">  celltype<span class="operator">=</span>celltype_v<span class="punctuation">,</span></span><br><span class="line">  gene<span class="operator">=</span>gene_v<span class="punctuation">,</span></span><br><span class="line">  <span class="built_in">exp</span><span class="operator">=</span>mean_v<span class="punctuation">,</span></span><br><span class="line">  ratio<span class="operator">=</span>ratio_v</span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>RColorBrewer<span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">$</span>celltype<span class="operator">=</span>factor<span class="punctuation">(</span>plotdf<span class="operator">$</span>celltype<span class="punctuation">,</span>levels <span class="operator">=</span> sort<span class="punctuation">(</span>unique<span class="punctuation">(</span>plotdf<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">$</span>gene<span class="operator">=</span>factor<span class="punctuation">(</span>plotdf<span class="operator">$</span>gene<span class="punctuation">,</span>levels <span class="operator">=</span> rev<span class="punctuation">(</span><span class="built_in">as.character</span><span class="punctuation">(</span>top10<span class="operator">$</span>gene<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">$</span><span class="built_in">exp</span><span class="operator">=</span>ifelse<span class="punctuation">(</span>plotdf<span class="operator">$</span><span class="built_in">exp</span><span class="operator">&amp;</span>gt;<span class="number">3</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>plotdf<span class="operator">$</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">%&amp;gt;%</span>ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>celltype<span class="punctuation">,</span>y<span class="operator">=</span>gene<span class="punctuation">,</span>size<span class="operator">=</span>ratio<span class="punctuation">,</span>color<span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_discrete<span class="punctuation">(</span><span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_gradientn<span class="punctuation">(</span>colours <span class="operator">=</span> rev<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#FFD92F&quot;</span><span class="punctuation">,</span><span class="string">&quot;#FEE391&quot;</span><span class="punctuation">,</span>brewer.pal<span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span> <span class="string">&quot;Spectral&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">7</span><span class="operator">:</span><span class="number">11</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_size_continuous<span class="punctuation">(</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.x.bottom <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> angle <span class="operator">=</span> <span class="number">90</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line">scRNA1<span class="operator">=</span>scRNA2</span><br><span class="line"></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="string">&quot;Mzb1&quot;</span><span class="punctuation">,</span>reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>split.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="string">&quot;S100a9&quot;</span><span class="punctuation">,</span>reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">1</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span>reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>  </span><br><span class="line">    panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">14</span><span class="punctuation">)</span>  </span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### </span></span><br><span class="line"></span><br><span class="line">mat1<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>scRNA1<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>data<span class="punctuation">[</span><span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>mat1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;exp&quot;</span></span><br><span class="line">mat2<span class="operator">=</span>Embeddings<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span><span class="string">&quot;tsne&quot;</span><span class="punctuation">)</span></span><br><span class="line">mat3<span class="operator">=</span>merge<span class="punctuation">(</span>mat2<span class="punctuation">,</span>mat1<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;row.names&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mat3<span class="operator">%&gt;%</span>ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>tSNE_1<span class="punctuation">,</span>tSNE_2<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>color<span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;grey&quot;</span><span class="punctuation">,</span>high <span class="operator">=</span><span class="string">&quot;#1B9E77&quot;</span><span class="punctuation">)</span><span class="operator">+</span>theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>  </span><br><span class="line">    panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">14</span><span class="punctuation">)</span>  </span><br><span class="line">  <span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>labs<span class="punctuation">(</span>title<span class="operator">=</span> <span class="string">&quot;Rbp1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>ggpubr<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span> scRNA1 <span class="punctuation">,</span> <span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>stat_compare_means<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&#x27;t.test&#x27;</span><span class="punctuation">)</span><span class="operator">+</span>geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>Rbp1 <span class="operator">&gt;</span> <span class="number">0</span> <span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>stat_compare_means<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&#x27;t.test&#x27;</span><span class="punctuation">)</span><span class="operator">+</span>geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">sc.FURIN<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>Rbp1 <span class="operator">&gt;</span> <span class="number">0</span> <span class="punctuation">)</span></span><br><span class="line">FURIN.exp<span class="operator">=</span>sc.FURIN<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>data<span class="punctuation">[</span><span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">FURIN.exp.m<span class="operator">=</span> sc.FURIN<span class="operator">@</span>meta.data</span><br><span class="line">table<span class="punctuation">(</span>sc.FURIN<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">FURIN.exp.m<span class="operator">$</span><span class="built_in">exp</span><span class="operator">=</span>FURIN.exp</span><br><span class="line">FURIN.exp.m<span class="operator">$</span>Cohort<span class="operator">=</span>factor<span class="punctuation">(</span>FURIN.exp.m<span class="operator">$</span>orig.ident<span class="punctuation">,</span></span><br><span class="line">                          levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg1&quot;</span><span class="punctuation">,</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">,</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">,</span><span class="string">&#x27;CAF2&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>FURIN.exp.m<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;FURIN.exp.m.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>FURIN.exp.m<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&quot;ggsignif&quot;</span><span class="punctuation">)</span></span><br><span class="line">my_comparisons<span class="operator">=</span><span class="built_in">list</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg1&quot;</span><span class="punctuation">,</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">,</span><span class="string">&#x27;CAF2&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg2&quot;</span> <span class="punctuation">,</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>FURIN.exp.m<span class="punctuation">,</span>aes<span class="punctuation">(</span>Cohort<span class="punctuation">,</span><span class="built_in">exp</span><span class="punctuation">,</span>fill<span class="operator">=</span>Cohort<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_violin<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title<span class="operator">=</span>element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.x<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">,</span>angle<span class="operator">=</span><span class="number">25</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">18</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.x<span class="operator">=</span>element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span>y<span class="operator">=</span> <span class="string">&#x27;Expression&#x27;</span><span class="punctuation">,</span>x<span class="operator">=</span><span class="string">&quot;Group&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_signif<span class="punctuation">(</span>comparisons <span class="operator">=</span> my_comparisons<span class="punctuation">,</span>step_increase <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">              map_signif_level <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>test <span class="operator">=</span> t.test<span class="punctuation">,</span>size<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>textsize <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_jitter<span class="punctuation">(</span>shape<span class="operator">=</span><span class="number">16</span><span class="punctuation">,</span> position<span class="operator">=</span>position_jitter<span class="punctuation">(</span><span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;Rbp1&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span><span class="number">18</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  guides<span class="punctuation">(</span>fill<span class="operator">=</span>guide_legend<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span> <span class="comment">##更改legend名字</span></span><br><span class="line">  <span class="comment">##如果是color分组 需要 guides(color=guide_legend(title = &quot;Group&quot;)) </span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.line.x<span class="operator">=</span>element_line<span class="punctuation">(</span>linetype<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.line.y<span class="operator">=</span>element_line<span class="punctuation">(</span>linetype<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>legend.text <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span> <span class="punctuation">)</span> <span class="comment">##legend字体变大</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="个性化绘图"><a class="headerlink" href="#个性化绘图"></a>个性化绘图</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cowplot<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D:/0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">scRNA_harmony<span class="operator">=</span>JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>SingleR<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;HumanPrimaryCellAtlasData.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">refdata <span class="operator">&lt;-</span> HumanPrimaryCellAtlasData</span><br><span class="line">testdata <span class="operator">=</span> LayerData<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> assay<span class="operator">=</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> layer<span class="operator">=</span><span class="string">&#x27;data&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 把scRNA数据中的seurat_clusters提取出来，注意这里是因子类型的</span></span><br><span class="line">clusters <span class="operator">&lt;-</span> scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters</span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>refdata<span class="operator">$</span>label.main<span class="punctuation">)</span></span><br><span class="line"><span class="comment">### 开始用singler分析</span></span><br><span class="line">cellpred <span class="operator">&lt;-</span> SingleR<span class="punctuation">(</span>test <span class="operator">=</span> testdata<span class="punctuation">,</span> ref <span class="operator">=</span> refdata<span class="punctuation">,</span> labels <span class="operator">=</span> refdata<span class="operator">$</span>label.main<span class="punctuation">,</span> </span><br><span class="line">                       method <span class="operator">=</span> <span class="string">&quot;cluster&quot;</span><span class="punctuation">,</span> clusters <span class="operator">=</span> clusters<span class="punctuation">,</span> </span><br><span class="line">                       assay.type.test <span class="operator">=</span> <span class="string">&quot;logcounts&quot;</span><span class="punctuation">,</span> assay.type.ref <span class="operator">=</span> <span class="string">&quot;logcounts&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">### 制作细胞类型的注释文件</span></span><br><span class="line">celltype <span class="operator">=</span> data.frame<span class="punctuation">(</span>ClusterID<span class="operator">=</span>rownames<span class="punctuation">(</span>cellpred<span class="punctuation">)</span><span class="punctuation">,</span> celltype<span class="operator">=</span>cellpred<span class="operator">$</span>labels<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>celltype <span class="operator">=</span><span class="string">&quot;NA&quot;</span></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  scRNA_harmony<span class="operator">@</span>meta.data<span class="punctuation">[</span>which<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters <span class="operator">==</span> celltype<span class="operator">$</span>ClusterID<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;celltype&#x27;</span><span class="punctuation">]</span> <span class="operator">&amp;</span>lt;<span class="operator">-</span> celltype<span class="operator">$</span>celltype<span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my36colors <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;#E5D2DD&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#53A85F&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F1BB72&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F3B1A0&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#D6E7A3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#57C3F3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#476D87&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#E95C59&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E59CC4&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#AB3282&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#23452F&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#BD956A&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#8C549C&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#585658&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#9FA3A8&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E0D4CA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#5F3D69&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#C5DEBA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#58A4C3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E4C755&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F7F398&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#AA9A59&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E63863&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E39A35&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#C1E6F3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#6778AE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#91D0BE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#B53E2B&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#712820&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#DCC1DD&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#CCE0F5&#x27;</span><span class="punctuation">,</span>  <span class="string">&#x27;#CCC9E6&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#625D9E&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#68A180&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#3A6963&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#968175&#x27;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span>cols <span class="operator">=</span> my36colors<span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">########################################################################################################</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">=</span>scRNA_harmony</span><br><span class="line">pt_size <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">x<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggpubr<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">df <span class="operator">&lt;-</span> scRNA1<span class="operator">@</span>reductions<span class="operator">$</span>umap<span class="operator">@</span>cell.embeddings</span><br><span class="line">df <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>df<span class="punctuation">,</span> as.data.frame<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>df<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;x&quot;</span><span class="punctuation">,</span> <span class="string">&quot;y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ident&quot;</span><span class="punctuation">)</span></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>x<span class="punctuation">,</span> y<span class="operator">=</span>y<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>colour<span class="operator">=</span>ident<span class="punctuation">)</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;umap_1&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span><span class="string">&quot;umap_2&quot;</span><span class="punctuation">)</span><span class="operator">+</span> theme_pubr<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  NoAxes<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> NoLegend<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p</span><br><span class="line">p1 <span class="operator">&lt;-</span> p <span class="operator">+</span> NoLegend<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p1</span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>y<span class="punctuation">,</span> y<span class="operator">=</span>x<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>colour<span class="operator">=</span>ident<span class="punctuation">)</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;umap_1&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span><span class="string">&quot;umap_2&quot;</span><span class="punctuation">)</span></span><br><span class="line">p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>x<span class="punctuation">,</span> y<span class="operator">=</span>y<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>colour<span class="operator">=</span>ident<span class="punctuation">)</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;umap_1&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span><span class="string">&quot;umap_2&quot;</span><span class="punctuation">)</span></span><br><span class="line">meta <span class="operator">=</span> scRNA1<span class="operator">@</span>meta.data</span><br><span class="line">meta <span class="operator">=</span> meta<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">df.m <span class="operator">=</span> merge<span class="punctuation">(</span>df<span class="punctuation">,</span>meta<span class="punctuation">,</span>by<span class="operator">=</span><span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>df.m<span class="punctuation">)</span></span><br><span class="line">df.m <span class="operator">&lt;-</span>  df.m <span class="operator">%&gt;%</span></span><br><span class="line">  dplyr<span class="operator">::</span>group_by<span class="punctuation">(</span>seurat_clusters<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  dplyr<span class="operator">::</span>summarise<span class="punctuation">(</span></span><br><span class="line">    x <span class="operator">=</span> median<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    y <span class="operator">=</span> median<span class="punctuation">(</span>y<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>colour  <span class="operator">=</span> ident<span class="punctuation">)</span><span class="punctuation">)</span>   <span class="operator">+</span></span><br><span class="line">  ggrepel<span class="operator">::</span>geom_text_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> seurat_clusters<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                           data <span class="operator">=</span> df.m<span class="punctuation">,</span></span><br><span class="line">                           size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                           label.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           segment.color <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line">  <span class="punctuation">)</span><span class="operator">+</span>   theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> theme_bw<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p<span class="operator">+</span>ggrepel<span class="operator">::</span>geom_text_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> seurat_clusters<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                           data <span class="operator">=</span> df.m<span class="punctuation">,</span></span><br><span class="line">                           size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                           label.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           segment.color <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line"><span class="punctuation">)</span><span class="operator">+</span>   theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> theme_bw<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 换个主题</span></span><br><span class="line">p<span class="operator">+</span>ggrepel<span class="operator">::</span>geom_text_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> seurat_clusters<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                           data <span class="operator">=</span> df.m<span class="punctuation">,</span></span><br><span class="line">                           size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                           label.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           segment.color <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line"><span class="punctuation">)</span><span class="operator">+</span>   theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> theme_dark<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">##########################################################</span></span><br><span class="line">p<span class="operator">+</span>ggrepel<span class="operator">::</span>geom_text_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> seurat_clusters<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                           data <span class="operator">=</span> df.m<span class="punctuation">,</span></span><br><span class="line">                           size <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                           label.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           segment.color <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line"><span class="punctuation">)</span><span class="operator">+</span>   theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> theme_dark<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;t-SNE 1&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span><span class="string">&quot;t-SNE 2&quot;</span><span class="punctuation">)</span><span class="operator">+</span> ggtitle<span class="punctuation">(</span><span class="string">&quot;huage&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> ggsci<span class="operator">::</span>scale_color_nejm<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################################################################</span></span><br><span class="line"><span class="comment">##自带的包也可以更改</span></span><br><span class="line"></span><br><span class="line">p3 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> </span><br><span class="line">                 reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 pt.size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                 label <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">                 cols <span class="operator">=</span>  my36colors <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p3</span><br><span class="line"></span><br><span class="line">p4 <span class="operator">&lt;-</span> p3 <span class="operator">+</span> NoLegend<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p4</span><br><span class="line"></span><br><span class="line">p5 <span class="operator">=</span> p4 <span class="operator">+</span> theme_dark<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p5</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 自定义绘制气泡图</span></span><br><span class="line"></span><br><span class="line">B_marker<span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;TCL1A&quot;</span><span class="punctuation">,</span><span class="string">&quot;FCER2&quot;</span><span class="punctuation">,</span><span class="string">&quot;IL4R&quot;</span><span class="punctuation">,</span><span class="string">&quot;IGHD&quot;</span> <span class="punctuation">,</span> <span class="comment">#### NaiveB</span></span><br><span class="line">            <span class="string">&quot;IFIT3&quot;</span><span class="punctuation">,</span><span class="string">&quot;IFI44L&quot;</span><span class="punctuation">,</span><span class="string">&quot;STAT1&quot;</span><span class="punctuation">,</span><span class="string">&quot;ISG15&quot;</span><span class="punctuation">,</span><span class="comment">### IFN</span></span><br><span class="line">            <span class="string">&quot;HSPA1A&quot;</span><span class="punctuation">,</span><span class="string">&quot;DNAJB1&quot;</span><span class="punctuation">,</span><span class="comment">### Activated</span></span><br><span class="line">            <span class="string">&quot;MT1X&quot;</span><span class="punctuation">,</span><span class="string">&quot;MT2A&quot;</span><span class="punctuation">,</span><span class="string">&quot;SLC30A1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;EGR1&quot;</span><span class="punctuation">,</span><span class="string">&quot;DUSP2&quot;</span><span class="punctuation">,</span><span class="comment">#### ACB1</span></span><br><span class="line">            <span class="string">&quot;NR4A2&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD69&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD83&quot;</span><span class="punctuation">,</span><span class="comment">#### ACB2</span></span><br><span class="line">            <span class="string">&quot;CCR7&quot;</span><span class="punctuation">,</span><span class="string">&quot;PIM3&quot;</span><span class="punctuation">,</span><span class="string">&quot;NFKBID&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;S100A10&quot;</span><span class="punctuation">,</span><span class="string">&quot;CRIP1&quot;</span><span class="punctuation">,</span><span class="string">&quot;S100A4&quot;</span><span class="punctuation">,</span><span class="string">&quot;ITGB1&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD27&quot;</span><span class="punctuation">,</span><span class="string">&quot;CR2&quot;</span><span class="punctuation">,</span><span class="string">&quot;AIM2&quot;</span><span class="punctuation">,</span><span class="string">&quot;GPR183&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD1C&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;DUSP4&quot;</span><span class="punctuation">,</span><span class="string">&quot;FCRL5&quot;</span><span class="punctuation">,</span><span class="string">&quot;ZEB2&quot;</span><span class="punctuation">,</span><span class="string">&quot;ITGAX&quot;</span><span class="punctuation">,</span><span class="string">&quot;FGR&quot;</span><span class="punctuation">,</span><span class="string">&quot;FCRL4&quot;</span><span class="punctuation">,</span><span class="string">&quot;CD274&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;NME1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PSME2&quot;</span><span class="punctuation">,</span><span class="string">&quot;ENO1&quot;</span><span class="punctuation">,</span><span class="string">&quot;FABP5&quot;</span><span class="punctuation">,</span><span class="comment">### PreGC</span></span><br><span class="line">            <span class="string">&quot;CXCR4&quot;</span><span class="punctuation">,</span><span class="string">&quot;GNB2L1&quot;</span><span class="punctuation">,</span><span class="string">&quot;ATP5L&quot;</span><span class="punctuation">,</span><span class="string">&quot;SUGCT&quot;</span><span class="punctuation">,</span><span class="comment">### DZGC and GC</span></span><br><span class="line">            <span class="string">&quot;LMO2&quot;</span><span class="punctuation">,</span><span class="string">&quot;GMDS&quot;</span><span class="punctuation">,</span><span class="string">&quot;PRPSAP2&quot;</span><span class="punctuation">,</span><span class="string">&quot;MARCKSL1&quot;</span><span class="punctuation">,</span><span class="comment">### LZGC</span></span><br><span class="line">            <span class="string">&quot;STMN1&quot;</span><span class="punctuation">,</span><span class="string">&quot;TUBB&quot;</span><span class="punctuation">,</span><span class="string">&quot;HMGB2&quot;</span><span class="punctuation">,</span><span class="string">&quot;TUBA1B&quot;</span><span class="punctuation">,</span><span class="string">&quot;MKI67&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;JCHAIN&quot;</span><span class="punctuation">,</span><span class="string">&quot;PRDM1&quot;</span><span class="punctuation">,</span><span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span><span class="string">&quot;MZB1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>RColorBrewer<span class="punctuation">)</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>object <span class="operator">=</span> scRNA_harmony<span class="punctuation">,</span> features <span class="operator">=</span>  B_marker<span class="punctuation">,</span>scale <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">##celltype_l3. ###seurat_clusters</span></span><br><span class="line">  scale_colour_gradientn<span class="punctuation">(</span>colors<span class="operator">=</span>brewer.pal<span class="punctuation">(</span><span class="number">9</span><span class="punctuation">,</span> <span class="string">&quot;YlGnBu&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> theme_bw<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">90</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">B_marker1 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;TCL1A&quot;</span><span class="punctuation">,</span><span class="string">&quot;FCER2&quot;</span> <span class="punctuation">,</span><span class="string">&quot;PRDM1&quot;</span><span class="punctuation">,</span><span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span><span class="string">&quot;MZB1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">f1 <span class="operator">=</span> sample<span class="punctuation">(</span>rownames<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">p <span class="operator">&lt;-</span> DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> B_marker1<span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p</span><br><span class="line">p <span class="operator">+</span> RotatedAxis<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dot.data <span class="operator">=</span> p<span class="punctuation">[[</span><span class="string">&quot;data&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>dot.data<span class="punctuation">)</span></span><br><span class="line">p1 <span class="operator">=</span> ggplot<span class="punctuation">(</span>dot.data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> id<span class="punctuation">,</span> y <span class="operator">=</span> features.plot<span class="punctuation">,</span> color <span class="operator">=</span> avg.exp.scaled<span class="punctuation">,</span> size <span class="operator">=</span> pct.exp<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> </span><br><span class="line">p1</span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改颜色、主题、坐标轴</span></span><br><span class="line">ggplot<span class="punctuation">(</span>dot.data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>id<span class="punctuation">,</span> y <span class="operator">=</span> features.plot<span class="punctuation">,</span> color <span class="operator">=</span> avg.exp.scaled<span class="punctuation">,</span> size <span class="operator">=</span> pct.exp<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_color_viridis_c<span class="punctuation">(</span>name <span class="operator">=</span> <span class="string">&#x27;expression&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  cowplot<span class="operator">::</span>theme_cowplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.line  <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> hjust<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置图例颜色的范围</span></span><br><span class="line"><span class="comment">## 使用scale_color_gradientn设置渐变色的范围为0-3，如果有的点超过了3，那么通过oob = scales::squish将它硬生生压到3</span></span><br><span class="line"><span class="comment">## install.packages(&quot;viridis&quot;)</span></span><br><span class="line">p4<span class="operator">=</span>ggplot<span class="punctuation">(</span>dot.data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>id<span class="punctuation">,</span> y <span class="operator">=</span> features.plot<span class="punctuation">,</span> color <span class="operator">=</span> avg.exp.scaled<span class="punctuation">,</span> size <span class="operator">=</span> pct.exp<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  cowplot<span class="operator">::</span>theme_cowplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.line  <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">90</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> hjust<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_color_gradientn<span class="punctuation">(</span>colours <span class="operator">=</span> viridis<span class="operator">::</span>viridis<span class="punctuation">(</span><span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span> limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> oob <span class="operator">=</span> scales<span class="operator">::</span>squish<span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&#x27;expression&#x27;</span><span class="punctuation">)</span></span><br><span class="line">p4</span><br><span class="line"></span><br><span class="line"><span class="comment">## ggplot没有内置聚类树，但可以有以下几个选择：</span></span><br><span class="line"><span class="comment"># remotes::install_github(&quot;YuLab-SMU/tidytree&quot;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## featurePlot的自定义绘制</span></span><br><span class="line"></span><br><span class="line">features<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;XBP1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> features <span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> features <span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 更改小提琴图横坐标顺序</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">My_levels <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;T_cells&quot;</span> <span class="punctuation">,</span> <span class="string">&quot;B_cell&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Monocyte&quot;</span><span class="punctuation">,</span><span class="string">&quot;Macrophage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Endothelial_cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Chondrocytes&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Tissue_stem_cells&quot;</span><span class="punctuation">,</span> <span class="string">&quot;MSC&quot;</span><span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">,</span> levels<span class="operator">=</span> My_levels<span class="punctuation">)</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加主题</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span> theme_dark<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加边框</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  annotate<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&#x27;segment&#x27;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> yend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span> x <span class="operator">=</span> <span class="operator">-</span><span class="literal">Inf</span><span class="punctuation">,</span> xend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  annotate<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&#x27;segment&#x27;</span><span class="punctuation">,</span> x <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> xend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="operator">-</span><span class="literal">Inf</span><span class="punctuation">,</span> yend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">p <span class="operator">=</span> FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lightgrey&quot;</span> <span class="punctuation">,</span><span class="string">&quot;#DE1F1F&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">,</span> label.size <span class="operator">=</span> <span class="number">6</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">1.2</span><span class="punctuation">)</span> <span class="operator">+</span>  <span class="comment">### blank 空的</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.line <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.title <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>  </span><br><span class="line">p</span><br><span class="line"></span><br><span class="line">p <span class="operator">=</span> FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lightgrey&quot;</span> <span class="punctuation">,</span><span class="string">&quot;#DE1F1F&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">,</span>label.size <span class="operator">=</span> <span class="number">6</span><span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">1.2</span><span class="punctuation">)</span> <span class="operator">+</span>  <span class="comment">### blank 空的</span></span><br><span class="line">  theme<span class="punctuation">(</span>  axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.title <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span>  </span><br><span class="line">p2 <span class="operator">=</span> p <span class="operator">+</span> annotate<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&#x27;segment&#x27;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> yend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span> x <span class="operator">=</span> <span class="operator">-</span><span class="literal">Inf</span><span class="punctuation">,</span> xend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  annotate<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&#x27;segment&#x27;</span><span class="punctuation">,</span> x <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> xend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="operator">-</span><span class="literal">Inf</span><span class="punctuation">,</span> yend <span class="operator">=</span> <span class="literal">Inf</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span> </span><br><span class="line">p2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 有时候想移除图例，使用 guides()。</span></span><br><span class="line">p <span class="operator">+</span> guides<span class="punctuation">(</span>fill<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">p <span class="operator">+</span> guides<span class="punctuation">(</span>color<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 可以用theme(legend.position=…)将图例移到图表的上方、下方、左边和右边。</span></span><br><span class="line">p2 <span class="operator">+</span> theme<span class="punctuation">(</span>legend.position<span class="operator">=</span><span class="string">&quot;top&quot;</span><span class="punctuation">)</span></span><br><span class="line">p2 <span class="operator">+</span> NoLegend<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 可以将通过rgb颜色改个透明度</span></span><br><span class="line">print<span class="punctuation">(</span>FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> features<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                  cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>rgb<span class="punctuation">(</span><span class="number">220</span><span class="punctuation">,</span><span class="number">212</span><span class="punctuation">,</span><span class="number">213</span><span class="punctuation">,</span><span class="number">180</span><span class="punctuation">,</span>maxColorValue <span class="operator">=</span> <span class="number">255</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                           rgb<span class="punctuation">(</span><span class="number">174</span><span class="punctuation">,</span><span class="number">27</span><span class="punctuation">,</span><span class="number">52</span><span class="punctuation">,</span><span class="number">50</span><span class="punctuation">,</span> maxColorValue <span class="operator">=</span> <span class="number">255</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                  slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">,</span>label.size <span class="operator">=</span> <span class="number">6</span><span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">                  min.cutoff <span class="operator">=</span> <span class="string">&quot;q10&quot;</span><span class="punctuation">,</span> max.cutoff <span class="operator">=</span> <span class="string">&quot;q90&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">        theme<span class="punctuation">(</span>axis.line <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.title <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> <span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>  </span><br><span class="line">    panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">14</span><span class="punctuation">)</span>  </span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### </span></span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span>GetAssayData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">)</span></span><br><span class="line">mat1<span class="operator">=</span>as.data.frame<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span><span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>mat1<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;exp&quot;</span></span><br><span class="line">mat2<span class="operator">=</span>Embeddings<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span><span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">mat3<span class="operator">=</span>merge<span class="punctuation">(</span>mat2<span class="punctuation">,</span>mat1<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;row.names&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>mat3<span class="punctuation">)</span></span><br><span class="line">mat3<span class="operator">%&amp;gt;%</span>ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>umap_1<span class="punctuation">,</span>umap_2<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>color<span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;grey&quot;</span><span class="punctuation">,</span>high <span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="operator">+</span>theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>  </span><br><span class="line">    panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">14</span><span class="punctuation">)</span>  </span><br><span class="line">  <span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>labs<span class="punctuation">(</span>title<span class="operator">=</span> <span class="string">&quot;Rbp1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################################################</span></span><br><span class="line"><span class="comment">##scRNA1@active.ident=scRNA1@meta.data$celltype</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 制作marker基因的热图</span></span><br><span class="line">my36colors <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;#E5D2DD&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#53A85F&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F1BB72&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F3B1A0&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#D6E7A3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#57C3F3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#476D87&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#E95C59&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E59CC4&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#AB3282&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#23452F&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#BD956A&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#8C549C&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#585658&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#9FA3A8&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E0D4CA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#5F3D69&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#C5DEBA&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#58A4C3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E4C755&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#F7F398&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#AA9A59&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E63863&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#E39A35&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#C1E6F3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#6778AE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#91D0BE&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#B53E2B&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#712820&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#DCC1DD&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#CCE0F5&#x27;</span><span class="punctuation">,</span>  <span class="string">&#x27;#CCC9E6&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#625D9E&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#68A180&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;#3A6963&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&#x27;#968175&#x27;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">degs <span class="operator">&lt;-</span> FindAllMarkers<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                          test.use <span class="operator">=</span> <span class="string">&quot;roc&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                          return.thresh <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> </span><br><span class="line">                          min.pct <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">degs_sig <span class="operator">&lt;-</span>  degs <span class="operator">%&gt;%</span> </span><br><span class="line">  filter<span class="punctuation">(</span>pct.1 <span class="operator">&gt;</span> <span class="number">0.3</span> <span class="operator">&amp;</span></span><br><span class="line">           power <span class="operator">&gt;</span> <span class="number">0.25</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  filter<span class="punctuation">(</span>cluster <span class="operator">!=</span> <span class="string">&quot;other&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>cluster<span class="punctuation">,</span> <span class="operator">-</span>power<span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># select degs for heatmap</span></span><br><span class="line">degs_top50 <span class="operator">&lt;-</span> degs_sig <span class="operator">%&gt;%</span> </span><br><span class="line">  <span class="comment">#  filter(cluster!=&quot;other&quot;) %&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  top_n<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">,</span> power<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  top_n<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">,</span> avg_diff<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>cluster<span class="punctuation">,</span> <span class="operator">-</span>power<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 提取什么数据</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">=</span> GetAssayData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">)</span></span><br><span class="line">avgData <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span>degs_top50<span class="operator">$</span>gene<span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  apply<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    tapply<span class="punctuation">(</span>x<span class="punctuation">,</span> scRNA1<span class="operator">$</span>celltype<span class="punctuation">,</span> mean<span class="punctuation">)</span> <span class="comment"># ExpMean</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phData <span class="operator">&lt;-</span> MinMax<span class="punctuation">(</span>scale<span class="punctuation">(</span>avgData<span class="punctuation">)</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span> <span class="comment"># z-score</span></span><br><span class="line">rownames<span class="punctuation">(</span>phData<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>phData<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##install.packages(&quot;pheatmap&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">phres <span class="operator">&lt;-</span> pheatmap<span class="punctuation">(</span></span><br><span class="line">  phData<span class="punctuation">,</span> </span><br><span class="line">  color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">99</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#配色</span></span><br><span class="line">  scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#不按行聚类</span></span><br><span class="line">  cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#按列聚类</span></span><br><span class="line">  clustering_method <span class="operator">=</span> <span class="string">&quot;complete&quot;</span><span class="punctuation">,</span></span><br><span class="line">  show_rownames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#显示cluster名</span></span><br><span class="line">  annotation_row <span class="operator">=</span> data.frame<span class="punctuation">(</span>cluster <span class="operator">=</span> degs_top50<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"><span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line">My_levels <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Macrophage&quot;</span> <span class="punctuation">,</span><span class="string">&quot;Tissue_stem_cells&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Endothelial_cells&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;Monocyte&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&quot;Chondrocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;B_cell&quot;</span><span class="punctuation">,</span><span class="string">&quot;MSC&quot;</span><span class="punctuation">,</span><span class="string">&quot;T_cells&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">)</span></span><br><span class="line">phData1<span class="operator">=</span> phData<span class="punctuation">[</span><span class="punctuation">,</span> My_levels <span class="punctuation">]</span> </span><br><span class="line">phres <span class="operator">&lt;-</span> pheatmap<span class="punctuation">(</span></span><br><span class="line">  phData1<span class="punctuation">,</span> </span><br><span class="line">  color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">99</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#配色</span></span><br><span class="line">  scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#不按行聚类</span></span><br><span class="line">  cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#按列聚类</span></span><br><span class="line">  clustering_method <span class="operator">=</span> <span class="string">&quot;complete&quot;</span><span class="punctuation">,</span></span><br><span class="line">  show_rownames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> <span class="comment">#显示cluster名</span></span><br><span class="line">  annotation_row <span class="operator">=</span> data.frame<span class="punctuation">(</span>cluster <span class="operator">=</span> degs_top50<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">phres</span><br><span class="line"><span class="comment">########################################################################################################</span></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## marker基因的热图制作</span></span><br><span class="line"><span class="comment">### ！！！</span></span><br><span class="line"></span><br><span class="line">scRNA1<span class="operator">@</span>active.ident<span class="operator">=</span>factor<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">,</span> levels <span class="operator">=</span> My_levels <span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">marker <span class="operator">=</span> FindAllMarkers<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">write.csv<span class="punctuation">(</span>marker<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;marker.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">top10 <span class="operator">&lt;-</span>  marker  <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1 <span class="operator">&lt;-</span>  ScaleData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> rownames<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span> label <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> slot <span class="operator">=</span> <span class="string">&quot;scale.data&quot;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">sc.s <span class="operator">=</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>downsample<span class="operator">=</span><span class="number">500</span><span class="punctuation">)</span></span><br><span class="line">DoHeatmap<span class="punctuation">(</span> sc.s <span class="punctuation">,</span>features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span>label <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;scale.data&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>DoHeatmap</span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line">scRNA2<span class="operator">=</span>scRNA1</span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA1<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">scRNA1 <span class="operator">=</span> subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> downsample <span class="operator">=</span> <span class="number">150</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colanno <span class="operator">=</span> scRNA1<span class="operator">@</span>meta.data </span><br><span class="line">colanno<span class="operator">$</span>barcode <span class="operator">=</span> rownames<span class="punctuation">(</span>colanno<span class="punctuation">)</span></span><br><span class="line">colanno <span class="operator">=</span> colanno<span class="operator">%&gt;%</span>arrange<span class="punctuation">(</span>celltype<span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>colanno<span class="punctuation">)</span> <span class="operator">=</span> colanno<span class="operator">$</span>barcode</span><br><span class="line">colanno<span class="operator">$</span>barcode <span class="operator">=</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">colanno1 <span class="operator">=</span> colanno<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line">colanno1 <span class="operator">=</span> as.data.frame<span class="punctuation">(</span>colanno1<span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>colanno1<span class="punctuation">)</span> <span class="operator">=</span> rownames<span class="punctuation">(</span>colanno<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>colanno1<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line"></span><br><span class="line">rowanno<span class="operator">=</span>top10</span><br><span class="line">colnames<span class="punctuation">(</span>top10<span class="punctuation">)</span></span><br><span class="line">rowanno<span class="operator">=</span>rowanno<span class="operator">%&gt;%</span>arrange<span class="punctuation">(</span>cluster<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scale.data<span class="operator">=</span>GetAssayData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>slot <span class="operator">=</span>  <span class="string">&quot;scale.data&quot;</span><span class="punctuation">)</span></span><br><span class="line">mat4<span class="operator">=</span>scale.data<span class="punctuation">[</span>rowanno<span class="operator">$</span>gene<span class="punctuation">,</span>rownames<span class="punctuation">(</span>colanno1<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">mat4<span class="punctuation">[</span>mat4 <span class="operator">&gt;=</span> <span class="number">2.5</span><span class="punctuation">]</span><span class="operator">=</span><span class="number">2.5</span></span><br><span class="line">mat4<span class="punctuation">[</span>mat4 <span class="operator">&lt;</span> <span class="punctuation">(</span><span class="operator">-</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="operator">=</span> <span class="operator">-</span><span class="number">1</span>  </span><br><span class="line"></span><br><span class="line">pheatmap<span class="punctuation">(</span>mat4<span class="punctuation">,</span>cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         annotation_col <span class="operator">=</span> colanno1<span class="punctuation">,</span></span><br><span class="line">         gaps_row<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>rowanno<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">9</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         gaps_col<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>colanno<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">9</span><span class="punctuation">]</span><span class="punctuation">)</span> </span><br><span class="line">         </span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pheatmap<span class="punctuation">(</span>mat4<span class="punctuation">,</span>cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         annotation_col <span class="operator">=</span> colanno1<span class="punctuation">,</span></span><br><span class="line">         gaps_row<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>rowanno<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         gaps_col<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>colanno<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;darkblue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">99</span><span class="punctuation">)</span></span><br><span class="line">         </span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pheatmap<span class="punctuation">(</span>mat4<span class="punctuation">,</span>cluster_rows <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>cluster_cols <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         annotation_col <span class="operator">=</span> colanno1<span class="punctuation">,</span></span><br><span class="line">         gaps_row<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>rowanno<span class="operator">$</span>cluster<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         gaps_col<span class="operator">=</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">cumsum</span><span class="punctuation">(</span>table<span class="punctuation">(</span>colanno<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="punctuation">,</span></span><br><span class="line">         filename<span class="operator">=</span><span class="string">&quot;marker.heatmap.pdf&quot;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">11</span><span class="punctuation">,</span>height <span class="operator">=</span> <span class="number">7</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 自定义绘制一个小提琴图</span></span><br><span class="line"></span><br><span class="line">top3 <span class="operator">&lt;-</span>  marker <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA1 <span class="operator">=</span> scRNA_harmony</span><br><span class="line">VlnPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> top3<span class="operator">$</span>gene<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span> <span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.x.bottom <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA1<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span></span><br><span class="line">marker <span class="operator">=</span> FindAllMarkers<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>logfc.threshold <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">top10 <span class="operator">&lt;-</span> marker <span class="operator">%&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>reshape2<span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">=</span> GetAssayData<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">)</span></span><br><span class="line">vln.df <span class="operator">=</span> as.data.frame<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span>top10<span class="operator">$</span>gene<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">vln.df<span class="operator">$</span>gene <span class="operator">=</span> rownames<span class="punctuation">(</span>vln.df<span class="punctuation">)</span></span><br><span class="line">vln.df <span class="operator">=</span> melt<span class="punctuation">(</span>vln.df<span class="punctuation">,</span>id<span class="operator">=</span><span class="string">&quot;gene&quot;</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>vln.df<span class="punctuation">)</span><span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;barcode&quot;</span><span class="punctuation">,</span><span class="string">&quot;exp&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">anno <span class="operator">=</span> scRNA1<span class="operator">@</span>meta.data</span><br><span class="line">anno<span class="operator">$</span>barcode <span class="operator">=</span> rownames<span class="punctuation">(</span>anno<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vln.df <span class="operator">=</span> inner_join<span class="punctuation">(</span>vln.df<span class="punctuation">,</span>anno<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;barcode&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##vln.df$gene=factor(vln.df$gene,levels = top10$gene[1:7]) #为了控制画图的基因顺序</span></span><br><span class="line">table<span class="punctuation">(</span>vln.df<span class="operator">$</span>gene<span class="punctuation">)</span></span><br><span class="line">vln.df<span class="operator">$</span>gene <span class="operator">=</span> factor<span class="punctuation">(</span>vln.df<span class="operator">$</span>gene<span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>.........<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">vln.df<span class="operator">%&gt;%</span>ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>celltype<span class="punctuation">,</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_violin<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill<span class="operator">=</span>gene<span class="punctuation">)</span><span class="punctuation">,</span>scale <span class="operator">=</span> <span class="string">&quot;width&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>vln.df<span class="operator">$</span>gene<span class="operator">~</span>.<span class="punctuation">,</span>scales <span class="operator">=</span> <span class="string">&quot;free_y&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_fill_brewer<span class="punctuation">(</span>palette <span class="operator">=</span> <span class="string">&quot;Set3&quot;</span><span class="punctuation">,</span>direction <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_continuous<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.x.bottom <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################################################################################</span></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">top10 <span class="operator">&lt;-</span> marker  <span class="operator">%&amp;&gt;%</span> group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span> top_n<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> wt <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line">DotPlot<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span> features <span class="operator">=</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span>cols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lightgrey&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#FF00FF&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot;huage&quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_discrete<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span>theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>RotatedAxis<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="operator">?</span>DotPlot</span><br><span class="line">bubble.df <span class="operator">=</span> as.matrix<span class="punctuation">(</span>scRNA1<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>data<span class="punctuation">[</span> top10<span class="operator">$</span>gene<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">bubble.df <span class="operator">=</span> t<span class="punctuation">(</span>bubble.df<span class="punctuation">)</span></span><br><span class="line">bubble.df <span class="operator">=</span> as.data.frame<span class="punctuation">(</span>scale<span class="punctuation">(</span>bubble.df<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">bubble.df<span class="operator">$</span>CB <span class="operator">=</span> rownames<span class="punctuation">(</span>bubble.df<span class="punctuation">)</span></span><br><span class="line">meta <span class="operator">=</span> scRNA1<span class="operator">@</span>meta.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">bubble.df <span class="operator">=</span> merge<span class="punctuation">(</span>bubble.df<span class="punctuation">,</span>meta<span class="punctuation">,</span>by.x <span class="operator">=</span> <span class="string">&quot;CB&quot;</span><span class="punctuation">,</span>by.y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">bubble.df<span class="operator">$</span>CB <span class="operator">=</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">celltype_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">gene_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">mean_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">ratio_v<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> unique<span class="punctuation">(</span>bubble.df<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  bubble.df_small<span class="operator">=</span>bubble.df<span class="operator">%&amp;gt;%</span>filter<span class="punctuation">(</span>celltype<span class="operator">==</span>i<span class="punctuation">)</span></span><br><span class="line">  <span class="keyword">for</span> <span class="punctuation">(</span>j <span class="keyword">in</span> top10<span class="operator">$</span>gene<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    exp_mean<span class="operator">=</span>mean<span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">    exp_ratio<span class="operator">=</span><span class="built_in">sum</span><span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span> <span class="operator">&amp;</span>gt; <span class="built_in">min</span><span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="built_in">length</span><span class="punctuation">(</span>bubble.df_small<span class="punctuation">[</span><span class="punctuation">,</span>j<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">    celltype_v<span class="operator">=</span>append<span class="punctuation">(</span>celltype_v<span class="punctuation">,</span>i<span class="punctuation">)</span>  <span class="comment">##Add elements to a vector.</span></span><br><span class="line">    gene_v<span class="operator">=</span>append<span class="punctuation">(</span>gene_v<span class="punctuation">,</span>j<span class="punctuation">)</span></span><br><span class="line">    mean_v<span class="operator">=</span>append<span class="punctuation">(</span>mean_v<span class="punctuation">,</span>exp_mean<span class="punctuation">)</span></span><br><span class="line">    ratio_v<span class="operator">=</span>append<span class="punctuation">(</span>ratio_v<span class="punctuation">,</span>exp_ratio<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">plotdf<span class="operator">=</span>data.frame<span class="punctuation">(</span></span><br><span class="line">  celltype<span class="operator">=</span>celltype_v<span class="punctuation">,</span></span><br><span class="line">  gene<span class="operator">=</span>gene_v<span class="punctuation">,</span></span><br><span class="line">  <span class="built_in">exp</span><span class="operator">=</span>mean_v<span class="punctuation">,</span></span><br><span class="line">  ratio<span class="operator">=</span>ratio_v</span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>RColorBrewer<span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">$</span>celltype<span class="operator">=</span>factor<span class="punctuation">(</span>plotdf<span class="operator">$</span>celltype<span class="punctuation">,</span>levels <span class="operator">=</span> sort<span class="punctuation">(</span>unique<span class="punctuation">(</span>plotdf<span class="operator">$</span>celltype<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">$</span>gene<span class="operator">=</span>factor<span class="punctuation">(</span>plotdf<span class="operator">$</span>gene<span class="punctuation">,</span>levels <span class="operator">=</span> rev<span class="punctuation">(</span><span class="built_in">as.character</span><span class="punctuation">(</span>top10<span class="operator">$</span>gene<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">$</span><span class="built_in">exp</span><span class="operator">=</span>ifelse<span class="punctuation">(</span>plotdf<span class="operator">$</span><span class="built_in">exp</span><span class="operator">&amp;</span>gt;<span class="number">3</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>plotdf<span class="operator">$</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line">plotdf<span class="operator">%&gt;%</span>ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>celltype<span class="punctuation">,</span>y<span class="operator">=</span>gene<span class="punctuation">,</span>size<span class="operator">=</span>ratio<span class="punctuation">,</span>color<span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span><span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="operator">+</span>scale_y_discrete<span class="punctuation">(</span><span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_gradientn<span class="punctuation">(</span>colours <span class="operator">=</span> rev<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#FFD92F&quot;</span><span class="punctuation">,</span><span class="string">&quot;#FEE391&quot;</span><span class="punctuation">,</span>brewer.pal<span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span> <span class="string">&quot;Spectral&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">7</span><span class="operator">:</span><span class="number">11</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_size_continuous<span class="punctuation">(</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span>theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.x.bottom <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> angle <span class="operator">=</span> <span class="number">90</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>ggpubr<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span> scRNA1 <span class="punctuation">,</span> <span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>stat_compare_means<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&#x27;t.test&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span> scRNA1 <span class="punctuation">,</span> <span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>stat_compare_means<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&#x27;t.test&#x27;</span><span class="punctuation">)</span><span class="operator">+</span>geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span> scRNA1 <span class="punctuation">,</span> <span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>stat_compare_means<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&#x27;t.test&#x27;</span><span class="punctuation">)</span><span class="operator">+</span>geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>XBP1 <span class="operator">&amp;</span>gt; <span class="number">0</span> <span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;XBP1&quot;</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>stat_compare_means<span class="punctuation">(</span>method <span class="operator">=</span> <span class="string">&#x27;t.test&#x27;</span><span class="punctuation">)</span><span class="operator">+</span>geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">sc.FURIN<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA1<span class="punctuation">,</span>Rbp1 <span class="operator">&amp;</span>gt; <span class="number">0</span> <span class="punctuation">)</span></span><br><span class="line">FURIN.exp<span class="operator">=</span>sc.FURIN<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>data<span class="punctuation">[</span><span class="string">&quot;Rbp1&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">FURIN.exp.m<span class="operator">=</span> sc.FURIN<span class="operator">@</span>meta.data</span><br><span class="line">table<span class="punctuation">(</span>sc.FURIN<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">FURIN.exp.m<span class="operator">$</span><span class="built_in">exp</span><span class="operator">=</span>FURIN.exp</span><br><span class="line">FURIN.exp.m<span class="operator">$</span>Cohort<span class="operator">=</span>factor<span class="punctuation">(</span>FURIN.exp.m<span class="operator">$</span>orig.ident<span class="punctuation">,</span></span><br><span class="line">                          levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg1&quot;</span><span class="punctuation">,</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">,</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">,</span><span class="string">&#x27;CAF2&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>FURIN.exp.m<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;FURIN.exp.m.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>FURIN.exp.m<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&quot;ggsignif&quot;</span><span class="punctuation">)</span></span><br><span class="line">my_comparisons<span class="operator">=</span><span class="built_in">list</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg1&quot;</span><span class="punctuation">,</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg2&quot;</span><span class="punctuation">,</span><span class="string">&#x27;CAF2&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DapiNeg2&quot;</span> <span class="punctuation">,</span><span class="string">&quot;CAF1&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>FURIN.exp.m<span class="punctuation">,</span>aes<span class="punctuation">(</span>Cohort<span class="punctuation">,</span><span class="built_in">exp</span><span class="punctuation">,</span>fill<span class="operator">=</span>Cohort<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_violin<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>theme_classic<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title<span class="operator">=</span>element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.x<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">,</span>angle<span class="operator">=</span><span class="number">25</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">18</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.x<span class="operator">=</span>element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span>y<span class="operator">=</span> <span class="string">&#x27;Expression&#x27;</span><span class="punctuation">,</span>x<span class="operator">=</span><span class="string">&quot;Group&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_signif<span class="punctuation">(</span>comparisons <span class="operator">=</span> my_comparisons<span class="punctuation">,</span>step_increase <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">              map_signif_level <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>test <span class="operator">=</span> t.test<span class="punctuation">,</span>size<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>textsize <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_jitter<span class="punctuation">(</span>shape<span class="operator">=</span><span class="number">16</span><span class="punctuation">,</span> position<span class="operator">=</span>position_jitter<span class="punctuation">(</span><span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;Rbp1&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span><span class="number">18</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  guides<span class="punctuation">(</span>fill<span class="operator">=</span>guide_legend<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span> <span class="comment">##更改legend名字</span></span><br><span class="line">  <span class="comment">##如果是color分组 需要 guides(color=guide_legend(title = &quot;Group&quot;)) </span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.line.x<span class="operator">=</span>element_line<span class="punctuation">(</span>linetype<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.line.y<span class="operator">=</span>element_line<span class="punctuation">(</span>linetype<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>legend.text <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span> <span class="punctuation">)</span> <span class="comment">##legend字体变大</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="差异基因分析"><a class="headerlink" href="#差异基因分析"></a>差异基因分析</h2>
<hr>
<h3 id="差异基因的展示（heatmap等）"><a class="headerlink" href="#差异基因的展示（heatmap等）"></a>差异基因的展示（heatmap等）</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 差异基因分析</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cowplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>reshape2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D:/0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D:/0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################################################################</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cowplot<span class="punctuation">)</span></span><br><span class="line">theme_set<span class="punctuation">(</span>theme_cowplot<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">t.cells <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> idents <span class="operator">=</span> <span class="string">&quot;1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>t.cells<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对两个分组进行差异分析</span></span><br><span class="line"><span class="comment">## ident.1，ident.2</span></span><br><span class="line">deg <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>t.cells<span class="punctuation">,</span> ident.1 <span class="operator">=</span> <span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span>ident.2 <span class="operator">=</span> <span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                      logfc.threshold <span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>t.cells<span class="punctuation">)</span> <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">deg <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>t.cells<span class="punctuation">,</span> ident.1 <span class="operator">=</span> <span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span> ident.2 <span class="operator">=</span> <span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                      logfc.threshold <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">=</span> AverageExpression<span class="punctuation">(</span>t.cells<span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">=</span> as.data.frame<span class="punctuation">(</span><span class="built_in">exp</span><span class="operator">$</span>RNA<span class="punctuation">)</span>  </span><br><span class="line"><span class="comment">## 取log值是防止基因的离散程度过高，表达量太大</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">=</span> log1p<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##avg.t.cells &lt;- as.data.frame(log1p(AverageExpression(t.cells, verbose = FALSE)$RNA))</span></span><br><span class="line">avg.t.cells <span class="operator">=</span> <span class="built_in">exp</span></span><br><span class="line"></span><br><span class="line">avg.t.cells<span class="operator">$</span>gene <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>avg.t.cells<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>avg.t.cells<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">deg <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>t.cells<span class="punctuation">,</span>ident.1 <span class="operator">=</span> <span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span>ident.2 <span class="operator">=</span> <span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                      logfc.threshold <span class="operator">=</span><span class="number">8</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">deg <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>t.cells<span class="punctuation">,</span>ident.1 <span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span><span class="string">&quot;sample_12&quot;</span><span class="punctuation">)</span> <span class="punctuation">,</span></span><br><span class="line">                      ident.2 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span><span class="string">&quot;sample_4&quot;</span><span class="punctuation">)</span> <span class="punctuation">,</span> </span><br><span class="line">                      logfc.threshold <span class="operator">=</span><span class="number">8</span><span class="punctuation">,</span> group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>avg.t.cells<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>avg.t.cells<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span><span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span><span class="string">&quot;gene&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">genes.to.label <span class="operator">=</span> sample<span class="punctuation">(</span>rownames<span class="punctuation">(</span>deg<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">p1 <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>avg.t.cells<span class="punctuation">,</span> aes<span class="punctuation">(</span>sample_11<span class="punctuation">,</span>sample_3<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> ggtitle<span class="punctuation">(</span><span class="string">&quot;T Cells&quot;</span><span class="punctuation">)</span></span><br><span class="line">p1 <span class="operator">&lt;-</span> LabelPoints<span class="punctuation">(</span>plot <span class="operator">=</span> p1<span class="punctuation">,</span> points <span class="operator">=</span> genes.to.label<span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">p1 </span><br><span class="line"></span><br><span class="line">p1 <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>avg.t.cells<span class="punctuation">,</span> aes<span class="punctuation">(</span>sample_11<span class="punctuation">,</span>sample_3<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> ggtitle<span class="punctuation">(</span><span class="string">&quot;T Cells&quot;</span><span class="punctuation">)</span></span><br><span class="line">LabelPoints<span class="punctuation">(</span>plot <span class="operator">=</span> p1<span class="punctuation">,</span> points <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;RPS4Y1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################################</span></span><br><span class="line"></span><br><span class="line">degdf <span class="operator">=</span> avg.t.cells</span><br><span class="line">degdf.l <span class="operator">=</span> degdf<span class="punctuation">[</span>genes.to.label<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">degdf.p <span class="operator">=</span> degdf<span class="punctuation">[</span><span class="operator">-</span>match<span class="punctuation">(</span>genes.to.label<span class="punctuation">,</span>rownames<span class="punctuation">(</span>degdf<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment">## 标注为不显著</span></span><br><span class="line">degdf.p<span class="operator">$</span>Sig <span class="operator">=</span> <span class="string">&quot;NO_DIFF&quot;</span></span><br><span class="line"><span class="comment">## 标注为显著</span></span><br><span class="line">degdf.l<span class="operator">$</span>Sig <span class="operator">=</span> <span class="string">&quot;DIFF&quot;</span></span><br><span class="line">degdf <span class="operator">=</span> rbind<span class="punctuation">(</span>degdf.p<span class="punctuation">,</span>degdf.l<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>degdf<span class="punctuation">)</span></span><br><span class="line">p <span class="operator">=</span> ggplot<span class="punctuation">(</span>degdf<span class="punctuation">,</span> aes<span class="punctuation">(</span>sample_11<span class="punctuation">,</span>sample_3<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span> aes<span class="punctuation">(</span>color<span class="operator">=</span>Sig<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  </span><br><span class="line">  scale_color_manual<span class="punctuation">(</span>values<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;grey&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;Stromal Cells&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span><span class="number">18</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> face <span class="operator">=</span> <span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  </span><br><span class="line">  theme<span class="punctuation">(</span>axis.title.x <span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">14</span><span class="punctuation">)</span><span class="punctuation">,</span> axis.title.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">14</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  </span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p</span><br><span class="line"></span><br><span class="line">p <span class="operator">=</span> p<span class="operator">+</span>theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>panel.border <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        </span><br><span class="line">        panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.line <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p</span><br><span class="line">data_selected <span class="operator">&lt;-</span> degdf<span class="punctuation">[</span>genes.to.label<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">p <span class="operator">+</span> geom_label_repel<span class="punctuation">(</span>data<span class="operator">=</span>data_selected<span class="punctuation">,</span></span><br><span class="line">                     aes<span class="punctuation">(</span>label<span class="operator">=</span>rownames<span class="punctuation">(</span>data_selected<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>geom_point</span><br><span class="line">p <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">6</span><span class="punctuation">,</span> shape <span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> data <span class="operator">=</span> data_selected<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MMP2&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>colour<span class="operator">=</span><span class="string">&quot;green&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggrepel<span class="operator">::</span>geom_text_repel<span class="punctuation">(</span></span><br><span class="line">    aes<span class="punctuation">(</span>label <span class="operator">=</span>genes.to.label<span class="punctuation">)</span><span class="punctuation">,</span>size <span class="operator">=</span><span class="number">2.5</span><span class="punctuation">,</span></span><br><span class="line">    data <span class="operator">=</span> data_selected<span class="punctuation">,</span></span><br><span class="line">    color<span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="operator">+</span>theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>panel.border <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        </span><br><span class="line">        panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.line <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;Stromal Cells&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span><span class="number">18</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>geom_label_repel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################################################################</span></span><br><span class="line"><span class="comment">##火山图</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line">cd4.naive<span class="operator">=</span>subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>idents <span class="operator">=</span><span class="string">&quot;1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">degdf <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>cd4.naive<span class="punctuation">,</span>ident.1 <span class="operator">=</span> <span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span>ident.2 <span class="operator">=</span> <span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.01</span><span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">degdf<span class="operator">$</span>symbol <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>degdf<span class="punctuation">)</span></span><br><span class="line">logFC_t <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">P.Value_t <span class="operator">=</span> <span class="number">1e-28</span></span><br><span class="line">degdf<span class="operator">$</span>change <span class="operator">=</span> ifelse<span class="punctuation">(</span>degdf<span class="operator">$</span>p_val_adj <span class="operator">&lt;</span> P.Value_t <span class="operator">&amp;</span> degdf<span class="operator">$</span>avg_log2FC <span class="operator">&lt;</span> <span class="number">0</span><span class="punctuation">,</span><span class="string">&quot;down&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      ifelse<span class="punctuation">(</span>degdf<span class="operator">$</span>p_val_adj <span class="operator">&lt;</span> P.Value_t <span class="operator">&amp;</span> degdf<span class="operator">$</span>avg_log2FC <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">,</span><span class="string">&quot;up&quot;</span><span class="punctuation">,</span><span class="string">&quot;stable&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">p<span class="operator">=</span>ggplot<span class="punctuation">(</span>degdf<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> avg_log2FC<span class="punctuation">,</span> y <span class="operator">=</span> <span class="operator">-</span>log10<span class="punctuation">(</span>p_val_adj<span class="punctuation">)</span><span class="punctuation">,</span> size <span class="operator">=</span> pct.1<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>alpha <span class="operator">=</span> <span class="number">0.4</span><span class="punctuation">,</span>  aes<span class="punctuation">(</span>color <span class="operator">=</span> change<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&quot;-log10(Pvalue)&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_manual<span class="punctuation">(</span>values<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;grey&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_hline<span class="punctuation">(</span>yintercept <span class="operator">=</span> <span class="operator">-</span>log10<span class="punctuation">(</span>P.Value_t<span class="punctuation">)</span><span class="punctuation">,</span>lty<span class="operator">=</span><span class="number">4</span><span class="punctuation">,</span>col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">,</span>lwd<span class="operator">=</span><span class="number">0.8</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">p<span class="operator">=</span>p<span class="operator">+</span>theme_bw<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>panel.border <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        </span><br><span class="line">        panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>axis.line <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 某个基因的单独展示</span></span><br><span class="line">data_selected <span class="operator">&lt;-</span> degdf<span class="punctuation">[</span><span class="string">&quot;TIMP1&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">p <span class="operator">+</span> geom_label_repel<span class="punctuation">(</span>data<span class="operator">=</span>data_selected<span class="punctuation">,</span></span><br><span class="line">                     aes<span class="punctuation">(</span>label<span class="operator">=</span>rownames<span class="punctuation">(</span>data_selected<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p <span class="operator">+</span> geom_text_repel<span class="punctuation">(</span>data<span class="operator">=</span>data_selected<span class="punctuation">,</span></span><br><span class="line">                    aes<span class="punctuation">(</span>label<span class="operator">=</span>rownames<span class="punctuation">(</span>data_selected<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>geom_point</span><br><span class="line">p <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">4</span><span class="punctuation">,</span> shape <span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> data <span class="operator">=</span> data_selected<span class="punctuation">,</span>colour<span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggrepel<span class="operator">::</span>geom_label_repel<span class="punctuation">(</span></span><br><span class="line">    aes<span class="punctuation">(</span>label <span class="operator">=</span> symbol<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    data <span class="operator">=</span> data_selected<span class="punctuation">,</span></span><br><span class="line">    color<span class="operator">=</span><span class="string">&quot;#f7aa5d&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">###如何改变点的颜色</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br></pre></td></tr></table></figure>
<h3 id="三维pca的展示"><a class="headerlink" href="#三维pca的展示"></a>三维pca的展示</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 三维pca的展示</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>scatterplot3d<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D:/0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;sc.combined.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D:/0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>new.celltype.2<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>type<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 三维pca图可以直接观看不同亚群之间的差异性</span></span><br><span class="line"><span class="comment">##  Fibroblasts</span></span><br><span class="line"></span><br><span class="line">sc.imm<span class="operator">=</span>subset<span class="punctuation">(</span>sc.combined<span class="punctuation">,</span>idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span><span class="string">&quot;Endothelial&quot;</span><span class="punctuation">,</span><span class="string">&quot;Stem_cell&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>sc.imm<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">table<span class="punctuation">(</span> sc.imm<span class="operator">@</span>active.ident<span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># factor 可以进行排序</span></span><br><span class="line">sc.imm<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="operator">=</span>factor<span class="punctuation">(</span>sc.imm<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">  <span class="string">&quot;GF_1&quot;</span><span class="punctuation">,</span><span class="string">&quot;GF_2&quot;</span><span class="punctuation">,</span><span class="string">&quot;GF_3&quot;</span><span class="punctuation">,</span><span class="string">&quot;SPF_1&quot;</span><span class="punctuation">,</span><span class="string">&quot;SPF_2&quot;</span><span class="punctuation">,</span><span class="string">&quot;SPF_3&quot;</span><span class="punctuation">,</span><span class="string">&quot;FMT_1&quot;</span><span class="punctuation">,</span><span class="string">&quot;FMT_2&quot;</span><span class="punctuation">,</span><span class="string">&quot;FMT_3&quot;</span></span><br><span class="line"><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>sc.imm<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">table<span class="punctuation">(</span>sc.imm<span class="operator">@</span>active.ident<span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>AverageExpression</span><br><span class="line">x<span class="operator">=</span>AverageExpression<span class="punctuation">(</span>sc.imm <span class="punctuation">,</span>add.ident<span class="operator">=</span><span class="string">&quot;new.celltype.2&quot;</span><span class="punctuation">)</span></span><br><span class="line">x1<span class="operator">=</span>AverageExpression<span class="punctuation">(</span>sc.imm  <span class="punctuation">)</span></span><br><span class="line">x<span class="operator">=</span>x<span class="operator">$</span>RNA</span><br><span class="line">x<span class="operator">=</span>as.matrix<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">x1<span class="operator">=</span>x1<span class="operator">$</span>RNA</span><br><span class="line">x1<span class="operator">=</span>as.matrix<span class="punctuation">(</span>x1<span class="punctuation">)</span></span><br><span class="line">pca <span class="operator">&lt;-</span> prcomp<span class="punctuation">(</span>t<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">=</span>pca<span class="operator">$</span>x</span><br><span class="line"></span><br><span class="line">rownames<span class="punctuation">(</span>pca.data<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>pca.data<span class="punctuation">)</span></span><br><span class="line">pca.data<span class="operator">=</span>pca.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">$</span>Type <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;GF&quot;</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;SPF&quot;</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;FMT&quot;</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">s1<span class="operator">=</span>strsplit<span class="punctuation">(</span>rownames<span class="punctuation">(</span>pca.data<span class="punctuation">)</span><span class="punctuation">,</span>split <span class="operator">=</span> <span class="string">&quot;_&quot;</span><span class="punctuation">,</span>fixed <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">type<span class="operator">=</span>sapply<span class="punctuation">(</span>s1<span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span>x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">&#125;</span>   <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">$</span>cell.type <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span><span class="string">&quot;Endothelial&quot;</span><span class="punctuation">,</span><span class="string">&quot;Stem_cell&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">9</span> <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type.p<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">16</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">17</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">cell.type.p <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">9</span> <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">colors.lib <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">)</span></span><br><span class="line">shapes.lib <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">,</span><span class="number">17</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">getwd<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Source the function</span></span><br><span class="line">source<span class="punctuation">(</span> <span class="string">&quot;E:/super.lesson/lesson9/huage.3D.plot.R&quot;</span> <span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 2. 3D scatter plot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s3d <span class="operator">&lt;-</span> scatterplot3d<span class="punctuation">(</span>pca.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;PC1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC2&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC3&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        </span><br><span class="line">                        pch <span class="operator">=</span> Type.p<span class="punctuation">,</span>color <span class="operator">=</span> cell.type.p<span class="punctuation">,</span></span><br><span class="line">                        </span><br><span class="line">                        cex.symbols <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>grid<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> box<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> </span><br><span class="line">                        </span><br><span class="line">                        main <span class="operator">=</span> <span class="string">&quot;3D PCA plot&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">legend<span class="punctuation">(</span><span class="string">&quot;topright&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Epithelial&quot;</span><span class="punctuation">,</span><span class="string">&quot;Endothelial&quot;</span><span class="punctuation">,</span><span class="string">&quot;Stem_cell&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       fill<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;blue&#x27;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       box.col<span class="operator">=</span><span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">legend<span class="punctuation">(</span><span class="string">&quot;topleft&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;GF&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;SPF&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;FMT&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       pch <span class="operator">=</span> shapes.lib<span class="punctuation">,</span></span><br><span class="line">       box.col<span class="operator">=</span><span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Add grids</span></span><br><span class="line">addgrids3d<span class="punctuation">(</span>pca.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;PC1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC2&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC3&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">,</span> grid <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;xy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;xz&quot;</span><span class="punctuation">,</span> <span class="string">&quot;yz&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>new.celltype.2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##  Goblet Paneth cells Enteroendocrine</span></span><br><span class="line">Idents<span class="punctuation">(</span>sc.combined<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;new.celltype.3&quot;</span></span><br><span class="line">sc.imm<span class="operator">=</span>subset<span class="punctuation">(</span>sc.combined<span class="punctuation">,</span>idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Goblet&quot;</span><span class="punctuation">,</span><span class="string">&quot;MSC&quot;</span><span class="punctuation">,</span><span class="string">&quot;T_NK&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>sc.imm<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line">x<span class="operator">=</span>AverageExpression<span class="punctuation">(</span>sc.imm <span class="punctuation">,</span>add.ident<span class="operator">=</span><span class="string">&quot;new.celltype.3&quot;</span><span class="punctuation">)</span></span><br><span class="line">x<span class="operator">=</span>x<span class="operator">$</span>RNA</span><br><span class="line">pca <span class="operator">&lt;-</span>  prcomp<span class="punctuation">(</span>t<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">=</span>pca<span class="operator">$</span>x</span><br><span class="line"></span><br><span class="line">rownames<span class="punctuation">(</span>pca.data<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">=</span>as.data.frame<span class="punctuation">(</span>pca.data<span class="punctuation">)</span></span><br><span class="line">pca.data<span class="operator">=</span>pca.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">pca.data<span class="operator">$</span>Type <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;GF&quot;</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;SPF&quot;</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;FMT&quot;</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">pca.data<span class="operator">$</span>cell.type <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Goblet&quot;</span><span class="punctuation">,</span><span class="string">&quot;Paneth cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Enteroendocrine&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">9</span> <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type.p<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">16</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">17</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">cell.type.p <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">9</span> <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">colors.lib <span class="operator">&amp;</span>lt;<span class="operator">-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">)</span></span><br><span class="line">shapes.lib <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">,</span><span class="number">17</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">getwd<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Source the function</span></span><br><span class="line">source<span class="punctuation">(</span><span class="string">&#x27;plot.3d.R&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 2. 3D scatter plot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s3d <span class="operator">&amp;</span>lt;<span class="operator">-</span> scatterplot3d<span class="punctuation">(</span>pca.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;PC1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC2&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC3&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        </span><br><span class="line">                        pch <span class="operator">=</span> Type.p<span class="punctuation">,</span>color <span class="operator">=</span> cell.type.p<span class="punctuation">,</span></span><br><span class="line">                        </span><br><span class="line">                        cex.symbols <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>grid<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> box<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> </span><br><span class="line">                        </span><br><span class="line">                        main <span class="operator">=</span> <span class="string">&quot;3D PCA plot&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">legend<span class="punctuation">(</span><span class="string">&quot;topright&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Goblet&quot;</span><span class="punctuation">,</span><span class="string">&quot;Paneth cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Enteroendocrine&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       fill<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;blue&#x27;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       box.col<span class="operator">=</span><span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">legend<span class="punctuation">(</span><span class="string">&quot;topleft&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;GF&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;SPF&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;FMT&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       pch <span class="operator">=</span> shapes.lib<span class="punctuation">,</span></span><br><span class="line">       box.col<span class="operator">=</span><span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Add grids</span></span><br><span class="line">addgrids3d<span class="punctuation">(</span>pca.data<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;PC1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC2&quot;</span><span class="punctuation">,</span><span class="string">&quot;PC3&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">,</span> grid <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;xy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;xz&quot;</span><span class="punctuation">,</span> <span class="string">&quot;yz&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="多个细胞类型基因展示"><a class="headerlink" href="#多个细胞类型基因展示"></a>多个细胞类型基因展示</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 不同分组差异基因的展示</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>reshape2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>RColorBrewer<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span>  </span><br><span class="line">library<span class="punctuation">(</span>magrittr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>data.table<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D://0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;scRNA_harmony.rdata&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>group.by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;D://0_SubjectData/&quot;</span><span class="punctuation">)</span></span><br><span class="line">sc.combined<span class="operator">=</span>scRNA_harmony</span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">type<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Chondrocytes&quot;</span><span class="punctuation">,</span><span class="string">&quot;Endothelial_cells&quot;</span><span class="punctuation">,</span><span class="string">&quot;Fibroblasts&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="string">&quot;Macrophage&quot;</span><span class="punctuation">,</span><span class="string">&quot;Monocyte&quot;</span><span class="punctuation">,</span> <span class="string">&quot;T_cells&quot;</span><span class="punctuation">,</span> </span><br><span class="line">       <span class="string">&quot;Tissue_stem_cells&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 等价于上面的代码</span></span><br><span class="line">type <span class="operator">=</span> unique<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dir.create<span class="punctuation">(</span><span class="string">&quot;deg/&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;deg/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#library(future)</span></span><br><span class="line"><span class="comment">#plan(&quot;multiprocess&quot;, workers =5)</span></span><br><span class="line"><span class="comment">#options(future.globals.maxSize = 2000 * 1024^2)</span></span><br><span class="line"></span><br><span class="line">r.deg <span class="operator">=</span> data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.combined<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span><span class="built_in">length</span><span class="punctuation">(</span>type<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  Idents<span class="punctuation">(</span>sc.combined<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line">  deg <span class="operator">=</span> FindMarkers<span class="punctuation">(</span>sc.combined<span class="punctuation">,</span>ident.1 <span class="operator">=</span> <span class="string">&quot;sample2&quot;</span><span class="punctuation">,</span>ident.2 <span class="operator">=</span> <span class="string">&quot;sample21&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span>subset.ident <span class="operator">=</span>type<span class="punctuation">[</span>i<span class="punctuation">]</span>   <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  write.csv<span class="punctuation">(</span>deg<span class="punctuation">,</span>file <span class="operator">=</span> paste0<span class="punctuation">(</span> type<span class="punctuation">[</span>i<span class="punctuation">]</span><span class="punctuation">,</span><span class="string">&#x27;deg.csv&#x27;</span><span class="punctuation">)</span> <span class="punctuation">)</span></span><br><span class="line">  deg<span class="operator">$</span>gene <span class="operator">=</span> rownames<span class="punctuation">(</span>deg<span class="punctuation">)</span></span><br><span class="line">  deg<span class="operator">$</span>celltype <span class="operator">=</span> type<span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line">  deg<span class="operator">$</span>unm <span class="operator">=</span> i<span class="operator">-</span><span class="number">1</span></span><br><span class="line">  r.deg <span class="operator">=</span> rbind<span class="punctuation">(</span>deg<span class="punctuation">,</span> r.deg<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>sc.combined<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line">deg<span class="operator">=</span>FindMarkers<span class="punctuation">(</span>sc.combined<span class="punctuation">,</span>ident.1 <span class="operator">=</span> <span class="string">&quot;sample_11&quot;</span><span class="punctuation">,</span>ident.2 <span class="operator">=</span> <span class="string">&quot;sample_3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                group.by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span>subset.ident <span class="operator">=</span>type<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span>   <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>r.deg<span class="operator">$</span>unm<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据自己计算的marker基因数量确定log2FC的阈值，这里先定为1.5</span></span><br><span class="line">r.deg <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>r.deg<span class="punctuation">,</span> p_val_adj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> <span class="built_in">abs</span><span class="punctuation">(</span>avg_log2FC<span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line">r.deg<span class="operator">$</span>threshold <span class="operator">&lt;-</span> as.factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>r.deg<span class="operator">$</span>avg_log2FC <span class="operator">&gt;</span> <span class="number">0</span> <span class="punctuation">,</span> <span class="string">&#x27;Up&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;Down&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">dim</span><span class="punctuation">(</span>r.deg<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">r.deg<span class="operator">$</span>adj_p_signi <span class="operator">&lt;-</span> as.factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>r.deg<span class="operator">$</span>p_val_adj <span class="operator">&lt;</span> <span class="number">0.01</span> <span class="punctuation">,</span> <span class="string">&#x27;Highly&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;Lowly&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">r.deg<span class="operator">$</span>thr_signi <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>r.deg<span class="operator">$</span>threshold<span class="punctuation">,</span> <span class="string">&quot;_&quot;</span><span class="punctuation">,</span> r.deg<span class="operator">$</span>adj_p_signi<span class="punctuation">)</span></span><br><span class="line">r.deg<span class="operator">$</span>unm <span class="operator">&lt;-</span> <span class="operator">&amp;</span><span class="operator">&gt;</span><span class="operator">% as.vector(.) %</span><span class="operator">&amp;</span><span class="operator">&gt;</span><span class="operator">% as.numeric(.)</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">##自定义显示想要展示的基因名</span></span><br><span class="line"><span class="operator">##这里挑选log2FC为top5的基因进行展示</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">top_up_label &lt;- r.deg %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  subset(., threshold%</span><span class="keyword">in</span><span class="operator">%&quot;Up&quot;) %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  group_by(unm) %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  top_n(n = 5, wt = avg_log2FC) %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  as.data.frame()</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">top_down_label &lt;- r.deg %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  subset(., threshold %</span><span class="keyword">in</span><span class="operator">% &quot;Down&quot;) %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  group_by(unm) %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  top_n(n = -5, wt = avg_log2FC) %</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  as.data.frame()</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">top_label &lt;- rbind(top_up_label,top_down_label)</span></span><br><span class="line"><span class="operator">top_label$thr_signi %</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">% </span></span><br><span class="line"><span class="operator">  factor(., levels = c(&quot;Up_Highly&quot;,&quot;Down_Highly&quot;,&quot;Up_Lowly&quot;,&quot;Down_Lowly&quot;))</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator"># 保存到文件，便于小白套用格式</span></span><br><span class="line"><span class="operator">#write.csv(top_label, &quot;easy_input_label.csv&quot;, quote = F)</span></span><br><span class="line"><span class="operator">##也可以基于output_pbmc.markers.csv文件，手动挑选出想要标注名字的基因，</span></span><br><span class="line"><span class="operator">#例如标注参与某一通路的基因，然后将文件命名为easy_input_label.csv</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">colnames(r.deg)</span></span><br><span class="line"><span class="operator">### 准备绘制暗灰色背景所需数据 </span></span><br><span class="line"><span class="operator">background_position &lt;- r.deg %</span><span class="operator">&gt;</span><span class="operator">%</span></span><br><span class="line"><span class="operator">  dplyr::group_by(unm) %</span><span class="operator">&gt;</span><span class="operator">%</span></span><br><span class="line"><span class="operator">  dplyr::summarise(Min = min(avg_log2FC) - 0.2, Max = max(avg_log2FC) + 0.2) %</span><span class="operator">&gt;</span><span class="operator">%</span></span><br><span class="line"><span class="operator">  as.data.frame()</span></span><br><span class="line"><span class="operator">## summarise()` ungrouping output (override with `.groups` argument)</span></span><br><span class="line"><span class="operator">background_position$unm %</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">% as.vector(.) %</span><span class="operator">&gt;</span><span class="operator">% as.numeric(.)</span></span><br><span class="line"><span class="operator">background_position$start &lt;- background_position$unm - 0.4</span></span><br><span class="line"><span class="operator">background_position$end &lt;- background_position$unm + 0.4</span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">### 准备绘制中间区域cluster彩色bar所需数据</span></span><br><span class="line"><span class="operator">cluster_bar_position &lt;- background_position</span></span><br><span class="line"><span class="operator">cluster_bar_position$start &lt;- cluster_bar_position$unm - 0.5</span></span><br><span class="line"><span class="operator">cluster_bar_position$end &lt;- cluster_bar_position$unm + 0.5</span></span><br><span class="line"><span class="operator">cluster_bar_position$unm %</span><span class="operator">&lt;</span><span class="operator">&gt;</span>% </span><br><span class="line">  factor<span class="punctuation">(</span>.<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="operator">:</span><span class="built_in">max</span><span class="punctuation">(</span>as.vector<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置填充颜色</span></span><br><span class="line">cols_thr_signi <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Up_Highly&quot;</span> <span class="operator">=</span> <span class="string">&quot;#d7301f&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       <span class="string">&quot;Down_Highly&quot;</span> <span class="operator">=</span> <span class="string">&quot;#225ea8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       <span class="string">&quot;Up_Lowly&quot;</span> <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       <span class="string">&quot;Down_Lowly&quot;</span> <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span></span><br><span class="line">cols_cluster <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;0&quot;</span> <span class="operator">=</span> <span class="string">&quot;#35978f&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;1&quot;</span> <span class="operator">=</span> <span class="string">&quot;#8dd3c7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;2&quot;</span> <span class="operator">=</span> <span class="string">&quot;#ffffb3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;3&quot;</span> <span class="operator">=</span> <span class="string">&quot;#bebada&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;4&quot;</span> <span class="operator">=</span> <span class="string">&quot;#fb8072&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;5&quot;</span> <span class="operator">=</span> <span class="string">&quot;#80b1d3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;6&quot;</span> <span class="operator">=</span> <span class="string">&quot;#fdb462&quot;</span><span class="punctuation">,</span><span class="string">&quot;7&quot;</span> <span class="operator">=</span> <span class="string">&quot;#925bea&quot;</span><span class="punctuation">,</span><span class="string">&quot;8&quot;</span> <span class="operator">=</span> <span class="string">&quot;#db5e92&quot;</span> </span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p<span class="operator">=</span> ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_rect<span class="punctuation">(</span>data <span class="operator">=</span> background_position<span class="punctuation">,</span> aes<span class="punctuation">(</span>xmin <span class="operator">=</span> start<span class="punctuation">,</span> xmax <span class="operator">=</span> end<span class="punctuation">,</span> ymin <span class="operator">=</span> Min<span class="punctuation">,</span></span><br><span class="line">                                            ymax <span class="operator">=</span> Max<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            fill <span class="operator">=</span> <span class="string">&quot;#525252&quot;</span><span class="punctuation">,</span> alpha <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">###添加灰色背景色</span></span><br><span class="line">  geom_jitter<span class="punctuation">(</span>data <span class="operator">=</span> r.deg<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span>unm<span class="punctuation">,</span> y <span class="operator">=</span> avg_log2FC<span class="punctuation">,</span> colour <span class="operator">=</span> thr_signi<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>position <span class="operator">=</span> position_jitter<span class="punctuation">(</span>seed <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_color_manual<span class="punctuation">(</span>values <span class="operator">=</span> cols_thr_signi<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="built_in">max</span><span class="punctuation">(</span>r.deg<span class="operator">$</span>unm<span class="punctuation">)</span> <span class="operator">+</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     breaks <span class="operator">=</span> seq<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="built_in">max</span><span class="punctuation">(</span>r.deg<span class="operator">$</span>unm<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     label <span class="operator">=</span> seq<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="built_in">max</span><span class="punctuation">(</span>r.deg<span class="operator">$</span>unm<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">#修改坐标轴显示刻度</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 根据top_label标注基因名</span></span><br><span class="line">  geom_text_repel<span class="punctuation">(</span>data <span class="operator">=</span> top_label<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span>unm<span class="punctuation">,</span> y <span class="operator">=</span> avg_log2FC<span class="punctuation">,</span> label <span class="operator">=</span> gene<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                  position <span class="operator">=</span> position_jitter<span class="punctuation">(</span>seed <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span> show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">2.5</span><span class="punctuation">,</span></span><br><span class="line">                  box.padding <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  </span><br><span class="line">  geom_rect<span class="punctuation">(</span>data <span class="operator">=</span> cluster_bar_position<span class="punctuation">,</span> aes<span class="punctuation">(</span>xmin <span class="operator">=</span> start<span class="punctuation">,</span> xmax <span class="operator">=</span> end<span class="punctuation">,</span> ymin <span class="operator">=</span> <span class="operator">-</span><span class="number">0.4</span><span class="punctuation">,</span></span><br><span class="line">                                             ymax <span class="operator">=</span> <span class="number">0.4</span><span class="punctuation">,</span> fill <span class="operator">=</span> unm<span class="punctuation">)</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span> alpha <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_manual<span class="punctuation">(</span>values <span class="operator">=</span> cols_cluster<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span>x <span class="operator">=</span> <span class="string">&quot;Cluster&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="string">&quot;average log2FC&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot1 <span class="operator">&lt;-</span>  p <span class="operator">+</span> theme<span class="punctuation">(</span>panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">##去除网格线</span></span><br><span class="line">                      panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      axis.text.y <span class="operator">=</span> element_text<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">14</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>colour <span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#89288F&quot;</span><span class="punctuation">,</span><span class="string">&quot;#89288F&quot;</span><span class="punctuation">,</span><span class="string">&quot;#F47D2B&quot;</span><span class="punctuation">,</span><span class="string">&quot;#F47D2B&quot;</span><span class="punctuation">,</span><span class="string">&quot;#FF00FF&quot;</span><span class="punctuation">,</span><span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;black&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">14</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">59.5</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#调整x轴坐标,vjust的值按照最终结果稍加调整</span></span><br><span class="line">                      panel.border <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">## 去掉坐标轴</span></span><br><span class="line">                      axis.ticks.x <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">## 去掉的坐标刻度线</span></span><br><span class="line">                      axis.line.y <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment">#添加y轴坐标轴</span></span><br><span class="line"></span><br><span class="line">plot1</span><br><span class="line"><span class="operator">?</span>element_text</span><br><span class="line">ggsave<span class="punctuation">(</span>filename <span class="operator">=</span> <span class="string">&quot;deg_pointplot.pdf&quot;</span><span class="punctuation">,</span> plot <span class="operator">=</span> plot1<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">9</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="通路富集分析"><a class="headerlink" href="#通路富集分析"></a>通路富集分析</h2>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240921164624949.png" alt="image-20240921164624949" loading="lazy"></p>
<p>GO 指的是 <strong>Gene Ontology（基因本体论）</strong>，是对基因在不同维度和不同层次上的描述。</p>
<p>GO 分为三个主要类别：</p>
<ol>
<li><strong>Biological Process（生物过程）</strong>
<ul>
<li>描述基因产物参与的生物学过程或路径，例如：细胞分裂、DNA 复制、凋亡（细胞死亡）等。</li>
</ul>
</li>
<li><strong>Molecular Function（分子功能）</strong>
<ul>
<li>描述基因产物的基本功能，通常指特定的分子活动，比如：催化活性、结合活性（如 ATP 结合）等。</li>
</ul>
</li>
<li><strong>Cellular Component（细胞成分）</strong>
<ul>
<li>描述基因产物所在的细胞部位或细胞结构，比如：线粒体、细胞核、膜等。</li>
</ul>
</li>
</ol>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 通路富集分析</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 1. 处理组和对照组进行差异富集分析</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2. 针对于相应的亚群的marker基因进行通路的富集分析</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 加载所需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>harmony<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>cowplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/scRNA_harmony.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## BiocManager::install(&quot;AUCell&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>AUCell<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## BiocManager::install(&quot;clusterProfiler&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对细胞进行抽样</span></span><br><span class="line">sc.id <span class="operator">=</span> sample<span class="punctuation">(</span>colnames<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1500</span><span class="punctuation">)</span></span><br><span class="line">sc2 <span class="operator">=</span> scRNA_harmony<span class="punctuation">[</span><span class="punctuation">,</span>sc.id<span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## install.packages(&quot;doParallel&quot;)</span></span><br><span class="line"><span class="comment">## install.packages(&quot;doRNG&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对表达矩阵进行提取</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>sc2<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>layers<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>sc2<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>layers<span class="operator">$</span>data<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果基因名称缺失，可以从 Seurat 对象中提取基因名并设置为行名</span></span><br><span class="line">rownames<span class="punctuation">(</span>sc2<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>layers<span class="operator">$</span>data<span class="punctuation">)</span> <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>sc2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果细胞名称缺失，可以从 Seurat 对象中提取细胞名称并设置为列名</span></span><br><span class="line">colnames<span class="punctuation">(</span>sc2<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>layers<span class="operator">$</span>data<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span>sc2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cells_rankings <span class="operator">&lt;-</span> AUCell_buildRankings<span class="punctuation">(</span>sc2<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>layers<span class="operator">$</span>data<span class="punctuation">,</span>  nCores<span class="operator">=</span><span class="number">6</span><span class="punctuation">,</span> plotStats<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">cells_rankings</span><br><span class="line"></span><br><span class="line"><span class="comment">## 读取KEGG基因集文件，是在GSEA网站下载</span></span><br><span class="line">c2 <span class="operator">&lt;-</span> read.gmt<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllData/c2.cp.kegg_medicus.v2024.1.Hs.symbols.gmt&quot;</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## lapply是列表的循环，是为了得到每个基因集的列表形式</span></span><br><span class="line">geneSets <span class="operator">&lt;-</span> lapply<span class="punctuation">(</span>unique<span class="punctuation">(</span>c2<span class="operator">$</span>term<span class="punctuation">)</span><span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span>print<span class="punctuation">(</span>x<span class="punctuation">)</span>;c2<span class="operator">$</span>gene<span class="punctuation">[</span>c2<span class="operator">$</span>term <span class="operator">==</span> x<span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>geneSets<span class="punctuation">)</span> <span class="operator">&lt;-</span> unique<span class="punctuation">(</span>c2<span class="operator">$</span>term<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"><span class="operator">?</span>AUCell_calcAUC</span><br><span class="line">cells_AUC <span class="operator">&lt;-</span>  AUCell_calcAUC<span class="punctuation">(</span>geneSets<span class="punctuation">,</span> cells_rankings<span class="punctuation">,</span>nCores <span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                               aucMaxRank<span class="operator">=</span>nrow<span class="punctuation">(</span>cells_rankings<span class="punctuation">)</span><span class="operator">*</span><span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grep<span class="punctuation">(</span><span class="string">&quot;OX&quot;</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>cells_AUC<span class="operator">@</span>assays<span class="operator">@</span>data<span class="operator">$</span>AUC<span class="punctuation">)</span><span class="punctuation">,</span>value <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">geneSet <span class="operator">&lt;-</span> <span class="string">&quot;KEGG_MEDICUS_REFERENCE_BETA_OXIDATION&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## 提取通路的数据</span></span><br><span class="line">aucs <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>getAUC<span class="punctuation">(</span>cells_AUC<span class="punctuation">)</span><span class="punctuation">[</span>geneSet<span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">sc2<span class="operator">$</span>AUC <span class="operator">&lt;-</span> aucs</span><br><span class="line">df <span class="operator">&lt;-</span>  data.frame<span class="punctuation">(</span>sc2<span class="operator">@</span>meta.data<span class="punctuation">,</span> sc2<span class="operator">@</span>reductions<span class="operator">$</span>umap<span class="operator">@</span>cell.embeddings<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>df<span class="punctuation">)</span></span><br><span class="line">class_avg <span class="operator">&lt;-</span> df <span class="operator">%&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>celltype<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  summarise<span class="punctuation">(</span></span><br><span class="line">    umap_1 <span class="operator">=</span> median<span class="punctuation">(</span>umap_1<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    umap_2 <span class="operator">=</span> median<span class="punctuation">(</span>umap_2<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>umap_1<span class="punctuation">,</span> umap_2<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>colour  <span class="operator">=</span> AUC<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> viridis<span class="operator">::</span>scale_color_viridis<span class="punctuation">(</span>option<span class="operator">=</span><span class="string">&quot;D&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggrepel<span class="operator">::</span>geom_label_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> celltype<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                            data <span class="operator">=</span> class_avg<span class="punctuation">,</span></span><br><span class="line">                            size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                            label.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                            segment.color <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line">  <span class="punctuation">)</span><span class="operator">+</span>   theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> theme_bw<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> facet_grid<span class="punctuation">(</span>.<span class="operator">~</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>df<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>viridis<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data.frame<span class="punctuation">(</span>sc2<span class="operator">@</span>meta.data<span class="punctuation">,</span>sc2<span class="operator">@</span>reductions<span class="operator">$</span>umap<span class="operator">@</span>cell.embeddings<span class="punctuation">)</span><span class="punctuation">,</span> aes<span class="punctuation">(</span>umap_1<span class="punctuation">,</span> umap_2<span class="punctuation">,</span> color<span class="operator">=</span>AUC<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span> size<span class="operator">=</span><span class="number">1.5</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">+</span> scale_color_viridis<span class="punctuation">(</span>option<span class="operator">=</span><span class="string">&quot;A&quot;</span><span class="punctuation">)</span>  <span class="operator">+</span> theme_light<span class="punctuation">(</span>base_size <span class="operator">=</span> <span class="number">26</span><span class="punctuation">)</span> <span class="operator">+</span> facet_grid<span class="punctuation">(</span>.<span class="operator">~</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 文章中的代码</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data.frame<span class="punctuation">(</span>cd8.seurat<span class="operator">@</span>meta.data<span class="punctuation">,</span> cd8.seurat<span class="operator">@</span>dr<span class="operator">$</span>umap<span class="operator">@</span>cell.embeddings<span class="punctuation">)</span><span class="punctuation">,</span> aes<span class="punctuation">(</span>UMAP1<span class="punctuation">,</span> UMAP2<span class="punctuation">,</span> color<span class="operator">=</span>AUC<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">+</span> geom_point<span class="punctuation">(</span> size<span class="operator">=</span><span class="number">1.5</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">+</span> scale_color_viridis<span class="punctuation">(</span>option<span class="operator">=</span><span class="string">&quot;A&quot;</span><span class="punctuation">)</span>  <span class="operator">+</span> theme_light<span class="punctuation">(</span>base_size <span class="operator">=</span> <span class="number">26</span><span class="punctuation">)</span> <span class="operator">+</span> facet_grid<span class="punctuation">(</span>.<span class="operator">~</span>Type<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 直接调用msigDB的数据库</span></span><br><span class="line"><span class="comment">## install.packages(&quot;msigdbr&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>msigdbr<span class="punctuation">)</span></span><br><span class="line">msigdbr_species<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">msigdbr_collections<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">m_df <span class="operator">&lt;-</span> msigdbr<span class="punctuation">(</span>species <span class="operator">=</span> <span class="string">&quot;Homo sapiens&quot;</span><span class="punctuation">,</span>  category <span class="operator">=</span> <span class="string">&quot;C2&quot;</span><span class="punctuation">,</span> subcategory <span class="operator">=</span> <span class="string">&quot;KEGG&quot;</span><span class="punctuation">)</span></span><br><span class="line">fgsea_sets <span class="operator">&lt;-</span>  m_df <span class="operator">%&gt;%</span> split<span class="punctuation">(</span>x <span class="operator">=</span> .<span class="operator">$</span>gene_symbol<span class="punctuation">,</span> f <span class="operator">=</span> .<span class="operator">$</span>gs_name<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="comment">###  gsva</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 通路的打分算法 GSVA</span></span><br><span class="line"><span class="comment">### 是基于基因集的分析方法，主要用于表征不同样本中基因表达的变化，而不是单个基因的表达水平</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&#x27;GSEABase&#x27;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>GSVA<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>msigdbr<span class="punctuation">)</span></span><br><span class="line">m_df <span class="operator">&lt;-</span> msigdbr<span class="punctuation">(</span>species <span class="operator">=</span><span class="string">&quot;Homo sapiens&quot;</span><span class="punctuation">,</span>  category <span class="operator">=</span> <span class="string">&quot;H&quot;</span> <span class="punctuation">)</span></span><br><span class="line">geneSets <span class="operator">&lt;-</span> m_df <span class="operator">%&gt;%</span> split<span class="punctuation">(</span>x <span class="operator">=</span> .<span class="operator">$</span>gene_symbol<span class="punctuation">,</span> f <span class="operator">=</span> .<span class="operator">$</span>gs_name<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line"><span class="comment">## 把各个类型的细胞取平均值</span></span><br><span class="line"><span class="operator">?</span>AverageExpression</span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span>AverageExpression<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span> </span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span>as.matrix<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>gsva</span><br><span class="line"><span class="operator">?</span>gsvaParam</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 gsvaParam 对象</span></span><br><span class="line">gsva_params <span class="operator">&lt;-</span> gsvaParam<span class="punctuation">(</span></span><br><span class="line">  exprData <span class="operator">=</span> as.matrix<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># 输入表达矩阵</span></span><br><span class="line">  geneSets <span class="operator">=</span> geneSets<span class="punctuation">,</span>         <span class="comment"># 基因集</span></span><br><span class="line">  minSize <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span>                 <span class="comment"># 最小基因集大小</span></span><br><span class="line">  maxSize <span class="operator">=</span> <span class="number">500</span><span class="punctuation">,</span>               <span class="comment"># 最大基因集大小</span></span><br><span class="line">  kcdf <span class="operator">=</span> <span class="string">&quot;Gaussian&quot;</span><span class="punctuation">,</span>           <span class="comment"># 使用高斯分布</span></span><br><span class="line">  tau <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>                     <span class="comment"># tau 参数</span></span><br><span class="line">  maxDiff <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>              <span class="comment"># 使用最大差异排名</span></span><br><span class="line">  absRanking <span class="operator">=</span> <span class="literal">FALSE</span>            <span class="comment"># 不使用绝对排名</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用 gsva 函数</span></span><br><span class="line">GSVA_hall <span class="operator">&lt;-</span> gsva<span class="punctuation">(</span></span><br><span class="line">  param <span class="operator">=</span> gsva_params<span class="punctuation">,</span></span><br><span class="line">  verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GSVA_hall &lt;- gsva(expr=as.matrix(exp), </span></span><br><span class="line"><span class="comment">#                      gset.idx.list=geneSets, </span></span><br><span class="line"><span class="comment">#                      mx.diff=T, # 数据为正态分布则T，双峰则F</span></span><br><span class="line"><span class="comment">#                      kcdf=&quot;Gaussian&quot;, #CPM, RPKM, TPM数据就用默认值&quot;Gaussian&quot;， read count数据则为&quot;Poisson&quot;，</span></span><br><span class="line"><span class="comment">#                      parallel.sz=4) # 并行线程数目</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>GSVA_hall<span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>pheatmap<span class="operator">::</span>pheatmap</span><br><span class="line">p <span class="operator">&lt;-</span> pheatmap<span class="operator">::</span>pheatmap<span class="punctuation">(</span>GSVA_hall<span class="punctuation">,</span> <span class="comment">#热图的数据</span></span><br><span class="line">                   <span class="comment"># GSVA_hall[1:20, ],</span></span><br><span class="line">                   cluster_rows <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span><span class="comment">#行聚类</span></span><br><span class="line">                   cluster_cols <span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span><span class="comment">#列聚类，可以看出样本之间的区分度</span></span><br><span class="line">                   </span><br><span class="line">                   show_colnames<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">                   scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span> <span class="comment">#以行来标准化，这个功能很不错</span></span><br><span class="line">                   color <span class="operator">=</span>colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;gsva_pheatmap.pdf&quot;</span><span class="punctuation">,</span> p<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span>height  <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 对不同的分组对象进行GSVA打分</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span>AverageExpression<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>add.ident <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span> </span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">counts2<span class="operator">=</span><span class="built_in">exp</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 gsvaParam 对象</span></span><br><span class="line">gsva_params <span class="operator">&lt;-</span> gsvaParam<span class="punctuation">(</span></span><br><span class="line">  exprData <span class="operator">=</span> as.matrix<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># 输入表达矩阵</span></span><br><span class="line">  geneSets <span class="operator">=</span> geneSets<span class="punctuation">,</span>         <span class="comment"># 基因集</span></span><br><span class="line">  minSize <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span>                 <span class="comment"># 最小基因集大小</span></span><br><span class="line">  maxSize <span class="operator">=</span> <span class="number">500</span><span class="punctuation">,</span>               <span class="comment"># 最大基因集大小</span></span><br><span class="line">  kcdf <span class="operator">=</span> <span class="string">&quot;Gaussian&quot;</span><span class="punctuation">,</span>           <span class="comment"># 使用高斯分布</span></span><br><span class="line">  tau <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>                     <span class="comment"># tau 参数</span></span><br><span class="line">  maxDiff <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>              <span class="comment"># 使用最大差异排名</span></span><br><span class="line">  absRanking <span class="operator">=</span> <span class="literal">FALSE</span>            <span class="comment"># 不使用绝对排名</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用 gsva 函数</span></span><br><span class="line">GSVA_hall <span class="operator">&lt;-</span> gsva<span class="punctuation">(</span></span><br><span class="line">  param <span class="operator">=</span> gsva_params<span class="punctuation">,</span></span><br><span class="line">  verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>GSVA_hall<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pheatmap<span class="operator">::</span>pheatmap<span class="punctuation">(</span>GSVA_hall<span class="punctuation">,</span> <span class="comment">#热图的数据</span></span><br><span class="line">                   cluster_rows <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span><span class="comment">#行聚类</span></span><br><span class="line">                   cluster_cols <span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span><span class="comment">#列聚类，可以看出样本之间的区分度</span></span><br><span class="line">                   </span><br><span class="line">                   show_colnames<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">                   scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span> <span class="comment">#以行来标准化，这个功能很不错</span></span><br><span class="line">                   color <span class="operator">=</span>colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#FF7744&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span><span class="string">&quot;#AAAAAA&quot;</span><span class="punctuation">,</span><span class="string">&quot;#0044BB&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################################################</span></span><br><span class="line"><span class="comment">#################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 绘制CNS上面的通路分析图示</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##install.packages(&quot;msigdbr&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##BiocManager::install(&quot;GSVA&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&#x27;GSEABase&#x27;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>GSVA<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>msigdbr<span class="punctuation">)</span></span><br><span class="line">m_df <span class="operator">&lt;-</span> msigdbr<span class="punctuation">(</span>species <span class="operator">=</span><span class="string">&quot;Homo sapiens&quot;</span><span class="punctuation">,</span>  category <span class="operator">=</span> <span class="string">&quot;H&quot;</span> <span class="punctuation">)</span></span><br><span class="line">geneSets <span class="operator">&lt;-</span> m_df <span class="operator">%&gt;%</span> split<span class="punctuation">(</span>x <span class="operator">=</span> .<span class="operator">$</span>gene_symbol<span class="punctuation">,</span> f <span class="operator">=</span> .<span class="operator">$</span>gs_name<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>celltype <span class="punctuation">,</span>scRNA_harmony<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line">sc.b <span class="operator">=</span> subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>ident<span class="operator">=</span><span class="string">&quot;Micro.&quot;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.b<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>sc.b<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义处理组和对照组的标识（这里定义了一个包含“处理组样本标识的向量”和一个包含“对照组样本标识的向量”。）  </span></span><br><span class="line">treatments <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Human_Organoid_AD&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_3D_AD&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Human_AD_01&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_02&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_03&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_04&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_05&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_06&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;Human_AD_07&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_08&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_09&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_10&quot;</span><span class="punctuation">)</span>  </span><br><span class="line">controls <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Human_Organoid_Normal&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_3D_Normal&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Human_Normal_01&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_02&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_03&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_04&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_05&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;Human_Normal_06&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_07&quot;</span><span class="punctuation">)</span>   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的标识列，将处理组合并为一个组，对照组合并为一个组  </span></span><br><span class="line">sc.b<span class="punctuation">[[</span><span class="string">&quot;treat_vs_control&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> </span><br><span class="line">  ifelse<span class="punctuation">(</span>sc.b<span class="operator">$</span>orig.ident <span class="operator">%in%</span> treatments<span class="punctuation">,</span> <span class="comment">#判断每个样本的原始标识（orig.ident）是否在处理组的标识中</span></span><br><span class="line">         <span class="string">&quot;Treated&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="string">&quot;Control&quot;</span><span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 将&quot;treat_vs_control&quot;设置为astrocyte_subset新的标识</span></span><br><span class="line">Idents<span class="punctuation">(</span>sc.b<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;treat_vs_control&quot;</span></span><br><span class="line"></span><br><span class="line">sc.b <span class="operator">=</span> subset<span class="punctuation">(</span>sc.b<span class="punctuation">,</span> ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Treated&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Control&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">sc.b <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>sc.b<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>sc.b<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span>GetAssayData<span class="punctuation">(</span>sc.b<span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;data&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span><span class="operator">=</span>as.matrix<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 gsvaParam 对象</span></span><br><span class="line">gsva_params <span class="operator">&lt;-</span> gsvaParam<span class="punctuation">(</span></span><br><span class="line">  exprData <span class="operator">=</span> as.matrix<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># 输入表达矩阵</span></span><br><span class="line">  geneSets <span class="operator">=</span> geneSets<span class="punctuation">,</span>         <span class="comment"># 基因集</span></span><br><span class="line">  minSize <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span>                 <span class="comment"># 最小基因集大小</span></span><br><span class="line">  maxSize <span class="operator">=</span> <span class="number">500</span><span class="punctuation">,</span>               <span class="comment"># 最大基因集大小</span></span><br><span class="line">  kcdf <span class="operator">=</span> <span class="string">&quot;Gaussian&quot;</span><span class="punctuation">,</span>           <span class="comment"># 使用高斯分布</span></span><br><span class="line">  tau <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>                     <span class="comment"># tau 参数</span></span><br><span class="line">  maxDiff <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>              <span class="comment"># 使用最大差异排名</span></span><br><span class="line">  absRanking <span class="operator">=</span> <span class="literal">FALSE</span>            <span class="comment"># 不使用绝对排名</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用 gsva 函数</span></span><br><span class="line">GSVA_hall <span class="operator">&lt;-</span> gsva<span class="punctuation">(</span></span><br><span class="line">  param <span class="operator">=</span> gsva_params<span class="punctuation">,</span></span><br><span class="line">  verbose <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>GSVA_hall<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## limma差异通路分析</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BiocManager::install(&#x27;limma&#x27;)</span></span><br><span class="line">library<span class="punctuation">(</span>limma<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 设置或导入分组</span></span><br><span class="line"></span><br><span class="line">group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>sc.b<span class="operator">@</span>meta.data<span class="operator">$</span>orig.ident<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span> <span class="string">&#x27;sample2&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;sample21&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">design <span class="operator">&lt;-</span> model.matrix<span class="punctuation">(</span><span class="operator">~</span><span class="number">0</span><span class="operator">+</span>group<span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>design<span class="punctuation">)</span> <span class="operator">=</span> levels<span class="punctuation">(</span>factor<span class="punctuation">(</span>group<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>design<span class="punctuation">)</span> <span class="operator">=</span> colnames<span class="punctuation">(</span>GSVA_hall<span class="punctuation">)</span></span><br><span class="line">design</span><br><span class="line"><span class="comment"># Tunor VS Normal</span></span><br><span class="line">compare <span class="operator">&lt;-</span> makeContrasts<span class="punctuation">(</span>sample2 <span class="operator">-</span> sample21<span class="punctuation">,</span> levels<span class="operator">=</span>design<span class="punctuation">)</span></span><br><span class="line">fit <span class="operator">&lt;-</span> lmFit<span class="punctuation">(</span>GSVA_hall<span class="punctuation">,</span> design<span class="punctuation">)</span></span><br><span class="line">fit2 <span class="operator">&lt;-</span> contrasts.fit<span class="punctuation">(</span>fit<span class="punctuation">,</span> compare<span class="punctuation">)</span></span><br><span class="line">fit3 <span class="operator">&lt;-</span> eBayes<span class="punctuation">(</span>fit2<span class="punctuation">)</span></span><br><span class="line">Diff <span class="operator">&lt;-</span> topTable<span class="punctuation">(</span>fit3<span class="punctuation">,</span> coef<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span> number<span class="operator">=</span><span class="number">200</span><span class="punctuation">)</span></span><br><span class="line">head<span class="punctuation">(</span>Diff<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 发散条形图绘制</span></span><br><span class="line"><span class="comment">## barplot</span></span><br><span class="line">dat_plot <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>id <span class="operator">=</span> row.names<span class="punctuation">(</span>Diff<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          t <span class="operator">=</span> Diff<span class="operator">$</span>t<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 去掉&quot;HALLMARK_&quot;</span></span><br><span class="line">library<span class="punctuation">(</span>stringr<span class="punctuation">)</span></span><br><span class="line">dat_plot<span class="operator">$</span>id <span class="operator">&lt;-</span> str_replace<span class="punctuation">(</span>dat_plot<span class="operator">$</span>id <span class="punctuation">,</span> <span class="string">&quot;HALLMARK_&quot;</span><span class="punctuation">,</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 新增一列 根据t阈值分类</span></span><br><span class="line">dat_plot<span class="operator">$</span>threshold <span class="operator">=</span> factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>dat_plot<span class="operator">$</span>t  <span class="operator">&gt;</span> <span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>dat_plot<span class="operator">$</span>t <span class="operator">&gt;=</span> <span class="number">1</span> <span class="punctuation">,</span><span class="string">&#x27;Up&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;NoSignifi&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;Down&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span>levels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Up&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Down&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;NoSignifi&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 排序</span></span><br><span class="line">dat_plot <span class="operator">&lt;-</span>  dat_plot <span class="operator">%&amp;&gt;%</span> arrange<span class="punctuation">(</span>t<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 变成因子类型</span></span><br><span class="line">dat_plot<span class="operator">$</span>id <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>dat_plot<span class="operator">$</span>id<span class="punctuation">,</span>levels <span class="operator">=</span> dat_plot<span class="operator">$</span>id<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 绘制</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##install.packages(&quot;ggthemes&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>ggthemes<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># install.packages(&quot;ggprism&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>ggprism<span class="punctuation">)</span></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data <span class="operator">=</span> dat_plot<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> id<span class="punctuation">,</span>y <span class="operator">=</span> t<span class="punctuation">,</span>fill <span class="operator">=</span> threshold<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Up&#x27;</span><span class="operator">=</span> <span class="string">&#x27;#36638a&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;NoSignifi&#x27;</span><span class="operator">=</span><span class="string">&#x27;#cccccc&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Down&#x27;</span><span class="operator">=</span><span class="string">&#x27;#7bcd7b&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_hline<span class="punctuation">(</span>yintercept <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span>color <span class="operator">=</span> <span class="string">&#x27;white&#x27;</span><span class="punctuation">,</span>size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>lty<span class="operator">=</span><span class="string">&#x27;dashed&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&#x27;&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&#x27;t value of GSVA score, S2 VS S1&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">#注意坐标轴旋转了</span></span><br><span class="line">  guides<span class="punctuation">(</span>fill<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span><span class="operator">+</span> <span class="comment"># 不显示图例</span></span><br><span class="line">  theme_prism<span class="punctuation">(</span>border <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span></span><br><span class="line">    axis.text.y <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    axis.ticks.y <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">p</span><br><span class="line"><span class="comment"># 添加标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 小于-1的数量</span></span><br><span class="line">low1 <span class="operator">&lt;-</span> dat_plot <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>t <span class="operator">&lt;</span> <span class="operator">-</span><span class="number">21</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> nrow<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 小于0总数量</span></span><br><span class="line">low0 <span class="operator">&lt;-</span> dat_plot <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span> t <span class="operator">&lt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> nrow<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 小于1总数量</span></span><br><span class="line">high0 <span class="operator">&lt;-</span> dat_plot <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>t <span class="operator">&lt;</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> nrow<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 总的柱子数量</span></span><br><span class="line">high1 <span class="operator">&lt;-</span> nrow<span class="punctuation">(</span>dat_plot<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 依次从下到上添加标签</span></span><br><span class="line">p <span class="operator">&lt;-</span> p <span class="operator">+</span> geom_text<span class="punctuation">(</span>data <span class="operator">=</span> dat_plot<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span>low1<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> id<span class="punctuation">,</span>y <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span>label <span class="operator">=</span> id<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      hjust <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>color <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment"># 小于-1的为黑色标签</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>data <span class="operator">=</span> dat_plot<span class="punctuation">[</span><span class="punctuation">(</span>low1 <span class="operator">+</span><span class="number">1</span><span class="punctuation">)</span><span class="operator">:</span>low0<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> id<span class="punctuation">,</span>y <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span>label <span class="operator">=</span> id<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            hjust <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>color <span class="operator">=</span> <span class="string">&#x27;grey&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment"># 灰色标签</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>data <span class="operator">=</span> dat_plot<span class="punctuation">[</span><span class="punctuation">(</span>low0 <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span><span class="operator">:</span>high0<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> id<span class="punctuation">,</span>y <span class="operator">=</span> <span class="operator">-</span><span class="number">0.1</span><span class="punctuation">,</span>label <span class="operator">=</span> id<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>color <span class="operator">=</span> <span class="string">&#x27;grey&#x27;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment"># 灰色标签</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>data <span class="operator">=</span> dat_plot<span class="punctuation">[</span><span class="punctuation">(</span>high0 <span class="operator">+</span><span class="number">1</span><span class="punctuation">)</span><span class="operator">:</span>high1<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> id<span class="punctuation">,</span>y <span class="operator">=</span> <span class="operator">-</span><span class="number">0.1</span><span class="punctuation">,</span>label <span class="operator">=</span> id<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>color <span class="operator">=</span> <span class="string">&#x27;black&#x27;</span><span class="punctuation">)</span> <span class="comment"># 大于1的为黑色标签</span></span><br><span class="line"></span><br><span class="line">p</span><br><span class="line"></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;gsva_bar.pdf&quot;</span><span class="punctuation">,</span>p<span class="punctuation">,</span>width <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span>height  <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## GO富集分析</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 找差异基因</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 定义处理组和对照组的标识（这里定义了一个包含“处理组样本标识的向量”和一个包含“对照组样本标识的向量”。）  </span></span><br><span class="line">treatments <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Human_Organoid_AD&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_3D_AD&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Human_AD_01&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_02&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_03&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_04&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_05&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_06&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;Human_AD_07&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_08&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_09&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_AD_10&quot;</span><span class="punctuation">)</span>  </span><br><span class="line">controls <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Human_Organoid_Normal&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_3D_Normal&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Human_Normal_01&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_02&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_03&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_04&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_05&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;Human_Normal_06&quot;</span><span class="punctuation">,</span><span class="string">&quot;Human_Normal_07&quot;</span><span class="punctuation">)</span>   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建一个新的标识列，将处理组合并为一个组，对照组合并为一个组  </span></span><br><span class="line">scRNA_harmony<span class="punctuation">[[</span><span class="string">&quot;treat_vs_control&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> </span><br><span class="line">  ifelse<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>orig.ident <span class="operator">%in%</span> treatments<span class="punctuation">,</span> <span class="comment">#判断每个样本的原始标识（orig.ident）是否在处理组的标识中</span></span><br><span class="line">         <span class="string">&quot;Treated&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="string">&quot;Control&quot;</span><span class="punctuation">)</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 将&quot;treat_vs_control&quot;设置为astrocyte_subset新的标识</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;treat_vs_control&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 只保留（提取）标识为&quot;Treated&quot;或&quot;Control&quot;的样本</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> idents <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Treated&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Control&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 通过JoinLayers函数合并不同层的数据</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 使用新的标识列&quot;treat_vs_control&quot;进行差异表达分析  </span></span><br><span class="line">degdf <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> ident.1 <span class="operator">=</span> <span class="string">&quot;Treated&quot;</span><span class="punctuation">,</span>   </span><br><span class="line">                                    ident.2 <span class="operator">=</span> <span class="string">&quot;Control&quot;</span><span class="punctuation">,</span>   </span><br><span class="line">                                    min.pct <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span>   </span><br><span class="line">                                    logfc.threshold <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">)</span>  </span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">$</span>celltype<span class="punctuation">,</span> scRNA_harmony<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># table(scRNA_harmony$orig.ident)</span></span><br><span class="line"><span class="comment"># table(scRNA_harmony$celltype,scRNA_harmony$orig.ident)</span></span><br><span class="line"><span class="comment"># degdf &lt;-  FindMarkers(scRNA_harmony,ident.1 = &quot;sample2&quot;,ident.2 = &quot;sample21&quot;, </span></span><br><span class="line"><span class="comment">#                         logfc.threshold = 0.5,group.by = &quot;orig.ident&quot;,</span></span><br><span class="line"><span class="comment">#                         ident=1,subset.ident = &quot;Chondrocytes&quot;,min.pct = 0.4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 筛选p值不显著的基因</span></span><br><span class="line">degdf1 <span class="operator">=</span> filter<span class="punctuation">(</span>degdf<span class="punctuation">,</span> p_val_adj <span class="operator">&lt;</span> <span class="number">0.01</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## options(download.file.method = &quot;curl&quot;) 查看当前下载进度条</span></span><br><span class="line"><span class="comment">##BiocManager::install(&quot;org.Hs.eg.db&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## GO富集分析</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">degs.list <span class="operator">=</span> rownames<span class="punctuation">(</span>degdf<span class="punctuation">)</span></span><br><span class="line">erich.go.BP <span class="operator">=</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span>degs.list<span class="punctuation">,</span></span><br><span class="line">                       OrgDb <span class="operator">=</span> org.Hs.eg.db<span class="punctuation">,</span></span><br><span class="line">                       keyType <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       ont <span class="operator">=</span> <span class="string">&quot;BP&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       pvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                       qvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 气泡图</span></span><br><span class="line">p1 <span class="operator">&lt;-</span> dotplot<span class="punctuation">(</span>erich.go.BP<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">10</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;erich_go_BP.pdf&quot;</span><span class="punctuation">,</span> p1<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> height  <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>dotplot</span><br><span class="line"></span><br><span class="line"><span class="comment">## barplot</span></span><br><span class="line">p2 <span class="operator">&lt;-</span> barplot<span class="punctuation">(</span>erich.go.BP<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;erich_go_BP_barplot.pdf&quot;</span><span class="punctuation">,</span> p2<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> height  <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">erich.go.BP<span class="operator">=</span>erich.go.BP<span class="operator">@</span>result</span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllDataResult/&quot;</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>erich.go.BP<span class="punctuation">,</span><span class="string">&quot;erich.go.BP.deg.con.hf.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################</span></span><br><span class="line">library<span class="punctuation">(</span>msigdbr<span class="punctuation">)</span></span><br><span class="line">msigdbr_species<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">msigdbr_collections<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##pathway=read.gmt(&quot;c2.cp.kegg.v7.5.1.symbols.gmt&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>msigdbr<span class="punctuation">)</span></span><br><span class="line">m_df.h <span class="operator">&lt;-</span> msigdbr<span class="punctuation">(</span>species <span class="operator">=</span><span class="string">&quot;Homo sapiens&quot;</span><span class="punctuation">,</span>  category <span class="operator">=</span> <span class="string">&quot;H&quot;</span> <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 提取m_df.h 的第三列和第四列的数据</span></span><br><span class="line">m_df.h <span class="operator">=</span> m_df.h<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">]</span> </span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>enricher</span><br><span class="line">res <span class="operator">=</span> enricher<span class="punctuation">(</span>degs.list<span class="punctuation">,</span> TERM2GENE <span class="operator">=</span>m_df.h <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dotplot<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### kegg</span></span><br><span class="line">m_df.kegg <span class="operator">&lt;-</span> msigdbr<span class="punctuation">(</span>species <span class="operator">=</span><span class="string">&quot;Homo sapiens&quot;</span><span class="punctuation">,</span>  category <span class="operator">=</span> <span class="string">&quot;C2&quot;</span><span class="punctuation">,</span> subcategory <span class="operator">=</span> <span class="string">&quot;KEGG&quot;</span> <span class="punctuation">)</span></span><br><span class="line">m_df.kegg <span class="operator">=</span> m_df.kegg<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span><span class="punctuation">]</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## enricher 既可以计算GO，也可以计算KEGG，也可以计算HALLMARK</span></span><br><span class="line">res.kegg <span class="operator">=</span> enricher<span class="punctuation">(</span> degs.list<span class="punctuation">,</span>TERM2GENE <span class="operator">=</span>m_df.kegg <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dotplot<span class="punctuation">(</span> res.kegg<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 富集分析结果用合旋图展示</span></span><br><span class="line"></span><br><span class="line">colnames<span class="punctuation">(</span>erich.go.BP<span class="punctuation">)</span></span><br><span class="line"><span class="comment">### install.packages(&quot;GOplot&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>GOplot<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## &gt; colnames(erich.go.BP)</span></span><br><span class="line"><span class="comment">## [1] &quot;ID&quot;             &quot;Description&quot;    &quot;GeneRatio&quot;      &quot;BgRatio&quot;        &quot;RichFactor&quot;    </span></span><br><span class="line"><span class="comment">## [6] &quot;FoldEnrichment&quot; &quot;zScore&quot;         &quot;pvalue&quot;         &quot;p.adjust&quot;       &quot;qvalue&quot;        </span></span><br><span class="line"><span class="comment">## [11] &quot;geneID&quot;         &quot;Count&quot;       </span></span><br><span class="line">go1 <span class="operator">=</span> erich.go.BP<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">11</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">rownames<span class="punctuation">(</span>go1<span class="punctuation">)</span><span class="operator">=</span>go1<span class="operator">$</span>ID</span><br><span class="line">go <span class="operator">=</span> go1</span><br><span class="line"><span class="comment">###install.packages(&quot;stringr&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>stringr<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## 把 / 替换为 ,</span></span><br><span class="line">go<span class="operator">$</span>geneID<span class="operator">=</span>str_replace_all<span class="punctuation">(</span>go<span class="operator">$</span>geneID<span class="punctuation">,</span><span class="string">&quot;/&quot;</span><span class="punctuation">,</span><span class="string">&quot;,&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>go<span class="punctuation">)</span><span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;ID&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Term&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Genes&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;adj_pval&#x27;</span><span class="punctuation">)</span></span><br><span class="line">go<span class="operator">$</span>Category<span class="operator">=</span><span class="string">&quot;BP&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x1<span class="operator">=</span>strsplit<span class="punctuation">(</span>go<span class="operator">$</span>Genes<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span>split<span class="operator">=</span><span class="string">&quot;,&quot;</span><span class="punctuation">,</span>fixed<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">x2<span class="operator">=</span>strsplit<span class="punctuation">(</span>go<span class="operator">$</span>Genes<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span>split<span class="operator">=</span><span class="string">&quot;,&quot;</span><span class="punctuation">,</span>fixed<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">x3<span class="operator">=</span>strsplit<span class="punctuation">(</span>go<span class="operator">$</span>Genes<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">,</span>split<span class="operator">=</span><span class="string">&quot;,&quot;</span><span class="punctuation">,</span>fixed<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">g1<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span>x1<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span>x2<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span>x3<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">genedata1<span class="operator">=</span>degdf<span class="punctuation">[</span>g1<span class="punctuation">,</span><span class="punctuation">]</span>   </span><br><span class="line">genedata1<span class="operator">$</span>ID<span class="operator">=</span>rownames<span class="punctuation">(</span>genedata1<span class="punctuation">)</span></span><br><span class="line">genedata2<span class="operator">=</span>data.frame<span class="punctuation">(</span>ID<span class="operator">=</span>genedata1<span class="operator">$</span>ID<span class="punctuation">,</span>logFC<span class="operator">=</span>genedata1<span class="operator">$</span>avg_log2FC<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#genedata=data.frame(ID=degs.list,logFC=degdf[degs.list,]$avg_log2FC)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">circ <span class="operator">&lt;-</span> circle_dat<span class="punctuation">(</span>go<span class="punctuation">,</span>genedata2<span class="punctuation">)</span></span><br><span class="line"><span class="comment">##条形图</span></span><br><span class="line">GOBar<span class="punctuation">(</span>subset<span class="punctuation">(</span>circ<span class="punctuation">,</span> category <span class="operator">==</span> <span class="string">&#x27;BP&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#气泡图</span></span><br><span class="line">GOBubble<span class="punctuation">(</span>circ<span class="punctuation">,</span> labels <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">GOCircle<span class="punctuation">(</span>circ<span class="punctuation">,</span> nsub <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chord <span class="operator">&lt;-</span> chord_dat<span class="punctuation">(</span>circ<span class="punctuation">,</span> genedata2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">chord</span><br><span class="line"></span><br><span class="line">GOChord<span class="punctuation">(</span>chord<span class="punctuation">,</span> gene.order <span class="operator">=</span> <span class="string">&#x27;logFC&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##基因与GO Term的热图(GOHeat)</span></span><br><span class="line">GOHeat<span class="punctuation">(</span>chord<span class="punctuation">,</span> nlfc <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> fill.col <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;red&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;yellow&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;green&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################3</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"><span class="comment">############################################################################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>org.Mm.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">degs.list<span class="operator">=</span>rownames<span class="punctuation">(</span>degdf<span class="punctuation">)</span></span><br><span class="line">erich.go.BP <span class="operator">=</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span>degs.list<span class="punctuation">,</span></span><br><span class="line">                       OrgDb <span class="operator">=</span> org.Mm.eg.db<span class="punctuation">,</span></span><br><span class="line">                       keyType <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       ont <span class="operator">=</span> <span class="string">&quot;BP&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       pvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                       qvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">)</span></span><br><span class="line">dotplot<span class="punctuation">(</span>erich.go.BP<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">10</span> <span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>dotplot</span><br><span class="line">barplot<span class="punctuation">(</span>erich.go.BP<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line">erich.go.BP<span class="operator">=</span>erich.go.BP<span class="operator">@</span>result</span><br><span class="line">write.table<span class="punctuation">(</span>erich.go.BP<span class="punctuation">,</span><span class="string">&quot;4.7.erich.go.BP.deg.con.hf.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kegg<span class="operator">=</span>read.table<span class="punctuation">(</span><span class="string">&quot;4.7.go.txt&quot;</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">)</span></span><br><span class="line">View<span class="punctuation">(</span>kegg<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">k <span class="operator">=</span> data.frame<span class="punctuation">(</span>kegg<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">before <span class="operator">&amp;</span>lt;<span class="operator">-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>sub<span class="punctuation">(</span><span class="string">&quot;/\\d+$&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> k<span class="operator">$</span>GeneRatio<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">after <span class="operator">&amp;</span>lt;<span class="operator">-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>sub<span class="punctuation">(</span><span class="string">&quot;^\\d+/&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> k<span class="operator">$</span>GeneRatio<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">k<span class="operator">$</span>GeneRatio <span class="operator">=</span> before <span class="operator">/</span>after</span><br><span class="line">font.size <span class="operator">=</span><span class="number">10</span></span><br><span class="line"></span><br><span class="line">k <span class="operator">%&amp;gt;%</span> </span><br><span class="line">  <span class="comment">## 对进行p值排序</span></span><br><span class="line">  arrange<span class="punctuation">(</span>p.adjust<span class="punctuation">)</span> <span class="operator">%&amp;gt;%</span> </span><br><span class="line">  <span class="comment">##指定富集的通路数目</span></span><br><span class="line">  dplyr<span class="operator">::</span>slice<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">14</span><span class="punctuation">)</span> <span class="operator">%&amp;gt;%</span> </span><br><span class="line">  <span class="comment">## 开始ggplot2 作图，其中fct_reorder调整因子level的顺序</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>GeneRatio<span class="punctuation">,</span>forcats<span class="operator">::</span>fct_reorder<span class="punctuation">(</span>Description<span class="punctuation">,</span>Count<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  <span class="comment">## 画出点图</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>color<span class="operator">=</span>p.adjust<span class="punctuation">,</span> size <span class="operator">=</span> Count<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  <span class="comment">## 调整颜色，guide_colorbar调整色图的方向</span></span><br><span class="line">  scale_color_continuous<span class="punctuation">(</span>low<span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span> high<span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> guide<span class="operator">=</span>guide_colorbar<span class="punctuation">(</span>reverse<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  <span class="comment">## 调整泡泡的大小</span></span><br><span class="line">  scale_size_continuous<span class="punctuation">(</span><span class="built_in">range</span><span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">8</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  <span class="comment">## 如果用ylab(&quot;&quot;)或出现左侧空白</span></span><br><span class="line">  labs<span class="punctuation">(</span>y<span class="operator">=</span><span class="literal">NULL</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  <span class="comment">## 如果没有这一句，上方会到顶</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  <span class="comment">## 设定主题</span></span><br><span class="line">  theme_bw<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                   size <span class="operator">=</span> font.size<span class="punctuation">,</span> vjust <span class="operator">=</span><span class="number">1</span> <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.y <span class="operator">=</span> element_text<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                   size <span class="operator">=</span> font.size<span class="punctuation">,</span> hjust <span class="operator">=</span><span class="number">1</span> <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title <span class="operator">=</span> element_text<span class="punctuation">(</span>margin<span class="operator">=</span>margin<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                  color <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span>size <span class="operator">=</span> font.size<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.y <span class="operator">=</span> element_text<span class="punctuation">(</span>angle<span class="operator">=</span><span class="number">90</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">erich.go.CC <span class="operator">=</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span>degs.list<span class="punctuation">,</span></span><br><span class="line">                       OrgDb <span class="operator">=</span> org.Mm.eg.db<span class="punctuation">,</span></span><br><span class="line">                       keyType <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       ont <span class="operator">=</span> <span class="string">&quot;CC&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       pvalueCutoff <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                       qvalueCutoff <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line">dotplot<span class="punctuation">(</span>erich.go.CC<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>dotplot</span><br><span class="line">barplot<span class="punctuation">(</span>erich.go.CC<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">erich.go.MF <span class="operator">=</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span>degs.list<span class="punctuation">,</span></span><br><span class="line">                       OrgDb <span class="operator">=</span> org.Mm.eg.db<span class="punctuation">,</span></span><br><span class="line">                       keyType <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       ont <span class="operator">=</span> <span class="string">&quot;MF&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       pvalueCutoff <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                       qvalueCutoff <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line">dotplot<span class="punctuation">(</span>erich.go.MF<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">?</span>dotplot</span><br><span class="line">barplot<span class="punctuation">(</span>erich.go.MF<span class="punctuation">,</span>showCategory <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">keytypes<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DEG.entrez_id <span class="operator">=</span> mapIds<span class="punctuation">(</span>x <span class="operator">=</span> org.Mm.eg.db<span class="punctuation">,</span></span><br><span class="line">                       keys <span class="operator">=</span>  degs.list<span class="punctuation">,</span></span><br><span class="line">                       keytype <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                       column <span class="operator">=</span> <span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## install.packages(&quot;R.utils&quot;)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>R.utils<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">R.utils<span class="operator">::</span>setOption<span class="punctuation">(</span><span class="string">&quot;clusterProfiler.download.method&quot;</span><span class="punctuation">,</span><span class="string">&quot;auto&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">erich.kegg.res <span class="operator">&amp;</span>lt;<span class="operator">-</span> enrichKEGG<span class="punctuation">(</span>gene <span class="operator">=</span> DEG.entrez_id<span class="punctuation">,</span></span><br><span class="line">                                organism <span class="operator">=</span> <span class="string">&quot;mmu&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                keyType <span class="operator">=</span> <span class="string">&quot;kegg&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dotplot<span class="punctuation">(</span>erich.kegg.res<span class="punctuation">)</span></span><br><span class="line">kegg.res.df<span class="operator">=</span>erich.kegg.res<span class="operator">@</span>result</span><br><span class="line">write.table<span class="punctuation">(</span>kegg.res.df<span class="punctuation">,</span><span class="string">&quot;erich.kegg.res.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="拟时间分析"><a class="headerlink" href="#拟时间分析"></a>拟时间分析</h2>
<hr>
<p><strong>伪时间分析</strong>：Monocle 能够推断出细胞的发育轨迹，也就是在没有时间点信息的前提下，基于基因表达变化预测细胞随时间的状态演变。这种分析可以帮助理解细胞在发育或分化过程中的变化路径。可以查看 <strong>处理组与对照组之间的动态变化轨迹（即：control组到处理组的变化）</strong>，也可以查看 <strong>细胞的发育过程（即：Naive B细胞到 Memory B细胞的变化）</strong>，也就是 <strong>细胞从一种状态到另外一种状态变化的时候，细胞经历了什么过程</strong></p>
<h3 id="Monocle2"><a class="headerlink" href="#Monocle2"></a>Monocle2</h3>
<hr>
<p>Monocle2 是利用机器学习技术（反向图嵌入）从单细胞数据中学习显式的主图来对细胞进行排序（例如从Naive B到 memory B的排序），主要还是用Monocle2进行轨迹的构建</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## Monocle2代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/scRNA_harmony.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>seurat_clusters<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 单独提取 xx 细胞进行轨迹的分析</span></span><br><span class="line"><span class="comment">## 以Micro.为例</span></span><br><span class="line">sc.t <span class="operator">=</span> scRNA_harmony<span class="punctuation">[</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>subset<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="punctuation">,</span>celltype <span class="operator">==</span> <span class="string">&quot;Micro.&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span>  </span><br><span class="line"></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;https://mirrors.westlake.edu.cn/bioconductor&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BiocManager::install(&quot;monocle&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>monocle<span class="punctuation">)</span></span><br><span class="line">Idents<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span><span class="operator">=</span><span class="string">&quot;celltype&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 这里的拟时序分析可以做对照组到处理组的，也可以做两个细胞之间的变化</span></span><br><span class="line">scRNA.Micro <span class="operator">=</span> subset<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Micro.&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA.Micro<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义处理组和对照组的标识（这里定义了一个包含“处理组样本标识的向量”和一个包含“对照组样本标识的向量”。）  </span></span><br><span class="line"><span class="comment"># treatments &lt;- c(&quot;Human_Organoid_AD&quot;,&quot;Human_3D_AD&quot;, &quot;Human_AD_01&quot;,&quot;Human_AD_02&quot;,&quot;Human_AD_03&quot;,&quot;Human_AD_04&quot;,&quot;Human_AD_05&quot;,&quot;Human_AD_06&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;Human_AD_07&quot;,&quot;Human_AD_08&quot;,&quot;Human_AD_09&quot;,&quot;Human_AD_10&quot;)  </span></span><br><span class="line"><span class="comment"># controls &lt;- c(&quot;Human_Organoid_Normal&quot;,&quot;Human_3D_Normal&quot;, &quot;Human_Normal_01&quot;,&quot;Human_Normal_02&quot;,&quot;Human_Normal_03&quot;,&quot;Human_Normal_04&quot;,&quot;Human_Normal_05&quot;,</span></span><br><span class="line"><span class="comment">#               &quot;Human_Normal_06&quot;,&quot;Human_Normal_07&quot;)   </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># # 创建一个新的标识列，将处理组合并为一个组，对照组合并为一个组  </span></span><br><span class="line"><span class="comment"># scRNA.Micro[[&quot;treat_vs_control&quot;]] &lt;- </span></span><br><span class="line"><span class="comment">#   ifelse(scRNA.Micro$orig.ident %in% treatments, #判断每个样本的原始标识（orig.ident）是否在处理组的标识中</span></span><br><span class="line"><span class="comment">#          &quot;Treated&quot;,</span></span><br><span class="line"><span class="comment">#          &quot;Control&quot;)  </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># # 设为新的标识</span></span><br><span class="line"><span class="comment"># Idents(scRNA.Micro) &lt;- &quot;treat_vs_control&quot;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># ##</span></span><br><span class="line"><span class="comment"># ## Idents(scRNA.Micro)=&quot;orig.ident&quot;</span></span><br><span class="line"><span class="comment"># sc.Micro = subset(scRNA.Micro, ident=c(&quot;Treated&quot;, &quot;Control&quot;))</span></span><br><span class="line"><span class="comment"># table(sc.Micro$orig.ident)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######</span></span><br><span class="line"><span class="comment">## past0是连接符</span></span><br><span class="line"><span class="comment">## 提取对应的细胞的流程</span></span><br><span class="line"><span class="comment"># scRNA_harmony$huage=paste0(scRNA_harmony$orig.ident,&quot;_&quot;,scRNA_harmony$celltype)</span></span><br><span class="line"><span class="comment"># table(scRNA_harmony$huage)</span></span><br><span class="line"><span class="comment"># Idents(scRNA_harmony)=&quot;huage&quot;</span></span><br><span class="line"><span class="comment"># sc.123=subset(scRNA.Osteoclastic,ident=&quot;sample2_Chondrocytes&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看可用的层次</span></span><br><span class="line">scRNA.Micro<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>layers</span><br><span class="line"></span><br><span class="line">data <span class="operator">&lt;-</span> GetAssayData<span class="punctuation">(</span>scRNA.Micro<span class="punctuation">,</span>slot <span class="operator">=</span> <span class="string">&quot;count&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>new</span><br><span class="line"><span class="comment">## new就是转换成S4对象</span></span><br><span class="line">pd <span class="operator">&lt;-</span> new<span class="punctuation">(</span><span class="string">&#x27;AnnotatedDataFrame&#x27;</span><span class="punctuation">,</span> data <span class="operator">=</span> scRNA.Micro<span class="operator">@</span>meta.data<span class="punctuation">)</span></span><br><span class="line">fData <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>gene_short_name <span class="operator">=</span> row.names<span class="punctuation">(</span>data<span class="punctuation">)</span><span class="punctuation">,</span> row.names <span class="operator">=</span> row.names<span class="punctuation">(</span>data<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">fd <span class="operator">&lt;-</span> new<span class="punctuation">(</span><span class="string">&#x27;AnnotatedDataFrame&#x27;</span><span class="punctuation">,</span> data <span class="operator">=</span> fData<span class="punctuation">)</span></span><br><span class="line">monocle_cds <span class="operator">&lt;-</span> newCellDataSet<span class="punctuation">(</span>data<span class="punctuation">,</span></span><br><span class="line">                                 phenoData <span class="operator">=</span> pd<span class="punctuation">,</span></span><br><span class="line">                                 featureData <span class="operator">=</span> fd<span class="punctuation">,</span></span><br><span class="line">                                 lowerDetectionLimit <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                                 expressionFamily <span class="operator">=</span> negbinomial.size<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">monocle_cds <span class="operator">&lt;-</span> estimateSizeFactors<span class="punctuation">(</span>monocle_cds<span class="punctuation">)</span></span><br><span class="line">monocle_cds <span class="operator">&lt;-</span> estimateDispersions<span class="punctuation">(</span>monocle_cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">monocle_cds <span class="operator">&lt;-</span> detectGenes<span class="punctuation">(</span>monocle_cds<span class="punctuation">,</span> min_expr <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>head<span class="punctuation">(</span>fData<span class="punctuation">(</span>monocle_cds<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">HSMM <span class="operator">=</span> monocle_cds</span><br><span class="line"><span class="comment">## Monocle2高变基因的筛选</span></span><br><span class="line">disp_table <span class="operator">&lt;-</span> dispersionTable<span class="punctuation">(</span>HSMM<span class="punctuation">)</span></span><br><span class="line">disp.genes <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>disp_table<span class="punctuation">,</span> mean_expression <span class="operator">&gt;=</span> <span class="number">0.1</span> <span class="operator">&amp;</span> dispersion_empirical <span class="operator">&gt;=</span> <span class="number">1</span> <span class="operator">*</span> dispersion_fit<span class="punctuation">)</span><span class="operator">$</span>gene_id</span><br><span class="line">HSMM <span class="operator">&lt;-</span> setOrderingFilter<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> disp.genes<span class="punctuation">)</span></span><br><span class="line">plot_ordering_genes<span class="punctuation">(</span>HSMM<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 降维</span></span><br><span class="line"><span class="comment">## max_components = 2 指两个维度</span></span><br><span class="line">HSMM <span class="operator">&lt;-</span> reduceDimension<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> max_components <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                           method <span class="operator">=</span> <span class="string">&#x27;DDRTree&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 排序，指明发育起点和发育终点</span></span><br><span class="line">HSMM <span class="operator">&lt;-</span> orderCells<span class="punctuation">(</span>HSMM<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 图示说明</span></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;Pseudotime&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># root_state = 5：这一步是指定拟时分析的“根状态”，也就是定义拟时过程的起点。</span></span><br><span class="line"><span class="comment"># 通过设置 root_state = 5，你指定第 5 个状态为细胞分化或发育过程的起始点。</span></span><br><span class="line"><span class="comment"># 在没有指定 root_state 时，Monocle 会自动选择一个根状态</span></span><br><span class="line">HSMM <span class="operator">&lt;-</span> orderCells<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> root_state <span class="operator">=</span> <span class="number">5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;Pseudotime&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## facet_wrap 用来做分支图</span></span><br><span class="line"><span class="comment">## 展示不同clusters的状态</span></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_wrap<span class="punctuation">(</span><span class="operator">~</span>State<span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_wrap<span class="punctuation">(</span><span class="operator">~</span>orig.ident <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 展示基因的变化的散点图</span></span><br><span class="line"><span class="comment">## &quot;GAPDH&quot;, &quot;RORA&quot;为示例基因</span></span><br><span class="line">blast_genes <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>fData<span class="punctuation">(</span>HSMM<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                   gene_short_name <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;GAPDH&quot;</span><span class="punctuation">,</span> <span class="string">&quot;RORA&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_genes_jitter<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>blast_genes<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                  grouping <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  min_expr <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 基因随着发育时间的变化图 </span></span><br><span class="line"><span class="comment">## 筛选基因</span></span><br><span class="line">HSMM_expressed_genes <span class="operator">&lt;-</span>  row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>fData<span class="punctuation">(</span>HSMM<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                             num_cells_expressed <span class="operator">&gt;=</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">HSMM_filtered <span class="operator">&lt;-</span> HSMM<span class="punctuation">[</span>HSMM_expressed_genes<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">my_genes <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>fData<span class="punctuation">(</span>HSMM_filtered<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                gene_short_name <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;YWHAB&quot;</span><span class="punctuation">,</span> <span class="string">&quot;GAPDH&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TNNC1&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">cds_subset <span class="operator">&lt;-</span> HSMM_filtered<span class="punctuation">[</span>my_genes<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">plot_genes_in_pseudotime<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_genes_in_pseudotime<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span> color_by <span class="operator">=</span>  <span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 想看下列三个基因的小提琴图、pseudotime图等</span></span><br><span class="line">genes <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;TNNT2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TNNC1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CDK1&quot;</span><span class="punctuation">)</span></span><br><span class="line">p1 <span class="operator">&lt;-</span> plot_genes_jitter<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>genes<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span> grouping <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line">p2 <span class="operator">&lt;-</span> plot_genes_violin<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>genes<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span> grouping <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line">p3 <span class="operator">&lt;-</span> plot_genes_in_pseudotime<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>genes<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line">plotc <span class="operator">&lt;-</span> p1<span class="operator">|</span>p2<span class="operator">|</span>p3</span><br><span class="line">plotc </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">to_be_tested <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>fData<span class="punctuation">(</span>HSMM<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                    gene_short_name <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MYH3&quot;</span><span class="punctuation">,</span> <span class="string">&quot;MEF2C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CCNB2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TNNT1&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">cds_subset <span class="operator">&lt;-</span> HSMM<span class="punctuation">[</span>to_be_tested<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">diff_test_res <span class="operator">&lt;-</span> differentialGeneTest<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span></span><br><span class="line">                                         fullModelFormulaStr <span class="operator">=</span> <span class="string">&quot;~sm.ns(Pseudotime)&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">diff_test_res<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gene_short_name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;pval&quot;</span><span class="punctuation">,</span> <span class="string">&quot;qval&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">plot_genes_in_pseudotime<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span> color_by <span class="operator">=</span><span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 筛选下列的基因的拟时序分析</span></span><br><span class="line">marker_genes <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>fData<span class="punctuation">(</span>HSMM<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                    gene_short_name <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MEF2C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;MEF2D&quot;</span><span class="punctuation">,</span> <span class="string">&quot;MYF5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;ANPEP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;PDGFRA&quot;</span><span class="punctuation">,</span><span class="string">&quot;MYOG&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;TPM1&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;TPM2&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;MYH2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;MYH3&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;NCAM1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TNNT1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;TNNT2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TNNC1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CDK1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;CDK2&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;CCNB1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CCNB2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                           <span class="string">&quot;CCND1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CCNA1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ID1&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">diff_test_res <span class="operator">&lt;-</span> differentialGeneTest<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>marker_genes<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                         fullModelFormulaStr <span class="operator">=</span> <span class="string">&quot;~sm.ns(Pseudotime)&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">sig_gene_names <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>diff_test_res<span class="punctuation">,</span> qval <span class="operator">&lt;</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_pseudotime_heatmap<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>sig_gene_names<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        num_clusters <span class="operator">=</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                        cores <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        show_rownames <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_cell_trajectory<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 无法运行！！！</span></span><br><span class="line"><span class="comment">## 查看哪些基因向左升高，哪些基因向右升高</span></span><br><span class="line">BEAM_res <span class="operator">&lt;-</span> BEAM<span class="punctuation">(</span>HSMM<span class="punctuation">,</span> branch_point <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> progenitor_method <span class="operator">=</span> <span class="string">&quot;duplicate&quot;</span><span class="punctuation">,</span> cores <span class="operator">=</span> <span class="number">7</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># methods &lt;- c(&quot;duplicate&quot;, &quot;expression&quot;, &quot;cluster&quot;)</span></span><br><span class="line"><span class="comment"># results &lt;- lapply(methods, function(method) &#123;</span></span><br><span class="line"><span class="comment">#   BEAM(HSMM, branch_point = 1, progenitor_method = method)</span></span><br><span class="line"><span class="comment"># &#125;)</span></span><br><span class="line"></span><br><span class="line">BEAM_res <span class="operator">&lt;-</span> BEAM_res<span class="punctuation">[</span>order<span class="punctuation">(</span>BEAM_res<span class="operator">$</span>qval<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">BEAM_res <span class="operator">&lt;-</span> BEAM_res<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gene_short_name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;pval&quot;</span><span class="punctuation">,</span> <span class="string">&quot;qval&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">plot_genes_branched_heatmap<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>BEAM_res<span class="punctuation">,</span></span><br><span class="line">                                                  qval <span class="operator">&lt;</span> <span class="number">1e-4</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                            branch_point <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                            num_clusters <span class="operator">=</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                            cores <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                            use_gene_short_name <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">                            show_rownames <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">genes <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>fData<span class="punctuation">(</span>HSMM<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                             gene_short_name <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span> <span class="string">&quot;MEF2C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CCNB2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TNNT1&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_genes_branched_pseudotime<span class="punctuation">(</span>HSMM<span class="punctuation">[</span>genes<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                               branch_point <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                               color_by <span class="operator">=</span> <span class="string">&quot;State&quot;</span><span class="punctuation">,</span></span><br><span class="line">                               ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Monocle3"><a class="headerlink" href="#Monocle3"></a>Monocle3</h3>
<hr>
<p>与Monocle2相比，Monocle3最大的变化就是可以去除批次效应，并且Monocle2有细胞数量的限制，Monocle3具有环路或收敛点的轨迹的方法</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## Monocle3的代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## BiocManager::install(c(&#x27;BiocGenerics&#x27;, &#x27;DelayedArray&#x27;, &#x27;DelayedMatrixStats&#x27;,</span></span><br><span class="line"><span class="comment">## &#x27;limma&#x27;, &#x27;S4Vectors&#x27;, &#x27;SingleCellExperiment&#x27;,</span></span><br><span class="line"><span class="comment">## &#x27;SummarizedExperiment&#x27;, &#x27;batchelor&#x27;, &#x27;Matrix.utils&#x27;))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## install.packages(&quot;devtools&quot;)</span></span><br><span class="line"><span class="comment">## devtools::install_github(&#x27;cole-trapnell-lab/leidenbase&#x27;)</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;https://mirrors.westlake.edu.cn/bioconductor&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">options<span class="punctuation">(</span>download.file.method <span class="operator">=</span> <span class="string">&quot;curl&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## devtools::install_github(&#x27;cole-trapnell-lab/monocle3&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##系统报错改为英文</span></span><br><span class="line">Sys.setenv<span class="punctuation">(</span>LANGUAGE <span class="operator">=</span> <span class="string">&quot;en&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##禁止转化为因子</span></span><br><span class="line">options<span class="punctuation">(</span>stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">##清空环境</span></span><br><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span><span class="operator">=</span>ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>patchwork<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>monocle3<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/scRNA_harmony.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">scRNA_harmony <span class="operator">&lt;-</span> JoinLayers<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/oelab/RunData2/heisenberg/AllDataResult/&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data <span class="operator">&lt;-</span> GetAssayData<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">,</span> slot <span class="operator">=</span> <span class="string">&#x27;counts&#x27;</span><span class="punctuation">)</span></span><br><span class="line">cell_metadata <span class="operator">&lt;-</span> scRNA_harmony<span class="operator">@</span>meta.data</span><br><span class="line">gene_annotation <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>gene_short_name <span class="operator">=</span> rownames<span class="punctuation">(</span>data<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>gene_annotation<span class="punctuation">)</span> <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>data<span class="punctuation">)</span></span><br><span class="line">cds <span class="operator">&lt;-</span> new_cell_data_set<span class="punctuation">(</span>data<span class="punctuation">,</span></span><br><span class="line">                            cell_metadata <span class="operator">=</span> cell_metadata<span class="punctuation">,</span></span><br><span class="line">                            gene_metadata <span class="operator">=</span> gene_annotation<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 归一化处理</span></span><br><span class="line"><span class="comment">## 这个时间比较久</span></span><br><span class="line">cds <span class="operator">&lt;-</span> preprocess_cds<span class="punctuation">(</span>cds<span class="punctuation">,</span> num_dim <span class="operator">=</span> <span class="number">100</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 展示前100个pc</span></span><br><span class="line">plot_pc_variance_explained<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span> reduce_dimension</span><br><span class="line"></span><br><span class="line"><span class="comment">## 降维 umap</span></span><br><span class="line">cds <span class="operator">&lt;-</span> reduce_dimension<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 降维画图</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>scRNA_harmony<span class="punctuation">)</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看某个基因的表达量</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> genes<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;GAPDH&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">?</span>reduce_dimension</span><br><span class="line"><span class="comment">## 进行tsne降维</span></span><br><span class="line">cds <span class="operator">&lt;-</span> reduce_dimension<span class="punctuation">(</span>cds<span class="punctuation">,</span>umap.fast_sgd<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span> cores <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> reduction_method<span class="operator">=</span><span class="string">&quot;tSNE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> reduction_method<span class="operator">=</span><span class="string">&quot;tSNE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> reduction_method<span class="operator">=</span><span class="string">&quot;tSNE&quot;</span><span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> label_cell_groups<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> reduction_method<span class="operator">=</span><span class="string">&quot;tSNE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## alignment_group指明消除批次效应的来源</span></span><br><span class="line">cds <span class="operator">=</span> align_cds<span class="punctuation">(</span>cds<span class="punctuation">,</span> num_dim <span class="operator">=</span> <span class="number">100</span><span class="punctuation">,</span> alignment_group <span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">)</span></span><br><span class="line">cds <span class="operator">=</span> reduce_dimension<span class="punctuation">(</span>cds<span class="punctuation">,</span> reduction_method<span class="operator">=</span><span class="string">&quot;tSNE&quot;</span><span class="punctuation">)</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">,</span> label_cell_groups<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span><span class="punctuation">,</span>reduction_method<span class="operator">=</span><span class="string">&quot;tSNE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cds <span class="operator">=</span> reduce_dimension<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 进行clusters聚类</span></span><br><span class="line">cds <span class="operator">=</span> cluster_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> resolution<span class="operator">=</span><span class="number">1e-5</span><span class="punctuation">)</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>cds<span class="operator">@</span>clusters<span class="operator">$</span>UMAP<span class="operator">$</span>clusters<span class="punctuation">)</span></span><br><span class="line">cds<span class="operator">@</span>clusters<span class="operator">$</span>UMAP<span class="operator">$</span>partitions</span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;partition&quot;</span><span class="punctuation">,</span> group_cells_by<span class="operator">=</span><span class="string">&quot;partition&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">marker_test_res <span class="operator">&lt;-</span> top_markers<span class="punctuation">(</span>cds<span class="punctuation">,</span> group_cells_by<span class="operator">=</span><span class="string">&quot;partition&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                                  reference_cells<span class="operator">=</span><span class="number">1000</span><span class="punctuation">,</span> cores<span class="operator">=</span><span class="number">8</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">top_specific_markers <span class="operator">&lt;-</span>  marker_test_res <span class="operator">%&gt;%</span></span><br><span class="line">  filter<span class="punctuation">(</span>fraction_expressing <span class="operator">&gt;=</span> <span class="number">0.10</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>cell_group<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  top_n<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> pseudo_R2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">top_specific_marker_ids <span class="operator">&lt;-</span> unique<span class="punctuation">(</span>top_specific_markers <span class="operator">%&gt;%</span> pull<span class="punctuation">(</span>gene_id<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_genes_by_group<span class="punctuation">(</span>cds<span class="punctuation">,</span></span><br><span class="line">                    top_specific_marker_ids<span class="punctuation">,</span></span><br><span class="line">                    group_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    ordering_type<span class="operator">=</span><span class="string">&quot;maximal_on_diag&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    max.size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">top_specific_markers <span class="operator">=</span> marker_test_res <span class="operator">%&gt;%</span></span><br><span class="line">  filter<span class="punctuation">(</span>fraction_expressing <span class="operator">&gt;=</span> <span class="number">0.10</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>cell_group<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  top_n<span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span> pseudo_R2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">top_specific_marker_ids <span class="operator">=</span> unique<span class="punctuation">(</span>top_specific_markers <span class="operator">%&gt;%</span> pull<span class="punctuation">(</span>gene_id<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_genes_by_group<span class="punctuation">(</span>cds<span class="punctuation">,</span></span><br><span class="line">                    top_specific_marker_ids<span class="punctuation">,</span></span><br><span class="line">                    group_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    ordering_type<span class="operator">=</span><span class="string">&quot;cluster_row_col&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    max.size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 先将partitions的分组由因子型转为字符型</span></span><br><span class="line">colData<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="operator">$</span>assigned_cell_type <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>partitions<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cds_subset <span class="operator">&lt;-</span> choose_cells<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cds <span class="operator">&lt;-</span> learn_graph<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span></span><br><span class="line">           color_cells_by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span></span><br><span class="line">           label_groups_by_cluster<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_leaves<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_branch_points<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           group_label_size<span class="operator">=</span><span class="number">4</span><span class="punctuation">,</span>cell_size<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cds <span class="operator">=</span> order_cells<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span></span><br><span class="line">           color_cells_by <span class="operator">=</span> <span class="string">&quot;pseudotime&quot;</span><span class="punctuation">,</span></span><br><span class="line">           label_cell_groups<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_leaves<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">           label_branch_points<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">           graph_label_size<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">           group_label_size<span class="operator">=</span><span class="number">4</span><span class="punctuation">,</span>cell_size<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table<span class="punctuation">(</span>scRNA_harmony<span class="operator">@</span>meta.data<span class="operator">$</span>celltype<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># a helper function to identify the root principal points:</span></span><br><span class="line">get_earliest_principal_node <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>cds<span class="punctuation">,</span> time_bin<span class="operator">=</span><span class="string">&quot;T_cells&quot;</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  cell_ids <span class="operator">&lt;-</span> which<span class="punctuation">(</span>colData<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">]</span> <span class="operator">==</span> time_bin<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  closest_vertex <span class="operator">&lt;-</span> cds<span class="operator">@</span>principal_graph_aux<span class="punctuation">[[</span><span class="string">&quot;UMAP&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">$</span>pr_graph_cell_proj_closest_vertex</span><br><span class="line">  closest_vertex <span class="operator">&lt;-</span> as.matrix<span class="punctuation">(</span>closest_vertex<span class="punctuation">[</span>colnames<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  root_pr_nodes <span class="operator">&lt;-</span></span><br><span class="line">    igraph<span class="operator">::</span>V<span class="punctuation">(</span>principal_graph<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="punctuation">[[</span><span class="string">&quot;UMAP&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="operator">$</span>name<span class="punctuation">[</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">names</span><span class="punctuation">(</span>which.max<span class="punctuation">(</span>table<span class="punctuation">(</span>closest_vertex<span class="punctuation">[</span>cell_ids<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  root_pr_nodes</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">cds <span class="operator">=</span> order_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span> root_pr_nodes<span class="operator">=</span>get_earliest_principal_node<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span></span><br><span class="line">           color_cells_by <span class="operator">=</span> <span class="string">&quot;pseudotime&quot;</span><span class="punctuation">,</span></span><br><span class="line">           label_cell_groups<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_leaves<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_branch_points<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           graph_label_size<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">           group_label_size<span class="operator">=</span><span class="number">4</span><span class="punctuation">,</span>cell_size<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cds_sub <span class="operator">&lt;-</span> choose_graph_segments<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Working with 3D trajectories</span></span><br><span class="line"><span class="comment">## 制作三维的Monocle3图</span></span><br><span class="line"></span><br><span class="line">cds_3d <span class="operator">=</span> reduce_dimension<span class="punctuation">(</span>cds<span class="punctuation">,</span> max_components <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">cds_3d <span class="operator">=</span> cluster_cells<span class="punctuation">(</span>cds_3d<span class="punctuation">)</span></span><br><span class="line">cds_3d <span class="operator">=</span> learn_graph<span class="punctuation">(</span>cds_3d<span class="punctuation">)</span></span><br><span class="line">cds_3d <span class="operator">=</span> order_cells<span class="punctuation">(</span>cds_3d<span class="punctuation">,</span> root_pr_nodes<span class="operator">=</span>get_earliest_principal_node<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cds_3d <span class="operator">=</span> order_cells<span class="punctuation">(</span>cds_3d<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cds_3d_plot_obj <span class="operator">=</span> plot_cells_3d<span class="punctuation">(</span>cds_3d<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">)</span></span><br><span class="line">cds_3d_plot_obj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ciliated_genes <span class="operator">=</span> top_specific_markers<span class="operator">$</span>gene_id<span class="punctuation">[</span><span class="number">5</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">]</span></span><br><span class="line">cds_subset <span class="operator">=</span> cds<span class="punctuation">[</span>rowData<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="operator">$</span>gene_short_name <span class="operator">%in%</span> ciliated_genes<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">gene_fits <span class="operator">=</span> fit_models<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span> model_formula_str <span class="operator">=</span> <span class="string">&quot;~seurat_clusters&quot;</span><span class="punctuation">)</span></span><br><span class="line">fit_coefs</span><br><span class="line">fit_coefs <span class="operator">=</span> coefficient_table<span class="punctuation">(</span>gene_fits<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 挑出时间相关的组分</span></span><br><span class="line">emb_time_terms <span class="operator">=</span> fit_coefs <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>term <span class="operator">==</span> <span class="string">&quot;seurat_clusters1&quot;</span><span class="punctuation">)</span></span><br><span class="line">emb_time_terms</span><br><span class="line"></span><br><span class="line">emb_time_terms <span class="operator">=</span> fit_coefs <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>term <span class="operator">==</span> <span class="string">&quot;seurat_clusters1&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">emb_time_terms <span class="operator">%&gt;%</span> filter <span class="punctuation">(</span>q_value <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  select<span class="punctuation">(</span>gene_short_name<span class="punctuation">,</span> term<span class="punctuation">,</span> q_value<span class="punctuation">,</span> estimate<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_genes_violin<span class="punctuation">(</span>cds_subset<span class="punctuation">[</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span> group_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span> ncol<span class="operator">=</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x<span class="operator">=</span>element_text<span class="punctuation">(</span>angle<span class="operator">=</span><span class="number">45</span><span class="punctuation">,</span> hjust<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">neurons_cds <span class="operator">&lt;-</span> cds<span class="punctuation">[</span><span class="punctuation">,</span>grepl<span class="punctuation">(</span><span class="string">&quot;Macrophage&quot;</span><span class="punctuation">,</span> colData<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="operator">$</span>celltype<span class="punctuation">,</span> ignore.case<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">plot_cells<span class="punctuation">(</span>neurons_cds<span class="punctuation">,</span> color_cells_by<span class="operator">=</span><span class="string">&quot;partition&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pr_graph_test_res <span class="operator">&lt;-</span> graph_test<span class="punctuation">(</span>neurons_cds<span class="punctuation">,</span> neighbor_graph<span class="operator">=</span><span class="string">&quot;knn&quot;</span><span class="punctuation">,</span> cores<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">pr_deg_ids <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>pr_graph_test_res<span class="punctuation">,</span> q_value <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">gene_module_df <span class="operator">=</span> find_gene_modules<span class="punctuation">(</span>neurons_cds<span class="punctuation">[</span>pr_deg_ids<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span> resolution<span class="operator">=</span><span class="number">1e-2</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cell_group_df <span class="operator">=</span> tibble<span class="operator">::</span>tibble<span class="punctuation">(</span>cell<span class="operator">=</span>row.names<span class="punctuation">(</span>colData<span class="punctuation">(</span>neurons_cds<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> cell_group<span class="operator">=</span>neurons_cds<span class="operator">@</span>colData<span class="operator">@</span>listData<span class="punctuation">[[</span><span class="string">&quot;seurat_clusters&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">agg_mat <span class="operator">=</span> aggregate_gene_expression<span class="punctuation">(</span>neurons_cds<span class="punctuation">,</span> gene_module_df<span class="punctuation">,</span> cell_group_df<span class="punctuation">)</span></span><br><span class="line">row.names<span class="punctuation">(</span>agg_mat<span class="punctuation">)</span> <span class="operator">=</span> stringr<span class="operator">::</span>str_c<span class="punctuation">(</span><span class="string">&quot;Module &quot;</span><span class="punctuation">,</span> row.names<span class="punctuation">(</span>agg_mat<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>agg_mat<span class="punctuation">)</span> <span class="operator">=</span> stringr<span class="operator">::</span>str_c<span class="punctuation">(</span><span class="string">&quot;Partition &quot;</span><span class="punctuation">,</span> colnames<span class="punctuation">(</span>agg_mat<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pheatmap<span class="operator">::</span>pheatmap<span class="punctuation">(</span>agg_mat<span class="punctuation">,</span> cluster_rows<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> cluster_cols<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">                   scale<span class="operator">=</span><span class="string">&quot;column&quot;</span><span class="punctuation">,</span> clustering_method<span class="operator">=</span><span class="string">&quot;ward.D2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   fontsize<span class="operator">=</span><span class="number">6</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>neurons_cds<span class="punctuation">,</span></span><br><span class="line">           genes<span class="operator">=</span>gene_module_df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>module <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">16</span><span class="punctuation">,</span><span class="number">38</span><span class="punctuation">,</span><span class="number">33</span><span class="punctuation">,</span><span class="number">42</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           group_cells_by<span class="operator">=</span><span class="string">&quot;cluster&quot;</span><span class="punctuation">,</span></span><br><span class="line">           color_cells_by<span class="operator">=</span><span class="string">&quot;cluster&quot;</span><span class="punctuation">,</span></span><br><span class="line">           show_trajectory_graph<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds<span class="punctuation">,</span></span><br><span class="line">           color_cells_by <span class="operator">=</span> <span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span></span><br><span class="line">           label_groups_by_cluster<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_leaves<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           label_branch_points<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##找到影响发育轨迹的基因</span></span><br><span class="line">trace<span class="punctuation">(</span><span class="string">&#x27;calculateLW&#x27;</span><span class="punctuation">,</span> edit <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> where <span class="operator">=</span> asNamespace<span class="punctuation">(</span><span class="string">&quot;monocle3&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## change Matrix::rBind to rbind on line 93</span></span><br><span class="line"><span class="comment"># 使用neighbor_graph=&quot;principal_graph&quot;来检验轨迹相邻的细胞的表达是否相关</span></span><br><span class="line">ciliated_cds_pr_test_res <span class="operator">&lt;-</span> graph_test<span class="punctuation">(</span>cds<span class="punctuation">,</span> neighbor_graph<span class="operator">=</span><span class="string">&quot;principal_graph&quot;</span><span class="punctuation">,</span> cores<span class="operator">=</span><span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pr_deg_ids <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>ciliated_cds_pr_test_res<span class="punctuation">,</span> q_value <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">AFD_genes <span class="operator">&lt;-</span> pr_deg_ids<span class="punctuation">[</span><span class="number">20</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">]</span></span><br><span class="line">AFD_lineage_cds <span class="operator">&lt;-</span> cds<span class="punctuation">[</span>rowData<span class="punctuation">(</span>cds<span class="punctuation">)</span><span class="operator">$</span>gene_short_name <span class="operator">%in%</span> AFD_genes<span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line">plot_genes_in_pseudotime<span class="punctuation">(</span>AFD_lineage_cds<span class="punctuation">,</span></span><br><span class="line">                         color_cells_by<span class="operator">=</span><span class="string">&quot;celltype&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         min_expr<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cds_subset <span class="operator">&lt;-</span> choose_cells<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">subset_pr_test_res <span class="operator">&lt;-</span> graph_test<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span> neighbor_graph<span class="operator">=</span><span class="string">&quot;principal_graph&quot;</span><span class="punctuation">,</span> cores<span class="operator">=</span><span class="number">4</span><span class="punctuation">)</span></span><br><span class="line">pr_deg_ids <span class="operator">&lt;-</span> row.names<span class="punctuation">(</span>subset<span class="punctuation">(</span>subset_pr_test_res<span class="punctuation">,</span> q_value <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">gene_module_df <span class="operator">&lt;-</span> find_gene_modules<span class="punctuation">(</span>cds_subset<span class="punctuation">[</span>pr_deg_ids<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span> resolution<span class="operator">=</span><span class="number">0.001</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">agg_mat <span class="operator">&lt;-</span> aggregate_gene_expression<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span> gene_module_df<span class="punctuation">)</span></span><br><span class="line">module_dendro <span class="operator">&lt;-</span> hclust<span class="punctuation">(</span>dist<span class="punctuation">(</span>agg_mat<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">gene_module_df<span class="operator">$</span>module <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>gene_module_df<span class="operator">$</span>module<span class="punctuation">,</span> </span><br><span class="line">                                   levels <span class="operator">=</span> row.names<span class="punctuation">(</span>agg_mat<span class="punctuation">)</span><span class="punctuation">[</span>module_dendro<span class="operator">$</span>order<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">plot_cells<span class="punctuation">(</span>cds_subset<span class="punctuation">,</span></span><br><span class="line">           genes<span class="operator">=</span>gene_module_df<span class="punctuation">,</span></span><br><span class="line">           label_cell_groups<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           show_trajectory_graph<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="细胞互作"><a class="headerlink" href="#细胞互作"></a>细胞互作</h2>
<hr>
<h3 id="CellChat"><a class="headerlink" href="#CellChat"></a>CellChat</h3>
<hr>
</article><div class="post-copyright"><div class="post-copyright__author_group"><a class="post-copyright__author_img" href="/about/"><img class="post-copyright__author_img_front" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/MyPhoto.jpg"></a><div class="post-copyright__author_name">coo1heisenberg's Blog</div><div class="post-copyright__author_desc">Diligence can make up for clumsiness!</div></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div id="quit-box" onclick="RemoveRewardMask()"></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本文是原创文章，采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>协议，完整转载请注明来自<a href="/">coo1heisenberg's Blog</a></span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/"><span class="tags-punctuation"></span>单细胞<span class="tagsPageCount">1</span></a></div></div><div class="social-share"></div></div><nav class="needEndHide pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">01 空间转录组 笔记</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/22/00-MongoDB/"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">04 MongoDB 笔记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><div class="author-info__top-group"><div class="author-info__sayhi" id="author-info__sayhi" onclick="sco.changeSayHelloText()">sayhello.morning</div></div></div><div class="avatar-img-group"><img class="avatar-img" alt="头像" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/MyPhoto.jpg"><div class="avatar-sticker"><img class="avatar-sticker-img" src="https://7.isyangs.cn/34/65f2e4e0423cc-34.png" alt="心情贴纸"></div></div><div class="author-info__description_group"><div class="author-info__description">菜鸡的自我救赎...</div><div class="author-info__description2"></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about/"><div class="author-info__name">Coo1heisenberg’s BLOG</div><div class="author-info__desc">Diligence can make up for clumsiness!</div></a><div class="card-info-social-icons is-center"><a class="social-icon" target="_blank" rel="noopener" href="https://github.com/coo1heisenbergProject" title="Github"><i class="solitude  st-github-line"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="solitude st-menu-line"></i><span>文章目录</span></div><div class="toc-content" id="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">单细胞多组学分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Seurat-%E5%AF%B9%E8%B1%A1%E6%9E%84%E5%BB%BA%E5%8F%8A%E9%99%8D%E7%BB%B4%E8%81%9A%E7%B1%BB"><span class="toc-text">Seurat 对象构建及降维聚类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E6%A0%B7%E6%9C%AC%E6%95%B0%E6%8D%AE%E6%95%B4%E5%90%88"><span class="toc-text">多个样本数据整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nature-Genetics-%E5%A4%84%E7%90%86%E6%A0%B7%E6%9C%AC%E6%95%B4%E5%90%88%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">Nature Genetics 处理样本整合的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%BD%92%E4%B8%80%E5%8C%96%E7%AE%97%E6%B3%95"><span class="toc-text">两种归一化算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SCTransfrom"><span class="toc-text">SCTransfrom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Harmony"><span class="toc-text">Harmony</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%8D%95%E7%BB%86%E8%83%9E%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E6%80%BB%E7%BB%93"><span class="toc-text">现阶段单细胞流程分析总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E6%95%B0%E6%8D%AE%E6%95%B4%E5%90%88%E6%96%B9%E5%BC%8F%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-text">四种数据整合方式的对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E7%BB%86%E8%83%9E%E7%9A%84%E5%8E%BB%E9%99%A4"><span class="toc-text">双细胞的去除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E6%A0%B7%E6%9C%AC%E7%9A%84%E5%8F%8C%E7%BB%86%E8%83%9E%E7%9A%84%E5%8E%BB%E9%99%A4"><span class="toc-text">单个样本的双细胞的去除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%9A%E7%BE%A4%E6%B3%A8%E9%87%8A"><span class="toc-text">亚群注释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%9A%E7%BE%A4%E7%BB%86%E5%88%86"><span class="toc-text">亚群细分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Marker%E5%9F%BA%E5%9B%A0%E5%B1%95%E7%A4%BA"><span class="toc-text">Marker基因展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E5%88%86%E7%B1%BB%E6%8F%90%E5%8F%96%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">样本分类提取的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Marker%E5%9F%BA%E5%9B%A0%E7%BB%98%E5%9B%BE%E5%B1%95%E7%A4%BA"><span class="toc-text">Marker基因绘图展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96%E7%BB%98%E5%9B%BE"><span class="toc-text">个性化绘图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E5%9F%BA%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-text">差异基因分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E5%9F%BA%E5%9B%A0%E7%9A%84%E5%B1%95%E7%A4%BA%EF%BC%88heatmap%E7%AD%89%EF%BC%89"><span class="toc-text">差异基因的展示（heatmap等）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%BB%B4pca%E7%9A%84%E5%B1%95%E7%A4%BA"><span class="toc-text">三维pca的展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E7%BB%86%E8%83%9E%E7%B1%BB%E5%9E%8B%E5%9F%BA%E5%9B%A0%E5%B1%95%E7%A4%BA"><span class="toc-text">多个细胞类型基因展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%B7%AF%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><span class="toc-text">通路富集分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%9F%E6%97%B6%E9%97%B4%E5%88%86%E6%9E%90"><span class="toc-text">拟时间分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Monocle2"><span class="toc-text">Monocle2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monocle3"><span class="toc-text">Monocle3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E8%83%9E%E4%BA%92%E4%BD%9C"><span class="toc-text">细胞互作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CellChat"><span class="toc-text">CellChat</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="solitude st-map-line"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/28/00-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" title="00 HTML5和CSS3 笔记"><img alt="00 HTML5和CSS3 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Web_Html%2BCSS.png"></a><div class="content"><a class="title" href="/2024/09/28/00-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" title="00 HTML5和CSS3 笔记">00 HTML5和CSS3 笔记</a><a class="article-recent_post_categories" href="/2024/09/28/00-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/">前端</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/" title="01 空间转录组 笔记"><img alt="01 空间转录组 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/bio_gene.png"></a><div class="content"><a class="title" href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/" title="01 空间转录组 笔记">01 空间转录组 笔记</a><a class="article-recent_post_categories" href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">生信分析</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/13/00-%E5%8D%95%E7%BB%86%E8%83%9E%E5%A4%9A%E7%BB%84%E5%AD%A6%E5%88%86%E6%9E%90/" title="00 单细胞多组学分析 笔记"><img alt="00 单细胞多组学分析 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/bio_gene.png"></a><div class="content"><a class="title" href="/2024/09/13/00-%E5%8D%95%E7%BB%86%E8%83%9E%E5%A4%9A%E7%BB%84%E5%AD%A6%E5%88%86%E6%9E%90/" title="00 单细胞多组学分析 笔记">00 单细胞多组学分析 笔记</a><a class="article-recent_post_categories" href="/2024/09/13/00-%E5%8D%95%E7%BB%86%E8%83%9E%E5%A4%9A%E7%BB%84%E5%AD%A6%E5%88%86%E6%9E%90/">生信分析</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/22/00-MongoDB/" title="04 MongoDB 笔记"><img alt="04 MongoDB 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Mongodb_title.png"></a><div class="content"><a class="title" href="/2024/07/22/00-MongoDB/" title="04 MongoDB 笔记">04 MongoDB 笔记</a><a class="article-recent_post_categories" href="/2024/07/22/00-MongoDB/">Database</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/17/00-elasticsearch/" title="00 ElasticSearch 笔记"><img alt="00 ElasticSearch 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/ElasticSearch.png"></a><div class="content"><a class="title" href="/2024/07/17/00-elasticsearch/" title="00 ElasticSearch 笔记">00 ElasticSearch 笔记</a><a class="article-recent_post_categories" href="/2024/07/17/00-elasticsearch/">Others</a></div></div></div></div></div></div></main><footer id="footer"><div id="st-footer-bar"><div class="footer-logo"><span>Solitude</span></div><div class="footer-bar-description">来自 Heisenberg 的原创文章</div><a class="footer-bar-link" href="/about/">了解更多</a></div><div id="footer_deal"></div><div id="st-footer"><div class="footer-group"><h3 class="footer-title">导航</h3><div class="footer-links"><a class="footer-item" href="/archives/" title="归档">归档</a><a class="footer-item" href="/categories/" title="分类">分类</a><a class="footer-item" href="/tags/" title="标签">标签</a></div></div><div class="footer-group"><h3 class="footer-title">服务</h3><div class="footer-links"><a class="footer-item" target="_blank" rel="noopener" href="https://aliyun.com/" title="阿里云">阿里云</a></div></div><div class="footer-group"><h3 class="footer-title">支持</h3><div class="footer-links"><a class="footer-item" href="/about/" title="打赏记录">打赏记录</a></div></div><div class="footer-group"><h3 class="footer-title">协议</h3><div class="footer-links"><a class="footer-item" href="/cookies/" title="Cookies">Cookies</a><a class="footer-item" href="/privacy/" title="用户协议">用户协议</a><a class="footer-item" href="/copyright/" title="版权协议">版权协议</a></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div class="copyright">© 2024 By&nbsp;<a class="footer-bar-link" href="/">Coo1heisenberg’s BLOG</a></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" alt="主题">主题</a><a class="footer-bar-link cc" href="/null" aria-label="copyright"><i class="solitude st-copyright-line"></i><i class="solitude st-creative-commons-by-line"></i><i class="solitude st-creative-commons-nc-line"></i><i class="solitude st-creative-commons-nd-line"></i></a></div></div></div></footer></div><!-- right_menu--><!-- inject body--><div><script src="/js/utils.js?v=1.10.6"></script><script src="/js/main.js?v=1.10.6"></script><script src="/js/third_party/waterfall.min.js?v=1.10.6"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script src="/js/third_party/universe.min.js?v=1.10.6"></script><script>dark()
</script><script src="//open.lightxi.com/cdnjs/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js"><script>(() => {
    document.querySelectorAll('#article-container span.katex-display').forEach(item => {
        utils.wrap(item, 'div', {class: 'katex-wrap'})
    })
})();
</script></script><script src="//open.lightxi.com/cdnjs/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js"></script><script>var meting_api = 'https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r';</script><script src="//open.lightxi.com/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/meting/2.0.1/Meting.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/pace/1.2.4/pace.min.js"></script><div class="js-pjax"><script defer pjax src="//open.lightxi.com/cdnjs/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.min.js"></script></div></div><!-- newest comment--><!-- pjax--><script>const pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: ['title','#body-wrap','#site-config','meta[name="description"]','.js-pjax','meta[property^="og:"]','#config-diff'],
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
})

document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
})

document.addEventListener('pjax:complete', () => {
    window.refreshFn()

    document.querySelectorAll('script[data-pjax]').forEach(item => {
        const newScript = document.createElement('script')
        const content = item.text || item.textContent || item.innerHTML || ""
        Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
        newScript.appendChild(document.createTextNode(content))
        item.parentNode.replaceChild(newScript, item)
    })

    GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

})

document.addEventListener('pjax:error', (e) => {
    if (e.request.status === 404) {
        pjax.loadUrl('/404.html')
    }
})</script><!-- theme--><script>initTheme = () => {
    let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const cachedMode = utils.saveToLocal.get('theme');
    if (cachedMode === undefined) {
        const nowMode =
            isDarkMode ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', nowMode);
    } else {
        document.documentElement.setAttribute('data-theme', cachedMode);
    }
    is_rm && rm.mode(cachedMode === 'dark' && isDarkMode)
}
initTheme()</script><!-- google adsense--><!-- search--><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="solitude st-close-fill"></i></button></nav><div class="search-wrap"><div class="search-box"><input class="search-box-input" id="search-input" type="text" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" placeholder="输入关键词快速查找"></div><div id="search-results"><div id="search-hits"></div></div><div id="search-pagination"></div><div id="search-tips"></div></div></div><div id="search-mask"></div></div><script src="/js/search/local.js?v=1.10.6"></script><!-- Tianli-Talk--><!-- music--></body></html><script>const posts=["2024/09/28/00-前端开发入门教程/","2024/09/26/01-空间转录组/","2024/09/13/00-单细胞多组学分析/","2024/07/22/00-MongoDB/","2024/07/17/00-elasticsearch/","2024/07/15/01-黑马redis/","2024/07/13/00-黑马redis/","2024/07/08/00-黑马SSM/","2024/07/08/01-头条点评项目/","2024/07/06/00-Mybatis-Plus/","2024/06/29/00-黑马MySQL/","2024/06/25/00-头条点评项目/","2024/06/21/02-Python/","2024/06/11/01-Python/","2024/05/25/00-Python/","2024/05/13/DesignPattern/","2024/05/13/Docker/","2024/05/13/Nginx/","2024/05/13/Linux/"];function toRandomPost(){ pjax.loadUrl('/'+posts[Math.floor(Math.random()*posts.length)]); }</script>