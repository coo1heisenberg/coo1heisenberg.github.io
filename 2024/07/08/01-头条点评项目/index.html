<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>01 仿今日头条项目 | coo1heisenberg's Blog</title><noscript>开启JavaScript才能访问本站哦~</noscript><link rel="icon" href="/img/pwa/favicon.ico"><!-- index.css--><link rel="stylesheet" href="/css/index.css?v=1.10.6"><!-- inject head--><link rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/7pOrz0WXB5ZWJPX/latest/iconfont.css"><!-- aplayer--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.css"><!-- swiper--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"><!-- fancybox ui--><!-- katex--><link rel="stylesheet" href="//open.lightxi.com/cdnjs/ajax/libs/KaTeX/0.16.9/katex.min.css"><!-- Open Graph--><meta name="description" content="仿今日头条项目 自媒体文章上下架 自媒体文章上下架的实现： 消息通知的其他需求： Kafka 概述 消息中间件的对比： 特性 ActiveMQ RabbitMQ RocketMQ Kafka 开发语言 java erlang java scala 单机吞吐量 万级 万级"><!-- pwa--><meta name="apple-mobile-web-app-capable" content="coo1heisenberg's Blog"><meta name="theme-color" content="var(--efu-main)"><meta name="apple-mobile-web-app-status-bar-style" content="var(--efu-main)"><link rel="bookmark" href="/img/pwa/favicon.ico"><link rel="apple-touch-icon" href="/img/pwa/favicon.ico" sizes="180x180"><script>console.log(
    "%c Program: Hexo %c Theme: Solitude %c Version: v1.10.6",
    "border-radius:5px 0 0 5px;padding: 5px 10px;color:white;background:#ff3842;",
    "padding: 5px 10px;color:white;background:#3e9f50;",
    "padding: 5px 10px;color:white;background:#0084ff;border-radius:0 5px 5px 0",
)
</script><script>(()=>{
        const saveToLocal = {
            set: function setWithExpiry(key, value, ttl) {
                if (ttl === 0)
                    return
                const now = new Date()
                const expiryDay = ttl * 86400000
                const item = {
                    value: value,
                    expiry: now.getTime() + expiryDay
                }
                localStorage.setItem(key, JSON.stringify(item))
            },
            get: function getWithExpiry(key) {
                const itemStr = localStorage.getItem(key)
    
                if (!itemStr) {
                    return undefined
                }
                const item = JSON.parse(itemStr)
                const now = new Date()
    
                if (now.getTime() > item.expiry) {
                    localStorage.removeItem(key)
                    return undefined
                }
                return item.value
            }
        };
        window.utils = {
            saveToLocal: saveToLocal,
            getCSS: (url, id = false) => new Promise((resolve, reject) => {
              const link = document.createElement('link')
              link.rel = 'stylesheet'
              link.href = url
              if (id) link.id = id
              link.onerror = reject
              link.onload = link.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                link.onload = link.onreadystatechange = null
                resolve()
              }
              document.head.appendChild(link)
            }),
            getScript: (url, attr = {}) => new Promise((resolve, reject) => {
              const script = document.createElement('script')
              script.src = url
              script.async = true
              script.onerror = reject
              script.onload = script.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                script.onload = script.onreadystatechange = null
                resolve()
              }
    
              Object.keys(attr).forEach(key => {
                script.setAttribute(key, attr[key])
              })
    
              document.head.appendChild(script)
            }),
            addGlobalFn: (key, fn, name = false, parent = window) => {
                const globalFn = parent.globalFn || {}
                const keyObj = globalFn[key] || {}
        
                if (name && keyObj[name]) return
        
                name = name || Object.keys(keyObj).length
                keyObj[name] = fn
                globalFn[key] = keyObj
                parent.globalFn = globalFn
            },
        }
    })()</script><!-- global head--><script>const GLOBAL_CONFIG = {
    root: '/',
    algolia: undefined,
    localsearch: {"preload":false,"path":"/search.xml"},
    runtime: '2024-05-12 00:00:00',
    lazyload: {
        enable: false,
        error: '/img/error_load.webp'
    },
    copyright: {"limit":50,"author":"作者: Coo1heisenberg’s BLOG","link":"链接: ","source":"来源: coo1heisenberg's Blog","info":"著作权归作者所有。 商业转载请联系作者获得授权，非商业转载请注明出处。"},
    highlight: {
        enable: true,
        limit: 200,
        expand: true,
        copy: true,
        syntax: 'highlight.js'
    },
    randomlink: false,
    lang: {"theme":{"dark":"已切换至深色模式","light":"已切换至浅色模式"},"copy":{"success":"复制成功","error":"复制失败"},"backtop":"返回顶部","time":{"day":"天前","hour":"小时前","just":"刚刚","min":"分钟前","month":"个月前"},"f12":"开发者模式已打开，请遵循GPL协议。","totalk":"无需删除空行，直接输入评论即可","search":{"empty":"找不到你查询的内容：${query}","hit":"找到 ${hits} 条结果，用时 ${time} 毫秒","placeholder":"输入关键词快速查找","count":"共 <b>${count}</b> 条结果。"}},
    aside: {
        sayhello: {
            morning: '一日之计在于晨',
            noon: '吃饱了才有力气干活',
            afternoon: '集中精力，攻克难关',
            night: '不要太劳累了，早睡更健康',
            goodnight: '睡个好觉，保证精力充沛',
        },
        sayhello2: [],
    },
    covercolor: {
        enable: false
    },
    comment: false,
    lightbox: 'null',
    post_ai: false,
    right_menu: false,
};</script><!-- page-config head--><script id="config-diff">var PAGE_CONFIG = {
    is_post: true,
    is_page: false,
    is_home: false,
    page: '',
    toc: true,
    comment: false,
    ai_text: false
}</script><meta name="generator" content="Hexo 7.2.0"></head><body id="body"><!-- universe--><canvas id="universe"></canvas><!-- loading--><!-- console--><div id="console"><div class="close-btn" onclick="sco.hideConsole()"><i class="solitude st-close-fill"></i></div><div class="console-card-group"><div class="console-card-group-right"><div class="console-card tags" onclick="sco.hideConsole()"><div class="card-content"><div class="author-content-item-tips">标签</div><div class="author-content-item-title">寻找感兴趣的领域</div></div><div class="card-tag-cloud"><a href="/tags/%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">空间转录组<sup>1</sup></a><a href="/tags/Python%E9%AB%98%E7%BA%A7/">Python高级<sup>1</sup></a><a href="/tags/Docker%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Docker基础语法<sup>1</sup></a><a href="/tags/Nginx%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Nginx基础语法<sup>1</sup></a><a href="/tags/MongoDB/">MongoDB<sup>1</sup></a><a href="/tags/HTML-CSS/">HTML+CSS<sup>1</sup></a><a href="/tags/Redis/">Redis<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<sup>1</sup></a><a href="/tags/Linux%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Linux基础语法<sup>1</sup></a><a href="/tags/Mybatis-Plus/">Mybatis-Plus<sup>1</sup></a><a href="/tags/ElasticSearch/">ElasticSearch<sup>1</sup></a><a href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础<sup>2</sup></a><a href="/tags/MySQL/">MySQL<sup>1</sup></a><a href="/tags/Project/">Project<sup>2</sup></a><a href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/">单细胞<sup>1</sup></a><a href="/tags/Spring/">Spring<sup>1</sup></a></div></div><div class="console-card history" onclick="sco.hideConsole()"><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">2024/09</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">2024/07</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">2024/06</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span class="card-archive-list-count-unit">篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">2024/05</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span class="card-archive-list-count-unit">篇</span></div></a></li></ul></div></div></div><div class="button-group"><div class="console-btn-item"><span class="darkmode_switchbutton" onclick="sco.switchDarkMode()" title="昼夜切换"><i class="solitude st-moon-clear-fill"></i></span></div><div class="console-btn-item" id="consoleHideAside"><span class="asideSwitch" onclick="sco.switchHideAside()" title="边栏显示控制"><i class="solitude st-side-bar-fill"></i></span></div></div><div class="console-mask" onclick="sco.hideConsole()"></div></div><!-- sidebar--><div id="sidebar" style="zoom: 1;"><div id="menu-mask" style="display: none;"></div><div id="sidebar-menus"><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><span class="darkmode_switchbutton menu-child" onclick="sco.switchDarkMode()"><i class="solitude st-moon-clear-fill"></i><span>显示模式</span></span></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">博客主题</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="Solitude"><img class="nolazyload back-menu-item-icon" src="https://7.isyangs.cn/1/65eb200ee4dea-1.png" alt="Solitude"><span class="back-menu-item-text">Solitude</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文库</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  st-checkbox-multiple-blank-fill"></i><span>全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/links/"><i class="solitude  st-group-fill"></i><span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/tlink/"><i class="solitude  st-tools-fill"></i><span>工具箱</span></a></li><li><a class="site-page child" href="/music/"><i class="solitude  st-disc-fill"></i><span>音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>关于本站</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-widget card-tags card-archives card-webinfo card-allinfo"><div class="card-tag-cloud"><a href="/tags/%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">空间转录组<sup>1</sup></a><a href="/tags/Python%E9%AB%98%E7%BA%A7/">Python高级<sup>1</sup></a><a href="/tags/Docker%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Docker基础语法<sup>1</sup></a><a href="/tags/Nginx%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Nginx基础语法<sup>1</sup></a><a href="/tags/MongoDB/">MongoDB<sup>1</sup></a><a href="/tags/HTML-CSS/">HTML+CSS<sup>1</sup></a><a href="/tags/Redis/">Redis<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式<sup>1</sup></a><a href="/tags/Linux%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">Linux基础语法<sup>1</sup></a><a href="/tags/Mybatis-Plus/">Mybatis-Plus<sup>1</sup></a><a href="/tags/ElasticSearch/">ElasticSearch<sup>1</sup></a><a href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础<sup>2</sup></a><a href="/tags/MySQL/">MySQL<sup>1</sup></a><a href="/tags/Project/">Project<sup>2</sup></a><a href="/tags/%E5%8D%95%E7%BB%86%E8%83%9E/">单细胞<sup>1</sup></a><a href="/tags/Spring/">Spring<sup>1</sup></a></div></div></div></div><!-- keyboard--><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav class="show" id="nav"><div id="nav-group"><div id="blog_name"><div class="back-home-button" tabindex="-1"><i class="back-home-button-icon solitude st-more-fill"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">博客主题</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="Solitude"><img class="nolazyload back-menu-item-icon" src="https://7.isyangs.cn/1/65eb200ee4dea-1.png" alt="Solitude"><span class="back-menu-item-text">Solitude</span></a></div></div></div></div><a id="site-name" href="/" title="返回博客主页"><span class="title">Solitude</span></a></div><div id="page-name-mask"><div id="page-name"><a id="page-name-text" onclick="sco.toTop()">01 仿今日头条项目</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文库</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  st-checkbox-multiple-blank-fill"></i><span>全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>全部标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/links/"><i class="solitude  st-group-fill"></i><span>友情链接</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/tlink/"><i class="solitude  st-tools-fill"></i><span>工具箱</span></a></li><li><a class="site-page child" href="/music/"><i class="solitude  st-disc-fill"></i><span>音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>关于本站</span></a></li></ul></div></div></div><div id="nav-left"></div><div id="nav-right"><div class="nav-button" id="travellings_button"><a class="site-page" href="/" title=""><i class="solitude st-train-line"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索"><i class="solitude st-search-line"></i></a></div><div class="nav-button" id="nav-totop" onclick="sco.toTop()"><a class="totopbtn"><i class="solitude st-arrow-up-line"></i><span id="percent">0</span></a></div><div id="toggle-menu"><a class="site-page"><i class="solitude st-menu-line"></i></a></div></div></div></nav><div class="coverdiv" id="coverdiv"><img class="nolazyload" id="post-cover" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Snipaste_2024-06-25_21-33-23.png" alt="01 仿今日头条项目"></div><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original" title="该文章为原创文章，注意版权协议">原创</a><span class="post-meta-categories"><a class="post-meta-categories" href="/categories/Java/">Java</a></span><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Project/"><span class="tags-name tags-punctuation">Project</span></a></div></div></div></div><h1 class="post-title">01 仿今日头条项目</h1><div id="post-meta"><div class="meta-secondline"><span class="post-meta-date" title="发布于 2024-07-08 23:35:44"><i class="post-meta-icon solitude st-calendar-todo-fill"></i><time datetime="2024-07-08T15:35:44.000Z">2024-07-08T15:35:44.000Z</time></span><span class="post-meta-date" title="最后更新于 2024-08-01 22:35:29"><i class="post-meta-icon solitude st-refresh-line"></i><time datetime="2024-08-01T14:35:29.625Z">2024-08-01T14:35:29.625Z</time></span><span class="post-meta-wordcount"><span class="post-meta-separator"></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>仿今日头条项目</h1>
<hr>
<h2 id="自媒体文章上下架"><a class="headerlink" href="#自媒体文章上下架"></a>自媒体文章上下架</h2>
<hr>
<p>自媒体文章上下架的实现：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240710184800433.png" alt="流程实现" loading="lazy"></p>
<p>消息通知的其他需求：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240710185106864.png" alt="消息通知的其他需求" loading="lazy"></p>
<hr>
<h3 id="Kafka-概述"><a class="headerlink" href="#Kafka-概述"></a>Kafka 概述</h3>
<hr>
<p><strong>消息中间件的对比</strong>：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody>
<tr>
<td>开发语言</td>
<td>java</td>
<td>erlang</td>
<td>java</td>
<td>scala</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>万级</td>
<td>万级</td>
<td>10万级</td>
<td>100万级</td>
</tr>
<tr>
<td>时效性</td>
<td>ms</td>
<td>us</td>
<td>ms</td>
<td>ms级以内</td>
</tr>
<tr>
<td>可用性</td>
<td>高（主从）</td>
<td>高（主从）</td>
<td>非常高（分布式）</td>
<td>非常高（分布式）</td>
</tr>
<tr>
<td>功能特性</td>
<td>成熟的产品、较全的文档、各种协议支持好</td>
<td>并发能力强、性能好、延迟低</td>
<td>MQ功能比较完善，扩展性佳</td>
<td>只支持主要的MQ功能，主要应用于大数据领域</td>
</tr>
</tbody>
</table>
<p><strong>消息中间件对比  –  选择建议</strong>：</p>
<table>
<thead>
<tr>
<th><strong>消息中间件</strong></th>
<th><strong>建议</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Kafka</td>
<td>追求高吞吐量，适合产生大量数据的互联网服务的数据收集业务</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>可靠性要求很高的金融互联网领域，稳定性高，经历了多次阿里双11考验</td>
</tr>
<tr>
<td>RabbitMQ</td>
<td>性能较好，社区活跃度高，数据量没有那么大，优先选择功能比较完备的RabbitMQ</td>
</tr>
</tbody>
</table>
<p><strong>Kafka 介绍</strong>：Kafka 是一个分布式流媒体平台，类似于 消息队列 或 企业消息传递系统。</p>
<p>kafka 官网：<a target="_blank" rel="noopener" href="http://kafka.apache.org/">http://kafka.apache.org/</a></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240710185833439.png" alt="Kafka" loading="lazy"></p>
<p><strong>Kafka 名称解释</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240710190024704.png" alt="Kafka结构图" loading="lazy"></p>
<ul>
<li>
<p>producer：发布消息的对象 称之为 主题生产者（Kafka topic producer）</p>
</li>
<li>
<p>topic：Kafka将消息分门别类，每一类的消息称之为一个主题（Topic）</p>
</li>
<li>
<p>consumer：订阅消息并处理发布的消息的对象 称之为 主题消费者（consumers）</p>
</li>
<li>
<p>broker：已发布的消息保存在一组服务器中，称之为 <strong>Kafka集群</strong>。集群中的每一个 服务器 都是一个 代理 （Broker），消费者可以订阅一个或多个 主题（topic），并从Broker拉数据，从而消费这些已发布的消息。</p>
</li>
</ul>
<hr>
<h3 id="Kafka-安装配置"><a class="headerlink" href="#Kafka-安装配置"></a>Kafka 安装配置</h3>
<hr>
<p>Kafka 对于 zookeeper 是强依赖，保存 kafka 相关的节点数据，所以安装Kafka之前必须先安装 zookeeper</p>
<ol>
<li>
<p>Docker 安装 zookeeper</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name zookeeper -p 2181:2181 zookeeper</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Docker 安装 kafka</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull wurstmeister/kafka</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kafka \</span><br><span class="line">--env KAFKA_ADVERTISED_HOST_NAME=192.168.88.129 \</span><br><span class="line">--env KAFKA_ZOOKEEPER_CONNECT=192.168.88.129:2181 \</span><br><span class="line">--env KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.88.129:9092 \</span><br><span class="line">--env KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">--env KAFKA_HEAP_OPTS=&quot;-Xmx256M -Xms256M&quot; \</span><br><span class="line">--net=host wurstmeister/kafka</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--net=host</code>，直接使用容器宿主机的网络命名空间， 即没有独立的网络环境。它使用宿主机的ip和端口</li>
</ul>
</li>
</ol>
<hr>
<h3 id="kafka-入门案例"><a class="headerlink" href="#kafka-入门案例"></a>kafka 入门案例</h3>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716180405342.png" alt="案例流程" loading="lazy"></p>
<ul>
<li>生产者 发送消息，多个消费者 只能有 一个消费者 接收到消息</li>
<li>生产者 发送消息，多个消费者 都可以 接收到消息</li>
</ul>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>创建 kafka-demo 项目，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>编写 消息生产者类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerQuickStart</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. kafka链接配置信息</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.1 设置kafka的链接地址</span></span><br><span class="line">        prop.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;192.168.88.129:9092&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.2 设置key和value的序列化</span></span><br><span class="line">        prop.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        prop.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建kafka生产者对象</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;String, String&gt;(prop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 发送消息</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 第一个参数：topic</span></span><br><span class="line"><span class="comment">         * 第二个参数：消息的key</span></span><br><span class="line"><span class="comment">         * 第三个参数：消息的value</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ProducerRecord&lt;String, String&gt; kvProducerRecord = <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;String, String&gt;(<span class="string">&quot;topic-first&quot;</span>, <span class="string">&quot;key-001&quot;</span>,<span class="string">&quot;hello kafka&quot;</span>);</span><br><span class="line">        producer.send(kvProducerRecord);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 关闭消息通道</span></span><br><span class="line">        <span class="comment">// 必须要关闭，否则发送不成功</span></span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>编写 消息消费者类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerQuickStart</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. kafka的配置信息</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.1 链接地址</span></span><br><span class="line">        prop.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;192.168.88.129:9092&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.2 key和value的反序列化器</span></span><br><span class="line">        prop.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        prop.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.3 设置消费者组</span></span><br><span class="line">        prop.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">&quot;group1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建消费者对象</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>&lt;String, String&gt;(prop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 订阅主题（topic）</span></span><br><span class="line">        consumer.subscribe(Collections.singletonList(<span class="string">&quot;topic-first&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 拉去消息</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(<span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;</span><br><span class="line">                System.out.println(consumerRecord.key());</span><br><span class="line">                System.out.println(consumerRecord.value());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>总结</strong>：</p>
<ul>
<li>
<p>生产者发送消息，多个消费者订阅同一个主题，只能有 一个消费者 收到消息（一对一）。是在同一个group 下</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716183251596.png" alt="同一个group下" loading="lazy"></p>
</li>
<li>
<p>生产者发送消息，多个消费者订阅同一个主题，所有消费者 都能收到消息（一对多）。是在不同的 group 下</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716183353924.png" alt="不同的group下" loading="lazy"></p>
</li>
</ul>
<hr>
<h3 id="Kafka-分区机制"><a class="headerlink" href="#Kafka-分区机制"></a>Kafka 分区机制</h3>
<hr>
<p>Kafka 中的 分区机制 指的是：将每个 主题 划分成 多个分区（Partition）</p>
<p>可以处理更多的消息，不受单台服务器的限制，可以不受限的处理更多的数据</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716183728229.png" alt="kafka分区机制" loading="lazy"></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716183813534.png" alt="topic剖析" loading="lazy"></p>
<ul>
<li>每一个 分区 都是一个 顺序的、不可变 的 消息队列， 并且可以 持续的添加</li>
<li>分区中的消息都被分了一个 序列号，称之为 <strong>偏移量(offset)</strong>，在每个分区中此 偏移量 都是 唯一的</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716183926195.png" alt="kafka分区策略" loading="lazy"></p>
<hr>
<h3 id="Kafka-高可用设计"><a class="headerlink" href="#Kafka-高可用设计"></a>Kafka 高可用设计</h3>
<hr>
<h4 id="集群"><a class="headerlink" href="#集群"></a>集群</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716184512770.png" alt="Kafka集群" loading="lazy"></p>
<ul>
<li>Kafka 的服务器端由被称为 Broker 的 服务进程 构成，即一个 Kafka 集群由多个 Broker 组成</li>
<li>如果 集群 中某一台 机器宕机，其他机器上的 Broker 也依然能够对外提供服务。这其实就是 <strong>Kafka 提供高可用的手段之一</strong></li>
</ul>
<hr>
<h4 id="备份机制-Replication）"><a class="headerlink" href="#备份机制-Replication）"></a>备份机制 (Replication）</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716184648850.png" alt="Kafka备份机制" loading="lazy"></p>
<p>Kafka 中消息的备份又叫做 副本（Replica）</p>
<p>Kafka 定义了两类副本：</p>
<ul>
<li>领导者副本（Leader Replica）</li>
<li>追随者副本（Follower Replica）</li>
</ul>
<p><strong>同步方式</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716184917054.png" alt="Kafka备份机制-同步方式" loading="lazy"></p>
<ul>
<li>ISR（in-sync replica）：需要 同步复制保存 的 follower</li>
<li>如果 leader 失效后，需要选出新的 leader
<ul>
<li>选举的原则如下：
<ul>
<li>第一：选举时优先从 ISR 中选定，因为这个列表中 follower 的数据是与 leader 同步的</li>
<li>第二：如果 ISR 列表中的 follower 都不行了，就只能从其他 follower 中选取</li>
</ul>
</li>
</ul>
</li>
<li>极端情况，就是 所有副本 都 失效 了
<ul>
<li>这时有两种方案：
<ul>
<li>第一：等待 ISR 中的一个活过来，选为 Leader，数据可靠，但活过来的时间不确定</li>
<li>第二：选择第一个活过来的 副本（Replication），不一定是 ISR 中的，选为 leader，以最快速度恢复可用性，但数据不一定完整</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="Kafka-生产者详解"><a class="headerlink" href="#Kafka-生产者详解"></a>Kafka 生产者详解</h3>
<hr>
<h4 id="发送类型"><a class="headerlink" href="#发送类型"></a>发送类型</h4>
<hr>
<p><strong>同步发送</strong></p>
<p>使用 send() 方法发送，它会返回一个 Future 对象，调用 get() 方法进行等待，就可以知道消息是否发送成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 第一个参数：topic</span></span><br><span class="line"><span class="comment"> * 第二个参数：消息的key</span></span><br><span class="line"><span class="comment"> * 第三个参数：消息的value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ProducerRecord&lt;String, String&gt; kvProducerRecord = <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;String, String&gt;(<span class="string">&quot;topic-first&quot;</span>, <span class="string">&quot;key-001&quot;</span>,<span class="string">&quot;hello kafka&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步发送消息</span></span><br><span class="line"><span class="type">RecordMetadata</span> <span class="variable">recordMetadata</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    recordMetadata = producer.send(kvProducerRecord).get();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; </span><br><span class="line">System.out.println(recordMetadata.offset()); <span class="comment">// 打印偏移量</span></span><br></pre></td></tr></table></figure>
<p><strong>异步发送</strong></p>
<p>调用 send() 方法，并指定一个回调函数，服务器在返回响应时调用函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 第一个参数：topic</span></span><br><span class="line"><span class="comment"> * 第二个参数：消息的key</span></span><br><span class="line"><span class="comment"> * 第三个参数：消息的value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ProducerRecord&lt;String, String&gt; kvProducerRecord = <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;String, String&gt;(<span class="string">&quot;topic-first&quot;</span>, <span class="string">&quot;key-001&quot;</span>,<span class="string">&quot;hello kafka&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步消息发送</span></span><br><span class="line">producer.send(kvProducerRecord, <span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(RecordMetadata recordMetadata, Exception e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里可以异步记录异常信息到日志表中</span></span><br><span class="line">            System.out.println(<span class="string">&quot;记录异常信息到日志表中&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(recordMetadata.offset());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="参数说明"><a class="headerlink" href="#参数说明"></a>参数说明</h4>
<hr>
<p><strong>ack</strong></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716190952391.png" alt="ack配置" loading="lazy"></p>
<p>参数表格：</p>
<table>
<thead>
<tr>
<th><strong>确认机制</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>acks=0</td>
<td>生产者在成功写入消息之前 不会等待任何来自服务器 的响应，消息有丢失的风险，但是速度最快</td>
</tr>
<tr>
<td>acks=1（默认值）</td>
<td>只要集群首领节点收到消息，生产者就会收到一个来自服务器的成功响应</td>
</tr>
<tr>
<td>acks=all</td>
<td>只有当所有参与赋值的节点全部收到消息时，生产者才会收到一个来自服务器的成功响应</td>
</tr>
</tbody>
</table>
<p>eg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ack配置 消息确认机制</span></span><br><span class="line"><span class="comment">// 只有当所有的副本同步之后，消息才会发送成功</span></span><br><span class="line">prop.put(ProducerConfig.ACKS_CONFIG, <span class="string">&quot;all&quot;</span>);</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>retries</strong></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716191352783.png" alt="retries配置" loading="lazy"></p>
<p>生产者从服务器收到的错误有可能是 临时性错误，在这种情况下，retries 参数的值决定了生产者可以重发消息的次数，如果达到这个次数，生产者会放弃重试返回错误，默认情况下，生产者会在每次重试之间等待100ms</p>
<p>eg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重试次数</span></span><br><span class="line"><span class="comment">// 当生产者发送消息，首领没有确认之后，会重试进行发送，一直发送10次</span></span><br><span class="line">prop.put(ProducerConfig.RETRIES_CONFIG, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>消息压缩</strong></p>
<p>默认情况下， 消息发送时 不会被压缩</p>
<table>
<thead>
<tr>
<th><strong>压缩算法</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>snappy</td>
<td>占用较少的  CPU，  却能提供较好的性能和相当可观的压缩比， 如果看重性能和网络带宽，建议采用</td>
</tr>
<tr>
<td>lz4</td>
<td>占用较少的 CPU， 压缩和解压缩速度较快，压缩比也很客观</td>
</tr>
<tr>
<td>gzip</td>
<td>占用较多的  CPU，但会提供更高的压缩比，网络带宽有限，可以使用这种算法</td>
</tr>
</tbody>
</table>
<p>使用 压缩 可以 降低网络传输开销 和 存储开销，而这往往是向 Kafka 发送消息的瓶颈所在</p>
<p>eg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据压缩</span></span><br><span class="line">prop.put(ProducerConfig.COMPRESSION_TYPE_CONFIG, <span class="string">&quot;snappy&quot;</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Kafka-消费者详解"><a class="headerlink" href="#Kafka-消费者详解"></a>Kafka 消费者详解</h3>
<hr>
<h4 id="消费者组"><a class="headerlink" href="#消费者组"></a>消费者组</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716192019467.png" alt="消费者组" loading="lazy"></p>
<ul>
<li>
<p>消费者组（Consumer Group） ：指的就是由 一个 或 多个 消费者 组成的 群体</p>
</li>
<li>
<p>一个发布在 topic 上消息被分发给此 消费者组 中的 一个消费者</p>
<ul>
<li>
<p>所有的 消费者 都在 一个组（group） 中，那么这就变成了 queue 模型</p>
</li>
<li>
<p>所有的 消费者 都在 不同的组（group） 中，那么就完全变成了 发布-订阅 模型</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="消费有序性"><a class="headerlink" href="#消费有序性"></a>消费有序性</h4>
<hr>
<p>应用场景：</p>
<ul>
<li>
<p>即时消息中的 单对单聊天 和 群聊，保证 发送方消息 发送顺序 与 接收方的顺序 一致</p>
</li>
<li>
<p>充值转账 两个渠道 在 同一个时间 进行 余额变更，短信通知 必须要 有顺序</p>
</li>
<li>
<p>…</p>
</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716192944836.png" alt="举例" loading="lazy"></p>
<ul>
<li>kafka集群 托管 4 个分区（P0-P3），2个 消费者 组，消费组A 有 2 个 消费者，消费组B 有 4 个</li>
<li>topic分区 中 消息 只能由 消费者组 中的 唯一一个消费者 处理，所以消息肯定是按照 先后顺序 进行处理的</li>
<li>但是它也仅仅是保证 Topic 的 一个分区 顺序处理，不能保证跨分区的消息先后处理顺序。 所以，<strong>如果想要顺序的处理Topic的所有消息，那就只提供一个分区</strong></li>
</ul>
<hr>
<h4 id="提交-和-偏移量"><a class="headerlink" href="#提交-和-偏移量"></a>提交 和 偏移量</h4>
<hr>
<p>kafka不会像其他 JMS 队列那样需要得到 消费者的确认，消费者可以使用 kafka 来追踪消息在 分区的位置（偏移量）</p>
<p>消费者会往一个叫做 <code>_consumer_offset</code> 的 特殊主题 发送消息，消息里包含了每个分区的 偏移量</p>
<p>如果消费者发生 崩溃 或 有新的消费者加入群组，就会 <strong>触发再均衡</strong></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716193913705.png" alt="再均衡" loading="lazy"></p>
<p>如果 消费者2 挂掉以后，会发生再均衡，消费者2负责的分区会被其他消费者进行消费，再均衡后不可避免会出现一些问题：</p>
<ul>
<li>
<p><strong>问题1</strong>：如果提交偏移量小于客户端处理的最后一个消息的偏移量，那么处于两个偏移量之间的消息就会被重复处理</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716194037974.png" alt="问题1" loading="lazy"></p>
</li>
<li>
<p><strong>问题2</strong>：如果提交的偏移量大于客户端的最后一个消息的偏移量，那么处于两个偏移量之间的消息将会丢失</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716194115509.png" alt="问题2" loading="lazy"></p>
</li>
</ul>
<p>如果想要解决这些问题，还要知道目前 kafka 提交偏移量的方式：</p>
<ul>
<li>
<p>提交偏移量的方式有两种，分别是 自动提交偏移量 和 手动提交偏移量</p>
<ul>
<li>
<p><strong>自动提交偏移量</strong></p>
<ul>
<li>当 <code>enable.auto.commit</code> 被设置为 true，提交方式就是让 消费者 自动提交偏移量，每隔 5 秒消费者会自动把从 poll() 方法接收的 最大偏移量 提交上去</li>
</ul>
</li>
<li>
<p><strong>手动提交偏移量</strong></p>
<ul>
<li>
<p>手动提交 ，当 <code>enable.auto.commit</code> 被设置为 false 可以有以下三种提交方式：</p>
<ul>
<li>
<p>提交当前偏移量（同步提交）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手动添加偏移量</span></span><br><span class="line">prop.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在拉去消息代码中添加</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 同步提交偏移量</span></span><br><span class="line">    consumer.commitSync();</span><br><span class="line">&#125; <span class="keyword">catch</span> (CommitFailedException e) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;记录提交失败的异常: &quot;</span> + e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>异步提交</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手动添加偏移量</span></span><br><span class="line">prop.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步方式提交偏移量</span></span><br><span class="line">consumer.commitAsync(<span class="keyword">new</span> <span class="title class_">OffsetCommitCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">(Map&lt;TopicPartition, OffsetAndMetadata&gt; map, Exception e)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;记录错误的提交偏移量：&quot;</span> + map + <span class="string">&quot;，异常信息为：&quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>同步和异步组合提交</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手动添加偏移量</span></span><br><span class="line">prop.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(<span class="number">1000</span>));</span><br><span class="line">        <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;</span><br><span class="line">            System.out.println(consumerRecord.key());</span><br><span class="line">            System.out.println(consumerRecord.value());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 异步提交偏移量</span></span><br><span class="line">        consumer.commitAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    System.out.println(<span class="string">&quot;记录错误的信息：&quot;</span> + e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 同步提交偏移量</span></span><br><span class="line">    consumer.commitSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="SpringBoot集成Kafka收发消息"><a class="headerlink" href="#SpringBoot集成Kafka收发消息"></a>SpringBoot集成Kafka收发消息</h3>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- kafkfa --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 resources 中创建文件 application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9991</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kafka-demo</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">key-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line">      <span class="attr">value-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">$&#123;spring.application.name&#125;-test</span></span><br><span class="line">      <span class="attr">key-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span></span><br><span class="line">      <span class="attr">value-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>消费生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在controller包下</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;itcast-topic&quot;</span>, <span class="string">&quot;程序员&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>消费消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在listener包下</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;itcast-topic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(message)) &#123;</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<p><strong>传递消息为对象</strong></p>
<p><strong>流程</strong>：</p>
<p>1、2 同上</p>
<p>消费生产者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// kafkaTemplate.send(&quot;itcast-topic&quot;, &quot;程序员&quot;);</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUsername(<span class="string">&quot;xiaowang&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;user-topic&quot;</span>, JSON.toJSONString(user));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消费消费者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;user-topic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(message)) &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(message, User.class);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="自媒体文章上下架功能完成"><a class="headerlink" href="#自媒体文章上下架功能完成"></a>自媒体文章上下架功能完成</h3>
<hr>
<h4 id="自媒体端"><a class="headerlink" href="#自媒体端"></a>自媒体端</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240716213415306.png" alt="自媒体文章上下架功能完成" loading="lazy"></p>
<p>接口定义：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>接口路径</td>
<td>/api/v1/news/down_or_up</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>DTO</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody>
</table>
<p>DTO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WmNewsDto</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 是否上架  0 下架  1 上架</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Short enable;</span><br><span class="line">                       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>在 heima-leadnews-wemedia 工程下的 WmNewsController 新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/down_or_up&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">downOrUp</span><span class="params">(<span class="meta">@RequestBody</span> WmNewsDto dto)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 WmNewsDto 中新增 enable 属性</p>
</li>
<li>
<p>在 WmNewsService 新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章的上下架</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">downOrUp</span><span class="params">(WmNewsDto dto)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章的上下架</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> wmNewsDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">downOrUp</span><span class="params">(WmNewsDto wmNewsDto)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 检查参数</span></span><br><span class="line">    <span class="keyword">if</span> (wmNewsDto.getId() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 查询文章</span></span><br><span class="line">    <span class="type">WmNews</span> <span class="variable">wmNews</span> <span class="operator">=</span> getById(wmNewsDto.getId());</span><br><span class="line">    <span class="keyword">if</span> (wmNews == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST, <span class="string">&quot;文章不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 判断文章是否已发布</span></span><br><span class="line">    <span class="keyword">if</span> (!wmNews.getStatus().equals(WmNews.Status.PUBLISHED.getCode())) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID, <span class="string">&quot;当前文章不是发布状态，不能上下架&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 修改文章 enable</span></span><br><span class="line">    <span class="keyword">if</span> (wmNewsDto.getEnable() != <span class="literal">null</span> &amp;&amp; wmNewsDto.getEnable() &gt; -<span class="number">1</span> &amp;&amp; wmNewsDto.getEnable() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        update(Wrappers.&lt;WmNews&gt;lambdaUpdate().set(WmNews::getEnable, wmNewsDto.getEnable())</span><br><span class="line">                .eq(WmNews::getId, wmNewsDto.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h4 id="article端"><a class="headerlink" href="#article端"></a>article端</h4>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>导入 Kafka 依赖（在 heima-leadnews-common模块中 ）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- kafkfa --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 自媒体端 的 nacos 配置中心配置 kafka 的生产者（在 heima-leadnews-wemedia模块中 ）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">key-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line">      <span class="attr">value-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 自媒体端 文章上下架后 发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4. 修改文章 enable</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (wmNews.getArticleId() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 发送消息，通知article修改文章的配置</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;articleId&quot;</span>, wmNews.getArticleId());</span><br><span class="line">        map.put(<span class="string">&quot;enable&quot;</span>, wmNewsDto.getEnable());</span><br><span class="line">        kafkaTemplate.send(WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC, JSON.toJSONString(map));</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义一个 常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WmNewsMessageConstants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WM_NEWS_UP_OR_DOWN_TOPIC=<span class="string">&quot;wm.news.up.or.down.topic&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 article 端的 nacos 配置中心配置 kafka 的消费者（在 heima-leadnews-article 模块中）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">      <span class="attr">key-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span></span><br><span class="line">      <span class="attr">value-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 article 端编写监听，接收数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleDownListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApArticleConfigService apArticleConfigService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(message)) &#123;</span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> JSON.parseObject(message, Map.class);</span><br><span class="line">            apArticleConfigService.updateByMap(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改 ap_article_config 表的数据</p>
</li>
<li>
<p>新建 ApArticleConfigService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApArticleConfigService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;ApArticleConfig&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改文章</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateByMap</span><span class="params">(Map map)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApArticleConfigServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ApArticleConfigMapper, ApArticleConfig&gt; <span class="keyword">implements</span> <span class="title class_">ApArticleConfigService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改文章</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateByMap</span><span class="params">(Map map)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 0 下架 1 上架</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">enable</span> <span class="operator">=</span> map.get(<span class="string">&quot;enable&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isDown</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (enable.equals(<span class="number">1</span>)) &#123;</span><br><span class="line">            isDown = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改文章</span></span><br><span class="line">        update(Wrappers.&lt;ApArticleConfig&gt;lambdaUpdate()</span><br><span class="line">                .eq(ApArticleConfig::getArticleId, map.get(<span class="string">&quot;articleId&quot;</span>))</span><br><span class="line">                .set(ApArticleConfig::getIsDown, isDown));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="app端文章搜索"><a class="headerlink" href="#app端文章搜索"></a>app端文章搜索</h2>
<hr>
<h3 id="搭建-ElasticSearch-环境"><a class="headerlink" href="#搭建-ElasticSearch-环境"></a>搭建 ElasticSearch 环境</h3>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:7.4.0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name elasticsearch -d --restart=always -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e &quot;discovery.type=single-node&quot; elasticsearch:7.4.0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置中文分词器 <code>ik</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/elasticsearch/plugins</span><br><span class="line"></span><br><span class="line">sudo mkdir analysis-ik</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果没有rz命令，执行 sudo apt install lrzsz</span></span><br><span class="line">rz</span><br></pre></td></tr></table></figure>
<ul>
<li>这部分安装详情见 ElasticSearch 的笔记部分</li>
</ul>
</li>
<li>
<p>Postman 测试</p>
</li>
</ol>
<hr>
<h3 id="app端文章搜索功能实现"><a class="headerlink" href="#app端文章搜索功能实现"></a>app端文章搜索功能实现</h3>
<hr>
<p><strong>功能实现</strong>：</p>
<ul>
<li>
<p>用户输入关键可搜索文章列表</p>
</li>
<li>
<p>关键词高亮显示</p>
</li>
<li>
<p>文章列表展示与 home 展示一样，当用户点击某一篇文章，可查看文章详情</p>
</li>
</ul>
<p><strong>思路分析</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724145836181.png" alt="思路分析" loading="lazy"></p>
<p><strong>创建对应的索引和映射</strong>：</p>
<p>可以在 kibana 创建索引库，具体操作说明见之前的 ES 笔记</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">PUT /app_info_article</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;publishTime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;layout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;staticUrl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;authorId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;authorName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="数据初始化到索引库"><a class="headerlink" href="#数据初始化到索引库"></a>数据初始化到索引库</h4>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>导入 es-init 到 heima-leadnews-test 工程下，用于数据的导入</p>
</li>
<li>
<p>查询所有的文章信息，批量导入到 es 索引库中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApArticleTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注意：数据量的导入，如果数据量过大，需要分页导入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApArticleMapper apArticleMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 查询所有符合条件的文章数据</span></span><br><span class="line">        List&lt;SearchArticleVo&gt; list = apArticleMapper.loadArticleList();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 批量导入到es索引库</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>(<span class="string">&quot;app_info_article&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchArticleVo searchArticleVo : list) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// IndexRequest 表示新增</span></span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>()</span><br><span class="line">                    .id(searchArticleVo.getId().toString())</span><br><span class="line">                    .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 批量添加数据</span></span><br><span class="line">            request.add(indexRequest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        restHighLevelClient.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>其中 ApArticleMapper 中 loadArticleList 的实现为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.heima.es.mapper.ApArticleMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;resultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.heima.es.pojo.SearchArticleVo&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;title&quot;</span> <span class="attr">property</span>=<span class="string">&quot;title&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;author_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;authorId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;author_name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;authorName&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;layout&quot;</span> <span class="attr">property</span>=<span class="string">&quot;layout&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;images&quot;</span> <span class="attr">property</span>=<span class="string">&quot;images&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;publish_time&quot;</span> <span class="attr">property</span>=<span class="string">&quot;publishTime&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;static_url&quot;</span> <span class="attr">property</span>=<span class="string">&quot;staticUrl&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;content&quot;</span> <span class="attr">property</span>=<span class="string">&quot;content&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadArticleList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;resultMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            aa.*, aacon.content</span><br><span class="line">        FROM</span><br><span class="line">            `ap_article` aa,</span><br><span class="line">            ap_article_config aac,</span><br><span class="line">            ap_article_content aacon</span><br><span class="line">        WHERE</span><br><span class="line">            aa.id = aac.article_id</span><br><span class="line">          AND aa.id = aacon.article_id</span><br><span class="line">          AND aac.is_delete != 1</span><br><span class="line">          AND aac.is_down != 1</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h4 id="文章搜索功能实现"><a class="headerlink" href="#文章搜索功能实现"></a>文章搜索功能实现</h4>
<hr>
<p><strong>实现接口的定义</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724152944745.png" alt="文章搜索功能实现" loading="lazy"></p>
<p><strong>UserSearchDto 的定义</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSearchDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 搜索关键字</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    String searchWords;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 当前页</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">int</span> pageNum;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 分页条数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">int</span> pageSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 最小时间</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Date minBehotTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getFromIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.pageNum&lt;<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.pageSize&lt;<span class="number">1</span>) <span class="built_in">this</span>.pageSize = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.pageSize * (pageNum-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>实现流程</strong>：</p>
<ol>
<li>
<p>创建  heima-leadnews-search 的模块</p>
</li>
<li>
<p>在 heima-leadnews-service 的 pom 中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--elasticsearch--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 nacos 配置中心 leadnews-search</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">autoconfigure:</span></span><br><span class="line">  <span class="comment"># 搜索微服务不需要连接数据库，要把该字段忽略</span></span><br><span class="line">    <span class="attr">exclude:</span> <span class="string">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9200</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>搜索接口的定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/article/search&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleSearchController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleSearchService articleSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(<span class="meta">@RequestBody</span> UserSearchDto dto)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> articleSearchService.search(dto);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建业务层接口：ApArticleSearchService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ArticleSearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * es文章分页检索</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(UserSearchDto dto)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleSearchServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ArticleSearchService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * es文章分页检索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(UserSearchDto dto)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 检查参数</span></span><br><span class="line">        <span class="keyword">if</span> (dto == <span class="literal">null</span> || StringUtils.isBlank(dto.getSearchWords())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置查询条件</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;app_info_article&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// boolean查询</span></span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1 关键字的分词之后查询</span></span><br><span class="line">        <span class="type">QueryStringQueryBuilder</span> <span class="variable">queryStringQueryBuilder</span> <span class="operator">=</span> QueryBuilders.queryStringQuery(dto.getSearchWords())</span><br><span class="line">                .field(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;content&quot;</span>)</span><br><span class="line">                .defaultOperator(Operator.OR);</span><br><span class="line"></span><br><span class="line">        boolQueryBuilder.must(queryStringQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2 查询小于mindate的数据</span></span><br><span class="line">        <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQueryBuilder</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;publishTime&quot;</span>)</span><br><span class="line">                .lt(dto.getMinBehotTime().getTime());</span><br><span class="line"></span><br><span class="line">        boolQueryBuilder.filter(rangeQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.3 分页查询</span></span><br><span class="line">        searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.size(dto.getPageSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.4 按照发布时间倒序查询</span></span><br><span class="line">        searchSourceBuilder.sort(<span class="string">&quot;publishTime&quot;</span>, SortOrder.DESC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.5 设置高亮 title</span></span><br><span class="line">        <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">        highlightBuilder.field(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置高亮的前缀</span></span><br><span class="line">        highlightBuilder.preTags(<span class="string">&quot;&lt;font style=&#x27;color: red; font-size: inherit;&#x27;&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置高亮的后缀</span></span><br><span class="line">        highlightBuilder.postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        request.source(searchSourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 结果封装返回</span></span><br><span class="line"></span><br><span class="line">        List&lt;Map&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        SearchHit[] hits = response.getHits().getHits();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> JSON.parseObject(json, Map.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理高亮</span></span><br><span class="line">            <span class="keyword">if</span> (hit.getHighlightFields() != <span class="literal">null</span> &amp;&amp; hit.getHighlightFields().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Text[] titles = hit.getHighlightFields().get(<span class="string">&quot;title&quot;</span>).getFragments();</span><br><span class="line">                <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> StringUtils.join(titles);</span><br><span class="line">                <span class="comment">// 高亮标题</span></span><br><span class="line">                map.put(<span class="string">&quot;h_title&quot;</span>, title);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 原始标题</span></span><br><span class="line">                map.put(<span class="string">&quot;h_title&quot;</span>, map.get(<span class="string">&quot;title&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            list.add(map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 app 的网关中添加搜索微服务的路由配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#搜索微服务</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">leadnews-search</span></span><br><span class="line"> <span class="attr">uri:</span> <span class="string">lb://leadnews-search</span></span><br><span class="line"> <span class="attr">predicates:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">Path=/search/**</span></span><br><span class="line"> <span class="attr">filters:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">StripPrefix=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="新增文章创建索引"><a class="headerlink" href="#新增文章创建索引"></a>新增文章创建索引</h3>
<hr>
<p><strong>思路分析</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724172909212.png" alt="思路分析" loading="lazy"></p>
<p><strong>实现流程</strong>：</p>
<ol>
<li>
<p>在 model 模块下定义 SearchArticleVo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchArticleVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文章id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">// 文章标题</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">// 文章发布时间</span></span><br><span class="line">    <span class="keyword">private</span> Date publishTime;</span><br><span class="line">    <span class="comment">// 文章布局</span></span><br><span class="line">    <span class="keyword">private</span> Integer layout;</span><br><span class="line">    <span class="comment">// 封面</span></span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line">    <span class="comment">// 作者id</span></span><br><span class="line">    <span class="keyword">private</span> Long authorId;</span><br><span class="line">    <span class="comment">// 作者名词</span></span><br><span class="line">    <span class="keyword">private</span> String authorName;</span><br><span class="line">    <span class="comment">// 静态url</span></span><br><span class="line">    <span class="keyword">private</span> String staticUrl;</span><br><span class="line">    <span class="comment">// 文章内容</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在文章微服务的 ArticleFreemarkerService 中的 buildArticleToMinIO 方法中收集数据并发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleFreemarkerServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ArticleFreemarkerService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成静态文件上传到minio中</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apArticle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileStorageService fileStorageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApArticleService apArticleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildArticleToMinIO</span><span class="params">(ApArticle apArticle, String content)</span> &#123;</span><br><span class="line">        <span class="comment">// 已知文章id</span></span><br><span class="line">        <span class="comment">// 1. 获取文章内容</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(content)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 文章内容通过freemarker生成html文件</span></span><br><span class="line">            <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">StringWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                template = configuration.getTemplate(<span class="string">&quot;article.ftl&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 数据模型</span></span><br><span class="line">                Map&lt;String, Object&gt; contentDataModel = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                contentDataModel.put(<span class="string">&quot;content&quot;</span>, JSONArray.parseArray(content));</span><br><span class="line"></span><br><span class="line">                out = <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 合成</span></span><br><span class="line">                template.process(contentDataModel, out);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 把html文件上传到minio中</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(out.toString().getBytes());</span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> fileStorageService.uploadHtmlFile(<span class="string">&quot;&quot;</span>, apArticle.getId() + <span class="string">&quot;.html&quot;</span>, in);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 修改ap_article表，保存static_url字段</span></span><br><span class="line">            apArticleService.update(Wrappers.&lt;ApArticle&gt;lambdaUpdate().eq(ApArticle::getId, apArticle.getId())</span><br><span class="line">                    .set(ApArticle::getStaticUrl, path));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送消息，创建索引</span></span><br><span class="line">            createArticleESIndex(apArticle, content, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息，创建索引</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apArticle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createArticleESIndex</span><span class="params">(ApArticle apArticle, String content, String path)</span> &#123;</span><br><span class="line">        <span class="type">SearchArticleVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchArticleVo</span>();</span><br><span class="line">        BeanUtils.copyProperties(apArticle, vo);</span><br><span class="line">        vo.setContent(content);</span><br><span class="line">        vo.setStaticUrl(path);</span><br><span class="line"></span><br><span class="line">        kafkaTemplate.send(ArticleConstants.ARTICLE_ES_SYNC_TOPIC, JSON.toJSONString(vo));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 ArticleConstants 类中添加新的常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleConstants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Short</span> <span class="variable">LOADTYPE_LOAD_MORE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Short</span> <span class="variable">LOADTYPE_LOAD_NEW</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_TAG</span> <span class="operator">=</span> <span class="string">&quot;__all__&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARTICLE_ES_SYNC_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;article.es.sync.topic&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>文章微服务集成 kafka 发送消息，在文章微服务的 nacos 的配置中心添加配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">key-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line">      <span class="attr">value-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>搜索微服务中添加 kafka 监听，在文章微服务的 nacos 的配置中心添加配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">      <span class="attr">key-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span></span><br><span class="line">      <span class="attr">value-deserializer:</span> <span class="string">org.apache.kafka.common.serialization.StringDeserializer</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义监听接收消息，保存索引数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncArticleListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = ArticleConstants.ARTICLE_ES_SYNC_TOPIC)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(message)) &#123;</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;SyncArticleListener，message = &#123;&#125;&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">            <span class="type">SearchArticleVo</span> <span class="variable">searchArticleVo</span> <span class="operator">=</span> JSON.parseObject(message, SearchArticleVo.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;app_info_article&quot;</span>);</span><br><span class="line"></span><br><span class="line">            indexRequest.id(searchArticleVo.getId().toString());</span><br><span class="line"></span><br><span class="line">            indexRequest.source(message, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;sync es error = &#123;&#125;&quot;</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="app端搜索-记录功能实现"><a class="headerlink" href="#app端搜索-记录功能实现"></a>app端搜索 记录功能实现</h3>
<hr>
<p><strong>需求分析</strong>：</p>
<ul>
<li>展示用户的搜索记录10条，按照搜索关键词的时间倒序</li>
<li>可以删除搜索记录</li>
<li>保存历史记录，保存10条，多余的则删除最久的历史记录</li>
</ul>
<p><strong>数据存储说明</strong>：</p>
<p>用户的搜索记录，需要给 <strong>每一个用户都保存一份</strong>，数据量较大，要求加载速度快，通常这样的数据存储到 mongodb 更合适，不建议直接存储到关系型数据库中</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724175918300.png" alt="数据存储说明" loading="lazy"></p>
<hr>
<h4 id="MongoDB-安装与集成"><a class="headerlink" href="#MongoDB-安装与集成"></a>MongoDB 安装与集成</h4>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>直接在docker中安装MongoDB，先拉去镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mongo</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name mongo-service --restart=always -p 27017:27017 -v ~/data/mongodata:/data mongo</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>导入 mongo 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置 mongo 配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9998</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">      <span class="attr">database:</span> <span class="string">leadnews-history</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建集合的映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 联想词表</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itheima</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(&quot;ap_associate_words&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApAssociateWords</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 联想词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String associateWords;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>测试 增删改查</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(classes = MongoApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApAssociateWords</span> <span class="variable">apAssociateWords</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApAssociateWords</span>();</span><br><span class="line">        apAssociateWords.setAssociateWords(<span class="string">&quot;今日头条&quot;</span>);</span><br><span class="line">        apAssociateWords.setCreatedTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        mongoTemplate.save(apAssociateWords);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询一条信息</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveFindOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApAssociateWords</span> <span class="variable">apAssociateWords</span> <span class="operator">=</span> mongoTemplate</span><br><span class="line">                .findById(<span class="string">&quot;66a0d49c87e1db149c1afa76&quot;</span>, ApAssociateWords.class);</span><br><span class="line">        System.out.println(apAssociateWords);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 条件查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQuery</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;associateWords&quot;</span>).is(<span class="string">&quot;今日头条&quot;</span>))</span><br><span class="line">                .with(Sort.by(Sort.Direction.DESC, <span class="string">&quot;createdTime&quot;</span>));</span><br><span class="line">        List&lt;ApAssociateWords&gt; apAssociateWordsList = mongoTemplate.find(query, ApAssociateWords.class);</span><br><span class="line">        System.out.println(apAssociateWordsList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDel</span><span class="params">()</span> &#123;</span><br><span class="line">        mongoTemplate.remove(Query.query(Criteria.where(<span class="string">&quot;associateWords&quot;</span>).is(<span class="string">&quot;今日头条&quot;</span>)), ApAssociateWords.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h4 id="保存搜索记录-功能实现"><a class="headerlink" href="#保存搜索记录-功能实现"></a>保存搜索记录 功能实现</h4>
<hr>
<p><strong>实现思路</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724182238951.png" alt="实现思路" loading="lazy"></p>
<ul>
<li>用户输入关键字进行搜索的异步记录关键字</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724182336349.png" alt="整体保存记录实现思路" loading="lazy"></p>
<p><strong>用户搜索记录对应的集合，生成对应实体类</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(&quot;ap_user_search&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApUserSearch</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置nacos配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">   <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">leadnews-history</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建 ApUserSearchService 新增 insert 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApUserSearchServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ApUserSearchService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户搜索历史记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyword 搜索关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId  当前线程传过来的userid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String keyword, Integer userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查询当前用户的搜索关键词</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria</span><br><span class="line">                .where(<span class="string">&quot;userId&quot;</span>)</span><br><span class="line">                .is(userId)</span><br><span class="line">                .and(<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                .is(keyword));</span><br><span class="line">        <span class="type">ApUserSearch</span> <span class="variable">apUserSearch</span> <span class="operator">=</span> mongoTemplate.findOne(query, ApUserSearch.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 存在，更新创建时间</span></span><br><span class="line">        <span class="keyword">if</span> (apUserSearch != <span class="literal">null</span>) &#123;</span><br><span class="line">            apUserSearch.setCreatedTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            mongoTemplate.save(apUserSearch);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 不存在，判断当前历史记录总数量是否超过10</span></span><br><span class="line">        apUserSearch = <span class="keyword">new</span> <span class="title class_">ApUserSearch</span>();</span><br><span class="line">        apUserSearch.setUserId(userId);</span><br><span class="line">        apUserSearch.setKeyword(keyword);</span><br><span class="line">        apUserSearch.setCreatedTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query1</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;userId&quot;</span>).is(userId));</span><br><span class="line">        query1.with(Sort.by(Sort.Direction.DESC, <span class="string">&quot;createdTime&quot;</span>));</span><br><span class="line"></span><br><span class="line">        List&lt;ApUserSearch&gt; apUserSearchList = mongoTemplate.find(query1, ApUserSearch.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apUserSearchList == <span class="literal">null</span> || apUserSearchList.size() &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            mongoTemplate.save(apUserSearch);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">ApUserSearch</span> <span class="variable">lastUserSearch</span> <span class="operator">=</span> apUserSearchList.get(apUserSearchList.size() - <span class="number">1</span>);</span><br><span class="line">            mongoTemplate.findAndReplace(Query.query(Criteria.where(<span class="string">&quot;id&quot;</span>).is(lastUserSearch.getId())), apUserSearch);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>参考自媒体相关微服务，在搜索微服务中获取当前登录的用户（ThreadLocalUtils）</p>
<ul>
<li>流程：在app端网关中获取用户id存到header中，在utils下创建AppThreadLocalUtil，在search下创建一个拦截器，拦截用户id，同时在config包下创建WebMvcConfig，配置拦截器</li>
</ul>
</li>
<li>
<p>在 ArticleSearchService 的search方法中调用保存历史记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleSearchServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ArticleSearchService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * es文章分页检索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApUserSearchService apUserSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(UserSearchDto dto)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 检查参数</span></span><br><span class="line">        <span class="keyword">if</span> (dto == <span class="literal">null</span> || StringUtils.isBlank(dto.getSearchWords())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO：这里新增</span></span><br><span class="line">        <span class="comment">// 异步调用 保存搜索记录</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.1 获取当前的用户</span></span><br><span class="line">        <span class="type">ApUser</span> <span class="variable">apUser</span> <span class="operator">=</span> AppThreadLocalUtil.getUser();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apUser != <span class="literal">null</span> &amp;&amp; dto.getFromIndex() == <span class="number">0</span>) &#123;</span><br><span class="line">            apUserSearchService.insert(dto.getSearchWords(), apUser.getId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置查询条件</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;app_info_article&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// boolean查询</span></span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1 关键字的分词之后查询</span></span><br><span class="line">        <span class="type">QueryStringQueryBuilder</span> <span class="variable">queryStringQueryBuilder</span> <span class="operator">=</span> QueryBuilders.queryStringQuery(dto.getSearchWords())</span><br><span class="line">                .field(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;content&quot;</span>)</span><br><span class="line">                .defaultOperator(Operator.OR);</span><br><span class="line"></span><br><span class="line">        boolQueryBuilder.must(queryStringQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2 查询小于mindate的数据</span></span><br><span class="line">        <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQueryBuilder</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;publishTime&quot;</span>)</span><br><span class="line">                .lt(dto.getMinBehotTime().getTime());</span><br><span class="line"></span><br><span class="line">        boolQueryBuilder.filter(rangeQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.3 分页查询</span></span><br><span class="line">        searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.size(dto.getPageSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.4 按照发布时间倒序查询</span></span><br><span class="line">        searchSourceBuilder.sort(<span class="string">&quot;publishTime&quot;</span>, SortOrder.DESC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.5 设置高亮 title</span></span><br><span class="line">        <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">        highlightBuilder.field(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置高亮的前缀</span></span><br><span class="line">        highlightBuilder.preTags(<span class="string">&quot;&lt;font style=&#x27;color: red; font-size: inherit;&#x27;&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置高亮的后缀</span></span><br><span class="line">        highlightBuilder.postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        request.source(searchSourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 结果封装返回</span></span><br><span class="line"></span><br><span class="line">        List&lt;Map&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        SearchHit[] hits = response.getHits().getHits();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> JSON.parseObject(json, Map.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理高亮</span></span><br><span class="line">            <span class="keyword">if</span> (hit.getHighlightFields() != <span class="literal">null</span> &amp;&amp; hit.getHighlightFields().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Text[] titles = hit.getHighlightFields().get(<span class="string">&quot;title&quot;</span>).getFragments();</span><br><span class="line">                <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> StringUtils.join(titles);</span><br><span class="line">                <span class="comment">// 高亮标题</span></span><br><span class="line">                map.put(<span class="string">&quot;h_title&quot;</span>, title);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 原始标题</span></span><br><span class="line">                map.put(<span class="string">&quot;h_title&quot;</span>, map.get(<span class="string">&quot;title&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            list.add(map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>保存历史记录中开启异步调用，添加注解 <code>@Async</code>，以及在启动类添加注解 <code>@EnableAsync</code></p>
</li>
</ol>
<hr>
<h4 id="加载搜索历史-功能实现"><a class="headerlink" href="#加载搜索历史-功能实现"></a>加载搜索历史 功能实现</h4>
<hr>
<p><strong>接口说明</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724195156928.png" alt="接口说明" loading="lazy"></p>
<ul>
<li>按照当前用户，按照时间倒序查询</li>
</ul>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>在 controller 包下定义接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/history&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApUserSearchController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApUserSearchService apUserSearchService;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/load&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">findUserSearch</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> apUserSearchService.findUserSearch();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 ApUserSearchService 中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询搜索历史</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">findUserSearch</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询搜索历史</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">findUserSearch</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 获取当前用户</span></span><br><span class="line">    <span class="type">ApUser</span> <span class="variable">user</span> <span class="operator">=</span> AppThreadLocalUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 根据用户查询数据，按照时间倒序</span></span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;userId&quot;</span>)</span><br><span class="line">                    .is(user.getId()))</span><br><span class="line">            .with(Sort.by(Sort.Direction.DESC, <span class="string">&quot;createdTime&quot;</span>));</span><br><span class="line">    List&lt;ApUserSearch&gt; apUserSearches = mongoTemplate.find(query, ApUserSearch.class);</span><br><span class="line">    <span class="keyword">return</span> ResponseResult.okResult(apUserSearches);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h4 id="删除搜索历史-功能实现"><a class="headerlink" href="#删除搜索历史-功能实现"></a>删除搜索历史 功能实现</h4>
<hr>
<p><strong>接口说明</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724200658672.png" alt="接口说明" loading="lazy"></p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>在 ApUserSearchController 接口新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/del&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">delUserSearch</span><span class="params">(<span class="meta">@RequestBody</span> HistorySearchDto dto)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> apUserSearchService.delUserSearch(dto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建 HistorySearchDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HistorySearchDto</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 接收搜索历史记录id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    String id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 ApUserSearchService 中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除历史记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">delUserSearch</span><span class="params">(HistorySearchDto dto)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除历史记录</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">delUserSearch</span><span class="params">(HistorySearchDto dto)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 检查参数</span></span><br><span class="line">    <span class="keyword">if</span> (dto.getId() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 判断是否登录</span></span><br><span class="line">    <span class="type">ApUser</span> <span class="variable">user</span> <span class="operator">=</span> AppThreadLocalUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 删除</span></span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria</span><br><span class="line">            .where(<span class="string">&quot;userId&quot;</span>)</span><br><span class="line">            .is(user.getId())</span><br><span class="line">            .and(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">            .is(dto.getId()));</span><br><span class="line">    mongoTemplate.remove(query, ApUserSearch.class);</span><br><span class="line">    <span class="keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="app端搜索-关键字联系词实现"><a class="headerlink" href="#app端搜索-关键字联系词实现"></a>app端搜索 关键字联系词实现</h3>
<hr>
<p><strong>需求分析</strong>：</p>
<p>根据用户输入的关键字展示联想词</p>
<p><strong>对应的实体类</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 联想词表</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itheima</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(&quot;ap_associate_words&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApAssociateWords</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 联想词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String associateWords;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>搜索词-数据来源</strong>:</p>
<p>通常是网上搜索频率比较高的一些词，通常在企业中有两部分来源：</p>
<ol>
<li>自己维护搜索词
<ul>
<li>通过分析用户搜索频率较高的词，按照排名作为搜索词</li>
</ul>
</li>
<li>第三方获取
<ul>
<li>关键词规划师（百度）、5118、爱站网</li>
</ul>
</li>
</ol>
<p><strong>接口说明</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724202048324.png" alt="接口说明" loading="lazy"></p>
<p><strong>正则表达式说明</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240724202143943.png" alt="正则表达式说明" loading="lazy"></p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>在 ApAssociateWordsController 下新建接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/associate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApAssociateWordsController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApAssociateWordsService apAssociateWordsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(<span class="meta">@RequestBody</span> UserSearchDto dto)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> apAssociateWordsService.search(dto);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 ApAssociateWordsService 下新建 联想词业务层 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApAssociateWordsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索联想词</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(UserSearchDto dto)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApAssociateWordsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ApAssociateWordsService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索联想词</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">search</span><span class="params">(UserSearchDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 检查参数</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(dto.getSearchWords())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 分页检查</span></span><br><span class="line">        <span class="keyword">if</span> (dto.getPageSize() &gt; <span class="number">20</span>) &#123;</span><br><span class="line">            dto.setPageSize(<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 执行查询，模糊查询</span></span><br><span class="line">        <span class="comment">// regex 部分见上面的正则表达式说明</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria</span><br><span class="line">                .where(<span class="string">&quot;associateWords&quot;</span>)</span><br><span class="line">                .regex(<span class="string">&quot;.*?\\&quot;</span> + dto.getSearchWords() + <span class="string">&quot;.*&quot;</span>));</span><br><span class="line">        query.limit(dto.getPageSize());</span><br><span class="line">        List&lt;ApAssociateWords&gt; apAssociateWords = mongoTemplate.find(query, ApAssociateWords.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(apAssociateWords);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="热点文章-定时计算"><a class="headerlink" href="#热点文章-定时计算"></a>热点文章 - 定时计算</h2>
<hr>
<h3 id="目前存在的弊端"><a class="headerlink" href="#目前存在的弊端"></a>目前存在的弊端</h3>
<hr>
<p>目前实现的思路：从数据库直接按照发布 时间倒序 查询</p>
<ul>
<li>
<p>问题1：</p>
<p>如何访问量较大，直接查询数据库，压力较大</p>
</li>
<li>
<p>问题2：</p>
<p>新发布的文章会展示在前面，并不是热点文章</p>
</li>
</ul>
<p><strong>解决方案</strong>：</p>
<p>把 热点数据 存入 redis 进行展示</p>
<ul>
<li>判断文章是否是热点，有几项标准： 点赞数量，评论数量，阅读数量，收藏数量 …</li>
</ul>
<p>计算文章热度，有两种方案：</p>
<ul>
<li>
<p><strong>定时计算 文章热度</strong></p>
</li>
<li>
<p><strong>实时计算 文章热度</strong></p>
</li>
</ul>
<hr>
<h3 id="定时计算"><a class="headerlink" href="#定时计算"></a>定时计算</h3>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725120528332.png" alt="定时计算" loading="lazy"></p>
<ul>
<li>
<p>根据文章的行为（点赞、评论、阅读、收藏）计算文章的分值，利用定时任务每天完成一次计算</p>
</li>
<li>
<p>把分值较大的文章数据存入到 redis 中</p>
</li>
<li>
<p>App端用户查询文章列表的时候，优先从 redis 中查询热度较高的文章数据</p>
</li>
</ul>
<hr>
<h3 id="定时任务框架-xxljob"><a class="headerlink" href="#定时任务框架-xxljob"></a>定时任务框架 - xxljob</h3>
<hr>
<p>spring 传统的定时任务 <code>@Scheduled</code>，但是这样存在这一些问题 ：</p>
<ul>
<li>
<p>做集群任务的重复执行问题</p>
</li>
<li>
<p>cron表达式定义在代码之中，修改不方便</p>
</li>
<li>
<p>定时任务失败了，无法重试也没有统计</p>
</li>
<li>
<p>如果任务量过大，不能有效的分片执行</p>
</li>
</ul>
<p>解决这些问题的方案为：</p>
<ul>
<li><strong>xxl-job 分布式任务调度框架</strong></li>
</ul>
<hr>
<h3 id="分布式任务调度"><a class="headerlink" href="#分布式任务调度"></a>分布式任务调度</h3>
<hr>
<p>在分布式架构下，一个服务往往会部署多个实例来运行我们的业务，如果在这种分布式系统环境下运行任务调度，称之为 <strong>分布式任务调度</strong></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725121223199.png" alt="分布式任务调度" loading="lazy"></p>
<p>将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p>
<ol>
<li><strong>并行任务调度</strong>
<ul>
<li>并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的</li>
<li>如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</li>
</ul>
</li>
<li><strong>高可用</strong>
<ul>
<li>若某一个实例宕机，不影响其他实例来执行任务。</li>
</ul>
</li>
<li><strong>弹性扩容</strong>
<ul>
<li>当集群中增加实例就可以提高并执行任务的处理效率。</li>
</ul>
</li>
<li><strong>任务管理与监测</strong>
<ul>
<li>对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</li>
</ul>
</li>
</ol>
<p><strong>分布式任务调度面临的问题</strong>：</p>
<ul>
<li>当任务调度以集群方式部署，同一个任务调度可能会执行多次，例如：电商系统定期发放优惠券，就可能重复发放优惠券，对公司造成损失，信用卡还款提醒就会重复执行多次，给用户造成烦恼，所以需要控制相同的任务在多个运行实例上只执行一次。<strong>常见解决方案</strong>：
<ul>
<li><strong>分布式锁</strong>，多个实例在任务执行前首先需要获取锁，如果获取失败那么就证明有其他服务已经在运行，如果获取成功那么证明没有服务在运行定时任务，那么就可以执行</li>
<li><strong>ZooKeeper选举</strong>，利用 ZooKeeper 对 Leader 实例执行定时任务，执行定时任务的时候判断自己是否是Leader，如果不是则不执行，如果是则执行业务逻辑，这样也能达到目的</li>
</ul>
</li>
</ul>
<hr>
<h3 id="xxl-Job-介绍"><a class="headerlink" href="#xxl-Job-介绍"></a>xxl-Job 介绍</h3>
<hr>
<p>XXL-JOB 是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用</p>
<ul>
<li>源码地址：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></li>
<li>文档地址：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725122207285.png" alt="其他同类型产品" loading="lazy"></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725124524932.png" alt="xxl-job 源码说明" loading="lazy"></p>
<hr>
<h3 id="配置部署-“调度中心”"><a class="headerlink" href="#配置部署-“调度中心”"></a>配置部署 “调度中心”</h3>
<hr>
<p>作用：统一管理任务调度平台上调度任务，负责触发调度执行，并且提供任务管理平台</p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>初始化 “调度数据库”</p>
<ul>
<li>
<p>位置：<code>/xxl-job/doc/db/tables_xxl_job.sql</code>  共8张表</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725125219579.png" alt="表结构" loading="lazy"></p>
</li>
</ul>
</li>
<li>
<p>调度中心配置</p>
<ul>
<li>配置文件地址：<code>/xxl-job/xxl-job-admin/src/main/resources/application.properties</code></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### web</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/xxl-job-admin</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### actuator</span></span><br><span class="line"><span class="attr">management.server.servlet.context-path</span>=<span class="string">/actuator</span></span><br><span class="line"><span class="attr">management.health.mail.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### resources</span></span><br><span class="line"><span class="attr">spring.mvc.servlet.load-on-startup</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.mvc.static-path-pattern</span>=<span class="string">/static/**</span></span><br><span class="line"><span class="attr">spring.resources.static-locations</span>=<span class="string">classpath:/static/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### freemarker</span></span><br><span class="line"><span class="attr">spring.freemarker.templateLoaderPath</span>=<span class="string">classpath:/templates/</span></span><br><span class="line"><span class="attr">spring.freemarker.suffix</span>=<span class="string">.ftl</span></span><br><span class="line"><span class="attr">spring.freemarker.charset</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="attr">spring.freemarker.request-context-attribute</span>=<span class="string">request</span></span><br><span class="line"><span class="attr">spring.freemarker.settings.number_format</span>=<span class="string">0.##########</span></span><br><span class="line"><span class="attr">spring.freemarker.settings.new_builtin_class_resolver</span>=<span class="string">safer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### mybatis</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:/mybatis-mapper/*Mapper.xml</span></span><br><span class="line"><span class="comment">#mybatis.type-aliases-package=com.xxl.job.admin.core.model</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### xxl-job, datasource</span></span><br><span class="line"><span class="comment">### 这块要修改，连接本地自己的数据库</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### datasource-pool</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.minimum-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.maximum-pool-size</span>=<span class="string">30</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.auto-commit</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.idle-timeout</span>=<span class="string">30000</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.pool-name</span>=<span class="string">HikariCP</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.max-lifetime</span>=<span class="string">900000</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.connection-timeout</span>=<span class="string">10000</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.connection-test-query</span>=<span class="string">SELECT 1</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.validation-timeout</span>=<span class="string">1000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### xxl-job, email</span></span><br><span class="line"><span class="attr">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="attr">spring.mail.port</span>=<span class="string">25</span></span><br><span class="line"><span class="attr">spring.mail.username</span>=<span class="string">xxx@qq.com</span></span><br><span class="line"><span class="attr">spring.mail.from</span>=<span class="string">xxx@qq.com</span></span><br><span class="line"><span class="attr">spring.mail.password</span>=<span class="string">xxx</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class="string">javax.net.ssl.SSLSocketFactory</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### xxl-job, access token</span></span><br><span class="line"><span class="attr">xxl.job.accessToken</span>=<span class="string">default_token</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### xxl-job, i18n (default is zh_CN, and you can choose &quot;zh_CN&quot;, &quot;zh_TC&quot; and &quot;en&quot;)</span></span><br><span class="line"><span class="attr">xxl.job.i18n</span>=<span class="string">zh_CN</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">## xxl-job, triggerpool max size</span></span><br><span class="line"><span class="attr">xxl.job.triggerpool.fast.max</span>=<span class="string">200</span></span><br><span class="line"><span class="attr">xxl.job.triggerpool.slow.max</span>=<span class="string">100</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### xxl-job, log retention days</span></span><br><span class="line"><span class="attr">xxl.job.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>启动调度中心，调度中心网址是：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin/%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%99%BB%E5%BD%95%E8%B4%A6%E5%8F%B7%EF%BC%9Aadmin%EF%BC%8C%E5%AF%86%E7%A0%81%EF%BC%9A123456">http://localhost:8080/xxl-job-admin/，默认登录账号：admin，密码：123456</a></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725130129612.png" alt="调度中心界面" loading="lazy"></p>
</li>
</ol>
<hr>
<h3 id="配置部署调度中心（docker安装）"><a class="headerlink" href="#配置部署调度中心（docker安装）"></a>配置部署调度中心（docker安装）</h3>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>创建MySQL容器，初始化xxl-job的SQL脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql --restart=always -v /home/ljaer/mysql:/var/lib/mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e TZ=Asia/Shanghai -d mysql:8.0.26</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull xuxueli/xxl-job-admin:2.3.0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -e PARAMS=&quot;--spring.datasource.url=jdbc:mysql://192.168.88.129:3306/xxl_job?Unicode=true&amp;characterEncoding=UTF-8 \</span><br><span class="line">--spring.datasource.username=root \</span><br><span class="line">--spring.datasource.password=root&quot; \</span><br><span class="line">-p 8888:8080 -v /tmp:/data/applogs \</span><br><span class="line">--name xxl-job-admin --restart=always  -d xuxueli/xxl-job-admin:2.3.0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在按照配置部署 “调度中心” 的步骤完成</p>
</li>
</ol>
<hr>
<h3 id="xxl-Job-入门案例"><a class="headerlink" href="#xxl-Job-入门案例"></a>xxl-Job 入门案例</h3>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>登录调度中心，点击下图所示 “新建任务” 按钮，新建示例任务</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725134025684.png" alt="image-20240725134025684" loading="lazy"></p>
</li>
<li>
<p>创建 xxljob-demo 项目，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--xxl-job--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置 application.yml 配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8881</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.88.129:8888/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">xxl-job-executor-sample</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726101959604.png" alt="executor.appname" loading="lazy"></p>
</li>
<li>
<p>在 config 目录下，新建配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>任务代码，重要注解：<code>@XxlJob(&quot;JobHandler&quot;)</code></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240725135340126.png" alt="@XxlJob注解内容" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单任务示例（Bean模式下）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloJob</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;JobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">HelloJob</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;简单任务执行了 ... &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改任务调度中心新任务的corn表达式</span></span><br><span class="line"><span class="comment"> * CRON：0/1 * * * * ? * 表示每秒钟执行一次</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="任务详解"><a class="headerlink" href="#任务详解"></a>任务详解</h3>
<hr>
<h4 id="执行器"><a class="headerlink" href="#执行器"></a>执行器</h4>
<hr>
<ul>
<li>执行器：任务的绑定的执行器，任务触发调度时将会自动发现注册成功的执行器，实现任务自动发现功能</li>
<li>另一方面也可以方便的进行任务分组，每个任务必须绑定一个执行器</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726102544194.png" alt="执行器" loading="lazy"></p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AppName</td>
<td>是每个执行器集群的唯一标识 AppName，执行器会周期性以 AppName 为对象进行自动注册。可通过该配置自动发现注册成功的执行器, 供任务调度时使用</td>
</tr>
<tr>
<td>名称</td>
<td>执行器的名称，因为 AppName 限制字母数字等组成，可读性不强，名称为了提高执行器的可读性</td>
</tr>
<tr>
<td>排序</td>
<td>执行器的排序，系统中需要执行器的地方，如任务新增，将会按照该排序读取可用的执行器列表</td>
</tr>
<tr>
<td>注册方式</td>
<td>调度中心获取执行器地址的方式</td>
</tr>
<tr>
<td>机器地址</td>
<td>注册方式为 “手动录入” 时有效，支持人工维护执行器的地址信息</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="基础配置"><a class="headerlink" href="#基础配置"></a>基础配置</h4>
<hr>
<ul>
<li>
<p>执行器：每个任务必须绑定一个执行器, 方便给任务进行分组</p>
</li>
<li>
<p>任务描述：任务的描述信息，便于任务管理</p>
</li>
<li>
<p>负责人：任务的负责人</p>
</li>
<li>
<p>报警邮件：任务调度失败时邮件通知的邮箱地址，支持配置多邮箱地址，配置多个邮箱地址时用逗号分隔</p>
</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726103901470.png" alt="基础配置" loading="lazy"></p>
<hr>
<h4 id="调度类型"><a class="headerlink" href="#调度类型"></a>调度类型</h4>
<hr>
<p>调度类型：</p>
<ul>
<li>无：该类型不会主动触发调度</li>
<li>CRON：该类型将会通过 CRON，触发任务调度</li>
<li>固定速度：该类型将会以固定速度，触发任务调度，按照固定的间隔时间，周期性触发</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726104143515.png" alt="调度类型" loading="lazy"></p>
<hr>
<h4 id="任务配置"><a class="headerlink" href="#任务配置"></a>任务配置</h4>
<hr>
<ul>
<li>运行模式：
<ul>
<li>BEAN模式：任务以 JobHandler 方式维护在执行器端；需要结合 “JobHandler” 属性匹配执行器中任务</li>
</ul>
</li>
<li>JobHandler：运行模式为 “BEAN模式” 时生效，对应执行器中新开发的 JobHandler 类 <code>@JobHandler</code> 注解自定义的value值</li>
<li>执行参数：任务执行所需的参数</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726104514056.png" alt="任务配置" loading="lazy"></p>
<hr>
<h4 id="阻塞处理策略"><a class="headerlink" href="#阻塞处理策略"></a>阻塞处理策略</h4>
<hr>
<p>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略</p>
<ul>
<li>
<p>单机串行（默认）：调度请求进入单机执行器后，调度请求进入 FIFO(First Input First Output) 队列并以串行方式运行</p>
</li>
<li>
<p>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败</p>
</li>
<li>
<p>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务</p>
</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726104729314.png" alt="阻塞处理策略" loading="lazy"></p>
<hr>
<h4 id="路由策略"><a class="headerlink" href="#路由策略"></a>路由策略</h4>
<hr>
<p>当执行器集群部署时，提供丰富的路由策略，包括；</p>
<ul>
<li>
<p>FIRST（第一个）：固定选择第一个机器</p>
</li>
<li>
<p>LAST（最后一个）：固定选择最后一个机器</p>
</li>
<li>
<p><strong>ROUND（轮询）</strong></p>
</li>
<li>
<p>RANDOM（随机）：随机选择在线的机器</p>
</li>
<li>
<p>CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上</p>
</li>
<li>
<p>LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举</p>
</li>
<li>
<p>LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举</p>
</li>
<li>
<p>FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度</p>
</li>
<li>
<p>BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度</p>
</li>
<li>
<p><strong>SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务</strong></p>
</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726104905642.png" alt="路由策略" loading="lazy"></p>
<hr>
<h3 id="路由策略-（轮询）案例"><a class="headerlink" href="#路由策略-（轮询）案例"></a>路由策略 （轮询）案例</h3>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>修改任务为 轮询</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726105214559.png" alt="轮询模式" loading="lazy"></p>
</li>
<li>
<p>启动多个微服务，先编辑 application.yml 配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">$&#123;port:8881&#125;</span>  <span class="comment"># 默认端口号是8881</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.88.129:8888/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">xxl-job-executor-sample</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">$&#123;executor.port:9999&#125;</span> <span class="comment"># 默认执行器的端口号是9999</span></span><br></pre></td></tr></table></figure>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726143729006.png" alt="配置两个引导类" loading="lazy"></p>
</li>
<li>
<p>启动多个微服务，每个微服务轮询的去执行任务</p>
</li>
</ol>
<hr>
<h3 id="路由策略（分片广播）"><a class="headerlink" href="#路由策略（分片广播）"></a>路由策略（分片广播）</h3>
<hr>
<p>执行器集群部署时，任务路由策略选择 ”分片广播” 情况下，一次任务调度将会广播触发对应集群中所有执行器执行一次任务</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726145633569.png" alt="分片广播策略" loading="lazy"></p>
<p><strong>案例需求</strong>：让两个节点同时执行10000个任务，每个节点分别执行5000个任务</p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>创建分片执行器</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726154527654.png" alt="分片执行器" loading="lazy"></p>
</li>
<li>
<p>创建任务，路由策略为分片广播</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726154857611.png" alt="路由策略：分片广播" loading="lazy"></p>
</li>
<li>
<p>修改 yml 配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">$&#123;port:8881&#125;</span>  <span class="comment"># 默认端口号是8881</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.88.129:8888/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="comment"># 主要修改 executor.appname</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">xxl-job-sharding-executor</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">$&#123;executor.port:9999&#125;</span> <span class="comment"># 默认执行器的端口号是9999</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>分片广播代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloJob</span> &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取分片的参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取总分片</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 业务逻辑</span></span><br><span class="line">        List&lt;Integer&gt; list = getList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Integer integer : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (integer % shardTotal == shardIndex) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;当前第 &quot;</span> + shardIndex</span><br><span class="line">                        + <span class="string">&quot; 分片执行了，任务项为：&quot;</span> + integer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>分片参数
<ul>
<li><code>Shardindex</code>：当前分片序号（从0开始），执行器集群列表中当前执行器的序号</li>
<li><code>Shardtotal</code>：总分片数，执行器集群的总机器数量</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="热点文章-任务流程"><a class="headerlink" href="#热点文章-任务流程"></a>热点文章  任务流程</h3>
<hr>
<p><strong>需求分析</strong>：为每个频道缓存热度较高的30条文章优先展示</p>
<p>判断 文章热度较高 的标准是：阅读量，点赞，评论，收藏</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726160837966.png" alt="对应ap_article表" loading="lazy"></p>
<p><strong>实现思路</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726161714982.png" alt="实现思路" loading="lazy"></p>
<hr>
<h4 id="实现步骤"><a class="headerlink" href="#实现步骤"></a>实现步骤</h4>
<hr>
<p>由于分值计算不涉及到前端工程，也无需提供 api 接口，是一个纯后台的功能的开发</p>
<ol>
<li>
<p>由于计算完成新热数据后，需要给每个频道缓存一份数据，所以需要查询所有频道信息</p>
<ul>
<li>
<p>在 heima-leadnews-feign-api 定义远程接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;leadnews-wemedia&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IWemediaClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/v1/channel/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">getChannels</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 heima-leadnews-wemedia 端提供接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WemediaClient</span> <span class="keyword">implements</span> <span class="title class_">IWemediaClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WmChannelService wmChannelService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/v1/channel/list&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">getChannels</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> wmChannelService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>在 ApArticleMapper.xml 新增方法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findArticleListByLast5days&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;resultMap&quot;</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    aa.*</span><br><span class="line">    FROM</span><br><span class="line">    `ap_article` aa</span><br><span class="line">    LEFT JOIN ap_article_config aac ON aa.id = aac.article_id</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        and aac.is_delete != 1</span><br><span class="line">        and aac.is_down != 1</span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dayParam != null&quot;</span>&gt;</span></span><br><span class="line">            and aa.publish_time &lt;![CDATA[&gt;=]]&gt; #&#123;dayParam&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改 ApArticleMapper 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApArticleMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;ApArticle&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载文章列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type  1  加载更多   2记载最新</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ApArticle&gt; <span class="title function_">loadArticleList</span><span class="params">(ArticleHomeDto dto,Short type)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;ApArticle&gt; <span class="title function_">findArticleListByLast5days</span><span class="params">(<span class="meta">@Param(&quot;dayParam&quot;)</span> Date dayParam)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义业务层接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HotArticleService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算热点文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">computeHotArticle</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改 ArticleConstants 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleConstants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Short</span> <span class="variable">LOADTYPE_LOAD_MORE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Short</span> <span class="variable">LOADTYPE_LOAD_NEW</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_TAG</span> <span class="operator">=</span> <span class="string">&quot;__all__&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARTICLE_ES_SYNC_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;article.es.sync.topic&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">HOT_ARTICLE_LIKE_WEIGHT</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">HOT_ARTICLE_COMMENT_WEIGHT</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">HOT_ARTICLE_COLLECTION_WEIGHT</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOT_ARTICLE_FIRST_PAGE</span> <span class="operator">=</span> <span class="string">&quot;hot_article_first_page_&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建一个 vo 接收计算分值后的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotArticleVo</span> <span class="keyword">extends</span> <span class="title class_">ApArticle</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文章分值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现业务层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotArticleServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">HotArticleService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算热点文章</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApArticleMapper apArticleMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">computeHotArticle</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 查询前5天的文章数据</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">dateParam</span> <span class="operator">=</span> DateTime.now().minusDays(<span class="number">5</span>).toDate();</span><br><span class="line">        List&lt;ApArticle&gt; articleList = apArticleMapper.findArticleListByLast5days(dateParam);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 计算文章的分值</span></span><br><span class="line">        List&lt;HotArticleVo&gt; hotArticleVoList = computeHotArticle(articleList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 为每个频道缓存30条分值较高的文章</span></span><br><span class="line">        catchTagToRedis(hotArticleVoList);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为每个频道缓存30条分值较高的文章</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hotArticleVoList</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IWemediaClient wemediaClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">catchTagToRedis</span><span class="params">(List&lt;HotArticleVo&gt; hotArticleVoList)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 为每个频道缓存30条分值较高的文章</span></span><br><span class="line">        <span class="type">ResponseResult</span> <span class="variable">responseResult</span> <span class="operator">=</span> wemediaClient.getChannels();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (responseResult.getCode().equals(<span class="number">200</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">channelJson</span> <span class="operator">=</span> JSON.toJSONString(responseResult.getData());</span><br><span class="line">            List&lt;WmChannel&gt; wmChannels = JSON.parseArray(channelJson, WmChannel.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检索出每个频道的文章</span></span><br><span class="line">            <span class="keyword">if</span> (wmChannels != <span class="literal">null</span> &amp;&amp; wmChannels.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (WmChannel wmChannel : wmChannels) &#123;</span><br><span class="line">                    List&lt;HotArticleVo&gt; hotArticleVos = hotArticleVoList.stream()</span><br><span class="line">                            .filter(x -&gt; x.getChannelId().equals(wmChannel.getId()))</span><br><span class="line">                            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 给文章进行排序，取30条分值较高的文章存入redis</span></span><br><span class="line">                    <span class="comment">// key：为频道的id</span></span><br><span class="line">                    <span class="comment">// value：30条分值较高文章的数据</span></span><br><span class="line"></span><br><span class="line">                    hotArticleVos = hotArticleVos.stream()</span><br><span class="line">                            .sorted(Comparator</span><br><span class="line">                                    .comparing(HotArticleVo::getScore)</span><br><span class="line">                                    .reversed())</span><br><span class="line">                            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (hotArticleVos.size() &gt; <span class="number">30</span>) &#123;</span><br><span class="line">                        hotArticleVos = hotArticleVos.subList(<span class="number">0</span>, <span class="number">30</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    cacheService.set(ArticleConstants.HOT_ARTICLE_FIRST_PAGE + wmChannel.getId(), JSON.toJSONString(hotArticleVos));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置推荐数据</span></span><br><span class="line">        <span class="comment">// 给文章进行排序，取30条分值较高的文章存入redis</span></span><br><span class="line">        <span class="comment">// key：为频道的id</span></span><br><span class="line">        <span class="comment">// value：30条分值较高文章的数据</span></span><br><span class="line"></span><br><span class="line">        hotArticleVoList = hotArticleVoList.stream()</span><br><span class="line">                .sorted(Comparator</span><br><span class="line">                        .comparing(HotArticleVo::getScore)</span><br><span class="line">                        .reversed())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hotArticleVoList.size() &gt; <span class="number">30</span>) &#123;</span><br><span class="line">            hotArticleVoList = hotArticleVoList.subList(<span class="number">0</span>, <span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cacheService.set(ArticleConstants.DEFAULT_TAG, JSON.toJSONString(hotArticleVoList));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算文章的分值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> articleList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;HotArticleVo&gt; <span class="title function_">computeHotArticle</span><span class="params">(List&lt;ApArticle&gt; articleList)</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;HotArticleVo&gt; hotArticleVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (articleList != <span class="literal">null</span> &amp;&amp; articleList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ApArticle apArticle : articleList) &#123;</span><br><span class="line">                <span class="type">HotArticleVo</span> <span class="variable">hot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotArticleVo</span>();</span><br><span class="line">                BeanUtils.copyProperties(apArticle, hot);</span><br><span class="line">                <span class="type">Integer</span> <span class="variable">score</span> <span class="operator">=</span> computeScore(apArticle);</span><br><span class="line">                hot.setScore(score);</span><br><span class="line">                hotArticleVoList.add(hot);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hotArticleVoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算文章的具体分值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apArticle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer <span class="title function_">computeScore</span><span class="params">(ApArticle apArticle)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">score</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apArticle.getLikes() != <span class="literal">null</span>) &#123;</span><br><span class="line">            score += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apArticle.getViews() != <span class="literal">null</span>) &#123;</span><br><span class="line">            score += apArticle.getViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apArticle.getComment() != <span class="literal">null</span>) &#123;</span><br><span class="line">            score += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apArticle.getCollection() != <span class="literal">null</span>) &#123;</span><br><span class="line">            score += apArticle.getCollection() * ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 ArticleApplication 的引导类中添加注解 <code>@EnableFeignClients</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.heima.article.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.heima.apis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ArticleApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// Mybatis-Plus的分页插件</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="定时计算-任务流程"><a class="headerlink" href="#定时计算-任务流程"></a>定时计算 任务流程</h3>
<hr>
<h4 id="实现步骤-2"><a class="headerlink" href="#实现步骤-2"></a>实现步骤</h4>
<hr>
<ol>
<li>
<p>在 heima-leadnews-article 中的 pom 文件中新增依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--xxl-job--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 xxl-job-admin 中新建执行器和任务</p>
<ul>
<li>
<p>新建执行器：<code>leadnews-hot-article-executor</code></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726195346381.png" alt="新建执行器" loading="lazy"></p>
</li>
<li>
<p>新建任务：路由策略为 轮询，Cron表达式为 <code>0 0 2 * * ?</code></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726195536082.png" alt="新建任务" loading="lazy"></p>
</li>
</ul>
</li>
<li>
<p>leadnews-article 中的 config 目录下集成 xxl-job</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 nacos 中的 leadnews-article 下配置新增配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.200.130:8888/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">leadnews-hot-article-executor</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 article 微服务中新建任务类，路径为 com.heima.article.job</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComputeHotArticleJob</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HotArticleService hotArticleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;computerHotArticleJob&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;热文章分值计算调度任务开始执行...&quot;</span>);</span><br><span class="line">        hotArticleService.computeHotArticle();</span><br><span class="line">        log.info(<span class="string">&quot;热文章分值计算调度任务结束执行...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="查询文章接口改造"><a class="headerlink" href="#查询文章接口改造"></a>查询文章接口改造</h2>
<hr>
<p><strong>思路分析</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240726200806140.png" alt="思路分析" loading="lazy"></p>
<hr>
<h3 id="实现步骤-3"><a class="headerlink" href="#实现步骤-3"></a>实现步骤</h3>
<hr>
<ol>
<li>
<p>在 ApArticleService 中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载文章列表，并判断是不是首页</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type 1  加载更多  2  加载最新</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> firstPage true 是首页  false 非首页</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">load2</span><span class="params">(ArticleHomeDto dto, Short type, <span class="type">boolean</span> firstPage)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现方法 ApArticleServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载文章列表，并判断是不是首页</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type      1  加载更多  2  加载最新</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> firstPage true 是首页  false 非首页</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CacheService cacheService;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">load2</span><span class="params">(ArticleHomeDto dto, Short type, <span class="type">boolean</span> firstPage)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (firstPage) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> cacheService.get(ArticleConstants.HOT_ARTICLE_FIRST_PAGE + dto.getTag());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(jsonStr)) &#123;</span><br><span class="line">            List&lt;HotArticleVo&gt; hotArticleVoList = JSON.parseArray(jsonStr, HotArticleVo.class);</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.okResult(hotArticleVoList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> load(dto, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载首页</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/load&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">load</span><span class="params">(<span class="meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;</span><br><span class="line">    <span class="comment">// return apArticleService.load(dto, ArticleConstants.LOADTYPE_LOAD_MORE);</span></span><br><span class="line">    <span class="keyword">return</span> apArticleService.load2(dto, ArticleConstants.LOADTYPE_LOAD_MORE, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="Kafka-Stream"><a class="headerlink" href="#Kafka-Stream"></a>Kafka Stream</h2>
<hr>
<h3 id="实时流式计算"><a class="headerlink" href="#实时流式计算"></a>实时流式计算</h3>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731163347227.png" alt="批量数据 vs 流式数据" loading="lazy"></p>
<ul>
<li>流式计算就相当于上图的右侧扶梯，是 <strong>可以源源不断的产生数据，源源不断的接收数据，时间上是没有边界的</strong></li>
</ul>
<p><strong>应用场景</strong>：</p>
<ul>
<li>
<p>日志分析</p>
<ul>
<li>网站的用户访问日志进行实时的分析，计算访问量，用户画像，留存率等等，实时的进行数据分析，帮助企业进行决策</li>
</ul>
</li>
<li>
<p>大屏看板统计</p>
<ul>
<li>可以实时的查看网站注册数量，订单数量，购买数量，金额等</li>
</ul>
</li>
<li>
<p>公交实时数据</p>
<ul>
<li>可以随时更新公交车方位，计算多久到达站牌等</li>
</ul>
</li>
<li>
<p>实时文章分值计算</p>
<ul>
<li>头条类文章的分值计算，通过用户的行为实时文章的分值，分值越高就越被推荐</li>
</ul>
</li>
</ul>
<p><strong>技术方案选型</strong>：</p>
<ul>
<li>Hadoop</li>
<li>Apche Storm</li>
<li>Flink</li>
<li>Kafka Stream
<ul>
<li>可以轻松地将其嵌入任何 Java 应用程序中，并与用户为其流应用程序所拥有的任何现有打包，部署和操作工具集成</li>
</ul>
</li>
</ul>
<hr>
<h3 id="Kafka-Stream-使用"><a class="headerlink" href="#Kafka-Stream-使用"></a>Kafka Stream 使用</h3>
<hr>
<h4 id="概述"><a class="headerlink" href="#概述"></a>概述</h4>
<hr>
<p>Kafka Stream：是 Apache Kafka 从 0.10 版本引入的一个新Feature。它是<strong>提供了对存储于 Kafka 内的数据进行流式处理和分析的功能</strong></p>
<p><strong>Kafka Stream 的特点</strong>：</p>
<ul>
<li>Kafka Stream提供了一个非常简单而轻量的Library，它可以非常方便地嵌入任意Java应用中，也可以任意方式打包和部署</li>
<li>除了 Kafka 外，无任何外部依赖</li>
<li>充分利用 Kafka 分区机制实现水平扩展和顺序性保证</li>
<li>通过可容错的 state store 实现高效的状态操作（如windowed join和aggregation）</li>
<li>支持正好一次处理语义</li>
<li>提供记录级的处理能力，从而实现毫秒级的低延迟</li>
<li>支持基于事件时间的窗口操作，并且可处理晚到的数据（late arrival of records）</li>
<li>同时提供底层的处理原语 Processor（类似于Storm的spout和bolt），以及高层抽象的 DSL（类似于Spark的map/group/reduce）</li>
</ul>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731164245975.png" alt="Kafka Stream" loading="lazy"></p>
<hr>
<h4 id="关键概念"><a class="headerlink" href="#关键概念"></a>关键概念</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731164509202.png" alt="Kafka Stream消息流转" loading="lazy"></p>
<ul>
<li><strong>源处理器（Source Processor）</strong>：源处理器是一个没有任何上游处理器的特殊类型的流处理器。它从一个或多个kafka主题生成输入流。通过消费这些主题的消息并将它们转发到下游处理器</li>
<li><strong>Sink处理器</strong>：Sink处理器是一个没有下游流处理器的特殊类型的流处理器。它接收上游流处理器的消息发送到一个指定的<strong>Kafka主题</strong></li>
</ul>
<hr>
<h4 id="KStream"><a class="headerlink" href="#KStream"></a>KStream</h4>
<hr>
<ol>
<li>
<p>数据结构类似于 map（key-value 键值对）</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731164713920.png" alt="KStream" loading="lazy"></p>
</li>
<li>
<p><strong>KStream</strong> 数据流（data stream），即是一段顺序的，可以无限长，不断更新的数据集</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731164936850.png" alt="KStream数据流" loading="lazy"></p>
<ul>
<li>KStream 负责抽象的，就是数据流。与 Kafka 自身 topic 中的数据一样，类似日志，每一次操作都是 <strong>向其中插入（insert）新数据</strong></li>
</ul>
</li>
</ol>
<hr>
<h4 id="Kafka-Stream-入门案例"><a class="headerlink" href="#Kafka-Stream-入门案例"></a>Kafka Stream 入门案例</h4>
<hr>
<p><strong>需求</strong>：求单词个数（word count）</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731165301472.png" alt="需求分析" loading="lazy"></p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-streams<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>connect-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka-clients<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建 kafka stream入门案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 流式处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaStreamQuickStart</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. kafka的配置信息</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;192.168.88.129:9092&quot;</span>);</span><br><span class="line">        <span class="comment">// 获得kafkaStream的key的序列化器Serdes</span></span><br><span class="line">        properties.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class="line">        <span class="comment">// 获得kafkaStream的value的序列化器Serdes</span></span><br><span class="line">        properties.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class="line">        properties.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="string">&quot;streams-quickstart&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. stream的构建器</span></span><br><span class="line">        <span class="type">StreamsBuilder</span> <span class="variable">streamsBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamsBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 流式计算</span></span><br><span class="line">        streamProcessor(streamsBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建kafkaStream的对象</span></span><br><span class="line">        <span class="type">KafkaStreams</span> <span class="variable">kafkaStreams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KafkaStreams</span>(streamsBuilder.build(), properties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 开启流式计算</span></span><br><span class="line">        kafkaStreams.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流式计算</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 消息的内容：hello kafka hello world</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> streamsBuilder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">streamProcessor</span><span class="params">(StreamsBuilder streamsBuilder)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建kStream对象，同时指定在哪个topic中接收消息</span></span><br><span class="line">        KStream&lt;String, String&gt; stream = streamsBuilder.stream(<span class="string">&quot;coo1heisenberg-topic-input&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 处理消息的value值</span></span><br><span class="line">        stream.flatMapValues(<span class="keyword">new</span> <span class="title class_">ValueMapper</span>&lt;String, Iterable&lt;String&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Iterable&lt;String&gt; <span class="title function_">apply</span><span class="params">(String value)</span> &#123;</span><br><span class="line">                        String[] valAry = value.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                        List&lt;String&gt; valList = Arrays.asList(valAry);</span><br><span class="line">                        <span class="keyword">return</span> valList;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="comment">// 按照value进行聚合处理</span></span><br><span class="line">                &#125;).groupBy((key, value) -&gt; value)</span><br><span class="line">                <span class="comment">// 时间窗口</span></span><br><span class="line">                .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="number">10</span>)))</span><br><span class="line">                <span class="comment">// 统计单词的个数</span></span><br><span class="line">                .count()</span><br><span class="line">                <span class="comment">// 转换为kstream对象</span></span><br><span class="line">                .toStream()</span><br><span class="line">                .map((key, value) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;key: &quot;</span> + key + <span class="string">&quot;, value: &quot;</span> + value);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyValue</span>&lt;&gt;(key.key().toString(), value.toString());</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 发送消息</span></span><br><span class="line">                .to(<span class="string">&quot;coo1heisenberg-topic-out&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>测试准备</p>
<blockquote>
<p>使用生产者在 topic 为：coo1heisenberg_topic_input中发送多条消息</p>
<p>使用消费者接收 topic 为：coo1heisenberg_topic_out</p>
</blockquote>
</li>
<li>
<p>结果</p>
<ul>
<li>通过流式计算，会把生产者的多条消息汇总成一条发送到消费者中输出</li>
</ul>
</li>
</ol>
<hr>
<h4 id="SpringBoot-集成-Kafka-Stream"><a class="headerlink" href="#SpringBoot-集成-Kafka-Stream"></a>SpringBoot 集成 Kafka Stream</h4>
<hr>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>自定配置参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过重新注册KafkaStreamsConfiguration对象，设置自定配置参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableKafkaStreams</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;kafka&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaStreamConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_MESSAGE_SIZE</span> <span class="operator">=</span> <span class="number">16</span>* <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> String hosts;</span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line">    <span class="meta">@Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> KafkaStreamsConfiguration <span class="title function_">defaultKafkaStreamsConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);</span><br><span class="line">        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="built_in">this</span>.getGroup()+<span class="string">&quot;_stream_aid&quot;</span>);</span><br><span class="line">        props.put(StreamsConfig.CLIENT_ID_CONFIG, <span class="built_in">this</span>.getGroup()+<span class="string">&quot;_stream_cid&quot;</span>);</span><br><span class="line">        props.put(StreamsConfig.RETRIES_CONFIG, <span class="number">10</span>);</span><br><span class="line">        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class="line">        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaStreamsConfiguration</span>(props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改 application.yml 文件，在最下方添加自定义配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kafka:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>新增配置类，创建 KStream 对象，进行聚合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaStreamHelloList</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KStream&lt;String, String&gt; <span class="title function_">kStream</span><span class="params">(StreamsBuilder streamsBuilder)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建kStream对象，同时指定在哪个topic中接收消息</span></span><br><span class="line">        KStream&lt;String, String&gt; stream = streamsBuilder.stream(<span class="string">&quot;coo1heisenberg-topic-input&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 处理消息的value值</span></span><br><span class="line">        stream.flatMapValues(<span class="keyword">new</span> <span class="title class_">ValueMapper</span>&lt;String, Iterable&lt;String&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Iterable&lt;String&gt; <span class="title function_">apply</span><span class="params">(String value)</span> &#123;</span><br><span class="line">                        String[] valAry = value.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                        List&lt;String&gt; valList = Arrays.asList(valAry);</span><br><span class="line">                        <span class="keyword">return</span> valList;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 按照value进行聚合处理</span></span><br><span class="line">                &#125;).groupBy((key, value) -&gt; value)</span><br><span class="line">                <span class="comment">// 时间窗口</span></span><br><span class="line">                .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="number">10</span>)))</span><br><span class="line">                <span class="comment">// 统计单词的个数</span></span><br><span class="line">                .count()</span><br><span class="line">                <span class="comment">// 转换为kstream对象</span></span><br><span class="line">                .toStream()</span><br><span class="line">                .map((key, value) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;key: &quot;</span> + key + <span class="string">&quot;, value: &quot;</span> + value);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyValue</span>&lt;&gt;(key.key().toString(), value.toString());</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 发送消息</span></span><br><span class="line">                .to(<span class="string">&quot;coo1heisenberg-topic-out&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可注入 StreamsBuilder</li>
<li>返回值必须是 KStream 且放入spring容器中</li>
</ul>
</li>
<li>
<p>测试：</p>
<ul>
<li>启动微服务，正常发送消息，可以正常接收到消息</li>
</ul>
</li>
</ol>
<hr>
<h2 id="热点文章-实时计算"><a class="headerlink" href="#热点文章-实时计算"></a>热点文章 - 实时计算</h2>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731163048468.png" alt="定时计算 vs 实时计算" loading="lazy"></p>
<p><strong>思路说明</strong>：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240731183737899.png" alt="思路说明" loading="lazy"></p>
<p><strong>流程</strong>：</p>
<p><strong>用户行为（阅读量，评论，点赞，收藏）发送消息，以 阅读 和 点赞 为例</strong></p>
<ol>
<li>
<p>在 heima-leadnews-behavior 微服务中集成 kafka 生产者配置，修改nacos，新增内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">leadnews-behavior</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">key-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line">      <span class="attr">value-serializer:</span> <span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改ApLikesBehaviorServiceImpl新增发送消息</p>
</li>
<li>
<p>定义消息发送封装类：UpdateArticleMess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateArticleMess</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改文章的字段类型</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">private</span> UpdateArticleType type;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文章ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long articleId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据的增量，可为正负</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer add;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UpdateArticleType</span>&#123;</span><br><span class="line">        COLLECTION,COMMENT,LIKES,VIEWS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义topic常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotArticleConstants</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOT_ARTICLE_SCORE_TOPIC=<span class="string">&quot;hot.article.score.topic&quot;</span>;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ApLikesBehaviorServiceImpl 修改后的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApLikesBehaviorServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ApLikesBehaviorService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">like</span><span class="params">(LikesBehaviorDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.检查参数</span></span><br><span class="line">        <span class="keyword">if</span> (dto == <span class="literal">null</span> || dto.getArticleId() == <span class="literal">null</span> || checkParam(dto)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.是否登录</span></span><br><span class="line">        <span class="type">ApUser</span> <span class="variable">user</span> <span class="operator">=</span> AppThreadLocalUtil.getUser();</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">UpdateArticleMess</span> <span class="variable">mess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateArticleMess</span>();</span><br><span class="line">        mess.setArticleId(dto.getArticleId());</span><br><span class="line">        mess.setType(UpdateArticleMess.UpdateArticleType.LIKES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.点赞  保存数据</span></span><br><span class="line">        <span class="keyword">if</span> (dto.getOperation() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> cacheService.hGet(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID, <span class="string">&quot;已点赞&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存当前key</span></span><br><span class="line">            log.info(<span class="string">&quot;保存当前key:&#123;&#125; ,&#123;&#125;, &#123;&#125;&quot;</span>, dto.getArticleId(), user.getId(), dto);</span><br><span class="line">            cacheService.hPut(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString(), JSON.toJSONString(dto));</span><br><span class="line">            mess.setAdd(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 删除当前key</span></span><br><span class="line">            log.info(<span class="string">&quot;删除当前key:&#123;&#125;, &#123;&#125;&quot;</span>, dto.getArticleId(), user.getId());</span><br><span class="line">            cacheService.hDelete(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());</span><br><span class="line">            mess.setAdd(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送消息，数据聚合</span></span><br><span class="line">        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkParam</span><span class="params">(LikesBehaviorDto dto)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dto.getType() &gt; <span class="number">2</span> || dto.getType() &lt; <span class="number">0</span> || dto.getOperation() &gt; <span class="number">1</span> || dto.getOperation() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改阅读行为的类 ApReadBehaviorServiceImpl 发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApReadBehaviorServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ApReadBehaviorService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">readBehavior</span><span class="params">(ReadBehaviorDto dto)</span> &#123;</span><br><span class="line">        <span class="comment">//1.检查参数</span></span><br><span class="line">        <span class="keyword">if</span> (dto == <span class="literal">null</span> || dto.getArticleId() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.是否登录</span></span><br><span class="line">        <span class="type">ApUser</span> <span class="variable">user</span> <span class="operator">=</span> AppThreadLocalUtil.getUser();</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//更新阅读次数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">readBehaviorJson</span> <span class="operator">=</span> (String) cacheService.hGet(BehaviorConstants.READ_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(readBehaviorJson)) &#123;</span><br><span class="line">            <span class="type">ReadBehaviorDto</span> <span class="variable">readBehaviorDto</span> <span class="operator">=</span> JSON.parseObject(readBehaviorJson, ReadBehaviorDto.class);</span><br><span class="line">            dto.setCount((<span class="type">short</span>) (readBehaviorDto.getCount() + dto.getCount()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存当前key</span></span><br><span class="line">        log.info(<span class="string">&quot;保存当前key:&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, dto.getArticleId(), user.getId(), dto);</span><br><span class="line">        cacheService.hPut(BehaviorConstants.READ_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString(), JSON.toJSONString(dto));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送消息，数据聚合</span></span><br><span class="line">        <span class="type">UpdateArticleMess</span> <span class="variable">mess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateArticleMess</span>();</span><br><span class="line">        mess.setArticleId(dto.getArticleId());</span><br><span class="line">        mess.setType(UpdateArticleMess.UpdateArticleType.VIEWS);</span><br><span class="line">        mess.setAdd(<span class="number">1</span>);</span><br><span class="line">        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<p><strong>stream聚合操作</strong></p>
<ol>
<li>
<p>在 leadnews-article 微服务中集成 kafkaStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过重新注册KafkaStreamsConfiguration对象，设置自定配置参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableKafkaStreams</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;kafka&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaStreamConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_MESSAGE_SIZE</span> <span class="operator">=</span> <span class="number">16</span>* <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> String hosts;</span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line">    <span class="meta">@Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> KafkaStreamsConfiguration <span class="title function_">defaultKafkaStreamsConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);</span><br><span class="line">        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="built_in">this</span>.getGroup()+<span class="string">&quot;_stream_aid&quot;</span>);</span><br><span class="line">        props.put(StreamsConfig.CLIENT_ID_CONFIG, <span class="built_in">this</span>.getGroup()+<span class="string">&quot;_stream_cid&quot;</span>);</span><br><span class="line">        props.put(StreamsConfig.RETRIES_CONFIG, <span class="number">10</span>);</span><br><span class="line">        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class="line">        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaStreamsConfiguration</span>(props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kafka:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:9092</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义实体类，用于聚合之后的分值封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleVisitStreamMess</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文章id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long articleId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 阅读</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> view;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收藏</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> collect;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> comment;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 点赞</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> like;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改常量类：增加常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotArticleConstants</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOT_ARTICLE_SCORE_TOPIC=<span class="string">&quot;hot.article.score.topic&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOT_ARTICLE_INCR_HANDLE_TOPIC=<span class="string">&quot;hot.article.incr.handle.topic&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义stream，接收消息并聚合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotArticleStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KStream&lt;String,String&gt; <span class="title function_">kStream</span><span class="params">(StreamsBuilder streamsBuilder)</span>&#123;</span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        KStream&lt;String,String&gt; stream = streamsBuilder.stream(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 聚合流式处理</span></span><br><span class="line">        stream.map((key,value)-&gt;&#123;</span><br><span class="line">            <span class="comment">// 将UpdateArticleMess反序列化</span></span><br><span class="line">            <span class="type">UpdateArticleMess</span> <span class="variable">mess</span> <span class="operator">=</span> JSON.parseObject(value, UpdateArticleMess.class);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重置消息的 key 和 value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyValue</span>&lt;&gt;(mess.getArticleId().toString(), mess.getType().name()+<span class="string">&quot;:&quot;</span>+mess.getAdd());</span><br><span class="line">            <span class="comment">//  key:1234343434, value: likes:1</span></span><br><span class="line">        &#125;)</span><br><span class="line">                <span class="comment">// 按照文章id进行聚合</span></span><br><span class="line">                .groupBy((key,value)-&gt;key)</span><br><span class="line">                <span class="comment">// 时间窗口</span></span><br><span class="line">                .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="number">10</span>)))</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 自行的完成聚合的计算</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                .aggregate(<span class="keyword">new</span> <span class="title class_">Initializer</span>&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 初始方法，返回值是消息的value</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 真正的聚合操作，返回值是消息的value</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                &#125;, <span class="keyword">new</span> <span class="title class_">Aggregator</span>&lt;String, String, String&gt;() &#123;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="comment">// aggValue：为初始化方法返回的值</span></span><br><span class="line">                    <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(String key, String value, String aggValue)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span>(StringUtils.isBlank(value))&#123;</span><br><span class="line">                            <span class="keyword">return</span> aggValue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 循环操作</span></span><br><span class="line">                        String[] aggAry = aggValue.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                        <span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> <span class="number">0</span>, com = <span class="number">0</span>, lik = <span class="number">0</span>, vie = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (String agg : aggAry) &#123;</span><br><span class="line">                            String[] split = agg.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                             * 获得初始值，也是时间窗口内计算之后的值</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            <span class="keyword">switch</span> (UpdateArticleMess.UpdateArticleType.valueOf(split[<span class="number">0</span>]))&#123;</span><br><span class="line">                                <span class="keyword">case</span> COLLECTION:</span><br><span class="line">                                    col = Integer.parseInt(split[<span class="number">1</span>]);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> COMMENT:</span><br><span class="line">                                    com = Integer.parseInt(split[<span class="number">1</span>]);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> LIKES:</span><br><span class="line">                                    lik = Integer.parseInt(split[<span class="number">1</span>]);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> VIEWS:</span><br><span class="line">                                    vie = Integer.parseInt(split[<span class="number">1</span>]);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * 累加操作</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        String[] valAry = value.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                        <span class="keyword">switch</span> (UpdateArticleMess.UpdateArticleType.valueOf(valAry[<span class="number">0</span>]))&#123;</span><br><span class="line">                            <span class="keyword">case</span> COLLECTION:</span><br><span class="line">                                col += Integer.parseInt(valAry[<span class="number">1</span>]);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> COMMENT:</span><br><span class="line">                                com += Integer.parseInt(valAry[<span class="number">1</span>]);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> LIKES:</span><br><span class="line">                                lik += Integer.parseInt(valAry[<span class="number">1</span>]);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> VIEWS:</span><br><span class="line">                                vie += Integer.parseInt(valAry[<span class="number">1</span>]);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="type">String</span> <span class="variable">formatStr</span> <span class="operator">=</span> String.format(<span class="string">&quot;COLLECTION:%d,COMMENT:%d,LIKES:%d,VIEWS:%d&quot;</span>, col, com, lik, vie);</span><br><span class="line">                        System.out.println(<span class="string">&quot;文章的id:&quot;</span> + key);</span><br><span class="line">                        System.out.println(<span class="string">&quot;当前时间窗口内的消息处理结果：&quot;</span> + formatStr);</span><br><span class="line">                        <span class="keyword">return</span> formatStr;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, Materialized.as(<span class="string">&quot;hot-atricle-stream-count-001&quot;</span>))</span><br><span class="line">                .toStream()</span><br><span class="line">                .map((key,value)-&gt;&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyValue</span>&lt;&gt;(key.key().toString(), formatObj(key.key().toString(), value));</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 发送消息</span></span><br><span class="line">                .to(HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化消息的value数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> articleId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">formatObj</span><span class="params">(String articleId,String value)</span>&#123;</span><br><span class="line">        <span class="type">ArticleVisitStreamMess</span> <span class="variable">mess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArticleVisitStreamMess</span>();</span><br><span class="line">        mess.setArticleId(Long.valueOf(articleId));</span><br><span class="line">        <span class="comment">// COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0</span></span><br><span class="line">        String[] valAry = value.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String val : valAry) &#123;</span><br><span class="line">            String[] split = val.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="keyword">switch</span> (UpdateArticleMess.UpdateArticleType.valueOf(split[<span class="number">0</span>]))&#123;</span><br><span class="line">                <span class="keyword">case</span> COLLECTION:</span><br><span class="line">                    mess.setCollect(Integer.parseInt(split[<span class="number">1</span>]));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> COMMENT:</span><br><span class="line">                    mess.setComment(Integer.parseInt(split[<span class="number">1</span>]));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> LIKES:</span><br><span class="line">                    mess.setLike(Integer.parseInt(split[<span class="number">1</span>]));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> VIEWS:</span><br><span class="line">                    mess.setView(Integer.parseInt(split[<span class="number">1</span>]));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;聚合消息处理之后的结果为:&#123;&#125;&quot;</span>,JSON.toJSONString(mess));</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(mess);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>重新计算文章的分值，更新到数据库和缓存中</strong></p>
<ol>
<li>
<p>在 ApArticleService 添加方法，用于更新数据库中的文章分值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新文章的分值  同时更新缓存中的热点文章数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mess</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateScore</span><span class="params">(ArticleVisitStreamMess mess)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新文章的分值  同时更新缓存中的热点文章数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mess</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateScore</span><span class="params">(ArticleVisitStreamMess mess)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 更新文章的阅读、点赞、收藏、评论的数量</span></span><br><span class="line">    <span class="type">ApArticle</span> <span class="variable">apArticle</span> <span class="operator">=</span> updateArticle(mess);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 计算文章的分值</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">score</span> <span class="operator">=</span> computeScore(apArticle);</span><br><span class="line">    score = score * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 替换当前文章对应频道的热点数据</span></span><br><span class="line">    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + apArticle.getChannelId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 替换推荐对应的热点数据</span></span><br><span class="line">    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + ArticleConstants.DEFAULT_TAG);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 替换数据并且存入到redis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apArticle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> score</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceDataToRedis</span><span class="params">(ApArticle apArticle, Integer score, String s)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">articleListStr</span> <span class="operator">=</span> cacheService.get(s);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(articleListStr)) &#123;</span><br><span class="line">        List&lt;HotArticleVo&gt; hotArticleVoList = JSON.parseArray(articleListStr, HotArticleVo.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果缓存中存在该文章，只更新分值</span></span><br><span class="line">        <span class="keyword">for</span> (HotArticleVo hotArticleVo : hotArticleVoList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hotArticleVo.getId().equals(apArticle.getId())) &#123;</span><br><span class="line">                hotArticleVo.setScore(score);</span><br><span class="line">                flag = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果缓存中不存在，查询缓存中分值最小的一条数据，进行分值的比较，如果当前文章的分值大于缓存中的数据，就替换</span></span><br><span class="line">        <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hotArticleVoList.size() &gt;= <span class="number">30</span>) &#123;</span><br><span class="line">                hotArticleVoList = hotArticleVoList.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());</span><br><span class="line">                <span class="type">HotArticleVo</span> <span class="variable">lastHot</span> <span class="operator">=</span> hotArticleVoList.get(hotArticleVoList.size() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (lastHot.getScore() &lt; score) &#123;</span><br><span class="line">                    hotArticleVoList.remove(lastHot);</span><br><span class="line">                    <span class="type">HotArticleVo</span> <span class="variable">hot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotArticleVo</span>();</span><br><span class="line">                    BeanUtils.copyProperties(apArticle, hot);</span><br><span class="line">                    hot.setScore(score);</span><br><span class="line">                    hotArticleVoList.add(hot);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">HotArticleVo</span> <span class="variable">hot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotArticleVo</span>();</span><br><span class="line">                BeanUtils.copyProperties(apArticle, hot);</span><br><span class="line">                hot.setScore(score);</span><br><span class="line">                hotArticleVoList.add(hot);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 缓存到redis</span></span><br><span class="line">        hotArticleVoList = hotArticleVoList.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());</span><br><span class="line">        cacheService.set(s, JSON.toJSONString(hotArticleVoList));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新文章行为数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mess</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> ApArticle <span class="title function_">updateArticle</span><span class="params">(ArticleVisitStreamMess mess)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">ApArticle</span> <span class="variable">apArticle</span> <span class="operator">=</span> getById(mess.getArticleId());</span><br><span class="line">    </span><br><span class="line">    apArticle.setCollection(apArticle.getCollection()==<span class="literal">null</span>?<span class="number">0</span>:apArticle.getCollection() + mess.getCollect());</span><br><span class="line">    </span><br><span class="line">    apArticle.setComment(apArticle.getComment()==<span class="literal">null</span>?<span class="number">0</span>:apArticle.getComment() + mess.getComment());</span><br><span class="line">    </span><br><span class="line">    apArticle.setLikes(apArticle.getLikes()==<span class="literal">null</span>?<span class="number">0</span>:apArticle.getLikes() + mess.getLike());</span><br><span class="line">    </span><br><span class="line">    apArticle.setViews(apArticle.getViews()==<span class="literal">null</span>?<span class="number">0</span>:apArticle.getViews() + mess.getView());</span><br><span class="line">    </span><br><span class="line">    updateById(apArticle);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> apArticle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算文章的具体分值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apArticle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> Integer <span class="title function_">computeScore</span><span class="params">(ApArticle apArticle)</span> &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">score</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(apArticle.getLikes() != <span class="literal">null</span>)&#123;</span><br><span class="line">        score += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(apArticle.getViews() != <span class="literal">null</span>)&#123;</span><br><span class="line">        score += apArticle.getViews();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(apArticle.getComment() != <span class="literal">null</span>)&#123;</span><br><span class="line">        score += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(apArticle.getCollection() != <span class="literal">null</span>)&#123;</span><br><span class="line">        score += apArticle.getCollection() * ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义监听，接收聚合之后的数据，文章的分值重新进行计算</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleIncrHandleListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApArticleService apArticleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String mess)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(mess))&#123;</span><br><span class="line">            <span class="type">ArticleVisitStreamMess</span> <span class="variable">articleVisitStreamMess</span> <span class="operator">=</span> JSON.parseObject(mess, ArticleVisitStreamMess.class);</span><br><span class="line">            apArticleService.updateScore(articleVisitStreamMess);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="持续集成"><a class="headerlink" href="#持续集成"></a>持续集成</h2>
<hr>
<p>持续集成（ Continuous integration ， 简称 CI ）指的是：频繁地（一天多次）将代码集成到主干</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801142450288.png" alt="持续集成" loading="lazy"></p>
<p><strong>持续集成的组成要素</strong></p>
<ol>
<li>一个自动构建过程， 从检出代码、 编译构建、 运行测试、 结果记录、 测试统计等都是自动完成的， 无需人工干预</li>
<li>一个代码存储库，即需要版本控制软件来保障代码的可维护性，同时作为构建过程的素材库，一般使用SVN或Git</li>
<li>一个持续集成服务器， Jenkins 就是一个配置简单和使用方便的持续集成服务器</li>
</ol>
<p><strong>持续集成的好处</strong>：</p>
<ol>
<li>降低风险，由于持续集成不断去构建，编译和测试，可以很早期发现问题，所以修复的代价就少</li>
<li>对系统健康持续检查，减少发布风险带来的问题</li>
<li>减少重复性工作</li>
<li>持续部署，提供可部署单元包</li>
<li>持续交付可供使用的版本</li>
<li>增强团队信心</li>
</ol>
<hr>
<h3 id="软件开发模式"><a class="headerlink" href="#软件开发模式"></a>软件开发模式</h3>
<hr>
<h4 id="软件开发生命周期"><a class="headerlink" href="#软件开发生命周期"></a>软件开发生命周期</h4>
<hr>
<p>软件开发生命周期又叫做SDLC（Software Development Life Cycle），它是集合了 计划、开发、测试 和 部署 过程的集合</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801143252530.png" alt="SDLC" loading="lazy"></p>
<ul>
<li>
<p><strong>需求分析</strong></p>
<p>这是生命周期的第一阶段，根据项目需求，团队执行一个可行性计划的分析。项目需求可能是公司内部或者客户提出的。这阶段主要是对信息的收集，也有可能是对现有项目的改善和重新做一个新的项目。还要分析项目的预算多长，可以从哪方面受益及布局，这也是项目创建的目标。</p>
</li>
<li>
<p><strong>设计</strong></p>
<p>第二阶段就是设计阶段，系统架构和满意状态（就是要做成什么样子，有什么功能），和创建一个项目计划。计划可以使用图表，布局设计或者文字的方式呈现。</p>
</li>
<li>
<p><strong>实现</strong></p>
<p>第三阶段就是实现阶段，项目经理创建和分配工作给开者，开发者根据任务和在设计阶段定义的目标进行开发代码。依据项目的大小和复杂程度，可以需要数月或更长时间才能完成。</p>
</li>
<li>
<p><strong>测试</strong></p>
<p>测试人员进行代码测试 ，包括功能测试、代码测试、压力测试等。</p>
</li>
<li>
<p><strong>进化</strong></p>
<p>最后进阶段就是对产品不断的进化改进和维护阶段，根据用户的使用情况，可能需要对某功能进行修改，bug修复，功能增加等</p>
</li>
</ul>
<hr>
<h4 id="软件开发瀑布模型"><a class="headerlink" href="#软件开发瀑布模型"></a>软件开发瀑布模型</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801143504515.png" alt="软件开发瀑布模型" loading="lazy"></p>
<table>
<thead>
<tr>
<th>优势</th>
<th>劣势</th>
</tr>
</thead>
<tbody>
<tr>
<td>简单易用和理解</td>
<td>各个阶段的划分完全固定，阶段之间产生大量的文档，极大地增加了工作量。</td>
</tr>
<tr>
<td>当前一阶段完成后，您只需要去关注后续阶段。</td>
<td>由于开发模型是线性的，用户只有等到整个过程的末期才能见到开发成果，从而增加了开发风险。</td>
</tr>
<tr>
<td>为项目提供了按阶段划分的检查节点</td>
<td>瀑布模型的突出缺点是不适应用户需求的变化。</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="软件的敏捷开发"><a class="headerlink" href="#软件的敏捷开发"></a>软件的敏捷开发</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801143629468.png" alt="软件的敏捷开发" loading="lazy"></p>
<ul>
<li><strong>敏捷开发</strong>：
<ul>
<li>敏捷开发（Agile Development） 的 <strong>核心是迭代开发（Iterative Development） 与 增量开发（Incremental Development）</strong></li>
</ul>
</li>
<li><strong>迭代开发</strong>：
<ul>
<li>对于大型软件项目，传统的开发方式是采用一个大周期（比如一年）进行开发，整个过程就是一次 “大开发”</li>
<li>迭代开发的方式则不一样，它将开发过程拆分成多个小周期，即一次 “大开发” 变成多次 “小开发”，每次小开发都是同样的流程，所以看上去就好像重复在做同样的步骤</li>
</ul>
</li>
<li><strong>增量开发</strong>：
<ul>
<li>软件的每个版本，都会新增一个用户可以感知的完整功能。也就是说，按照新增功能来划分迭代</li>
</ul>
</li>
<li><strong>软件敏捷开发的好处</strong>：
<ul>
<li><strong>早期交付</strong></li>
<li><strong>降低风险</strong></li>
</ul>
</li>
</ul>
<hr>
<h3 id="Jenkins-安装配置"><a class="headerlink" href="#Jenkins-安装配置"></a>Jenkins 安装配置</h3>
<hr>
<p>Jenkins  是一款流行的开源持续集成（Continuous Integration）工具，广泛用于项目开发，具有自动化构建、测试和部署等功能</p>
<p>官网：  <a target="_blank" rel="noopener" href="http://jenkins-ci.org/">http://jenkins-ci.org/</a></p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801144228655.png" alt="Jenkins流程" loading="lazy"></p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p>采用YUM方式安装</p>
<p>加入jenkins安装源：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo --no-check-certificate</span><br><span class="line"></span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br></pre></td></tr></table></figure>
<p>执行yum命令安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install jenkins</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>采用RPM安装包方式</p>
<p><a target="_blank" rel="noopener" href="https://pkg.jenkins.io/redhat-stable/">Jenkins安装包下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.jenkins.io/redhat-stable/jenkins-2.190.1-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>执行安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jenkins-2.190.1-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置：</p>
<p>修改配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/jenkins</span><br></pre></td></tr></table></figure>
<p>修改内容：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改为对应的目标用户， 这里使用的是root</span></span><br><span class="line"><span class="variable">$JENKINS_USER</span>=<span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="comment"># 服务监听端口</span></span><br><span class="line">JENKINS_PORT=<span class="string">&quot;16060&quot;</span></span><br></pre></td></tr></table></figure>
<p>目录权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R root:root /var/lib/jenkins</span><br><span class="line"><span class="built_in">chown</span> -R root:root /var/cache/jenkins</span><br><span class="line"><span class="built_in">chown</span> -R root:root /var/log/jenkins</span><br></pre></td></tr></table></figure>
<p>重启：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart jenkins</span><br></pre></td></tr></table></figure>
<p>如果启动失败， 出现错误信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Starting Jenkins bash: /usr/bin/java: No such file or directory</span><br></pre></td></tr></table></figure>
<p>创建JAVA环境的软链接：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /usr/local/jdk/bin/java /usr/bin/java</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>管理后台初始化设置</p>
<p><a target="_blank" rel="noopener" href="http://192.168.200.100:16060/">http://192.168.200.100:16060/</a></p>
<p>需要输入管理密码， 在以下位置查看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/lib/jenkins/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801144754069.png" alt loading="lazy"></p>
<p>按默认设置，把建议的插件都安装上</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801144820501.png" alt loading="lazy"></p>
<p>这一步等待时间较长， 安装完成之后， 创建管理员用户：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20210802011653454.png" alt loading="lazy"></p>
</li>
</ol>
<p>配置访问地址：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20210802011707013.png" alt loading="lazy"></p>
<p>配置完成之后， 会进行重启， 之后可以看到管理后台：</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20210802011723835.png" alt loading="lazy"></p>
<hr>
<h4 id="Jenkins-安装-插件安装"><a class="headerlink" href="#Jenkins-安装-插件安装"></a>Jenkins 安装 - 插件安装</h4>
<hr>
<p>在实现持续集成之前， 需要确保以下插件安装成功。</p>
<ul>
<li><code>Maven Integration plugin</code>：Maven 集成管理插件</li>
<li><code>Docker plugin</code>：Docker集成插件</li>
<li><code>GitLab Plugin</code>：GitLab集成插件</li>
<li><code>Publish Over SSH</code>：远程文件发布插件</li>
<li><code>SSH</code>：远程脚本执行插件</li>
</ul>
<hr>
<p><strong>JDK 安装（略）</strong></p>
<h4 id="Git-安装配置"><a class="headerlink" href="#Git-安装配置"></a>Git 安装配置</h4>
<ol>
<li>
<p>yum 安装方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>采用源码包方式安装</p>
<ul>
<li>
<p>安装依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install curl-devel expat-devel gettext-devel openssl-devel zlib-devel</span><br><span class="line">yum -y install gcc perl-ExtUtils-MakeMaker</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>如果之前有安装旧版本， 先做卸载， 没有安装则忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove git</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>下载源码包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">wget https://mirrors.edge.kernel.org/pub/software/scm/git/git-1.8.3.1.tar.gz</span><br><span class="line">tar -xvf git-1.8.3.1.tar.gz</span><br></pre></td></tr></table></figure>
<p>也可以安装其他版本， 地址：<a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/software/scm/git/">https://mirrors.edge.kernel.org/pub/software/scm/git/</a></p>
</li>
<li>
<p>编译安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd git-1.8.3.1</span><br><span class="line">make prefix=/usr/local/git all</span><br><span class="line">make prefix=/usr/local/git install</span><br><span class="line">echo &quot;export PATH=$PATH:/usr/local/git/bin&quot; &gt;&gt; /etc/bashrc</span><br><span class="line">source /etc/bashrc</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>检查git版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost jenkins]# git version</span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h4 id="Maven-安装配置"><a class="headerlink" href="#Maven-安装配置"></a>Maven 安装配置</h4>
<ol>
<li>
<p>下载安装包</p>
<p>下载地址： <a target="_blank" rel="noopener" href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a></p>
</li>
<li>
<p>解压安装包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">unzip -o apache-maven-3.6.1.zip </span><br></pre></td></tr></table></figure>
<p>上传本地仓库并解压</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801145732709.png" alt loading="lazy"></p>
</li>
<li>
<p>配置</p>
<p>环境变量配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure>
<p>增加：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export MAVEN_HOME=/usr/local/maven/apache-maven-3.6.1</span><br><span class="line">export PATH=$PATH:$MAVEN_HOME/bin</span><br></pre></td></tr></table></figure>
<p>如果权限不够，则需要增加当前目录的权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 /usr/local/maven/apache-maven-3.6.1/bin/mvn</span><br></pre></td></tr></table></figure>
<p>修改镜像仓库配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/maven/apache-maven-3.6.1/conf/settings.xml</span><br></pre></td></tr></table></figure>
<p>需要把本机的仓库打包上传到服务器上（不上传会自动下载）</p>
<p>然后指定上传后的仓库配置</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801145755557.png" alt loading="lazy"></p>
</li>
</ol>
<hr>
<h4 id="Docker-安装配置"><a class="headerlink" href="#Docker-安装配置"></a>Docker 安装配置</h4>
<ol>
<li>
<p>更新软件包版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y update</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>卸载旧版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y remove docker  docker-common docker-selinux docker-engine</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>安装软件依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置yum源为阿里云</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>安装后查看docker版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>启动</p>
<p>设置开机启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<p>启动docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="Jenkins-工具配置"><a class="headerlink" href="#Jenkins-工具配置"></a>Jenkins 工具配置</h3>
<ol>
<li>
<p>进入【系统管理】–&gt; 【全局工具配置】</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801151019556.png" alt loading="lazy"></p>
</li>
<li>
<p>MAVEN配置全局设置</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801151043135.png" alt loading="lazy"></p>
</li>
<li>
<p>指定JDK配置</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801151107976.png" alt loading="lazy"></p>
</li>
<li>
<p>指定 MAVEN 目录</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801151137555.png" alt loading="lazy"></p>
</li>
<li>
<p>指定 DOCKER 目录</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801151207193.png" alt loading="lazy"></p>
<p>如果不清楚docker的安装的目录，可以使用<code>whereis docker</code> 命令查看docker的安装的目录</p>
</li>
</ol>
<hr>
<h3 id="后端项目部署"><a class="headerlink" href="#后端项目部署"></a>后端项目部署</h3>
<hr>
<h4 id="多环境切换"><a class="headerlink" href="#多环境切换"></a>多环境切换</h4>
<p>在项目开发部署的过程中，一般都会有三套项目环境</p>
<ul>
<li>Development：开发环境</li>
<li>Production：生产环境</li>
<li>Test：测试环境</li>
</ul>
<h4 id="微服务中多环境配置"><a class="headerlink" href="#微服务中多环境配置"></a>微服务中多环境配置</h4>
<ol>
<li>
<p>在微服务中的bootstrap.yml中新增配置（以user微服务为例）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">51801</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">leadnews-user</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">    <span class="comment"># prod</span></span><br><span class="line">    <span class="comment"># test</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在nacos的配置中心中新增各个环境的配置文件（以user微服务为例）</p>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801152441986.png" alt="创建开发环境的相关配置文件" loading="lazy"></p>
<ul>
<li>也可以配置 leadnews-user-test 的配置</li>
</ul>
</li>
</ol>
<hr>
<h4 id="整体思路"><a class="headerlink" href="#整体思路"></a>整体思路</h4>
<hr>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801152942452.png" alt="整体思路" loading="lazy"></p>
<ul>
<li>注意：<code>192.168.200.100</code> 与 <code>192.168.200.130</code> 必须使用 <strong>NAT</strong> 这个网卡，必须在同一个网段，是可以互相通信的，可以使用 ping 命令来检查</li>
</ul>
<hr>
<h4 id="服务集成Docker配置"><a class="headerlink" href="#服务集成Docker配置"></a>服务集成Docker配置</h4>
<hr>
<p>目标：部署的每一个微服务都是先创建 <strong>docker镜像</strong> 后创建对应容器启动</p>
<p>方法：</p>
<ol>
<li>本地微服务打包以后上传到服务器，编写 Dockerfile 文件完成</li>
<li>使用 dockerfile-maven-plugin 插件，可以直接把微服务创建为镜像使用（更省事）</li>
</ol>
<p>步骤：</p>
<ol>
<li>
<p>每个微服务都引入该依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;docker.image&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/image-20240801221613747.png" alt="说明" loading="lazy"></p>
</li>
<li>
<p>创建Dockerfile文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置JAVA版本</span></span><br><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"><span class="comment"># 指定存储卷, 任何向/tmp写入的信息都不会记录到容器存储层</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /tmp</span></span><br><span class="line"><span class="comment"># 拷贝运行JAR包</span></span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;JAR_FILE&#125;</span> app.jar</span></span><br><span class="line"><span class="comment"># 设置JVM运行参数， 这里限定下内存大小，减少开销</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;\</span></span><br><span class="line"><span class="string">-server \</span></span><br><span class="line"><span class="string">-Xms256m \</span></span><br><span class="line"><span class="string">-Xmx512m \</span></span><br><span class="line"><span class="string">-XX:MetaspaceSize=256m \</span></span><br><span class="line"><span class="string">-XX:MaxMetaspaceSize=512m&quot;</span></span><br><span class="line"><span class="comment"># 空参数，方便创建容器时传参</span></span><br><span class="line"><span class="keyword">ENV</span> PARAMS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 入口点， 执行JAVA运行命令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;java -jar <span class="variable">$JAVA_OPTS</span> /app.jar <span class="variable">$PARAMS</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>通过的maven的命令可以把微服务打成镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerfile:build</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>后面会结合着jenkins一起使用</p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author_group"><a class="post-copyright__author_img" href="/about/"><img class="post-copyright__author_img_front" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/MyPhoto.jpg"></a><div class="post-copyright__author_name">coo1heisenberg's Blog</div><div class="post-copyright__author_desc">Diligence can make up for clumsiness!</div></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div id="quit-box" onclick="RemoveRewardMask()"></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本文是原创文章，采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>协议，完整转载请注明来自<a href="/">coo1heisenberg's Blog</a></span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Project/"><span class="tags-punctuation"></span>Project<span class="tagsPageCount">2</span></a></div></div><div class="social-share"></div></div><nav class="needEndHide pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/08/00-%E9%BB%91%E9%A9%ACSSM/"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">06 SSM框架 笔记</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/06/00-Mybatis-Plus/"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">00 Mybatis-Plus 笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="solitude st-star-smile-fill"></i><span>喜欢这篇的人也看了</span><div class="relatedPosts-link"><a onclick="event.preventDefault(); toRandomPost();" href="javascript:void(0);" rel="external nofollow" data-pjax-state="">随便逛逛</a></div></div><div class="relatedPosts-list"><div><a href="/2024/06/25/00-%E5%A4%B4%E6%9D%A1%E7%82%B9%E8%AF%84%E9%A1%B9%E7%9B%AE/" title="00 仿今日头条项目"><img class="cover" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Snipaste_2024-06-25_21-33-23.png" alt="cover"><div class="content is-center"><div class="title">00 仿今日头条项目</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><div class="author-info__top-group"><div class="author-info__sayhi" id="author-info__sayhi" onclick="sco.changeSayHelloText()">sayhello.morning</div></div></div><div class="avatar-img-group"><img class="avatar-img" alt="头像" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/MyPhoto.jpg"><div class="avatar-sticker"><img class="avatar-sticker-img" src="https://7.isyangs.cn/34/65f2e4e0423cc-34.png" alt="心情贴纸"></div></div><div class="author-info__description_group"><div class="author-info__description">菜鸡的自我救赎...</div><div class="author-info__description2"></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about/"><div class="author-info__name">Coo1heisenberg’s BLOG</div><div class="author-info__desc">Diligence can make up for clumsiness!</div></a><div class="card-info-social-icons is-center"><a class="social-icon" target="_blank" rel="noopener" href="https://github.com/coo1heisenbergProject" title="Github"><i class="solitude  st-github-line"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="solitude st-menu-line"></i><span>文章目录</span></div><div class="toc-content" id="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">仿今日头条项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AA%92%E4%BD%93%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6"><span class="toc-text">自媒体文章上下架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E6%A6%82%E8%BF%B0"><span class="toc-text">Kafka 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-text">Kafka 安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">kafka 入门案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E5%88%86%E5%8C%BA%E6%9C%BA%E5%88%B6"><span class="toc-text">Kafka 分区机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E9%AB%98%E5%8F%AF%E7%94%A8%E8%AE%BE%E8%AE%A1"><span class="toc-text">Kafka 高可用设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-text">集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E6%9C%BA%E5%88%B6-Replication%EF%BC%89"><span class="toc-text">备份机制 (Replication）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E7%94%9F%E4%BA%A7%E8%80%85%E8%AF%A6%E8%A7%A3"><span class="toc-text">Kafka 生产者详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%B1%BB%E5%9E%8B"><span class="toc-text">发送类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-text">参数说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E6%B6%88%E8%B4%B9%E8%80%85%E8%AF%A6%E8%A7%A3"><span class="toc-text">Kafka 消费者详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-text">消费者组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-text">消费有序性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4-%E5%92%8C-%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="toc-text">提交 和 偏移量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot%E9%9B%86%E6%88%90Kafka%E6%94%B6%E5%8F%91%E6%B6%88%E6%81%AF"><span class="toc-text">SpringBoot集成Kafka收发消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AA%92%E4%BD%93%E6%96%87%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%9E%B6%E5%8A%9F%E8%83%BD%E5%AE%8C%E6%88%90"><span class="toc-text">自媒体文章上下架功能完成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AA%92%E4%BD%93%E7%AB%AF"><span class="toc-text">自媒体端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#article%E7%AB%AF"><span class="toc-text">article端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#app%E7%AB%AF%E6%96%87%E7%AB%A0%E6%90%9C%E7%B4%A2"><span class="toc-text">app端文章搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA-ElasticSearch-%E7%8E%AF%E5%A2%83"><span class="toc-text">搭建 ElasticSearch 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app%E7%AB%AF%E6%96%87%E7%AB%A0%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">app端文章搜索功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%B0%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">数据初始化到索引库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">文章搜索功能实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%96%87%E7%AB%A0%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text">新增文章创建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app%E7%AB%AF%E6%90%9C%E7%B4%A2-%E8%AE%B0%E5%BD%95%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">app端搜索 记录功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MongoDB-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%9B%86%E6%88%90"><span class="toc-text">MongoDB 安装与集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E6%90%9C%E7%B4%A2%E8%AE%B0%E5%BD%95-%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">保存搜索记录 功能实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%90%9C%E7%B4%A2%E5%8E%86%E5%8F%B2-%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">加载搜索历史 功能实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%90%9C%E7%B4%A2%E5%8E%86%E5%8F%B2-%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">删除搜索历史 功能实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app%E7%AB%AF%E6%90%9C%E7%B4%A2-%E5%85%B3%E9%94%AE%E5%AD%97%E8%81%94%E7%B3%BB%E8%AF%8D%E5%AE%9E%E7%8E%B0"><span class="toc-text">app端搜索 关键字联系词实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E6%96%87%E7%AB%A0-%E5%AE%9A%E6%97%B6%E8%AE%A1%E7%AE%97"><span class="toc-text">热点文章 - 定时计算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%BC%8A%E7%AB%AF"><span class="toc-text">目前存在的弊端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E8%AE%A1%E7%AE%97"><span class="toc-text">定时计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6-xxljob"><span class="toc-text">定时任务框架 - xxljob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-text">分布式任务调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xxl-Job-%E4%BB%8B%E7%BB%8D"><span class="toc-text">xxl-Job 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2-%E2%80%9C%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E2%80%9D"><span class="toc-text">配置部署 “调度中心”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%EF%BC%88docker%E5%AE%89%E8%A3%85%EF%BC%89"><span class="toc-text">配置部署调度中心（docker安装）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xxl-Job-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">xxl-Job 入门案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%AF%A6%E8%A7%A3"><span class="toc-text">任务详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-text">执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-text">基础配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%B1%BB%E5%9E%8B"><span class="toc-text">调度类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-text">任务配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-text">阻塞处理策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5"><span class="toc-text">路由策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5-%EF%BC%88%E8%BD%AE%E8%AF%A2%EF%BC%89%E6%A1%88%E4%BE%8B"><span class="toc-text">路由策略 （轮询）案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%EF%BC%88%E5%88%86%E7%89%87%E5%B9%BF%E6%92%AD%EF%BC%89"><span class="toc-text">路由策略（分片广播）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E6%96%87%E7%AB%A0-%E4%BB%BB%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">热点文章  任务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-text">实现步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E8%AE%A1%E7%AE%97-%E4%BB%BB%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">定时计算 任务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-2"><span class="toc-text">实现步骤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E7%AB%A0%E6%8E%A5%E5%8F%A3%E6%94%B9%E9%80%A0"><span class="toc-text">查询文章接口改造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-3"><span class="toc-text">实现步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-Stream"><span class="toc-text">Kafka Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97"><span class="toc-text">实时流式计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-Stream-%E4%BD%BF%E7%94%A8"><span class="toc-text">Kafka Stream 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-text">关键概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KStream"><span class="toc-text">KStream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka-Stream-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">Kafka Stream 入门案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringBoot-%E9%9B%86%E6%88%90-Kafka-Stream"><span class="toc-text">SpringBoot 集成 Kafka Stream</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E6%96%87%E7%AB%A0-%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97"><span class="toc-text">热点文章 - 实时计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90"><span class="toc-text">持续集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-text">软件开发模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">软件开发生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E7%80%91%E5%B8%83%E6%A8%A1%E5%9E%8B"><span class="toc-text">软件开发瀑布模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%9A%84%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91"><span class="toc-text">软件的敏捷开发</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-text">Jenkins 安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text">Jenkins 安装 - 插件安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Git-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-text">Git 安装配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Maven-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-text">Maven 安装配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-text">Docker 安装配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE"><span class="toc-text">Jenkins 工具配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-text">后端项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%88%87%E6%8D%A2"><span class="toc-text">多环境切换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">微服务中多环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="toc-text">整体思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90Docker%E9%85%8D%E7%BD%AE"><span class="toc-text">服务集成Docker配置</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="solitude st-map-line"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/28/00-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" title="00 HTML5和CSS3 笔记"><img alt="00 HTML5和CSS3 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Web_Html%2BCSS.png"></a><div class="content"><a class="title" href="/2024/09/28/00-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" title="00 HTML5和CSS3 笔记">00 HTML5和CSS3 笔记</a><a class="article-recent_post_categories" href="/2024/09/28/00-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/">前端</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/" title="01 空间转录组 笔记"><img alt="01 空间转录组 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/bio_gene.png"></a><div class="content"><a class="title" href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/" title="01 空间转录组 笔记">01 空间转录组 笔记</a><a class="article-recent_post_categories" href="/2024/09/26/01-%E7%A9%BA%E9%97%B4%E8%BD%AC%E5%BD%95%E7%BB%84/">生信分析</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/13/00-%E5%8D%95%E7%BB%86%E8%83%9E%E5%A4%9A%E7%BB%84%E5%AD%A6%E5%88%86%E6%9E%90/" title="00 单细胞多组学分析 笔记"><img alt="00 单细胞多组学分析 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/bio_gene.png"></a><div class="content"><a class="title" href="/2024/09/13/00-%E5%8D%95%E7%BB%86%E8%83%9E%E5%A4%9A%E7%BB%84%E5%AD%A6%E5%88%86%E6%9E%90/" title="00 单细胞多组学分析 笔记">00 单细胞多组学分析 笔记</a><a class="article-recent_post_categories" href="/2024/09/13/00-%E5%8D%95%E7%BB%86%E8%83%9E%E5%A4%9A%E7%BB%84%E5%AD%A6%E5%88%86%E6%9E%90/">生信分析</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/22/00-MongoDB/" title="04 MongoDB 笔记"><img alt="04 MongoDB 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/Mongodb_title.png"></a><div class="content"><a class="title" href="/2024/07/22/00-MongoDB/" title="04 MongoDB 笔记">04 MongoDB 笔记</a><a class="article-recent_post_categories" href="/2024/07/22/00-MongoDB/">Database</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/17/00-elasticsearch/" title="00 ElasticSearch 笔记"><img alt="00 ElasticSearch 笔记" src="https://coo1heisenberg-blog.oss-cn-shanghai.aliyuncs.com/ElasticSearch.png"></a><div class="content"><a class="title" href="/2024/07/17/00-elasticsearch/" title="00 ElasticSearch 笔记">00 ElasticSearch 笔记</a><a class="article-recent_post_categories" href="/2024/07/17/00-elasticsearch/">Others</a></div></div></div></div></div></div></main><footer id="footer"><div id="st-footer-bar"><div class="footer-logo"><span>Solitude</span></div><div class="footer-bar-description">来自 Heisenberg 的原创文章</div><a class="footer-bar-link" href="/about/">了解更多</a></div><div id="footer_deal"></div><div id="st-footer"><div class="footer-group"><h3 class="footer-title">导航</h3><div class="footer-links"><a class="footer-item" href="/archives/" title="归档">归档</a><a class="footer-item" href="/categories/" title="分类">分类</a><a class="footer-item" href="/tags/" title="标签">标签</a></div></div><div class="footer-group"><h3 class="footer-title">服务</h3><div class="footer-links"><a class="footer-item" target="_blank" rel="noopener" href="https://aliyun.com/" title="阿里云">阿里云</a></div></div><div class="footer-group"><h3 class="footer-title">支持</h3><div class="footer-links"><a class="footer-item" href="/about/" title="打赏记录">打赏记录</a></div></div><div class="footer-group"><h3 class="footer-title">协议</h3><div class="footer-links"><a class="footer-item" href="/cookies/" title="Cookies">Cookies</a><a class="footer-item" href="/privacy/" title="用户协议">用户协议</a><a class="footer-item" href="/copyright/" title="版权协议">版权协议</a></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div class="copyright">© 2024 By&nbsp;<a class="footer-bar-link" href="/">Coo1heisenberg’s BLOG</a></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" alt="主题">主题</a><a class="footer-bar-link cc" href="/null" aria-label="copyright"><i class="solitude st-copyright-line"></i><i class="solitude st-creative-commons-by-line"></i><i class="solitude st-creative-commons-nc-line"></i><i class="solitude st-creative-commons-nd-line"></i></a></div></div></div></footer></div><!-- right_menu--><!-- inject body--><div><script src="/js/utils.js?v=1.10.6"></script><script src="/js/main.js?v=1.10.6"></script><script src="/js/third_party/waterfall.min.js?v=1.10.6"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script src="/js/third_party/universe.min.js?v=1.10.6"></script><script>dark()
</script><script src="//open.lightxi.com/cdnjs/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js"><script>(() => {
    document.querySelectorAll('#article-container span.katex-display').forEach(item => {
        utils.wrap(item, 'div', {class: 'katex-wrap'})
    })
})();
</script></script><script src="//open.lightxi.com/cdnjs/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js"></script><script>var meting_api = 'https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r';</script><script src="//open.lightxi.com/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/meting/2.0.1/Meting.min.js"></script><script src="//open.lightxi.com/cdnjs/ajax/libs/pace/1.2.4/pace.min.js"></script><div class="js-pjax"><script defer pjax src="//open.lightxi.com/cdnjs/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.min.js"></script></div></div><!-- newest comment--><!-- pjax--><script>const pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: ['title','#body-wrap','#site-config','meta[name="description"]','.js-pjax','meta[property^="og:"]','#config-diff'],
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
})

document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
})

document.addEventListener('pjax:complete', () => {
    window.refreshFn()

    document.querySelectorAll('script[data-pjax]').forEach(item => {
        const newScript = document.createElement('script')
        const content = item.text || item.textContent || item.innerHTML || ""
        Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
        newScript.appendChild(document.createTextNode(content))
        item.parentNode.replaceChild(newScript, item)
    })

    GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

})

document.addEventListener('pjax:error', (e) => {
    if (e.request.status === 404) {
        pjax.loadUrl('/404.html')
    }
})</script><!-- theme--><script>initTheme = () => {
    let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const cachedMode = utils.saveToLocal.get('theme');
    if (cachedMode === undefined) {
        const nowMode =
            isDarkMode ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', nowMode);
    } else {
        document.documentElement.setAttribute('data-theme', cachedMode);
    }
    is_rm && rm.mode(cachedMode === 'dark' && isDarkMode)
}
initTheme()</script><!-- google adsense--><!-- search--><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="solitude st-close-fill"></i></button></nav><div class="search-wrap"><div class="search-box"><input class="search-box-input" id="search-input" type="text" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" placeholder="输入关键词快速查找"></div><div id="search-results"><div id="search-hits"></div></div><div id="search-pagination"></div><div id="search-tips"></div></div></div><div id="search-mask"></div></div><script src="/js/search/local.js?v=1.10.6"></script><!-- Tianli-Talk--><!-- music--></body></html><script>const posts=["2024/09/28/00-前端开发入门教程/","2024/09/26/01-空间转录组/","2024/09/13/00-单细胞多组学分析/","2024/07/22/00-MongoDB/","2024/07/17/00-elasticsearch/","2024/07/15/01-黑马redis/","2024/07/13/00-黑马redis/","2024/07/08/00-黑马SSM/","2024/07/08/01-头条点评项目/","2024/07/06/00-Mybatis-Plus/","2024/06/29/00-黑马MySQL/","2024/06/25/00-头条点评项目/","2024/06/21/02-Python/","2024/06/11/01-Python/","2024/05/25/00-Python/","2024/05/13/DesignPattern/","2024/05/13/Docker/","2024/05/13/Nginx/","2024/05/13/Linux/"];function toRandomPost(){ pjax.loadUrl('/'+posts[Math.floor(Math.random()*posts.length)]); }</script>